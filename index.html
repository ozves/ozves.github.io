<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SÄ±nav Sistemi V12 (Okul No DoÄŸrulamalÄ± GiriÅŸ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0;}
        .app-card { background-color:white;padding:2.5rem;border-radius:1.5rem;box-shadow:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05);max-width:450px;width:90%;transition:all .3s;position:relative;}
        .header-bg { background: linear-gradient(135deg,#4f46e5 0%,#818cf8 100%); color:white;padding:1rem 0;border-radius:1rem 1rem 0 0;margin:-2.5rem -2.5rem 1.5rem -2.5rem;text-align:center;}
        .button{transition:all .2s;box-shadow:0 4px 6px rgba(0,0,0,0.1)}
        .button:hover{transform:translateY(-1px);box-shadow:0 6px 10px rgba(0,0,0,0.15)}
        .teacher-mode { max-width: 1400px !important; width: 98% !important; } 
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body>

    <div id="app" class="app-card">
        <div id="loginHeader" class="header-bg">
            <h1 class="text-2xl font-extrabold">Ã–ÄŸrenci GiriÅŸi</h1>
        </div>
        
        <div id="connectionStatus" class="hidden mb-4 text-xs font-bold text-center p-2 rounded border"></div>
        
        <div id="mainContentArea">
            <div id="loadingIndicator" class="text-center py-10">
                <svg class="animate-spin h-8 w-8 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p id="loadingText" class="text-sm text-gray-500 mt-4 font-bold">Sistem BaÅŸlatÄ±lÄ±yor...</p>
            </div>
        </div>
    </div>

    <div id="customModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center p-4 z-50">
        <div id="modalContent" class="bg-white rounded-xl p-6 max-w-3xl w-full text-center shadow-2xl overflow-y-auto max-h-[90vh]"></div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, collection, onSnapshot, serverTimestamp, query, where, getDocs, deleteDoc, getDoc, addDoc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyCHhFAHbWnclad6yFuI-Pw9gX6F_Dx1B2c",
    authDomain: "online-sinav-b3644.firebaseapp.com",
    projectId: "online-sinav-b3644",
    storageBucket: "online-sinav-b3644.firebasestorage.app",
    messagingSenderId: "965507531268",
    appId: "1:965507531268:web:94cfd13774a40b6cf16b51"
};

let db, auth;
let isAuthReady = false, isDbConnected = false;

let adminMasterCode = "123456";
let systemPreparerName = "Sistem YÃ¶neticisi";

let currentTeacherId = null; 
let currentTeacherName = null; 

let currentExamConfig = {
    exam_code: "DEFAULT",
    teacher_name: "Sistem YÃ¶neticisi",
    time_limit: 600,
    exam_description: "VarsayÄ±lan sÄ±nav. LÃ¼tfen yeni bir sÄ±nav kodu oluÅŸturun."
};
let quizQuestions = [];

let selectedAnswers = [], questionOrder = [], currentQuestionIndex = 0, resumeStartIndex = 0;
let timerInterval = null, timeLeft = 0, isTeacherMode = false, studentData = {};
let focusLossCount = 0, autoSaveInterval = null, currentSessionDocId = null;
let allSubmissions = [];
let studentList = [];

const getConfigRef = (code) => doc(db, "exam_settings", code.toUpperCase());
const getQuestionsRef = (code) => doc(db, "questions_pool", code.toUpperCase());
const getSubmissionRef = (id) => doc(db, "quiz_submissions", id);
const getTeacherRef = (id) => doc(db, "teachers", id);


function seededShuffle(array, seed) {
    let hash = 0;
    for (let i = 0; i < seed.length; i++) { hash = ((hash << 5) - hash) + seed.charCodeAt(i); hash |= 0; }
    const shuffled = [...array];
    let n = shuffled.length;
    while (n > 1) {
        hash = (hash * 9301 + 49297) % 233280;
        if (hash < 0) hash += 233280;
        let random = hash / 233280.0;
        let k = Math.floor(random * n);
        n--;
        [shuffled[n], shuffled[k]] = [shuffled[k], shuffled[n]];
    }
    return shuffled;
}

// --- MODAL FONKSÄ°YONLARI ---
function showCustomAlert(title, message, isHtml = false) {
    return new Promise(resolve => {
        const modal = document.getElementById('customModal');
        const modalContent = document.getElementById('modalContent');
        
        let contentHtml = `
            <h3 class="text-xl font-semibold text-gray-800 mb-4">${title}</h3>
        `;
        if (isHtml) {
            contentHtml += `<div class="text-gray-600 mb-6 text-left">${message}</div>`;
        } else {
            contentHtml += `<p class="text-gray-600 mb-6 whitespace-pre-line">${message}</p>`;
        }
        contentHtml += `
            <button id="modalClose" class="button bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md">Tamam</button>
        `;

        modalContent.innerHTML = contentHtml;
        modal.classList.remove('hidden'); modal.classList.add('flex');
        document.getElementById('modalClose').onclick = () => { modal.classList.add('hidden'); modal.classList.remove('flex'); resolve(); };
    });
}

// --- BAÅLATMA ---
async function initializeFirebase() {
    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        await signInAnonymously(auth);
        onAuthStateChanged(auth, async (user) => {
            if (user) { isAuthReady = true; await checkConnectivity(); }
        });
    } catch (error) { alert("Kritik BaÅŸlatma HatasÄ±: " + error.message); }
}

async function checkConnectivity() {
    const statusDiv = document.getElementById('connectionStatus');
    try {
        const adminSnap = await getDoc(doc(db, "exam_settings", "admin_config"));
        if (adminSnap.exists()) {
            const data = adminSnap.data();
            adminMasterCode = data.master_code || "123456";
            systemPreparerName = data.preparer_name || "Sistem YÃ¶neticisi";
        }

        isDbConnected = true;
        statusDiv.innerHTML = "ğŸŸ¢ VeritabanÄ± BaÄŸlÄ± (CanlÄ± Mod)";
        statusDiv.className = "mb-4 text-xs font-bold text-center p-2 rounded border bg-green-100 text-green-800 border-green-300";
    } catch(e) {
        isDbConnected = false;
        statusDiv.innerHTML = `ğŸ”´ BAÄLANTI YOK - VarsayÄ±lan ModdasÄ±nÄ±z<br><span class='text-[10px] font-normal'>${e.message || 'Veri bulunamadÄ±'}</span>`;
        statusDiv.className = "mb-4 text-xs font-bold text-center p-2 rounded border bg-red-100 text-red-800 border-red-300";
    }
    statusDiv.classList.remove('hidden');
    document.getElementById('loadingIndicator').classList.add('hidden');
    showLoginForm();
}

async function fetchExamData(code) {
    if (!isDbConnected) {
        currentExamConfig = { exam_code: code.toUpperCase(), teacher_name: systemPreparerName, time_limit: 600, exam_description: "Ã‡evrimdÄ±ÅŸÄ± modda varsayÄ±lan ayarlar kullanÄ±lÄ±yor." };
        quizQuestions = [];
        studentList = [];
        return true;
    }
    try {
        const configRef = getConfigRef(code);
        const questionsRef = getQuestionsRef(code);
        const listRef = doc(db, "student_lists", code);
        
        const configSnap = await getDoc(configRef);
        if (!configSnap.exists()) {
            currentExamConfig = { exam_code: code.toUpperCase(), teacher_name: systemPreparerName, time_limit: 600, exam_description: "SÄ±nav ayarlarÄ± bulunamadÄ±. VarsayÄ±lan sÃ¼re (10dk) kullanÄ±lÄ±yor." };
        } else {
            currentExamConfig = { exam_code: code.toUpperCase(), ...configSnap.data() };
            currentTeacherId = currentExamConfig.teacherId || null; 
        }
        
        const questionsSnap = await getDoc(questionsRef);
        quizQuestions = questionsSnap.exists() ? (questionsSnap.data().questions_list || []) : [];
        
        const listSnap = await getDoc(listRef);
        studentList = listSnap.exists() ? (listSnap.data().students || []) : [];

        return true;
    } catch(e) {
        alert("SÄ±nav verisi Ã§ekilirken hata: " + e.message);
        return false;
    }
}

// --- GÄ°RÄ°Å EKRANI (Ã–ÄŸrenci) ---
function showLoginForm() {
    if (!isAuthReady) return;
    document.getElementById('app').className = 'app-card max-w-md';
    document.getElementById('loginHeader').innerHTML = '<h1 class="text-2xl font-extrabold">Ã–ÄŸrenci GiriÅŸi</h1>';
    const timeInMinutes = Math.floor(currentExamConfig.time_limit / 60);
    
    document.getElementById('mainContentArea').innerHTML = `
        <div class="space-y-4">
            <div class="text-center p-2 bg-indigo-50 rounded-lg border border-indigo-100">
                <p class="text-xs text-gray-500">SÄ±navÄ± HazÄ±rlayan</p>
                <p class="font-bold text-indigo-700">${systemPreparerName}</p>
            </div>
            <div id="examInfoArea" class="bg-yellow-50 border border-yellow-200 p-3 rounded-lg text-sm text-yellow-800">
                <p class="font-bold mb-1">âš ï¸ SÄ±nav Bilgisi:</p>
                <p class="mb-2">${currentExamConfig.exam_description}</p>
                <p class="font-semibold">SÃ¼re: ${timeInMinutes} Dakika</p>
            </div>
            
            <input id="examCodeInput" type="text" placeholder="SÄ±nav Kodu" class="w-full p-3 border rounded-lg uppercase">
            
            <div id="studentLoginFields" class="space-y-4">
                <p class="text-sm text-center text-gray-500 font-semibold border-t pt-4">SÄ±nav kodunu girdikten sonra listeyi gÃ¶receksiniz.</p>
            </div>

            <button id="startQuizButton" class="button w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg" disabled>SÄ±nava BaÅŸla</button>
            <button id="teacherLoginButton" class="button w-full bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm py-2 rounded-lg">Ã–ÄŸretmen / YÃ¶netici GiriÅŸi</button>
        </div>
    `;
    document.getElementById('teacherLoginButton').onclick = showTeacherLogin;
    document.getElementById('examCodeInput').oninput = handleCodeEntry;
    document.getElementById('startQuizButton').onclick = handleStudentLogin;
}

function updateExamInfoArea(code) {
    const area = document.getElementById('examInfoArea');
    const timeInMinutes = Math.floor(currentExamConfig.time_limit / 60);
    area.innerHTML = `
        <p class="font-bold mb-1">âœ… SÄ±nav: ${code}</p>
        <p class="mb-2">${currentExamConfig.exam_description}</p>
        <p class="font-semibold">SÃ¼re: ${timeInMinutes} Dakika (HazÄ±rlayan: ${currentExamConfig.teacher_name})</p>
    `;
    area.className = "bg-green-50 border border-green-200 p-3 rounded-lg text-sm text-green-800";
}

async function handleCodeEntry() {
    const code = document.getElementById('examCodeInput').value.trim().toUpperCase();
    const loginFields = document.getElementById('studentLoginFields');
    const startBtn = document.getElementById('startQuizButton');

    if (code.length < 3) {
        loginFields.innerHTML = `<p class="text-sm text-center text-gray-500 font-semibold border-t pt-4">SÄ±nav kodunu girdikten sonra listeyi gÃ¶receksiniz.</p>`;
        startBtn.disabled = true;
        return;
    }

    if (await fetchExamData(code)) {
        updateExamInfoArea(code);
        if (studentList.length > 0) {
            const options = studentList.map(s => `<option value="${s.number}">${s.className} - ${s.name}</option>`).join('');
            loginFields.innerHTML = `
                <select id="studentNumberInput" class="w-full p-3 border rounded-lg">
                    <option value="">LÃ¼tfen listeden kendinizi seÃ§in...</option>
                    ${options}
                </select>
                <input id="studentNameInput" type="hidden">
                <input id="studentClassInput" type="hidden">
            `;
            startBtn.disabled = true;
            document.getElementById('studentNumberInput').onchange = (e) => {
                const selectedStudent = studentList.find(s => s.number === e.target.value);
                if (selectedStudent) {
                    document.getElementById('studentNameInput').value = selectedStudent.name;
                    document.getElementById('studentClassInput').value = selectedStudent.className;
                    startBtn.disabled = false;
                } else {
                    startBtn.disabled = true;
                }
            };
        } else {
            loginFields.innerHTML = `
                <input id="studentNumberInput" type="text" placeholder="Okul NumarasÄ±" class="w-full p-3 border rounded-lg">
                <input id="studentClassInput" type="text" placeholder="SÄ±nÄ±fÄ± (Ã–rn: 9A)" class="w-full p-3 border rounded-lg uppercase">
                <input id="studentNameInput" type="text" placeholder="AdÄ±nÄ±z SoyadÄ±nÄ±z" class="w-full p-3 border rounded-lg">
            `;
            const checkFields = () => {
                const num = document.getElementById('studentNumberInput').value.trim();
                const cls = document.getElementById('studentClassInput').value.trim();
                const name = document.getElementById('studentNameInput').value.trim();
                startBtn.disabled = !(num && cls && name);
            };
            document.getElementById('studentNumberInput').oninput = checkFields;
            document.getElementById('studentClassInput').oninput = checkFields;
            document.getElementById('studentNameInput').oninput = checkFields;
        }
    } else {
        loginFields.innerHTML = `<p class="text-sm text-center text-red-500 font-semibold border-t pt-4">SÄ±nav kodu bulunamadÄ± veya bir hata oluÅŸtu.</p>`;
        startBtn.disabled = true;
    }
}

async function handleStudentLogin() {
    const code = document.getElementById('examCodeInput').value.trim().toUpperCase();
    const number = document.getElementById('studentNumberInput')?.value.trim();
    const className = document.getElementById('studentClassInput')?.value.trim().toUpperCase();
    const name = document.getElementById('studentNameInput')?.value.trim();

    if (!code || !number || !className || !name) {
        return showCustomAlert("Hata", "LÃ¼tfen tÃ¼m giriÅŸ bilgilerini doldurun.");
    }
    
    if (quizQuestions.length === 0) {
        return showCustomAlert("Hata", `SÄ±nav Kodu '${code}' iÃ§in henÃ¼z soru yÃ¼klenmemiÅŸ.`);
    }

    studentData = { examCode: code, number, className, name };

    if (isDbConnected) {
        const q = query(collection(db, "active_sessions"), where("examCode", "==", code), where("number", "==", number));
        const snap = await getDocs(q);
        if (snap.docs.length > 0) {
            const sessionData = snap.docs[0].data();
            currentSessionDocId = snap.docs[0].id;
            await restoreSession(sessionData);
        } else {
            await startNewSession();
        }
    } else {
        await startNewSession();
    }
}

async function restoreSession(sessionData) {
    if(await showCustomAlert("KaldÄ±ÄŸÄ±nÄ±z Yerden Devam", `Sisteme ${sessionData.name} olarak giriÅŸ yaptÄ±nÄ±z. KaydedilmiÅŸ bir oturum bulundu. KaldÄ±ÄŸÄ±nÄ±z yerden devam edilsin mi?`, true)) {
        selectedAnswers = sessionData.answers || [];
        questionOrder = sessionData.order || [];
        timeLeft = sessionData.timeLeft || currentExamConfig.time_limit;
        resumeStartIndex = (sessionData.currentQuestion || 0);
        focusLossCount = sessionData.focusLossCount || 0;
        showQuiz();
    } else {
        await deleteDoc(doc(db, "active_sessions", currentSessionDocId));
        currentSessionDocId = null;
        await startNewSession();
    }
}

async function startNewSession() {
    selectedAnswers = new Array(quizQuestions.length).fill(null);
    questionOrder = seededShuffle(Array.from({length: quizQuestions.length}, (_, i) => i), studentData.number + studentData.examCode);
    timeLeft = currentExamConfig.time_limit;
    currentQuestionIndex = 0;
    focusLossCount = 0;
    
    if (isDbConnected) {
        const newSessionRef = await addDoc(collection(db, "active_sessions"), {
            ...studentData, 
            teacherId: currentExamConfig.teacherId, // Ã–ÄŸretmen ID'si eklendi
            order: questionOrder, 
            answers: selectedAnswers, 
            timeLeft: timeLeft, 
            currentQuestion: currentQuestionIndex,
            timestamp: serverTimestamp(),
            focusLossCount: focusLossCount
        });
        currentSessionDocId = newSessionRef.id;
    }
    showQuiz();
}

// --- SINAV EKRANI ---
function showQuiz() {
    document.getElementById('app').className = 'app-card max-w-3xl teacher-mode';
    document.getElementById('loginHeader').innerHTML = `<h1 class="text-2xl font-bold text-indigo-700">${studentData.examCode} SÄ±navÄ±</h1>`;
    
    document.getElementById('mainContentArea').innerHTML = `
        <div class="flex justify-between items-center mb-4 pb-2 border-b">
            <div class="text-sm font-semibold">${studentData.className} - ${studentData.name}</div>
            <div id="quizTimer" class="text-xl font-bold text-red-600">00:00</div>
        </div>
        <div id="quizQuestionArea" class="mb-6"></div>
        <div id="answerFeedback" class="text-sm text-red-600 font-bold mb-4"></div>
        <div id="quizNav" class="flex flex-wrap gap-2 mb-6 p-2 bg-gray-100 rounded"></div>
        <div class="flex justify-between mt-4">
            <button id="prevBtn" class="button bg-gray-500 text-white px-4 py-2 rounded font-bold">Ã–nceki</button>
            <button id="nextBtn" class="button bg-indigo-600 text-white px-4 py-2 rounded font-bold">Sonraki</button>
            <button id="finishBtn" class="button bg-red-600 text-white px-4 py-2 rounded font-bold">SÄ±navÄ± Bitir</button>
        </div>
        <p id="focusLossWarning" class="text-red-500 text-xs text-center mt-3 font-semibold hidden">âš ï¸ DÄ°KKAT: Pencereden ${focusLossCount} kez ayrÄ±ldÄ±nÄ±z!</p>
    `;

    document.getElementById('prevBtn').onclick = () => { if (currentQuestionIndex > 0) { currentQuestionIndex--; renderQuestion(); } };
    document.getElementById('nextBtn').onclick = () => { if (currentQuestionIndex < quizQuestions.length - 1) { currentQuestionIndex++; renderQuestion(); } };
    document.getElementById('finishBtn').onclick = () => finishQuiz();
    
    for (let i = 0; i < quizQuestions.length; i++) {
        const btn = document.createElement('button');
        btn.id = `navBtn_${i}`;
        btn.className = 'w-8 h-8 rounded text-xs font-bold bg-gray-300 hover:bg-gray-400';
        btn.textContent = (i + 1);
        btn.onclick = () => { currentQuestionIndex = i; renderQuestion(); };
        document.getElementById('quizNav').appendChild(btn);
    }

    startTimer();
    setupFocusCheck();
    startAutoSave();
    currentQuestionIndex = resumeStartIndex;
    renderQuestion();
}

function renderQuestion() {
    const area = document.getElementById('quizQuestionArea');
    const qIndex = questionOrder[currentQuestionIndex];
    const q = quizQuestions[qIndex];
    
    // Navigasyon butonlarÄ±nÄ± gÃ¼ncelle
    document.querySelectorAll('#quizNav button').forEach((btn, index) => {
        btn.className = `w-8 h-8 rounded text-xs font-bold ${
            index === currentQuestionIndex ? 'bg-indigo-600 text-white ring-2 ring-indigo-300' :
            selectedAnswers[questionOrder[index]] ? 'bg-green-400 text-white' : 
            'bg-gray-300 hover:bg-gray-400 text-gray-800'
        }`;
    });
    
    document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
    document.getElementById('nextBtn').disabled = currentQuestionIndex === quizQuestions.length - 1;

    let optionsHtml = q.options.map((opt, i) => {
        const optionLetter = String.fromCharCode(65 + i);
        const isChecked = selectedAnswers[qIndex] === optionLetter;
        return `
            <label class="flex items-center p-3 border rounded-lg cursor-pointer transition duration-150 ease-in-out hover:bg-indigo-50 ${isChecked ? 'bg-indigo-100 border-indigo-600' : 'bg-white border-gray-300'}">
                <input type="radio" name="answer_${qIndex}" value="${optionLetter}" ${isChecked ? 'checked' : ''} class="w-5 h-5 text-indigo-600 focus:ring-indigo-500" onchange="handleAnswerChange('${qIndex}', '${optionLetter}')">
                <span class="ml-3 text-sm font-medium text-gray-700">${optionLetter}) ${opt}</span>
            </label>
        `;
    }).join('');

    area.innerHTML = `
        <h2 class="text-xl font-bold mb-4 text-indigo-700">Soru ${currentQuestionIndex + 1} / ${quizQuestions.length}</h2>
        ${q.image ? `<img src="${q.image}" alt="Soru gÃ¶rseli" class="mb-4 max-w-full h-auto rounded-lg shadow-md border">` : ''}
        <p class="mb-6 text-gray-800 font-semibold">${q.question}</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">${optionsHtml}</div>
    `;
}

window.handleAnswerChange = (qIndex, answer) => {
    selectedAnswers[qIndex] = answer;
    // CevaplandÄ±ktan sonra navigasyon butonunu gÃ¼ncelle
    document.getElementById(`navBtn_${currentQuestionIndex}`).className = 'w-8 h-8 rounded text-xs font-bold bg-green-400 text-white ring-2 ring-green-300';
    saveProgress();
};

function startTimer() {
    clearInterval(timerInterval);
    const timerDisplay = document.getElementById('quizTimer');
    timerInterval = setInterval(() => {
        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            finishQuiz(true);
            return;
        }
        timeLeft--;
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timerDisplay.textContent = `${minutes < 10 ? '0' : ''}${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
    }, 1000);
}

function setupFocusCheck() {
    window.onblur = () => {
        focusLossCount++;
        const warning = document.getElementById('focusLossWarning');
        warning.textContent = `âš ï¸ DÄ°KKAT: Pencereden ${focusLossCount} kez ayrÄ±ldÄ±nÄ±z!`;
        warning.classList.remove('hidden');
        if (focusLossCount > 5) {
            showCustomAlert("UyarÄ±", "Pencereyi sÄ±k sÄ±k terk etmeniz yasaktÄ±r. SÄ±navÄ±nÄ±z otomatik olarak sonlandÄ±rÄ±labilir.");
        }
    };
    window.onfocus = () => {
        document.getElementById('focusLossWarning')?.classList.add('hidden');
    };
}

function startAutoSave() {
    clearInterval(autoSaveInterval);
    autoSaveInterval = setInterval(saveProgress, 30000); // Her 30 saniyede bir kaydet
}

async function saveProgress() {
    if (!isDbConnected || !currentSessionDocId) return;

    try {
        await updateDoc(doc(db, "active_sessions", currentSessionDocId), {
            answers: selectedAnswers,
            timeLeft: timeLeft,
            currentQuestion: currentQuestionIndex,
            focusLossCount: focusLossCount
        });
    } catch(e) {
        console.error("Otomatik kaydetme hatasÄ±: ", e.message);
    }
}

async function finishQuiz(force = false) {
    clearInterval(timerInterval); clearInterval(autoSaveInterval); window.onblur = null;
    if (!force && !confirm("SÄ±navÄ± bitirmek istediÄŸinize emin misiniz?")) { startTimer(); setupFocusCheck(); return; }

    document.getElementById('mainContentArea').innerHTML = `<div class="text-center py-10 font-bold text-gray-600">SonuÃ§lar iÅŸleniyor...</div>`;
    
    const examCode = studentData.examCode;
    const questionsSnap = await getDoc(getQuestionsRef(examCode));
    const currentQuestions = questionsSnap.exists() ? (questionsSnap.data().questions_list || []) : [];
    
    let c = 0, i = 0, e = 0;
    
    for (let idx = 0; idx < questionOrder.length; idx++) {
        const realQIdx = questionOrder[idx]; 
        const correctQuestion = currentQuestions[realQIdx]; 
        if (!correctQuestion) continue; 
        const studentAnsVal = selectedAnswers[realQIdx]; 
        const studentAns = String(studentAnsVal || '').trim().toLowerCase();
        const correctAns = String(correctQuestion.answer || '').trim().toLowerCase();
        
        if (!studentAnsVal) { 
            e++;
        } else if (studentAns === correctAns) { 
            c++;
        } else { 
            i++;
        }
    }
    
    const score = (c * 100 / currentQuestions.length).toFixed(2);

    let ip = "Bilinmiyor";
    try { const r = await fetch('https://api.ipify.org?format=json'); const d = await r.json(); ip = d.ip; } catch(err){}

    const finalData = {
        ...studentData, 
        studentKey: `${studentData.examCode}_${studentData.number}`,
        teacherId: currentExamConfig.teacherId || null, 
        score, correct: c, incorrect: i, empty: e, 
        timeSpent: currentExamConfig.time_limit - timeLeft, 
        timestamp: serverTimestamp(), focusLossCount, ipAddress: ip, 
        questionOrder, allAnswers: selectedAnswers 
    };

    if(isDbConnected) {
        try {
            await addDoc(collection(db, "quiz_submissions"), finalData);
            if (currentSessionDocId) await deleteDoc(doc(db, "active_sessions", currentSessionDocId));
        } catch(e) { alert("Kaydetme hatasÄ±: " + e.message); }
    }
    showResult(finalData);
}

function showResult(data) {
    document.getElementById('mainContentArea').innerHTML = `
        <div class="text-center py-8">
            <h3 class="text-3xl font-extrabold text-indigo-600 mb-4">SÄ±nav SonuÃ§larÄ±</h3>
            <p class="text-xl font-bold mb-6">${data.name} (${data.className})</p>
            
            <div class="grid grid-cols-2 gap-4 max-w-sm mx-auto mb-8">
                <div class="p-4 bg-green-100 rounded-lg"><p class="text-sm font-semibold text-green-700">DOÄRU</p><p class="text-2xl font-bold text-green-800">${data.correct}</p></div>
                <div class="p-4 bg-red-100 rounded-lg"><p class="text-sm font-semibold text-red-700">YANLIÅ</p><p class="text-2xl font-bold text-red-800">${data.incorrect}</p></div>
                <div class="p-4 bg-gray-100 rounded-lg"><p class="text-sm font-semibold text-gray-700">BOÅ</p><p class="text-2xl font-bold text-gray-800">${data.empty}</p></div>
                <div class="p-4 ${data.score>=50?'bg-indigo-100':'bg-orange-100'} rounded-lg"><p class="text-sm font-semibold text-indigo-700">PUAN</p><p class="text-2xl font-bold ${data.score>=50?'text-indigo-800':'text-orange-800'}">${data.score}</p></div>
            </div>
            
            <p class="text-xs text-gray-500 mb-6">Harcanan SÃ¼re: ${Math.floor(data.timeSpent/60)} dakika | Odak KaybÄ±: ${data.focusLossCount} kez</p>

            <button onclick="location.reload()" class="button bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg shadow-md">Yeni SÄ±nav</button>
        </div>
    `;
}

// --- Ã–ÄRETMEN / YÃ–NETÄ°CÄ° GÄ°RÄ°ÅÄ° ---
function showTeacherLogin() {
    document.getElementById('mainContentArea').innerHTML = `
        <div class="space-y-4">
            <h3 class="text-center font-bold text-2xl mb-4 text-indigo-700">Ã–ÄŸretmen / YÃ¶netici GiriÅŸi</h3>
            <div class="text-center text-xs mb-2 ${isDbConnected ? 'text-green-600':'text-red-600 font-bold'}">
                ${isDbConnected ? 'VeritabanÄ± Aktif' : 'VeritabanÄ± BaÄŸlÄ± DeÄŸil!'}
            </div>

            <input id="userId" type="text" placeholder="KullanÄ±cÄ± AdÄ± (Ã–rn: AHMET)" class="w-full p-3 border rounded uppercase">
            <input id="pass" type="password" placeholder="Åifre" class="w-full p-3 border rounded">
            
            <button id="login" class="button bg-indigo-600 hover:bg-indigo-700 text-white w-full py-3 rounded font-bold">GiriÅŸ Yap</button>
            <button onclick="location.reload()" class="button bg-gray-200 w-full py-2 rounded">Geri</button>
        </div>
    `;
    document.getElementById('login').onclick = handleTeacherLogin;
}

async function handleTeacherLogin() {
    const userId = document.getElementById('userId').value.trim().toUpperCase();
    const pass = document.getElementById('pass').value.trim();

    if (!userId || !pass) {
        return alert("LÃ¼tfen KullanÄ±cÄ± AdÄ± ve Åifreyi girin.");
    }

    // 1. ADIM: MASTER ADMIN KONTROLÃœ
    if (userId === "ADMIN" && pass === adminMasterCode) {
        isTeacherMode = true;
        currentTeacherId = "SUPER_ADMIN";
        currentTeacherName = "SÃ¼per YÃ¶netici";
        showDashboard(); 
        return;
    }

    if (!isDbConnected) {
        return alert("VeritabanÄ± baÄŸlÄ± deÄŸilken Ã¶ÄŸretmen giriÅŸi yapamazsÄ±nÄ±z.");
    }

    // 2. ADIM: NORMAL Ã–ÄRETMEN KONTROLÃœ
    try {
        const teacherSnap = await getDoc(getTeacherRef(userId));
        
        if (teacherSnap.exists()) {
            const data = teacherSnap.data();
            if (data.password === pass) {
                isTeacherMode = true;
                currentTeacherId = userId;
                currentTeacherName = data.name;
                showDashboard(); 
                return;
            }
        }
        
        alert("HatalÄ± KullanÄ±cÄ± AdÄ± veya Åifre.");

    } catch(e) {
        alert("GiriÅŸ iÅŸlemi sÄ±rasÄ±nda hata oluÅŸtu: " + e.message);
    }
}


// --- YÃ–NETÄ°M PANELÄ° (GiriÅŸ yapan Ã¶ÄŸretmene gÃ¶re filtrelenir) ---
function showDashboard() {
    if(!isDbConnected) return alert("VeritabanÄ± baÄŸlÄ± deÄŸilken panele eriÅŸemezsiniz.");
    
    document.getElementById('connectionStatus').classList.add('hidden');
    document.getElementById('app').className = 'app-card teacher-mode';
    document.getElementById('loginHeader').innerHTML = `
        <h1 class="text-2xl font-bold">Panel: ${currentTeacherName} ${currentTeacherId === "SUPER_ADMIN" ? '(SÃ¼per YÃ¶netici)' : ''}</h1>
    `;

    const teacherTab = currentTeacherId === "SUPER_ADMIN" ? 
        `<button onclick="changeTab('teachers')" class="px-4 py-2 bg-purple-600 text-white rounded text-sm">Ã–ÄŸretmen YÃ¶netimi</button>` : '';

    const dashboard = `
        <div class="flex gap-2 mb-4 border-b pb-2 overflow-x-auto">
            <button onclick="changeTab('results')" class="px-4 py-2 bg-indigo-600 text-white rounded text-sm">SonuÃ§lar</button>
            <button onclick="changeTab('settings')" class="px-4 py-2 bg-gray-600 text-white rounded text-sm">SÄ±nav AyarlarÄ±</button>
            <button onclick="changeTab('questions')" class="px-4 py-2 bg-orange-600 text-white rounded text-sm">Soru YÃ¼kleme</button>
            <button onclick="changeTab('lists')" class="px-4 py-2 bg-teal-600 text-white rounded text-sm">Ã–ÄŸrenci Listeleri</button>
            ${teacherTab}
            <button onclick="location.reload()" class="px-4 py-2 bg-red-600 text-white rounded text-sm ml-auto">Ã‡Ä±kÄ±ÅŸ</button>
        </div>
        
        <div id="tab-results" class="tab-content">
            <div id="statsArea" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 text-center"></div>
            <div class="flex flex-wrap gap-2 mb-4 items-center bg-gray-50 p-3 rounded border">
                <input id="fCode" placeholder="SÄ±nav Kodu" class="p-2 border rounded text-sm w-32">
                <input id="fClass" placeholder="SÄ±nÄ±f" class="p-2 border rounded text-sm w-24">
                <input id="fName" placeholder="Ad Soyad" class="p-2 border rounded text-sm w-32">
                <button id="btnExport" class="bg-green-600 text-white px-3 py-2 rounded text-sm shadow">Excel Ä°ndir</button>
                <button id="btnDel" class="bg-red-600 text-white px-3 py-2 rounded text-sm shadow">SeÃ§ilenleri Sil</button>
            </div>
            <div class="overflow-x-auto border rounded max-h-[600px] overflow-y-auto shadow">
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                    <thead class="bg-gray-100 sticky top-0">
                        <tr>
                            <th class="p-3 text-left"><input type="checkbox" id="selectAll"></th>
                            <th class="p-3 text-left font-bold text-gray-600">SÄ±nÄ±f/No</th>
                            <th class="p-3 text-left font-bold text-gray-600">Ad Soyad</th>
                            <th class="p-3 text-left font-bold text-gray-600">Kod</th>
                            <th class="p-3 text-left font-bold text-gray-600">Puan</th>
                            <th class="p-3 text-left font-bold text-gray-600">D/Y/B</th>
                            <th class="p-3 text-left font-bold text-gray-600">SÃ¼re (dk)</th>
                            <th class="p-3 text-left font-bold text-gray-600">AyrÄ±lma (Kez)</th>
                            <th class="p-3 text-left font-bold text-gray-600">IP Adresi</th> <th class="p-3 text-left font-bold text-gray-600">Tarih</th>
                            <th class="p-3 text-left font-bold text-gray-600">Ä°ÅŸlem</th>
                        </tr>
                    </thead>
                    <tbody id="resTable" class="bg-white divide-y"></tbody>
                </table>
            </div>
        </div>

        <div id="tab-settings" class="tab-content hidden">
            <div class="space-y-4 max-w-lg mx-auto bg-gray-50 p-6 rounded border">
                <h3 class="font-bold text-lg mb-4">SÄ±nav AyarlarÄ± OluÅŸtur/DÃ¼zenle</h3>
                <p class="text-sm font-bold text-indigo-700">AyarlarÄ± Kaydeden: ${currentTeacherName}</p>
                <div>
                    <label class="text-xs font-bold text-red-600">SÄ±nav Kodu (ZORUNLU)</label>
                    <input id="manageCode" class="w-full p-2 border rounded uppercase font-bold" placeholder="Ã–rn: 9A_BIYOLOJI">
                    <button id="loadSettingsBtn" class="mt-1 w-full bg-gray-200 text-gray-800 py-2 rounded text-sm">AyarlarÄ± YÃ¼kle</button>
                </div>
                <hr>
                <div><label class="text-xs font-bold">SÄ±navÄ±n UygulayÄ±cÄ±sÄ± (Bu SÄ±nava Ã–zel)</label><input id="setTeacher" class="w-full p-2 border rounded"></div>
                <div><label class="text-xs font-bold">SÃ¼re (Dakika)</label><input id="setTime" type="number" class="w-full p-2 border rounded"></div>
                <div><label class="text-xs font-bold">AÃ§Ä±klama</label><textarea id="setDesc" rows="3" class="w-full p-2 border rounded"></textarea></div>
                <button id="saveSettingsBtn" class="w-full bg-indigo-600 text-white py-3 rounded font-bold shadow">KAYDET / OLUÅTUR</button>
                
                ${currentTeacherId === "SUPER_ADMIN" ? `
                    <hr>
                    <h3 class="font-bold text-lg text-red-600">YÃ¶netici AyarlarÄ± (Sadece Super Admin)</h3>
                    <p class="text-xs text-gray-600">Mevcut YÃ¶netici Åifresi: <span class="font-bold text-red-700">${adminMasterCode}</span></p>
                    
                    <div><label class="text-xs font-bold">Yeni YÃ¶netici Åifresi</label><input id="newAdminPass" type="password" class="w-full p-2 border rounded" placeholder="Yeni ÅŸifrenizi girin"></div>
                    <button id="saveAdminPassBtn" class="w-full bg-red-600 text-white py-3 rounded font-bold shadow mb-4">YÃ–NETÄ°CÄ° ÅÄ°FRESÄ°NÄ° DEÄÄ°ÅTÄ°R</button>

                    <div><label class="text-xs font-bold text-indigo-600">Sistemin Ana HazÄ±rlayÄ±cÄ±sÄ±/Kurucusu</label><input id="systemPrepName" class="w-full p-2 border rounded" placeholder="GiriÅŸ ekranÄ±nda gÃ¶rÃ¼necek ad (Ã–rn: Ahmet Ã–ÄŸretmen)"></div>
                    <button id="saveSystemPrepBtn" class="w-full bg-indigo-600 text-white py-3 rounded font-bold shadow">HAZIRLAYICI ADINI GÃœNCELLE</button>
                ` : ''}
            </div>
        </div>

        <div id="tab-questions" class="tab-content hidden">
            <div class="space-y-4 max-w-2xl mx-auto">
                <div class="bg-yellow-100 p-3 rounded border border-yellow-300 text-sm">
                    <label class="font-bold text-red-700">Soru YÃ¼klenecek SÄ±nav Kodu</label>
                    <input id="questionCode" class="w-full p-2 border rounded uppercase font-bold mt-1" placeholder="Ã–rn: 9A_BIYOLOJI">
                </div>
                <textarea id="jsonInput" rows="15" class="w-full p-3 font-mono text-xs border rounded bg-gray-800 text-green-400" placeholder="SorularÄ± buraya yapÄ±ÅŸtÄ±rÄ±n..."></textarea>
                <div class="flex gap-2">
                    <button id="loadSampleBtn" class="bg-gray-500 text-white px-4 py-2 rounded">Ã–rnek Format</button>
                    <button id="uploadQuestionsBtn" class="bg-orange-600 text-white px-4 py-2 rounded font-bold flex-grow shadow">SORULARI YÃœKLE (KODU KONTROL ET!)</button>
                </div>
            </div>
        </div>

        <div id="tab-lists" class="tab-content hidden">
            <div class="space-y-4 max-w-2xl mx-auto">
                <h3 class="font-bold text-lg text-teal-700 mb-2">Ã–ÄŸrenci Listesi YÃ¼kleme</h3>
                <div class="bg-indigo-100 p-3 rounded border border-indigo-300 text-sm">
                    <label class="font-bold text-indigo-700">Liste YÃ¼klenecek SÄ±nav Kodu</label>
                    <input id="listCode" class="w-full p-2 border rounded uppercase font-bold mt-1" placeholder="Ã–rn: 9A_BIYOLOJI">
                </div>
                <textarea id="listInput" rows="15" class="w-full p-3 font-mono text-xs border rounded bg-gray-50 text-gray-800" placeholder="Excel'den kopyalayÄ±p yapÄ±ÅŸtÄ±rÄ±n..."></textarea>
                <div class="p-3 bg-yellow-50 rounded border border-yellow-300 text-sm text-yellow-800 font-semibold">
                    <p class="mb-1">âš ï¸ **Ã–NEMLÄ° FORMAT UYARISI**</p>
                    <p>LÃ¼tfen Excel'den kopyaladÄ±ÄŸÄ±nÄ±z sÃ¼tunlarÄ±n sÄ±rasÄ±na DÄ°KKAT EDÄ°N:</p>
                    <p>1. SÃ¼tun: **Okul No**</p>
                    <p>2. SÃ¼tun: **SÄ±nÄ±f**</p>
                    <p>3. SÃ¼tun: **Ad Soyad**</p>
                    <p class="mt-2">Verileri yapÄ±ÅŸtÄ±rdÄ±ktan sonra kontrol edin. Her satÄ±rda bu Ã¼Ã§ bilgi olmalÄ±dÄ±r.</p>
                </div>
                <button id="uploadListBtn" class="bg-teal-600 text-white px-4 py-2 rounded font-bold flex-grow shadow w-full">Ã–ÄRENCÄ° LÄ°STESÄ°NÄ° KAYDET / GÃœNCELLE</button>
                <p class="text-sm text-red-600 text-center font-semibold">UYARI: Yeni liste yÃ¼klemek, ilgili kodun eski listesini tamamen silecektir!</p>
            </div>
        </div>

        ${currentTeacherId === "SUPER_ADMIN" ? `
        <div id="tab-teachers" class="tab-content hidden">
            <div class="space-y-4 max-w-lg mx-auto p-6 bg-purple-50 rounded border border-purple-200">
                <h3 class="font-bold text-lg text-purple-700">Ã–ÄŸretmen HesabÄ± YÃ¶netimi</h3>
                <p class="text-sm text-gray-600">Yeni Ã¶ÄŸretmen ekleyebilir veya mevcut Ã¶ÄŸretmenlerin ÅŸifresini deÄŸiÅŸtirebilirsiniz.</p>
                <div><label class="text-xs font-bold text-purple-600">KullanÄ±cÄ± AdÄ± (Benzersiz ID)</label><input id="newTeacherId" class="w-full p-2 border rounded uppercase font-bold" placeholder="Ã–rn: ALI_HOCA"></div>
                <div><label class="text-xs font-bold">Ad Soyad</label><input id="newTeacherName" class="w-full p-2 border rounded" placeholder="Ã–rn: Ali Kaya"></div>
                <div><label class="text-xs font-bold">Åifre</label><input id="newTeacherPass" type="password" class="w-full p-2 border rounded" placeholder="Åifre"></div>
                <button id="saveTeacherBtn" class="w-full bg-purple-600 text-white py-3 rounded font-bold shadow">Ã–ÄRETMEN HESABI OLUÅTUR / GÃœNCELLE</button>
                <hr>
                <div class="overflow-y-auto max-h-48 border rounded">
                    <table id="teacherListTable" class="min-w-full text-xs">
                        <thead class="bg-purple-100 sticky top-0"><tr><th class="p-2 text-left">ID</th><th class="p-2 text-left">Ad Soyad</th><th class="p-2">Sil</th></tr></thead>
                        <tbody id="teacherListBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        ` : ''}
    `;
    document.getElementById('mainContentArea').innerHTML = dashboard;
    
    window.changeTab = (t) => { document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden')); document.getElementById('tab-'+t).classList.remove('hidden'); };
    
    if (currentTeacherId === "SUPER_ADMIN") {
        setupTeacherManagement();
    }


    // --- SINAV AYARLARI Ä°ÅLEVLERÄ° (teacherId Entegrasyonu) ---
    document.getElementById('loadSettingsBtn').onclick = async () => {
        const code = document.getElementById('manageCode').value.toUpperCase();
        if (!code) return alert("LÃ¼tfen SÄ±nav Kodu girin.");
        
        const q = query(collection(db, "exam_settings"), 
                        where("exam_code", "==", code),
                        ...(currentTeacherId !== "SUPER_ADMIN" ? [where("teacherId", "==", currentTeacherId)] : [])
                    );
        try {
            const snap = await getDocs(q);
            if (!snap.empty) {
                const data = snap.docs[0].data();
                document.getElementById('setTeacher').value = data.teacher_name;
                document.getElementById('setTime').value = Math.floor(data.time_limit/60);
                document.getElementById('setDesc').value = data.exam_description;
                alert(`'${code}' ayarlarÄ± yÃ¼klendi. (Ã–ÄŸretmen: ${data.teacher_name})`);
            } else {
                document.getElementById('setTeacher').value = currentTeacherName;
                document.getElementById('setTime').value = 60;
                document.getElementById('setDesc').value = "Yeni sÄ±nav ayarlarÄ±";
                alert(`'${code}' ayarlarÄ± bulunamadÄ±. Yeni oluÅŸturulacak.`);
            }
        } catch(e) { alert("YÃ¼kleme HatasÄ±: " + e.message); }
    };

    document.getElementById('saveSettingsBtn').onclick = async () => {
        const code = document.getElementById('manageCode').value.toUpperCase();
        if (!code) return alert("LÃ¼tfen SÄ±nav Kodu girin.");

        try {
            await setDoc(getConfigRef(code), {
                exam_code: code,
                teacherId: currentTeacherId,
                teacher_name: document.getElementById('setTeacher').value || currentTeacherName || "", 
                time_limit: parseInt(document.getElementById('setTime').value)*60 || 3600,
                exam_description: document.getElementById('setDesc').value || "AÃ§Ä±klama yok"
            }, {merge: true});
            alert(`SÄ±nav Kodu '${code}' baÅŸarÄ±yla kaydedildi!`);
        } catch(e) { alert("Kaydetme HatasÄ±: " + e.message); }
    };
    
    if (currentTeacherId === "SUPER_ADMIN") {
        document.getElementById('saveAdminPassBtn').onclick = async () => {
             const newPass = document.getElementById('newAdminPass').value;
             if (!newPass || newPass.length < 4) return alert("Åifre en az 4 karakter olmalÄ±dÄ±r.");
             if(confirm(`YÃ¶netici Paneli Åifresi "${newPass}" olarak deÄŸiÅŸtirilecektir. Emin misiniz?`)) {
                 try {
                     await setDoc(doc(db, "exam_settings", "admin_config"), { master_code: newPass }, {merge: true});
                     adminMasterCode = newPass; 
                     alert("Yeni ÅŸifre kaydedildi! LÃ¼tfen sayfayÄ± yenileyin.");
                     document.getElementById('newAdminPass').value = '';
                 } catch(e) { alert("YÃ¶netici Åifresini kaydederken hata: " + e.message); }
             }
        };

        document.getElementById('systemPrepName').value = systemPreparerName;
        document.getElementById('saveSystemPrepBtn').onclick = async () => {
            const newPrepName = document.getElementById('systemPrepName').value.trim();
            if (!newPrepName) return alert("HazÄ±rlayÄ±cÄ± adÄ± boÅŸ bÄ±rakÄ±lamaz.");
            if(confirm(`Sistemin Ana HazÄ±rlayÄ±cÄ± adÄ± "${newPrepName}" olarak deÄŸiÅŸtirilecektir. Emin misiniz?`)) {
                try {
                    await setDoc(doc(db, "exam_settings", "admin_config"), { preparer_name: newPrepName }, {merge: true});
                    systemPreparerName = newPrepName;
                    alert("HazÄ±rlayÄ±cÄ± adÄ± kaydedildi! DeÄŸiÅŸikliÄŸin giriÅŸ ekranÄ±na yansÄ±masÄ± iÃ§in sayfayÄ± yenileyin.");
                } catch(e) { alert("HazÄ±rlayÄ±cÄ± adÄ±nÄ± kaydederken hata: " + e.message); }
            }
        };
    }


    // --- SORULAR SEKEMESÄ° Ä°ÅLEVÄ° (teacherId Entegrasyonu) ---
    document.getElementById('loadSampleBtn').onclick = () => {
        document.getElementById('jsonInput').value = `[
{ "question": "Soru 1?", "options": ["A","B","C","D"], "answer": "A" },
{ "question": "Soru 2?", "image": "https://link.com/img.jpg", "options": ["X","Y"], "answer": "X" }
]`;
    };

    document.getElementById('uploadQuestionsBtn').onclick = async () => {
        const code = document.getElementById('questionCode').value.toUpperCase();
        if (!code) return alert("LÃ¼tfen Soru YÃ¼klenecek SÄ±nav Kodunu girin.");
        
        try {
            const parsed = JSON.parse(document.getElementById('jsonInput').value);
            if(!Array.isArray(parsed)) throw new Error("Liste [...] formatÄ±nda olmalÄ±");
            
            if(confirm(`SÄ±nav Kodu '${code}' iÃ§in ${parsed.length} soru YÃœKLENSÄ°N MÄ°? (Eski sorular silinecektir!)`)) {
                await setDoc(getQuestionsRef(code), { questions_list: parsed, teacherId: currentTeacherId });
                alert(`SÄ±nav Kodu '${code}' iÃ§in ${parsed.length} soru baÅŸarÄ±yla yÃ¼klendi!`);
            }
        } catch(e) { alert("Format HatasÄ±: " + e.message); }
    };

    // --- Ã–ÄRENCÄ° LÄ°STESÄ° SEKEMESÄ° Ä°ÅLEVÄ° (teacherId Entegrasyonu) ---
    document.getElementById('uploadListBtn').onclick = async () => {
        const code = document.getElementById('listCode').value.toUpperCase();
        const listText = document.getElementById('listInput').value.trim();
        if (!code) return alert("LÃ¼tfen Liste YÃ¼klenecek SÄ±nav Kodunu girin.");
        if (!listText) return alert("LÃ¼tfen yapÄ±ÅŸtÄ±rÄ±lacak Ã¶ÄŸrenci listesini girin.");

        const students = [];
        const lines = listText.split('\n').filter(line => line.trim() !== '');
        let errorCount = 0;
        for (const line of lines) {
            const parts = line.trim().split('\t').map(p => p.trim());
            if (parts.length >= 3) {
                const number = parts[0];
                const className = parts[1];
                const name = parts.slice(2).join(' ').trim();
                if (number && className && name) {
                    students.push({ number: String(number), className: String(className).toUpperCase(), name: String(name) });
                } else { errorCount++; }
            } else { errorCount++; }
        }
        if (students.length === 0) return alert(`Hata: Girilen veriden geÃ§erli Ã¶ÄŸrenci bilgisi Ã§Ä±karÄ±lamadÄ±. Kontrol edin. (BaÅŸarÄ±sÄ±z: ${errorCount} satÄ±r)`);

        if(confirm(`SÄ±nav Kodu '${code}' iÃ§in ${students.length} Ã¶ÄŸrenci kaydedilecektir. Emin misiniz?`)) {
            try {
                await setDoc(doc(db, "student_lists", code), { 
                    students: students, 
                    count: students.length, 
                    teacherId: currentTeacherId,
                    lastUpdated: serverTimestamp() 
                });
                alert(`SÄ±nav Kodu '${code}' iÃ§in ${students.length} Ã¶ÄŸrenci baÅŸarÄ±yla kaydedildi! (HatalÄ±/Eksik satÄ±r: ${errorCount})`);
                document.getElementById('listInput').value = ''; 
            } catch(e) { alert("Kaydetme HatasÄ±: " + e.message); }
        }
    };
    
    setupResultsTable();
}


// --- YENÄ° FONKSÄ°YON: Ã–ÄRETMEN YÃ–NETÄ°MÄ° (Sadece Super Admin) ---
function setupTeacherManagement() {
    
    const renderTeachers = () => {
        onSnapshot(collection(db, "teachers"), (snap) => {
            const tbody = document.getElementById('teacherListBody');
            if (!tbody) return;

            const teachers = snap.docs.map(d => ({id:d.id, ...d.data()}));
            tbody.innerHTML = teachers.map(t => `
                <tr class="hover:bg-gray-100">
                    <td class="p-2 font-mono">${t.teacherId}</td>
                    <td class="p-2">${t.name}</td>
                    <td class="p-2"><button onclick="deleteTeacher('${t.teacherId}')" class="text-red-600 hover:text-red-800">Sil</button></td>
                </tr>
            `).join('');
        });
    };
    
    document.getElementById('saveTeacherBtn').onclick = async () => {
        const id = document.getElementById('newTeacherId').value.trim().toUpperCase();
        const name = document.getElementById('newTeacherName').value.trim();
        const pass = document.getElementById('newTeacherPass').value.trim();

        if (!id || !name || !pass) return alert("TÃ¼m alanlarÄ± doldurun.");
        if (id === "ADMIN") return alert("ADMIN ID'si kullanÄ±lamaz.");

        if(confirm(`Ã–ÄŸretmen HesabÄ± '${id}' (${name}) kaydedilsin/gÃ¼ncellensin mi?`)) {
            try {
                await setDoc(getTeacherRef(id), {
                    teacherId: id,
                    name: name,
                    password: pass 
                });
                alert(`Ã–ÄŸretmen hesabÄ± '${id}' baÅŸarÄ±yla kaydedildi!`);
                document.getElementById('newTeacherId').value = '';
                document.getElementById('newTeacherName').value = '';
                document.getElementById('newTeacherPass').value = '';
            } catch(e) { alert("Kaydetme HatasÄ±: " + e.message); }
        }
    };

    window.deleteTeacher = async (id) => { 
        if(confirm(`'${id}' ID'li Ã¶ÄŸretmen hesabÄ± silinecektir. Emin misiniz?`)) {
            try {
                await deleteDoc(getTeacherRef(id));
                alert(`'${id}' hesabÄ± silindi.`);
            } catch(e) { alert("Silme HatasÄ±: " + e.message); }
        }
    };

    renderTeachers();
}


// --- SONUÃ‡ TABLOSU (teacherId'ye GÃ¶re Filtreleme ve IP Adresi Ekleme) ---
function setupResultsTable() {
    const tbody = document.getElementById('resTable');
    const statsArea = document.getElementById('statsArea');

    const render = () => {
        const fCode = (document.getElementById('fCode')?.value||'').toLowerCase();
        const fClass = (document.getElementById('fClass')?.value||'').toLowerCase();
        const fName = (document.getElementById('fName')?.value||'').toLowerCase();
        
        const filtered = allSubmissions.filter(s => 
            (s.examCode||'').toLowerCase().includes(fCode) && 
            (s.className||'').toLowerCase().includes(fClass) &&
            (s.name||'').toLowerCase().includes(fName)
        );

        // Ä°statistikler KÄ±smÄ± (AynÄ± KaldÄ±)
        if (statsArea) {
            const total = filtered.length;
            const avgScore = total > 0 ? (filtered.reduce((sum, s) => sum + parseFloat(s.score || 0), 0) / total).toFixed(2) : '0.00';
            const avgLoss = total > 0 ? (filtered.reduce((sum, s) => sum + (s.focusLossCount || 0), 0) / total).toFixed(1) : '0.0';
            const avgTime = total > 0 ? Math.floor(filtered.reduce((sum, s) => sum + (s.timeSpent || 0), 0) / total / 60) : '0';

            statsArea.innerHTML = `
                <div class="bg-white p-3 rounded-lg shadow-md border-b-4 border-indigo-500"><p class="text-xs text-gray-500">Toplam GiriÅŸ</p><p class="text-xl font-bold">${total}</p></div>
                <div class="bg-white p-3 rounded-lg shadow-md border-b-4 border-green-500"><p class="text-xs text-gray-500">Ortalama Puan</p><p class="text-xl font-bold">${avgScore}</p></div>
                <div class="bg-white p-3 rounded-lg shadow-md border-b-4 border-red-500"><p class="text-xs text-gray-500">Ort. Odak KaybÄ±</p><p class="text-xl font-bold">${avgLoss}</p></div>
                <div class="bg-white p-3 rounded-lg shadow-md border-b-4 border-gray-500"><p class="text-xs text-gray-500">Ort. SÃ¼re (dk)</p><p class="text-xl font-bold">${avgTime}</p></div>
            `;
        }


        tbody.innerHTML = filtered.map(s => {
            const date = s.timestamp ? new Date(s.timestamp.seconds*1000).toLocaleString('tr-TR') : '-';
            const mins = Math.floor((s.timeSpent||0)/60); 

            return `
                <tr class="hover:bg-gray-50">
                    <td class="p-3"><input type="checkbox" class="selRow" value="${s.id}"></td>
                    <td class="p-3">${s.className} / ${s.number}</td>
                    <td class="p-3 font-medium">${s.name}</td>
                    <td class="p-3 font-bold text-indigo-600">${s.examCode}</td>
                    <td class="p-3 font-bold ${parseFloat(s.score)>=50?'text-green-600':'text-red-600'}">${s.score}</td>
                    <td class="p-3 text-xs">${s.correct}D / ${s.incorrect}Y / ${s.empty}B</td>
                    <td class="p-3 text-xs text-gray-500">${mins} dk</td> 
                    <td class="p-3 text-xs font-bold ${s.focusLossCount>0 ? 'text-red-600 bg-red-50 rounded-md p-1' : 'text-green-600'}">${s.focusLossCount || 0}</td>
                    <td class="p-3 text-xs font-mono bg-gray-50 rounded">${s.ipAddress || '-'}</td> <td class="p-3 text-xs text-gray-500">${date}</td>
                    <td class="p-3 flex gap-2">
                        <button onclick="showDetails('${s.id}')" class="text-green-600 text-xs hover:underline font-bold">Cevap DetayÄ±</button> 
                        <button onclick="showGraph('${s.number}','${s.name}')" class="text-blue-600 text-xs hover:underline font-bold">Grafik</button>
                        <button onclick="delSub('${s.id}')" class="text-red-600 text-xs hover:underline">Sil</button>
                    </td>
                </tr>
            `;
        }).join('');
    };

    let submissionQuery;
    if (currentTeacherId === "SUPER_ADMIN") {
        submissionQuery = query(collection(db, "quiz_submissions"));
    } else {
        submissionQuery = query(collection(db, "quiz_submissions"), where("teacherId", "==", currentTeacherId));
    }

    onSnapshot(submissionQuery, (snap) => {
        allSubmissions = snap.docs.map(d => ({id:d.id, ...d.data()})).sort((a,b) => (b.timestamp?.seconds||0)-(a.timestamp?.seconds||0));
        render();
    });

    document.getElementById('fCode').oninput = render;
    document.getElementById('fClass').oninput = render;
    document.getElementById('fName').oninput = render;
    
    document.getElementById('selectAll').onclick = (e) => document.querySelectorAll('.selRow').forEach(c => c.checked = e.target.checked);
    document.getElementById('btnDel').onclick = async () => {
        const ids = Array.from(document.querySelectorAll('.selRow:checked')).map(c=>c.value);
        if(ids.length && confirm(`${ids.length} kayÄ±t silinsin mi?`)) ids.forEach(id => deleteDoc(doc(db, "quiz_submissions", id)));
    };
    
    // Export Fonksiyonu (Eksiksiz TÃ¼m AlanlarÄ± Ä°Ã§erir)
    document.getElementById('btnExport').onclick = () => {
        const fCode = (document.getElementById('fCode')?.value||'').toLowerCase();
        const fClass = (document.getElementById('fClass')?.value||'').toLowerCase();
        const fName = (document.getElementById('fName')?.value||'').toLowerCase();
        const filtered = allSubmissions.filter(s => (s.examCode||'').toLowerCase().includes(fCode) && (s.className||'').toLowerCase().includes(fClass) && (s.name||'').toLowerCase().includes(fName));
        
        let csv = "\uFEFFSinif,No,Ad Soyad,Kod,Puan,Dogru,Yanlis,Bos,Sure(dk),Ayrilma(Kez),IP,Tarih,OgretmenID\n";
        filtered.forEach(s => {
            csv += `${s.className},${s.number},"${s.name}",${s.examCode},${s.score},${s.correct},${s.incorrect},${s.empty},${Math.floor((s.timeSpent||0)/60)},${s.focusLossCount},${s.ipAddress},"${new Date(s.timestamp?.seconds*1000).toLocaleString()}",${s.teacherId||'-'}\n`;
        });
        const link = document.createElement("a");
        link.href = encodeURI("data:text/csv;charset=utf-8," + csv);
        link.download = "sonuclar_detayli.csv";
        link.click();
    };

    window.delSub = async (id) => { 
        if(confirm("Silinsin mi?")) {
            await deleteDoc(doc(db, "quiz_submissions", id)); 
        }
    };
    
    window.showDetails = async (id) => {
        const snap = await getDoc(getSubmissionRef(id));
        if (!snap.exists()) return showCustomAlert("Hata", "SonuÃ§ bulunamadÄ±.");
        const sub = snap.data();
        
        const qSnap = await getDoc(getQuestionsRef(sub.examCode));
        const questions = qSnap.exists() ? (qSnap.data().questions_list || []) : [];
        
        let detailHtml = `<h4 class="text-lg font-bold mb-4 text-indigo-700">${sub.name} - Cevap DetayÄ± (${sub.examCode})</h4>`;
        detailHtml += `<div class="space-y-3 max-h-[70vh] overflow-y-auto pr-3">`;
        
        for (let i = 0; i < sub.questionOrder.length; i++) {
            const realQIdx = sub.questionOrder[i];
            const studentAnswer = sub.allAnswers[realQIdx];
            const correctQuestion = questions[realQIdx];
            const correctAnswer = correctQuestion ? String(correctQuestion.answer) : '-';
            
            let status = 'BOÅ';
            let color = 'bg-gray-100';
            if (studentAnswer) {
                if (String(studentAnswer).toLowerCase() === String(correctAnswer).toLowerCase()) {
                    status = 'DOÄRU';
                    color = 'bg-green-100';
                } else {
                    status = 'YANLIÅ';
                    color = 'bg-red-100';
                }
            }

            detailHtml += `
                <div class="p-3 rounded-lg border ${color}">
                    <p class="font-bold text-sm mb-1">Soru ${i + 1} (${status})</p>
                    <p class="text-xs">Ã–ÄŸrenci CevabÄ±: <span class="font-bold text-indigo-700">${studentAnswer || '-'}</span></p>
                    <p class="text-xs">DoÄŸru Cevap: <span class="font-bold text-green-700">${correctAnswer}</span></p>
                </div>
            `;
        }

        detailHtml += `</div><button onclick="document.getElementById('customModal').classList.add('hidden')" class="mt-4 bg-gray-200 px-4 py-2 rounded">Kapat</button>`;
        showCustomAlert('Cevap DetayÄ±', detailHtml, true);
    };

    window.showGraph = async (num, name) => {
        const hSnap = await getDocs(query(collection(db, "quiz_submissions"), where("number", "==", String(num))));
        const history = hSnap.docs.map(d => d.data()).sort((a,b) => (a.timestamp?.seconds||0)-(b.timestamp?.seconds||0));
        
        const modal = document.getElementById('customModal');
        document.getElementById('modalContent').innerHTML = `
            <h3 class="text-lg font-bold mb-4">${name} - GeliÅŸim GrafiÄŸi</h3>
            <canvas id="modalChart"></canvas>
            <button onclick="document.getElementById('customModal').classList.add('hidden')" class="mt-4 bg-gray-200 px-4 py-2 rounded">Kapat</button>
        `;
        modal.classList.remove('hidden');
        new Chart(document.getElementById('modalChart'), {
            type: 'line',
            data: { labels: history.map(h => h.examCode), datasets: [{ label: 'Puan', data: history.map(h => h.score), borderColor: '#4f46e5', tension: 0.1 }] }
        });
    };
}

initializeFirebase();
    </script>
</body>
</html>



