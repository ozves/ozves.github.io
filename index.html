<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    
    <!-- G√ú√áLENDƒ∞Rƒ∞LMƒ∞≈û CACHE √ñNLEME -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0, pre-check=0, post-check=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="-1">
    <meta name="cache-control" content="no-cache">
    <meta name="expires" content="0">
    <meta name="pragma" content="no-cache">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√ñƒürenci Sƒ±nav Uygulamasƒ± (Geli≈ümi≈ü) - v1.0</title>
    
    <!-- Version eklenmi≈ü CDN -->
    <script src="https://cdn.tailwindcss.com?v=3.4.0"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Cache bypass script -->
    <script>
        // Sayfa geri butonuyla gelirse zorla yenile
        window.addEventListener('pageshow', function(event) {
            if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
                window.location.reload(true);
            }
        });
        
        // Konsola version bilgisi yazdƒ±r (g√ºncelleme kontrol√º i√ßin)
        console.log('üîÑ Sƒ±nav Sistemi Version: 1.0 - Son G√ºncelleme:', new Date().toLocaleString('tr-TR'));
    </script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0;}
        .app-card { background-color:white;padding:2.5rem;border-radius:1.5rem;box-shadow:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05);max-width:450px;width:90%;transition:all .3s;position:relative;}
        .header-bg { background: linear-gradient(135deg,#4f46e5 0%,#818cf8 100%); color:white;padding:1rem 0;border-radius:1rem 1rem 0 0;margin:-2.5rem -2.5rem 1.5rem -2.5rem;text-align:center;}
        .button{transition:all .2s;box-shadow:0 4px 6px rgba(0,0,0,0.1)}
        .button:hover{transform:translateY(-1px);box-shadow:0 6px 10px rgba(0,0,0,0.15)}
        @media (max-width:640px){ .app-card{padding:1.5rem;border-radius:1rem} .header-bg{margin:-1.5rem -1.5rem 1rem -1.5rem;padding:.75rem 0} }
        
        /* Version g√∂stergesi */
        .version-badge {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(79, 70, 229, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 10px;
            z-index: 9999;
        }
    </style>
</head>
<body>
    <!-- Version g√∂stergesi (geli≈ütirme i√ßin - canlƒ±da kaldƒ±rabilirsiniz) -->
    <div class="version-badge">v1.0 - <span id="buildTime"></span></div>
    <script>
        document.getElementById('buildTime').textContent = new Date().toLocaleTimeString('tr-TR');
    </script>

    <div id="app" class="app-card">
        <div id="loginHeader" class="header-bg">
            <h1 class="text-2xl font-extrabold">√ñƒürenci Giri≈üi</h1>
        </div>
        <div id="mainContentArea">
            <div id="loadingIndicator" class="text-center py-10">
                <svg class="animate-spin h-5 w-5 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="text-sm text-gray-500 mt-2">Sistem Ba≈ülatƒ±lƒ±yor...</p>
                <p id="systemStatus" class="text-xs text-gray-400 mt-4"></p>
            </div>
        </div>
    </div>

    <div id="customModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center p-4 z-50">
        <div id="modalContent" class="bg-white rounded-xl p-8 max-w-sm w-full text-center shadow-2xl transform transition-all scale-100"></div>
    </div>

    <script type="module">
        // Mod√ºl version kontrol√º
        console.log('üì¶ JavaScript Mod√ºl√º Y√ºklendi:', new Date().toISOString());
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, serverTimestamp, query, where, getDocs, deleteDoc, getDoc, addDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        const TEACHER_CODE = 'OGRETMEN34';
        const EXAM_CODE = '33344';
        const TEACHER_NAME = '√ñzt√ºrk sevin√ß (biyoloji √ñƒüretmeni)';
        const TIME_LIMIT_SECONDS = 600;

        const firebaseConfig = {
            apiKey: "AIzaSyCHhFAHbWnclad6yFuI-Pw9gX6F_Dx1B2c",
            authDomain: "online-sinav-b3644.firebaseapp.com",
            projectId: "online-sinav-b3644",
            storageBucket: "online-sinav-b3644.firebasestorage.app",
            messagingSenderId: "965507531268",
            appId: "1:965507531268:web:94cfd13774a40b6cf16b51"
        };

        const quizQuestions = [        
  {
    "question": "Canlƒ±larƒ± benzerlik, farklƒ±lƒ±k ve akrabalƒ±k derecelerine g√∂re gruplara ayƒ±rma ilke ve √∂l√ß√ºtlerini belirleyen bilim dalƒ±na ne ad verilir?",
    "options": ["Morfoloji", "Histoloji", "Biyokimya", "Taksonomi", "Fizyoloji"],
    "answer": "Taksonomi"
  },
  {
    "question": "A≈üaƒüƒ±dakilerden hangisi, ortak √∂zelliklere, genetik mirasa sahip olan ve birbirleriyle √ßiftle≈üip **verimli d√∂l verebilen** canlƒ±lar grubu olarak tanƒ±mlanan sƒ±nƒ±flandƒ±rmadaki temel kategoridir?",
    "options": ["Cins", "Aile", "≈ûube", "√Çlem", "T√ºr"],
    "answer": "T√ºr"
  },
  {
    "question": "G√ºn√ºm√ºzde canlƒ±larƒ±n akrabalƒ±k ili≈ükilerine g√∂re yapƒ±lan, morfolojik, anatomik ve genetik gibi bir√ßok √∂zelliƒüin dikkate alƒ±ndƒ±ƒüƒ± sƒ±nƒ±flandƒ±rma sistemi ne olarak adlandƒ±rƒ±lƒ±r?",
    "options": ["Yapƒ±sal Sƒ±nƒ±flandƒ±rma", "Yapay Sƒ±nƒ±flandƒ±rma", "Sistematik Sƒ±nƒ±flandƒ±rma", "Doƒüal (Filogenetik) Sƒ±nƒ±flandƒ±rma", "Ekolojik Sƒ±nƒ±flandƒ±rma"],
    "answer": "Doƒüal (Filogenetik) Sƒ±nƒ±flandƒ±rma"
  },
  {
    "question": "T√ºrlerin isimlendirilmesinde kullanƒ±lan ikili (binominal) adlandƒ±rma y√∂ntemini √∂neren ƒ∞sve√ßli doƒüa bilimci a≈üaƒüƒ±dakilerden hangisidir?",
    "options": ["Aristoteles", "Galileo Galilei", "Carl Linneaus", "Charles Darwin", "Gregor Mendel"],
    "answer": "Carl Linneaus"
  },
  {
    "question": "Metinde verilen 'Fritillaria imperialis' t√ºr adƒ±nda, 'imperialis' kelimesi hangi g√∂revi ifade eder?",
    "options": ["Cins Adƒ±", "Aile Adƒ±", "Tamamlayƒ±cƒ± Ad", "Takƒ±m Adƒ±", "T√ºr Adƒ±"],
    "answer": "Tamamlayƒ±cƒ± Ad"
  },
  {
    "question": "ƒ∞kili adlandƒ±rma y√∂ntemine g√∂re, bir t√ºr adƒ±nƒ±n birinci kelimesi (Cins adƒ±) ile ilgili doƒüru kural a≈üaƒüƒ±dakilerden hangisidir?",
    "options": ["Tamamen b√ºy√ºk harflerle yazƒ±lƒ±r.", "ƒ∞lk harfi k√º√ß√ºk yazƒ±lƒ±r.", "Akrabalƒ±k derecesini ifade eder.", "ƒ∞lk harfi b√ºy√ºk yazƒ±lƒ±r.", "Tek ba≈üƒ±na t√ºr√º ifade eder."],
    "answer": "ƒ∞lk harfi b√ºy√ºk yazƒ±lƒ±r"
  },
  {
    "question": "Sƒ±nƒ±flandƒ±rma bilimi, mikroorganizmalarƒ±n doƒüru tanƒ±mlanmasƒ± ve tehlike altƒ±ndaki t√ºrlerin korunmasƒ± gibi konulara katkƒ± saƒülayarak hangi iki alandaki ara≈ütƒ±rmalarƒ±n temelini olu≈üturur?",
    "options": ["Ekonomi ve Hukuk", "Eƒüitim ve K√ºlt√ºr", "Saƒülƒ±k ve √áevre Koruma", "Ula≈üƒ±m ve ƒ∞leti≈üim", "Sanayi ve Tarƒ±m"],
    "answer": "Saƒülƒ±k ve √áevre Koruma"
  },
  {
    "question": "Metinde bahsedilen taksonomik hiyerar≈üi sƒ±ralamasƒ±na g√∂re, birbirine yakƒ±n t√ºrlerin bir araya gelmesiyle olu≈üan kategoriden ba≈ülayarak doƒüru sƒ±ralama (k√º√ß√ºkten b√ºy√ºƒüe) hangi se√ßenekte verilmi≈ütir?",
    "options": ["T√ºr, Cins, Aile, Takƒ±m, Sƒ±nƒ±f, ≈ûube, √Çlem", "Cins, Aile, Takƒ±m, Sƒ±nƒ±f, ≈ûube, √Çlem", "Cins, Sƒ±nƒ±f, Aile, Takƒ±m, ≈ûube, √Çlem", "Cins, Aile, Sƒ±nƒ±f, Takƒ±m, ≈ûube, √Çlem", "√Çlem, ≈ûube, Sƒ±nƒ±f, Takƒ±m, Aile, Cins"],
    "answer": "Cins, Aile, Takƒ±m, Sƒ±nƒ±f, ≈ûube, √Çlem"
  },
  {
    "question": "Doƒüal (filogenetik) sƒ±nƒ±flandƒ±rmada canlƒ±lar arasƒ±ndaki akrabalƒ±k ili≈ükilerinin molek√ºler d√ºzeyde belirlenmesine en √∂nemli katkƒ±yƒ± saƒülayan inceleme y√∂ntemi a≈üaƒüƒ±dakilerden hangisidir?",
    "options": ["Morfolojik yapƒ±larƒ±n kar≈üƒ±la≈ütƒ±rƒ±lmasƒ±", "Ya≈üadƒ±klarƒ± habitatlarƒ±n incelenmesi", "Fiziksel √∂zelliklerin √∂l√ß√ºlmesi", "Beslenme alƒ±≈ükanlƒ±klarƒ±nƒ±n g√∂zlemlenmesi", "DNA ve RNA dizilerinin incelenmesi"],
    "answer": "DNA ve RNA dizilerinin incelenmesi"
  },
  {
    "question": "A≈üaƒüƒ±dakilerden hangisi, taksonomi biliminin canlƒ±larƒ± tanƒ±mlama √ßalƒ±≈ümalarƒ±nda yararlandƒ±ƒüƒ± biyolojinin alt dallarƒ± arasƒ±nda **sayƒ±lmamƒ±≈ütƒ±r**?",
    "options": ["Morfoloji", "Anatomi", "Histoloji", "Biyokimya", "Ekoloji"],
    "answer": "Ekoloji"
  }
        ];

        let selectedAnswers = Array(quizQuestions.length).fill(null);
        let questionOrder = Array.from({length: quizQuestions.length}, (_, i) => i);
        let currentQuestionIndex = 0;
        let timerInterval = null;
        let timeLeft = TIME_LIMIT_SECONDS;
        let isTeacherMode = false;
        let studentData = {};
        let focusLossCount = 0;
        let autoSaveInterval = null;
        let currentSessionDocId = null;

        function seededShuffle(array, seed) {
            let hash = 0;
            for (let i = 0; i < seed.length; i++) {
                hash = ((hash << 5) - hash) + seed.charCodeAt(i);
                hash |= 0;
            }
            const shuffled = [...array];
            let n = shuffled.length;
            while (n > 1) {
                hash = (hash * 9301 + 49297) % 233280;
                let random = hash / 233280.0;
                let k = Math.floor(random * n);
                n--;
                [shuffled[n], shuffled[k]] = [shuffled[k], shuffled[n]];
            }
            return shuffled;
        }

        async function initializeFirebase() {
            try {
                if (!firebaseConfig || !firebaseConfig.apiKey) {
                    document.getElementById('systemStatus').textContent = 'Hata: Firebase yapƒ±landƒ±rmasƒ± eksik.';
                    return;
                }
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                document.getElementById('systemStatus').textContent = 'Oturum a√ßƒ±lƒ±yor...';
                await signInAnonymously(auth);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        document.getElementById('loadingIndicator')?.classList.add('hidden');
                        document.getElementById('systemStatus').textContent = `Kullanƒ±cƒ± ID: ${userId}`;
                        showLoginForm();
                    } else {
                        userId = null;
                        isAuthReady = true;
                        document.getElementById('loadingIndicator')?.classList.add('hidden');
                        document.getElementById('systemStatus').textContent = 'Oturum A√ßƒ±lamadƒ± (Anonim)';
                        showLoginForm();
                    }
                });
            } catch (error) {
                console.error("Firebase ba≈ülatƒ±lƒ±rken hata olu≈ütu:", error);
                document.getElementById('mainContentArea').innerHTML = `
                    <p class="text-red-600 text-center text-lg font-bold">Sistem Hatasƒ±: Baƒülantƒ± Kurulamadƒ±</p>
                    <p class="text-sm text-red-500 text-center mt-2">Detay: ${error.message}</p>
                `;
            }
        }

        function showLoginForm() {
            if (!isAuthReady) return;
            document.getElementById('app').classList.remove('max-w-3xl', 'max-w-4xl');
            document.getElementById('app').classList.add('max-w-md');
            document.getElementById('loginHeader').innerHTML = '<h1 class="text-2xl font-extrabold">√ñƒürenci Giri≈üi</h1>';
            const timeInMinutes = Math.floor(TIME_LIMIT_SECONDS / 60);

            const content = `
                <div class="space-y-4">
                    <div class="text-center p-2 bg-indigo-50 rounded-lg shadow-sm">
                        <p class="text-xs text-gray-500">Sƒ±navƒ± Hazƒ±rlayan:</p>
                        <p class="font-bold text-indigo-700">${TEACHER_NAME}</p>
                    </div>
                    <div class="p-3 bg-red-100 border border-red-300 rounded-lg text-red-700 font-medium text-sm text-center shadow-inner">
                        <p class="font-bold">√ñNEMLƒ∞ UYARI:</p>
                        <p>Sƒ±nav s√ºreniz tam olarak <span class="text-red-900">${timeInMinutes} dakika</span>'dƒ±r. S√ºre dolduƒüunda sƒ±navƒ±nƒ±z otomatik olarak sonlandƒ±rƒ±lƒ±r.</p>
                    </div>
                    <input id="examCodeInput" type="text" placeholder="Sƒ±nav Kodu (√ñrn: ${EXAM_CODE})" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm uppercase" required>
                    <input id="nameInput" type="text" placeholder="Adƒ±nƒ±z Soyadƒ±nƒ±z" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm" required>
                    <input id="numberInput" type="number" placeholder="Okul Numaranƒ±z" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm" required>
                    <input id="classInput" type="text" placeholder="Sƒ±nƒ±fƒ±nƒ±z (√ñrn: 10A)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm" required>
                    <button id="startQuizButton" class="button w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-lg shadow-md">Sƒ±nava Ba≈üla</button>
                    <button id="teacherLoginButton" class="button w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 rounded-lg text-sm shadow-sm">√ñƒüretmen Giri≈üi</button>
                </div>
            `;
            document.getElementById('mainContentArea').innerHTML = content;
            document.getElementById('startQuizButton').addEventListener('click', handleStudentLogin);
            document.getElementById('teacherLoginButton').addEventListener('click', showTeacherLogin);
        }

        async function handleStudentLogin() {
            const name = document.getElementById('nameInput').value.trim();
            const number = document.getElementById('numberInput').value.trim();
            const className = document.getElementById('classInput').value.trim();
            const examCode = document.getElementById('examCodeInput').value.trim().toUpperCase();

            if (!name || !number || !className || !examCode) {
                showCustomAlert("Eksik Bilgi", "L√ºtfen t√ºm alanlarƒ± doldurun.");
                return;
            }

            if (examCode !== EXAM_CODE) {
                showCustomAlert("Hatalƒ± Sƒ±nav Kodu", `Girdiƒüiniz sƒ±nav kodu ("${examCode}") ge√ßersizdir. L√ºtfen doƒüru kodu giriniz.`);
                return;
            }

            studentData = { name, number, className, examCode };
            isTeacherMode = false;

            const studentKey = `${examCode}_${number}`;
            
            console.log("√ñƒürenci kontrol√º ba≈ülatƒ±lƒ±yor:", studentKey);
            
            const completedExam = await checkCompletedExam(studentKey);
            if (completedExam) {
                console.log("Tamamlanmƒ±≈ü sƒ±nav bulundu:", completedExam);
                await showCustomAlert("Sƒ±nav Tamamlandƒ±", 
                    `Bu sƒ±navƒ± daha √∂nce tamamladƒ±nƒ±z!\n\nPuanƒ±nƒ±z: ${completedExam.score}\nTarih: ${completedExam.timestamp}`);
                return;
            }

            console.log("Devam eden oturum kontrol ediliyor...");
            const existingSession = await checkExistingSession(studentKey);
            
            if (existingSession) {
                console.log("Devam eden oturum bulundu:", existingSession);
                const shouldResume = await showCustomConfirmation(
                    `Daha √∂nce bu sƒ±nava ba≈ülamƒ±≈üsƒ±nƒ±z.\n\nKalan s√ºre: ${Math.floor(existingSession.timeLeft / 60)} dk ${existingSession.timeLeft % 60} sn\nTamamlanan soru: ${existingSession.currentQuestionIndex + 1}/${quizQuestions.length}\n\nKaldƒ±ƒüƒ±nƒ±z yerden devam etmek ister misiniz?`
                );
                
                if (shouldResume) {
                    console.log("Kullanƒ±cƒ± devam etmeyi se√ßti, oturum y√ºkleniyor...");
                    studentData = { 
                        name: existingSession.name || name, 
                        number: existingSession.number || number, 
                        className: existingSession.className || className, 
                        examCode: existingSession.examCode || examCode 
                    };
                    questionOrder = existingSession.questionOrder || [];
                    selectedAnswers = existingSession.selectedAnswers || Array(quizQuestions.length).fill(null);
                    currentQuestionIndex = existingSession.currentQuestionIndex || 0;
                    timeLeft = existingSession.timeLeft || TIME_LIMIT_SECONDS;
                    focusLossCount = existingSession.focusLossCount || 0;
                    currentSessionDocId = existingSession.id;
                    
                    console.log("Oturum bilgileri:", {
                        questionOrder,
                        selectedAnswers,
                        currentQuestionIndex,
                        timeLeft,
                        focusLossCount
                    });
                    
                    showQuiz();
                    return;
                } else {
                    console.log("Kullanƒ±cƒ± yeniden ba≈ülamayƒ± se√ßti, eski oturum siliniyor...");
                    try {
                        await deleteDoc(doc(db, "active_sessions", existingSession.id));
                        console.log("Eski oturum silindi");
                    } catch (error) {
                        console.error("Eski oturum silinirken hata:", error);
                    }
                }
            } else {
                console.log("Devam eden oturum bulunamadƒ±, yeni oturum ba≈ülatƒ±lƒ±yor");
            }

            questionOrder = seededShuffle(Array.from({length: quizQuestions.length}, (_, i) => i), number);
            selectedAnswers = Array(quizQuestions.length).fill(null);
            currentQuestionIndex = 0;
            focusLossCount = 0;
            timeLeft = TIME_LIMIT_SECONDS;
            currentSessionDocId = null;

            console.log("Yeni oturum ba≈ülatƒ±lƒ±yor");
            showQuiz();
        }

        async function checkCompletedExam(studentKey) {
            if (!db) return null;
            
            const q = query(
                collection(db, "quiz_submissions"),
                where("studentKey", "==", studentKey)
            );
            
            try {
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    const docData = querySnapshot.docs[0].data();
                    const timestamp = docData.timestamp?.toDate ? 
                        docData.timestamp.toDate().toLocaleString('tr-TR') : 'Bilinmiyor';
                    return {
                        score: docData.score,
                        timestamp: timestamp
                    };
                }
                return null;
            } catch (error) {
                console.error("Tamamlanmƒ±≈ü sƒ±nav kontrol√º hatasƒ±:", error);
                return null;
            }
        }

        async function checkExistingSession(studentKey) {
            if (!db) return null;
            
            const q = query(
                collection(db, "active_sessions"),
                where("studentKey", "==", studentKey)
            );
            
            try {
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    const doc = querySnapshot.docs[0];
                    return { id: doc.id, ...doc.data() };
                }
                return null;
            } catch (error) {
                console.error("Oturum kontrol√º hatasƒ±:", error);
                return null;
            }
        }

        function showTeacherLogin() {
            document.getElementById('loginHeader').innerHTML = '<h1 class="text-2xl font-extrabold">√ñƒüretmen Giri≈üi</h1>';
            const content = `
                <div class="space-y-4">
                    <p class="text-sm text-gray-600 text-center">Canlƒ± sonu√ß paneline eri≈ümek i√ßin √∂ƒüretmen kodunu girin.</p>
                    <input id="teacherCodeInput" type="password" placeholder="√ñƒüretmen Kodu" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition duration-150 shadow-sm" required>
                    <button id="teacherLoginButtonExecute" class="button w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 rounded-lg shadow-md">Giri≈ü Yap</button>
                    <button id="backToStudentLogin" class="button w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 rounded-lg text-sm shadow-sm">√ñƒürenci Giri≈üine D√∂n</button>
                </div>
            `;
            document.getElementById('mainContentArea').innerHTML = content;
            document.getElementById('teacherLoginButtonExecute').addEventListener('click', handleTeacherLogin);
            document.getElementById('backToStudentLogin').addEventListener('click', showLoginForm);
        }

        function handleTeacherLogin() {
            const code = document.getElementById('teacherCodeInput').value.trim();
            if (code === TEACHER_CODE) {
                isTeacherMode = true;
                showTeacherPanel();
            } else {
                showCustomAlert("Hata", "Girdiƒüiniz √∂ƒüretmen kodu yanlƒ±≈ü.");
            }
        }

        function showQuiz() {
            document.getElementById('app').classList.remove('max-w-md');
            document.getElementById('app').classList.add('max-w-3xl');
            document.getElementById('loginHeader').innerHTML = `<h1 class="text-2xl font-extrabold">${studentData.name} - Sƒ±nav (${studentData.examCode})</h1>`;

            const quizHtml = `
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 border-b pb-3 space-y-2 sm:space-y-0">
                    <p class="text-base text-gray-600">${studentData.className} / ${studentData.number}</p>
                    <p class="text-sm font-medium text-indigo-600">Soru: <span id="questionCounter">1/${quizQuestions.length}</span></p>
                    <div id="timerDisplay" class="text-xl font-bold text-red-600 bg-red-100 p-2 rounded-lg shadow-md">10:00</div>
                </div>
                <div id="questionsContainer" class="space-y-8 min-h-[250px] flex flex-col justify-between"></div>
                <div id="focusWarning" class="hidden mt-4 p-2 bg-yellow-100 border border-yellow-400 text-yellow-800 rounded-lg text-sm font-medium text-center">
                    UYARI: Sayfadan ayrƒ±ldƒ±nƒ±z. L√ºtfen sƒ±nava geri d√∂n√ºn! (Kayƒ±p: ${focusLossCount})
                </div>
                <div id="autoSaveIndicator" class="mt-2 p-2 bg-green-50 border border-green-300 text-green-700 rounded-lg text-xs text-center">
                    ‚úì Otomatik kaydetme aktif - ƒ∞lerlemeniz g√ºvende
                </div>
                <div class="mt-8 pt-4 border-t flex justify-between">
                    <button id="prevButton" class="button bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md disabled:opacity-50" disabled>√ñnceki</button>
                    <button id="nextButton" class="button bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-xl">Sonraki</button>
                </div>
            `;
            document.getElementById('mainContentArea').innerHTML = quizHtml;

            renderQuestion(currentQuestionIndex);
            startTimer();
            setupFocusCheck();
            startAutoSave();

            document.getElementById('prevButton').addEventListener('click', handlePrevQuestion);
            document.getElementById('nextButton').addEventListener('click', handleNextQuestion);
        }

        async function startAutoSave() {
            await saveProgress();
            autoSaveInterval = setInterval(async () => {
                await saveProgress();
            }, 10000);
        }

        async function saveProgress() {
            if (!db || isTeacherMode) return;

            const studentKey = `${studentData.examCode}_${studentData.number}`;
            const progressData = {
                ...studentData,
                studentKey: studentKey,
                questionOrder,
                selectedAnswers,
                currentQuestionIndex,
                timeLeft,
                focusLossCount,
                isCompleted: false,
                lastUpdated: serverTimestamp()
            };

            try {
                if (currentSessionDocId) {
                    await updateDoc(doc(db, "active_sessions", currentSessionDocId), progressData);
                } else {
                    const docRef = await addDoc(collection(db, "active_sessions"), progressData);
                    currentSessionDocId = docRef.id;
                }
                
                const indicator = document.getElementById('autoSaveIndicator');
                if (indicator) {
                    indicator.classList.add('bg-green-200');
                    setTimeout(() => {
                        indicator.classList.remove('bg-green-200');
                    }, 300);
                }
            } catch (error) {
                console.error("ƒ∞lerleme kaydedilemedi:", error);
            }
        }

        function setupFocusCheck() {
            const warningElement = document.getElementById('focusWarning');
            let hasWarned = false;
            const handleBlur = () => {
                if (!isTeacherMode) {
                    focusLossCount++;
                    if (focusLossCount > 0) {
                        warningElement.classList.remove('hidden');
                        warningElement.innerHTML = `UYARI: Sayfadan ${focusLossCount} kez ayrƒ±ldƒ±nƒ±z. L√ºtfen sƒ±nava geri d√∂n√ºn!`;
                    }
                    if (focusLossCount >= 5 && !hasWarned) {
                        showCustomAlert("G√ºvenlik Uyarƒ±sƒ±", "√áok fazla odak kaybƒ± tespit edildi. L√ºtfen sƒ±nava odaklanƒ±n. (Sonu√ßlarƒ±nƒ±za kaydedilecektir!)");
                        hasWarned = true;
                    }
                    saveProgress();
                }
            };
            const handleFocus = () => { warningElement.classList.add('hidden'); };
            window.addEventListener('blur', handleBlur);
            window.addEventListener('focus', handleFocus);
            document.getElementById('app').addEventListener('quiz-ended', () => {
                window.removeEventListener('blur', handleBlur);
                window.removeEventListener('focus', handleFocus);
            });
        }

        function renderQuestion(quizIndex) {
            const container = document.getElementById('questionsContainer');
            if (!container) return;
            const originalIndex = questionOrder[quizIndex];
            const q = quizQuestions[originalIndex];
            const shuffledOptions = seededShuffle(q.options, studentData.number + 'options' + originalIndex);
            const currentAnswer = selectedAnswers[originalIndex];

            const questionHtml = `
                <div class="question-card p-6 border-4 border-indigo-200 rounded-xl bg-white shadow-xl flex-grow">
                    <div class="text-2xl font-bold text-indigo-700 mb-4">Soru ${quizIndex + 1}:</div>
                    <p class="font-semibold text-gray-800 text-lg mb-6">${q.question}</p>
                    <div class="options-container space-y-3" data-original-index="${originalIndex}">
                        ${shuffledOptions.map((option, oIndex) => {
                            const isChecked = currentAnswer === option;
                            return `
                                <label class="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-indigo-50 transition duration-150 ${isChecked ? 'bg-indigo-100 border-indigo-500 shadow-md' : 'bg-white'}">
                                    <input type="radio" name="q_current" value="${option}" class="text-indigo-600 focus:ring-indigo-500 h-5 w-5" ${isChecked ? 'checked' : ''}>
                                    <span class="text-gray-700 font-medium">${option}</span>
                                </label>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            container.innerHTML = questionHtml;
            document.getElementById('questionCounter').textContent = `${quizIndex + 1}/${quizQuestions.length}`;
            container.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.addEventListener('change', async (e) => {
                    selectedAnswers[originalIndex] = e.target.value;
                    container.querySelectorAll('label').forEach(label => {
                        label.classList.remove('bg-indigo-100', 'border-indigo-500', 'shadow-md');
                        label.classList.add('bg-white', 'border-gray-200');
                    });
                    e.target.closest('label').classList.add('bg-indigo-100', 'border-indigo-500', 'shadow-md');
                    e.target.closest('label').classList.remove('bg-white', 'border-gray-200');
                    await saveProgress();
                });
            });
            updateNavigationButtons(quizIndex);
        }

        function updateNavigationButtons(quizIndex) {
            const prevButton = document.getElementById('prevButton');
            const nextButton = document.getElementById('nextButton');
            prevButton.disabled = quizIndex === 0;
            if (quizIndex === quizQuestions.length - 1) {
                nextButton.textContent = "Sƒ±navƒ± Bitir ve G√∂nder";
                nextButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                nextButton.classList.add('bg-green-600', 'hover:bg-green-700');
            } else {
                nextButton.textContent = "Sonraki";
                nextButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                nextButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            }
        }

        async function handleNextQuestion() {
            if (currentQuestionIndex < quizQuestions.length - 1) {
                currentQuestionIndex++;
                renderQuestion(currentQuestionIndex);
                await saveProgress();
            } else {
                finishQuiz(false);
            }
        }
        
        async function handlePrevQuestion() { 
            if (currentQuestionIndex > 0) { 
                currentQuestionIndex--; 
                renderQuestion(currentQuestionIndex);
                await saveProgress();
            } 
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            const timerDisplay = document.getElementById('timerDisplay');
            timerInterval = setInterval(() => {
                timeLeft--;
                if (timeLeft < 0) {
                    clearInterval(timerInterval);
                    timeLeft = 0;
                    finishQuiz(true);
                }
                updateTimerDisplay(timerDisplay);
            }, 1000);
            updateTimerDisplay(timerDisplay);
        }

        function updateTimerDisplay(displayElement) {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const timeString = `${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
            displayElement.textContent = timeString;
            if (timeLeft <= 60) {
                displayElement.classList.remove('text-red-600','bg-red-100','text-yellow-700','bg-yellow-100');
                displayElement.classList.add('text-white','bg-red-700');
            } else if (timeLeft <= 180) {
                displayElement.classList.remove('text-white','bg-red-700','text-red-600','bg-red-100');
                displayElement.classList.add('text-yellow-700','bg-yellow-100');
            } else {
                displayElement.classList.remove('text-yellow-700','bg-yellow-100','text-white','bg-red-700');
                displayElement.classList.add('text-red-600','bg-red-100');
            }
        }

        async function finishQuiz(isTimeUp = false) {
            clearInterval(timerInterval);
            if (autoSaveInterval) clearInterval(autoSaveInterval);
            document.getElementById('app').dispatchEvent(new Event('quiz-ended'));
            
            const confirmationMessage = isTimeUp ? 'S√ºre doldu! Sonu√ßlarƒ±nƒ±z otomatik olarak g√∂nderiliyor.' : 'Sƒ±navƒ± bitirmek istediƒüinizden emin misiniz? Cevapsƒ±z sorularƒ±nƒ±z kalmƒ±≈ü olabilir.';
            const confirmed = isTimeUp ? true : await showCustomConfirmation(confirmationMessage);
            
            if (confirmed) {
                const results = calculateScore();
                await saveSubmission(results);
                
                if (currentSessionDocId) {
                    try {
                        await deleteDoc(doc(db, "active_sessions", currentSessionDocId));
                    } catch (error) {
                        console.error("Oturum temizleme hatasƒ±:", error);
                    }
                }
                
                await showResultScreen(results, isTimeUp);
            } else {
                if (!isTimeUp) startTimer();
                updateNavigationButtons(currentQuestionIndex);
            }
        }

        function calculateScore() {
            let correctCount = 0, incorrectCount = 0, emptyCount = 0;
            quizQuestions.forEach((q, originalIndex) => {
                const answer = selectedAnswers[originalIndex];
                if (answer === null) emptyCount++;
                else if (answer === q.answer) correctCount++;
                else incorrectCount++;
            });
            return { correct: correctCount, incorrect: incorrectCount, empty: emptyCount, total: quizQuestions.length, score: correctCount * 100 / quizQuestions.length };
        }

        async function saveSubmission(results) {
            if (!db || isTeacherMode) {
                console.error("Veritabanƒ± hazƒ±r deƒüil veya √∂ƒüretmen modu.");
                return;
            }

            const timeSpent = TIME_LIMIT_SECONDS - timeLeft;
            const studentKey = `${studentData.examCode}_${studentData.number}`;
            
            const submissionData = {
                ...studentData,
                studentKey: studentKey,
                score: results.score.toFixed(2),
                correct: results.correct,
                incorrect: results.incorrect,
                empty: results.empty,
                timeSpent: timeSpent,
                timestamp: serverTimestamp(),
                focusLossCount: focusLossCount,
                questionOrder: questionOrder,
                allAnswers: selectedAnswers
            };

            try {
                await addDoc(collection(db, "quiz_submissions"), submissionData);
                console.log("Sonu√ß ba≈üarƒ±yla kaydedildi.");
            } catch (e) {
                console.error("Sonu√ß kaydedilirken hata olu≈ütu: ", e);
                await showCustomAlert("Hata!", "Sonu√ßlar kaydedilemedi. Konsolu kontrol edin.");
            }
        }

        async function getRankingData(examCode) {
            if (!db) return [];
            const collectionRef = collection(db, 'quiz_submissions');
            const q = query(collectionRef, where('examCode', '==', examCode));
            try {
                const querySnapshot = await getDocs(q);
                return querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), score: parseFloat(doc.data().score) || 0, timeSpent: doc.data().timeSpent || 0 }));
            } catch (error) {
                console.error("Sƒ±ralama verisi √ßekilirken hata olu≈ütu:", error);
                return [];
            }
        }

        async function showResultScreen(results, isTimeUp) {
            document.getElementById('app').classList.remove('max-w-3xl','max-w-4xl');
            document.getElementById('app').classList.add('max-w-md');
            document.getElementById('loginHeader').innerHTML = '<h1 class="text-2xl font-extrabold">Sƒ±nav Sonucu</h1>';
            const timeSpent = TIME_LIMIT_SECONDS - timeLeft;
            const timeSpentMinutes = Math.floor(timeSpent / 60);
            const timeSpentSeconds = timeSpent % 60;
            const rankingData = await getRankingData(studentData.examCode);
            const rankedList = rankingData.sort((a,b)=>{ const sc = parseFloat(b.score)-parseFloat(a.score); if (sc!==0) return sc; return a.timeSpent - b.timeSpent; });
            const totalStudents = rankedList.length;
            const studentKey = `${studentData.examCode}_${studentData.number}`;
            const studentRank = rankedList.findIndex(sub => sub.studentKey === studentKey) + 1;
            const top5 = rankedList.slice(0,5);
            const top5Html = top5.map((s,index) => `
                <li class="flex justify-between p-2 rounded-lg text-gray-700 ${index < 3 ? 'bg-yellow-200/50 font-bold border-l-4 border-yellow-500' : 'bg-gray-100'} ${s.studentKey === studentKey ? 'bg-indigo-200/70 border-l-4 border-indigo-600' : ''}">
                    <span class="text-sm">${index + 1}. ${s.name} (${s.className})</span>
                    <span class="text-sm font-semibold ${parseFloat(s.score) >= 50 ? 'text-green-700' : 'text-red-700'}">${parseFloat(s.score).toFixed(2)} Puan</span>
                </li>
            `).join('');

            const resultHtml = `
                <div class="text-center py-6">
                    <h2 class="text-3xl font-bold ${results.score >= 50 ? 'text-green-600' : 'text-red-600'} mb-2">Sƒ±nav Bitti!</h2>
                    ${isTimeUp ? '<p class="text-red-500 font-semibold mb-4">S√ºreniz Dolduƒüu ƒ∞√ßin Otomatik G√∂nderildi.</p>' : ''}
                    <p class="text-lg text-gray-700 mb-6">${studentData.name}, sonu√ßlarƒ±nƒ±z kaydedildi.</p>
                    <div class="grid grid-cols-2 gap-4 text-left max-w-sm mx-auto p-4 bg-gray-50 rounded-xl shadow-inner mb-6">
                        <div class="font-semibold text-gray-600">Puanƒ±nƒ±z:</div>
                        <div class="font-bold text-2xl ${results.score >= 50 ? 'text-green-600' : 'text-red-600'}">${results.score.toFixed(2)} / 100</div>
                        <div class="font-semibold text-gray-600">Doƒüru/Yanlƒ±≈ü/Bo≈ü:</div>
                        <div class="font-bold text-lg text-gray-800">${results.correct}D / ${results.incorrect}Y / ${results.empty}B</div>
                        <div class="font-semibold text-gray-600">Harcanan S√ºre:</div>
                        <div class="font-bold text-lg text-indigo-600">${timeSpentMinutes} dk ${String(timeSpentSeconds).padStart(2,'0')} sn</div>
                    </div>
                    <div class="bg-indigo-50 p-4 rounded-xl shadow-lg mb-6 max-w-sm mx-auto border-t-4 border-indigo-500">
                        <h3 class="text-xl font-bold text-indigo-800 mb-3">Sƒ±nav ƒ∞statistikleri (${studentData.examCode})</h3>
                        <p class="text-md font-semibold text-gray-700 mb-2">Toplam Katƒ±lƒ±mcƒ±: <span class="text-indigo-600 font-extrabold">${totalStudents}</span> √∂ƒürenci</p>
                        <div class="p-3 bg-indigo-500 rounded-lg text-white my-3">
                            <p class="text-sm">Bu sƒ±navdaki sƒ±ralamanƒ±z:</p>
                            <p class="text-3xl font-extrabold">#${studentRank}</p>
                        </div>
                        <div class="mt-4">
                            <h4 class="font-bold text-gray-700 mb-2 text-left">En ƒ∞yi 5 Derece:</h4>
                            <ul class="space-y-1 text-left">${top5Html}</ul>
                        </div>
                    </div>
                    ${focusLossCount > 0 ? `<div class="mt-6 p-3 bg-red-100 border border-red-400 rounded-lg text-red-800 text-sm font-semibold max-w-sm mx-auto">‚ö†Ô∏è Sayfadan Ayrƒ±lma Sayƒ±sƒ± (Kopya √ñnleme Kaydƒ±): ${focusLossCount}</div>` : ''}
                </div>
                <div class="mt-8 text-center"><button id="returnToLogin" class="button bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md">Ana Ekrana D√∂n</button></div>
            `;
            document.getElementById('mainContentArea').innerHTML = resultHtml;
            document.getElementById('returnToLogin').addEventListener('click', showLoginForm);
        }

let currentSubmissions = [];

function showTeacherPanel() {
    document.getElementById('app').classList.remove('max-w-md');
    document.getElementById('app').classList.add('max-w-4xl');
    document.getElementById('loginHeader').innerHTML = '<h1 class="text-2xl font-extrabold">√ñƒüretmen Sonu√ß Paneli (Canlƒ±)</h1>';

    const teacherHtml = `
        <p class="text-sm text-gray-600 text-center mb-4">Yeni sonu√ßlar sayfayƒ± yenilemeden anƒ±nda g√∂r√ºn√ºr (Firebase onSnapshot).</p>
        <div class="flex justify-start items-center mb-4 gap-2 flex-wrap">
            <input type="text" id="filterExamCode" placeholder="Sƒ±nav Kodu ile filtrele" class="border border-gray-300 rounded-lg px-3 py-1 text-sm" />
            <input type="text" id="filterStudentNumber" placeholder="√ñƒürenci No ile filtrele" class="border border-gray-300 rounded-lg px-3 py-1 text-sm" />
        </div>
        <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
            <button id="downloadCsvButton" class="button bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg text-sm shadow-md">T√ºm Sonu√ßlarƒ± Excel (CSV) ƒ∞ndir</button>
            <button id="teacherLogout" class="button bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg text-sm shadow-md">√áƒ±kƒ±≈ü Yap</button>
        </div>
        <div class="overflow-x-auto bg-white rounded-lg shadow-lg border border-in
    </script>
</body>
</html>
