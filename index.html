<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SÄ±nav Sistemi V13 (Ã‡oklu Ã–ÄŸretmen - GÃ¼venli)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0;}
        .app-card { background-color:white;padding:2.5rem;border-radius:1.5rem;box-shadow:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05);max-width:450px;width:90%;transition:all .3s;position:relative;}
        .header-bg { background: linear-gradient(135deg,#4f46e5 0%,#818cf8 100%); color:white;padding:1rem 0;border-radius:1rem 1rem 0 0;margin:-2.5rem -2.5rem 1.5rem -2.5rem;text-align:center;}
        .button{transition:all .2s;box-shadow:0 4px 6px rgba(0,0,0,0.1)}
        .button:hover{transform:translateY(-1px);box-shadow:0 6px 10px rgba(0,0,0,0.15)}
        .teacher-mode { max-width: 1400px !important; width: 98% !important; } 
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body>

    <div id="app" class="app-card">
        <div id="loginHeader" class="header-bg">
            <h1 class="text-2xl font-extrabold">Ã–ÄŸrenci GiriÅŸi</h1>
        </div>
        
        <div id="connectionStatus" class="hidden mb-4 text-xs font-bold text-center p-2 rounded border"></div>
        
        <div id="mainContentArea">
            <div id="loadingIndicator" class="text-center py-10">
                <svg class="animate-spin h-8 w-8 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p id="loadingText" class="text-sm text-gray-500 mt-4 font-bold">Sistem BaÅŸlatÄ±lÄ±yor...</p>
            </div>
        </div>
    </div>

    <div id="customModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center p-4 z-50">
        <div id="modalContent" class="bg-white rounded-xl p-6 max-w-3xl w-full text-center shadow-2xl overflow-y-auto max-h-[90vh]"></div>
    </div>

    <script type="module">
       import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, collection, onSnapshot, serverTimestamp, query, where, getDocs, deleteDoc, getDoc, addDoc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyCHhFAHbWnclad6yFuI-Pw9gX6F_Dx1B2c",
    authDomain: "online-sinav-b3644.firebaseapp.com",
    projectId: "online-sinav-b3644",
    storageBucket: "online-sinav-b3644.firebasestorage.app",
    messagingSenderId: "965507531268",
    appId: "1:965507531268:web:94cfd13774a40b6cf16b51"
};

let db, auth;
let isAuthReady = false, isDbConnected = false;

let adminMasterCode = ""; // SABÄ°T ÅÄ°FRE YOK - Firebase'den gelecek
let systemPreparerName = "Sistem YÃ¶neticisi";
let currentUser = null;

let currentExamConfig = {
    exam_code: "DEFAULT",
    teacher_name: "Sistem YÃ¶neticisi",
    time_limit: 600,
    exam_description: "VarsayÄ±lan sÄ±nav. LÃ¼tfen yeni bir sÄ±nav kodu oluÅŸturun."
};
let quizQuestions = [];

let selectedAnswers = [], questionOrder = [], currentQuestionIndex = 0, resumeStartIndex = 0;
let timerInterval = null, timeLeft = 0, isTeacherMode = false, studentData = {};
let focusLossCount = 0, autoSaveInterval = null, currentSessionDocId = null;
let allSubmissions = [];
let studentList = [];

// Firebase Referans FonksiyonlarÄ±
const getConfigRef = (code) => doc(db, "exam_settings", code.toUpperCase());
const getQuestionsRef = (code) => doc(db, "questions_pool", code.toUpperCase());
const getSubmissionRef = (id) => doc(db, "quiz_submissions", id);

function seededShuffle(array, seed) {
    let hash = 0;
    for (let i = 0; i < seed.length; i++) { hash = ((hash << 5) - hash) + seed.charCodeAt(i); hash |= 0; }
    const shuffled = [...array];
    let n = shuffled.length;
    while (n > 1) {
        hash = (hash * 9301 + 49297) % 233280;
        if (hash < 0) hash += 233280;
        let random = hash / 233280.0;
        let k = Math.floor(random * n);
        n--;
        [shuffled[n], shuffled[k]] = [shuffled[k], shuffled[n]];
    }
    return shuffled;
}

// --- MODAL FONKSÄ°YONLARI ---
function showCustomAlert(title, message, isHtml = false) {
    return new Promise(resolve => {
        const modal = document.getElementById('customModal');
        const modalContent = document.getElementById('modalContent');
        
        let contentHtml = `
            <h3 class="text-xl font-semibold text-gray-800 mb-4">${title}</h3>
        `;
        if (isHtml) {
            contentHtml += `<div class="text-gray-600 mb-6 text-left">${message}</div>`;
        } else {
            contentHtml += `<p class="text-gray-600 mb-6 whitespace-pre-line">${message}</p>`;
        }
        contentHtml += `
            <button id="modalClose" class="button bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md">Tamam</button>
        `;

        modalContent.innerHTML = contentHtml;
        modal.classList.remove('hidden'); modal.classList.add('flex');
        document.getElementById('modalClose').onclick = () => { modal.classList.add('hidden'); modal.classList.remove('flex'); resolve(); };
    });
}

// --- BAÅLATMA ---
async function initializeFirebase() {
    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        await signInAnonymously(auth);
        onAuthStateChanged(auth, async (user) => {
            if (user) { isAuthReady = true; await checkConnectivity(); }
        });
    } catch (error) { alert("Kritik BaÅŸlatma HatasÄ±: " + error.message); }
}

async function checkConnectivity() {
    const statusDiv = document.getElementById('connectionStatus');
    try {
        const adminSnap = await getDoc(doc(db, "exam_settings", "admin_config"));
        if (adminSnap.exists()) {
            const data = adminSnap.data();
            adminMasterCode = data.master_code; // Sadece Firebase'den al
            systemPreparerName = data.preparer_name || "Sistem YÃ¶neticisi";
        } else {
            // Ä°lk kurulum - ÅŸifre yok
            systemPreparerName = "Sistem YÃ¶neticisi";
        }

        isDbConnected = true;
        statusDiv.innerHTML = "ğŸŸ¢ VeritabanÄ± BaÄŸlÄ± (CanlÄ± Mod)";
        statusDiv.className = "mb-4 text-xs font-bold text-center p-2 rounded border bg-green-100 text-green-800 border-green-300";
    } catch(e) {
        isDbConnected = false;
        statusDiv.innerHTML = `ğŸ”´ BAÄLANTI YOK - Ã‡evrimdÄ±ÅŸÄ± Mod`;
        statusDiv.className = "mb-4 text-xs font-bold text-center p-2 rounded border bg-red-100 text-red-800 border-red-300";
    }
    statusDiv.classList.remove('hidden');
    document.getElementById('loadingIndicator').classList.add('hidden');
    showRoleSelection();
}

// --- ROL SEÃ‡Ä°M EKRANI ---
function showRoleSelection() {
    document.getElementById('app').className = 'app-card max-w-md';
    document.getElementById('loginHeader').innerHTML = '<h1 class="text-2xl font-extrabold">HoÅŸ Geldiniz</h1>';
    
    document.getElementById('mainContentArea').innerHTML = `
        <div class="space-y-4">
            <div class="text-center p-4 bg-indigo-50 rounded-lg border border-indigo-100">
                <p class="text-sm text-gray-500">Sistem YÃ¶neticisi</p>
                <p class="font-bold text-indigo-700">${systemPreparerName}</p>
            </div>
            
            <div class="grid grid-cols-1 gap-4">
                <button onclick="showStudentLogin()" class="button bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-lg text-lg">
                    ğŸ“ Ã–ÄŸrenci GiriÅŸi
                </button>
                
                <button onclick="showTeacherLogin()" class="button bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-lg text-lg">
                    ğŸ‘¨â€ğŸ« Ã–ÄŸretmen GiriÅŸi
                </button>
                
                <button onclick="showAdminLogin()" class="button bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-lg text-lg">
                    âš™ï¸ YÃ¶netici GiriÅŸi
                </button>
            </div>
            
            <div class="text-center text-xs text-gray-500 mt-4">
                ${isDbConnected ? 'ğŸŸ¢ VeritabanÄ± BaÄŸlÄ±' : 'ğŸ”´ Ã‡evrimdÄ±ÅŸÄ± Mod'}
            </div>
        </div>
    `;
}

// --- Ã–ÄRENCÄ° GÄ°RÄ°ÅÄ° ---
function showStudentLogin() {
    document.getElementById('app').className = 'app-card max-w-md';
    document.getElementById('loginHeader').innerHTML = '<h1 class="text-2xl font-extrabold">Ã–ÄŸrenci GiriÅŸi</h1>';
    
    document.getElementById('mainContentArea').innerHTML = `
        <div class="space-y-4">
            <div id="examInfoArea" class="bg-yellow-50 border border-yellow-200 p-3 rounded-lg text-sm text-yellow-800">
                <p class="font-bold mb-1">âš ï¸ SÄ±nav Bilgisi:</p>
                <p class="mb-2">SÄ±nav kodunu girdikten sonra bilgiler gÃ¶rÃ¼necektir.</p>
            </div>
            
            <input id="examCodeInput" type="text" placeholder="SÄ±nav Kodu" class="w-full p-3 border rounded-lg uppercase">
            
            <div id="studentLoginFields" class="space-y-4">
                <p class="text-sm text-center text-gray-500 font-semibold border-t pt-4">SÄ±nav kodunu girdikten sonra listeyi gÃ¶receksiniz.</p>
            </div>

            <button id="startQuizButton" class="button w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg" disabled>SÄ±nava BaÅŸla</button>
            <button onclick="showRoleSelection()" class="button w-full bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm py-2 rounded-lg">Geri DÃ¶n</button>
        </div>
    `;
    
    document.getElementById('examCodeInput').oninput = handleCodeEntry;
    document.getElementById('startQuizButton').onclick = handleStudentLogin;
}

// --- Ã–ÄRETMEN GÄ°RÄ°ÅÄ° ---
function showTeacherLogin() {
    document.getElementById('app').className = 'app-card max-w-md';
    document.getElementById('loginHeader').innerHTML = '<h1 class="text-2xl font-extrabold">Ã–ÄŸretmen GiriÅŸi</h1>';
    
    document.getElementById('mainContentArea').innerHTML = `
        <div class="space-y-4">
            <div class="text-center text-xs mb-2 ${isDbConnected ? 'text-green-600':'text-red-600 font-bold'}">
                ${isDbConnected ? 'VeritabanÄ± Aktif' : 'VeritabanÄ± BaÄŸlÄ± DeÄŸil!'}
            </div>
            
            <input id="teacherUsername" type="text" placeholder="KullanÄ±cÄ± AdÄ±" class="w-full p-3 border rounded">
            <input id="teacherPassword" type="password" placeholder="Åifre" class="w-full p-3 border rounded">
            
            <button id="teacherLoginBtn" class="button bg-green-600 text-white w-full py-3 rounded">GiriÅŸ Yap</button>
            <button onclick="showRoleSelection()" class="button bg-gray-200 w-full py-2 rounded">Geri DÃ¶n</button>
            
            <div class="text-center text-xs text-gray-500 mt-4">
                <p>YÃ¶neticinizden kullanÄ±cÄ± adÄ± ve ÅŸifre alÄ±nÄ±z.</p>
            </div>
        </div>
    `;
    
    document.getElementById('teacherLoginBtn').onclick = handleTeacherLogin;
}

// --- YÃ–NETÄ°CÄ° GÄ°RÄ°ÅÄ° ---
function showAdminLogin() {
    document.getElementById('app').className = 'app-card max-w-md';
    document.getElementById('loginHeader').innerHTML = '<h1 class="text-2xl font-extrabold">YÃ¶netici GiriÅŸi</h1>';
    
    document.getElementById('mainContentArea').innerHTML = `
        <div class="space-y-4">
            <div class="text-center text-xs mb-2 ${isDbConnected ? 'text-green-600':'text-red-600 font-bold'}">
                ${isDbConnected ? 'VeritabanÄ± Aktif' : 'VeritabanÄ± BaÄŸlÄ± DeÄŸil!'}
            </div>
            
            <input id="adminPassword" type="password" placeholder="YÃ¶netici Åifresi" class="w-full p-3 border rounded">
            
            <button id="adminLoginBtn" class="button bg-red-600 text-white w-full py-3 rounded">YÃ¶netici GiriÅŸi</button>
            <button onclick="showRoleSelection()" class="button bg-gray-200 w-full py-2 rounded">Geri DÃ¶n</button>
            
            ${!adminMasterCode ? `
            <div class="bg-yellow-50 p-3 rounded border border-yellow-200 text-sm text-yellow-800">
                <p class="font-bold">Ä°lk Kurulum</p>
                <p>Ä°lk defa giriÅŸ yapÄ±yorsanÄ±z, ÅŸifrenizi belirleyin.</p>
            </div>
            ` : ''}
        </div>
    `;
    
    document.getElementById('adminLoginBtn').onclick = async () => {
        const enteredPassword = document.getElementById('adminPassword').value;
        
        if (!enteredPassword) {
            alert("LÃ¼tfen ÅŸifre girin.");
            return;
        }
        
        if (!adminMasterCode) {
            // Ä°lk kurulum - ÅŸifreyi kaydet
            if (confirm("Bu ÅŸifre yÃ¶netici ÅŸifreniz olarak ayarlanacaktÄ±r. Emin misiniz?")) {
                try {
                    await setDoc(doc(db, "exam_settings", "admin_config"), {
                        master_code: enteredPassword,
                        preparer_name: systemPreparerName,
                        firstSetup: true,
                        setupDate: serverTimestamp()
                    });
                    adminMasterCode = enteredPassword;
                    isTeacherMode = true;
                    currentUser = { role: 'admin', username: 'admin' };
                    showAdminDashboard();
                    alert("YÃ¶netici ÅŸifreniz baÅŸarÄ±yla oluÅŸturuldu!");
                } catch(e) {
                    alert("Åifre kaydedilirken hata: " + e.message);
                }
            }
        } else {
            // Normal giriÅŸ
            if (enteredPassword === adminMasterCode) {
                isTeacherMode = true;
                currentUser = { role: 'admin', username: 'admin' };
                showAdminDashboard();
            } else {
                alert("HatalÄ± ÅŸifre!");
            }
        }
    };
}

// --- Ã–ÄRETMEN GÄ°RÄ°Å Ä°ÅLEMÄ° ---
async function handleTeacherLogin() {
    const username = document.getElementById('teacherUsername').value.trim();
    const password = document.getElementById('teacherPassword').value;
    
    if (!username || !password) {
        alert("LÃ¼tfen kullanÄ±cÄ± adÄ± ve ÅŸifre girin.");
        return;
    }
    
    try {
        const teachersSnap = await getDocs(collection(db, "teachers"));
        let teacherFound = false;
        let teacherData = null;
        
        teachersSnap.forEach(doc => {
            const data = doc.data();
            if (data.username === username && data.password === password && data.isActive) {
                teacherFound = true;
                teacherData = { id: doc.id, ...data };
            }
        });
        
        if (teacherFound) {
            isTeacherMode = true;
            currentUser = { role: 'teacher', ...teacherData };
            showTeacherDashboard();
        } else {
            alert("HatalÄ± kullanÄ±cÄ± adÄ±/ÅŸifre veya hesap pasif durumda!");
        }
    } catch(error) {
        alert("GiriÅŸ hatasÄ±: " + error.message);
    }
}

// --- YÃ–NETÄ°CÄ° PANELÄ° ---
function showAdminDashboard() {
    document.getElementById('connectionStatus').classList.add('hidden');
    document.getElementById('app').className = 'app-card teacher-mode';
    document.getElementById('loginHeader').innerHTML = '<h1 class="text-2xl font-bold">YÃ¶netici Paneli</h1>';

    const dashboard = `
        <div class="flex gap-2 mb-4 border-b pb-2 overflow-x-auto">
            <button onclick="changeTab('teachers')" class="px-4 py-2 bg-blue-600 text-white rounded text-sm">Ã–ÄŸretmenler</button>
            <button onclick="changeTab('results')" class="px-4 py-2 bg-indigo-600 text-white rounded text-sm">TÃ¼m SonuÃ§lar</button>
            <button onclick="changeTab('settings')" class="px-4 py-2 bg-gray-600 text-white rounded text-sm">Sistem AyarlarÄ±</button>
            <button onclick="logout()" class="px-4 py-2 bg-red-600 text-white rounded text-sm ml-auto">Ã‡Ä±kÄ±ÅŸ</button>
        </div>
        
        <!-- Ã–ÄŸretmen YÃ¶netimi -->
        <div id="tab-teachers" class="tab-content">
            <div class="space-y-4">
                <h3 class="font-bold text-lg text-blue-700 mb-2">Ã–ÄŸretmen YÃ¶netimi</h3>
                
                <div class="bg-blue-50 p-4 rounded border border-blue-200">
                    <h4 class="font-bold text-blue-800 mb-3">Yeni Ã–ÄŸretmen Ekle</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input id="newTeacherFullName" type="text" placeholder="Ad Soyad" class="p-2 border rounded">
                        <input id="newTeacherUsername" type="text" placeholder="KullanÄ±cÄ± AdÄ±" class="p-2 border rounded">
                        <input id="newTeacherPassword" type="password" placeholder="Åifre" class="p-2 border rounded">
                        <button onclick="addNewTeacher()" class="bg-blue-600 text-white p-2 rounded font-bold">Ã–ÄŸretmen Ekle</button>
                    </div>
                </div>
                
                <div class="bg-white border rounded-lg shadow">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-3 text-left font-bold text-gray-600">Ad Soyad</th>
                                <th class="p-3 text-left font-bold text-gray-600">KullanÄ±cÄ± AdÄ±</th>
                                <th class="p-3 text-left font-bold text-gray-600">Åifre</th>
                                <th class="p-3 text-left font-bold text-gray-600">Durum</th>
                                <th class="p-3 text-left font-bold text-gray-600">KayÄ±t Tarihi</th>
                                <th class="p-3 text-left font-bold text-gray-600">Ä°ÅŸlemler</th>
                            </tr>
                        </thead>
                        <tbody id="teachersList" class="bg-white divide-y">
                            <tr><td colspan="6" class="p-4 text-center text-gray-500">YÃ¼kleniyor...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TÃ¼m SonuÃ§lar -->
        <div id="tab-results" class="tab-content hidden">
            <div class="space-y-4">
                <h3 class="font-bold text-lg text-indigo-700 mb-2">TÃ¼m SÄ±nav SonuÃ§larÄ±</h3>
                <div class="flex flex-wrap gap-2 mb-4 items-center bg-gray-50 p-3 rounded border">
                    <input id="fCode" placeholder="SÄ±nav Kodu" class="p-2 border rounded text-sm w-32">
                    <input id="fClass" placeholder="SÄ±nÄ±f" class="p-2 border rounded text-sm w-24">
                    <input id="fName" placeholder="Ad Soyad" class="p-2 border rounded text-sm w-32">
                    <button id="btnExport" class="bg-green-600 text-white px-3 py-2 rounded text-sm shadow">Excel Ä°ndir</button>
                </div>
                <div class="overflow-x-auto border rounded max-h-[600px] overflow-y-auto shadow">
                    <table class="min-w-full divide-y divide-gray-200 text-sm">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="p-3 text-left font-bold text-gray-600">SÄ±nÄ±f/No</th>
                                <th class="p-3 text-left font-bold text-gray-600">Ad Soyad</th>
                                <th class="p-3 text-left font-bold text-gray-600">Kod</th>
                                <th class="p-3 text-left font-bold text-gray-600">Puan</th>
                                <th class="p-3 text-left font-bold text-gray-600">D/Y/B</th>
                                <th class="p-3 text-left font-bold text-gray-600">SÃ¼re</th>
                                <th class="p-3 text-left font-bold text-gray-600">Tarih</th>
                            </tr>
                        </thead>
                        <tbody id="resTable" class="bg-white divide-y"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Sistem AyarlarÄ± -->
        <div id="tab-settings" class="tab-content hidden">
            <div class="space-y-4 max-w-lg mx-auto bg-gray-50 p-6 rounded border">
                <h3 class="font-bold text-lg mb-4">Sistem AyarlarÄ±</h3>
                
                <div>
                    <label class="text-xs font-bold text-indigo-600">Sistem HazÄ±rlayÄ±cÄ± AdÄ±</label>
                    <input id="systemPrepName" class="w-full p-2 border rounded" value="${systemPreparerName}">
                    <button onclick="changeSystemPreparer()" class="mt-2 w-full bg-indigo-600 text-white py-2 rounded font-bold">HAZIRLAYICI ADINI GÃœNCELLE</button>
                </div>
                
                <div class="mt-6">
                    <label class="text-xs font-bold text-red-600">YÃ¶netici Åifresini DeÄŸiÅŸtir</label>
                    <input id="newAdminPass" type="password" placeholder="Yeni ÅŸifre" class="w-full p-2 border rounded mt-1">
                    <input id="confirmAdminPass" type="password" placeholder="Yeni ÅŸifre (tekrar)" class="w-full p-2 border rounded mt-2">
                    <button onclick="changeAdminPassword()" class="mt-2 w-full bg-red-600 text-white py-2 rounded font-bold">YÃ–NETÄ°CÄ° ÅÄ°FRESÄ°NÄ° DEÄÄ°ÅTÄ°R</button>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('mainContentArea').innerHTML = dashboard;
    
    window.changeTab = (t) => { 
        document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden')); 
        document.getElementById('tab-'+t).classList.remove('hidden'); 
        if (t === 'teachers') loadTeachersList();
        if (t === 'results') setupAdminResultsTable();
    };
}

// --- Ã–ÄRETMEN YÃ–NETÄ°M FONKSÄ°YONLARI ---
async function loadTeachersList() {
    try {
        const teachersSnap = await getDocs(collection(db, "teachers"));
        const teachersList = document.getElementById('teachersList');
        
        if (teachersSnap.empty) {
            teachersList.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">HenÃ¼z Ã¶ÄŸretmen kaydÄ± yok.</td></tr>';
            return;
        }
        
        teachersList.innerHTML = teachersSnap.docs.map(doc => {
            const teacher = doc.data();
            const date = teacher.createdAt ? new Date(teacher.createdAt.seconds * 1000).toLocaleDateString('tr-TR') : '-';
            
            return `
                <tr class="hover:bg-gray-50">
                    <td class="p-3 font-medium">${teacher.fullName}</td>
                    <td class="p-3 font-mono">${teacher.username}</td>
                    <td class="p-3 font-mono text-sm bg-gray-50 rounded">${teacher.password}</td>
                    <td class="p-3">
                        <span class="px-2 py-1 rounded text-xs font-bold ${teacher.isActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${teacher.isActive ? 'AKTÄ°F' : 'PASÄ°F'}
                        </span>
                    </td>
                    <td class="p-3 text-sm text-gray-500">${date}</td>
                    <td class="p-3 flex gap-2">
                        <button onclick="toggleTeacherStatus('${doc.id}', ${!teacher.isActive})" class="text-blue-600 text-xs hover:underline">
                            ${teacher.isActive ? 'Pasif Yap' : 'Aktif Yap'}
                        </button>
                        <button onclick="resetTeacherPassword('${doc.id}')" class="text-green-600 text-xs hover:underline">Åifre DeÄŸiÅŸtir</button>
                        <button onclick="deleteTeacher('${doc.id}')" class="text-red-600 text-xs hover:underline">Sil</button>
                    </td>
                </tr>
            `;
        }).join('');
    } catch(error) {
        document.getElementById('teachersList').innerHTML = '<tr><td colspan="6" class="p-4 text-center text-red-500">Hata: ' + error.message + '</td></tr>';
    }
}

async function addNewTeacher() {
    const fullName = document.getElementById('newTeacherFullName').value.trim();
    const username = document.getElementById('newTeacherUsername').value.trim();
    const password = document.getElementById('newTeacherPassword').value;
    
    if (!fullName || !username || !password) {
        alert("LÃ¼tfen tÃ¼m alanlarÄ± doldurun.");
        return;
    }
    
    if (password.length < 4) {
        alert("Åifre en az 4 karakter olmalÄ±dÄ±r.");
        return;
    }
    
    try {
        // KullanÄ±cÄ± adÄ± kontrolÃ¼
        const existingTeacher = await getDocs(query(collection(db, "teachers"), where("username", "==", username)));
        if (!existingTeacher.empty) {
            alert("Bu kullanÄ±cÄ± adÄ± zaten kullanÄ±lÄ±yor!");
            return;
        }
        
        await addDoc(collection(db, "teachers"), {
            fullName,
            username,
            password,
            isActive: true,
            createdAt: serverTimestamp()
        });
        
        alert("Ã–ÄŸretmen baÅŸarÄ±yla eklendi!");
        document.getElementById('newTeacherFullName').value = '';
        document.getElementById('newTeacherUsername').value = '';
        document.getElementById('newTeacherPassword').value = '';
        loadTeachersList();
    } catch(error) {
        alert("Ã–ÄŸretmen eklenirken hata: " + error.message);
    }
}

async function toggleTeacherStatus(teacherId, newStatus) {
    try {
        await updateDoc(doc(db, "teachers", teacherId), {
            isActive: newStatus
        });
        alert(`Ã–ÄŸretmen ${newStatus ? 'aktif' : 'pasif'} yapÄ±ldÄ±!`);
        loadTeachersList();
    } catch(error) {
        alert("Durum deÄŸiÅŸtirilirken hata: " + error.message);
    }
}

async function resetTeacherPassword(teacherId) {
    const newPassword = prompt("Yeni ÅŸifreyi girin (en az 4 karakter):");
    if (!newPassword || newPassword.length < 4) {
        alert("Åifre en az 4 karakter olmalÄ±dÄ±r!");
        return;
    }
    
    try {
        await updateDoc(doc(db, "teachers", teacherId), {
            password: newPassword
        });
        alert("Åifre baÅŸarÄ±yla deÄŸiÅŸtirildi!");
        loadTeachersList();
    } catch(error) {
        alert("Åifre deÄŸiÅŸtirilirken hata: " + error.message);
    }
}

async function deleteTeacher(teacherId) {
    if (!confirm("Bu Ã¶ÄŸretmeni silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz!")) {
        return;
    }
    
    try {
        await deleteDoc(doc(db, "teachers", teacherId));
        alert("Ã–ÄŸretmen baÅŸarÄ±yla silindi!");
        loadTeachersList();
    } catch(error) {
        alert("Ã–ÄŸretmen silinirken hata: " + error.message);
    }
}

async function changeSystemPreparer() {
    const newPrepName = document.getElementById('systemPrepName').value.trim();
    if (!newPrepName) return alert("HazÄ±rlayÄ±cÄ± adÄ± boÅŸ bÄ±rakÄ±lamaz.");

    if(confirm(`Sistemin Ana HazÄ±rlayÄ±cÄ± adÄ± "${newPrepName}" olarak deÄŸiÅŸtirilecektir. Emin misiniz?`)) {
        try {
            await setDoc(doc(db, "exam_settings", "admin_config"), { preparer_name: newPrepName }, {merge: true});
            systemPreparerName = newPrepName;
            alert("HazÄ±rlayÄ±cÄ± adÄ± kaydedildi! Sayfa yenilenecek.");
            setTimeout(() => location.reload(), 1000);
        } catch(e) {
            alert("HazÄ±rlayÄ±cÄ± adÄ±nÄ± kaydederken hata: " + e.message);
        }
    }
}

async function changeAdminPassword() {
    const newPass = document.getElementById('newAdminPass').value;
    const confirmPass = document.getElementById('confirmAdminPass').value;
    
    if (!newPass || newPass.length < 4) {
        alert("Åifre en az 4 karakter olmalÄ±dÄ±r!");
        return;
    }
    
    if (newPass !== confirmPass) {
        alert("Åifreler eÅŸleÅŸmiyor!");
        return;
    }
    
    if(confirm(`YÃ¶netici ÅŸifresini deÄŸiÅŸtirmek istediÄŸinizden emin misiniz?`)) {
        try {
            await setDoc(doc(db, "exam_settings", "admin_config"), { 
                master_code: newPass 
            }, { merge: true });
            
            adminMasterCode = newPass;
            alert("YÃ¶netici ÅŸifresi baÅŸarÄ±yla deÄŸiÅŸtirildi!");
            document.getElementById('newAdminPass').value = '';
            document.getElementById('confirmAdminPass').value = '';
            
        } catch(e) {
            alert("Åifre deÄŸiÅŸtirilirken hata: " + e.message);
        }
    }
}

// --- Ã‡IKIÅ Ä°ÅLEMÄ° ---
function logout() {
    isTeacherMode = false;
    currentUser = null;
    showRoleSelection();
}

// UygulamayÄ± baÅŸlat
initializeFirebase();

    </script>
</body>
</html>
