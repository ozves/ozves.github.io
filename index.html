<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SÄ±nav Sistemi V16 (Tam SÃ¼rÃ¼m)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0;}
        .app-card { background-color:white;padding:2.5rem;border-radius:1.5rem;box-shadow:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05);max-width:450px;width:90%;transition:all .3s;position:relative;}
        .header-bg { background: linear-gradient(135deg,#4f46e5 0%,#818cf8 100%); color:white;padding:1rem 0;border-radius:1rem 1rem 0 0;margin:-2.5rem -2.5rem 1.5rem -2.5rem;text-align:center;}
        .button{transition:all .2s;box-shadow:0 4px 6px rgba(0,0,0,0.1)}
        .button:hover{transform:translateY(-1px);box-shadow:0 6px 10px rgba(0,0,0,0.15)}
        .teacher-mode { max-width: 1400px !important; width: 98% !important; } 
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .paste-area { border: 2px dashed #cbd5e0; border-radius: 0.5rem; padding: 1rem; background-color: #f9fafb; cursor: text; min-height: 120px; }
        .paste-area:focus { outline: none; border-color: #4f46e5; }
    </style>
</head>
<body>

    <div id="app" class="app-card">
        <div id="loginHeader" class="header-bg">
            <h1 class="text-2xl font-extrabold">Ã–ÄŸrenci GiriÅŸi</h1>
        </div>
        
        <div id="connectionStatus" class="hidden mb-4 text-xs font-bold text-center p-2 rounded border"></div>
        
        <div id="mainContentArea">
            <div id="loadingIndicator" class="text-center py-10">
                <div class="loader"></div>
                <p id="loadingText" class="text-sm text-gray-500 mt-4 font-bold">Sistem BaÅŸlatÄ±lÄ±yor...</p>
            </div>
        </div>
    </div>

    <div id="customModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center p-4 z-50">
        <div id="modalContent" class="bg-white rounded-xl p-6 max-w-3xl w-full shadow-2xl overflow-y-auto max-h-[90vh]"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, collection, onSnapshot, serverTimestamp, query, where, getDocs, deleteDoc, getDoc, addDoc, updateDoc, setDoc, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- FIREBASE AYARLARI ---
        const firebaseConfig = {
            apiKey: "AIzaSyCHhFAHbWnclad6yFuI-Pw9gX6F_Dx1B2c",
            authDomain: "online-sinav-b3644.firebaseapp.com",
            projectId: "online-sinav-b3644",
            storageBucket: "online-sinav-b3644.firebasestorage.app",
            messagingSenderId: "965507531268",
            appId: "1:965507531268:web:94cfd13774a40b6cf16b51"
        };

        // --- GLOBAL DEÄÄ°ÅKENLER ---
        let db, auth;
        let isAuthReady = false, isDbConnected = false;
        let adminMasterCode = null;
        
        // Ã‡oklu KullanÄ±cÄ± DeÄŸiÅŸkenleri
        let isTeacherMode = false;
        let currentUser = { username: "", role: "", name: "" };
        let isSuperAdmin = false;
        let systemPreparerName = "Sistem YÃ¶neticisi";

        // SÄ±nav DeÄŸiÅŸkenleri
        let currentExamConfig = { exam_code: "DEFAULT", teacher_name: "YÃ¼kleniyor...", time_limit: 600, exam_description: "..." };
        let quizQuestions = [];
        let studentList = [];
        let studentData = {};
        let selectedAnswers = [];
        let questionOrder = [];
        let currentQuestionIndex = 0;
        let focusLossCount = 0;
        let currentSessionDocId = null;
        let timerInterval = null;
        let examendTimeStamp = null;
        let autoSaveInterval = null;
        let allSubmissions = [];

        // --- YARDIMCI FONKSÄ°YONLAR ---
        function sanitizeInput(input) { if (typeof input !== 'string') return ''; return input.replace(/</g, '&lt;').replace(/>/g, '&gt;').substring(0, 500); }
        function sanitizeExamCode(code) { if (typeof code !== 'string') return ''; return code.replace(/[^a-zA-Z0-9_]/g, '').toUpperCase().substring(0, 20); }
        function validateStudentData(s) { return (s && typeof s === 'object' && s.name?.trim().length > 0 && s.number?.trim().length > 0 && s.className?.trim().length > 0); }
        const getConfigRef = (code) => doc(db, "exam_settings", sanitizeExamCode(code));
        const getQuestionsRef = (code) => doc(db, "questions_pool", sanitizeExamCode(code));

        // --- BAÅLATMA ---
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await signInAnonymously(auth);
                onAuthStateChanged(auth, async (user) => { if (user) { isAuthReady = true; await checkConnectivity(); } });
            } catch (error) { showCustomAlert("Kritik Hata", "Firebase baÅŸlatÄ±lamadÄ±: " + error.message); }
        }

        async function checkConnectivity() {
            const statusDiv = document.getElementById('connectionStatus');
            try {
                const adminSnap = await getDoc(doc(db, "exam_settings", "admin_config"));
                if (adminSnap.exists()) {
                    const data = adminSnap.data();
                    adminMasterCode = data.master_code;
                    isDbConnected = true;
                    statusDiv.innerHTML = "ğŸŸ¢ Sistem Ã‡evrimiÃ§i";
                    statusDiv.className = "mb-4 text-xs font-bold text-center p-2 rounded border bg-green-100 text-green-800 border-green-300";
                } else { throw new Error("Admin konfigÃ¼rasyonu eksik."); }
            } catch(e) {
                isDbConnected = false;
                adminMasterCode = null;
                statusDiv.innerHTML = `ğŸ”´ BAÄLANTI HATASI: ${e.message}`;
                statusDiv.className = "mb-4 text-xs font-bold text-center p-2 rounded border bg-red-100 text-red-800 border-red-300";
            }
            statusDiv.classList.remove('hidden');
            document.getElementById('loadingIndicator').classList.add('hidden');
            showLoginForm();
        }

        function resetApp() {
            if (timerInterval) clearInterval(timerInterval);
            if (autoSaveInterval) clearInterval(autoSaveInterval);
            window.onblur = null; document.oncontextmenu = null;
            
            currentUser = { username: "", role: "", name: "" };
            isSuperAdmin = false;
            isTeacherMode = false;
            studentData = {};
            
            document.getElementById('app').className = 'app-card max-w-md';
            document.getElementById('connectionStatus').classList.remove('hidden');
            showLoginForm();
        }

        // --- Ã–ÄRENCÄ° GÄ°RÄ°ÅÄ° ---
        function showLoginForm() {
            document.getElementById('loginHeader').innerHTML = '<h1 class="text-2xl font-extrabold">Ã–ÄŸrenci GiriÅŸi</h1>';
            document.getElementById('mainContentArea').innerHTML = `
                <div class="space-y-4">
                    <div id="examInfoArea" class="hidden bg-yellow-50 border border-yellow-200 p-3 rounded-lg text-sm text-yellow-800"></div>
                    <input id="examCodeInput" type="text" placeholder="SINAV KODU (Ã–rn: 9A_MAT)" class="w-full p-3 border rounded-lg uppercase font-bold text-center tracking-widest">
                    <div id="studentLoginFields" class="space-y-4"><p class="text-sm text-center text-gray-400 italic mt-2">SÄ±nav kodunu girince liste aÃ§Ä±lacaktÄ±r.</p></div>
                    <button id="startQuizButton" class="button w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg shadow-lg opacity-50 cursor-not-allowed" disabled>SÄ±nava BaÅŸla</button>
                    <div class="border-t pt-4 mt-4"><button id="teacherLoginButton" class="text-gray-400 hover:text-gray-600 text-xs w-full text-center">Ã–ÄŸretmen GiriÅŸi</button></div>
                </div>`;

            document.getElementById('teacherLoginButton').onclick = showTeacherLogin;
            document.getElementById('examCodeInput').oninput = handleCodeEntry;
            document.getElementById('startQuizButton').onclick = handleStudentLogin;
        }

        let typingTimer;
        async function handleCodeEntry() {
            clearTimeout(typingTimer);
            const code = sanitizeExamCode(document.getElementById('examCodeInput').value.trim());
            const infoArea = document.getElementById('examInfoArea');
            const loginFields = document.getElementById('studentLoginFields');
            const btn = document.getElementById('startQuizButton');

            if (code.length < 3) { infoArea.classList.add('hidden'); return; }

            typingTimer = setTimeout(async () => {
                await fetchExamData(code);
                const mins = Math.floor(currentExamConfig.time_limit / 60);
                infoArea.innerHTML = `<p class="font-bold">SÄ±nav: ${code}</p><p>${sanitizeInput(currentExamConfig.exam_description)}</p><p class="text-xs mt-1">â±ï¸ ${mins} Dk | ğŸ“ ${quizQuestions.length} Soru</p>`;
                infoArea.classList.remove('hidden');

                if (studentList.length === 0) {
                    loginFields.innerHTML = `<div class="bg-red-50 p-2 rounded text-xs text-red-700 mb-2">âš ï¸ Liste yok. Manuel giriÅŸ yapÄ±nÄ±z.</div>
                        <input id="nameInput" type="text" placeholder="Ad Soyad" class="w-full p-3 border rounded-lg">
                        <input id="numberInput" type="number" placeholder="Okul No" class="w-full p-3 border rounded-lg">
                        <input id="classInput" type="text" placeholder="SÄ±nÄ±f" class="w-full p-3 border rounded-lg">`;
                    const check = () => { btn.disabled = !(document.getElementById('nameInput').value && document.getElementById('numberInput').value && document.getElementById('classInput').value); btn.classList.toggle('opacity-50', btn.disabled); };
                    loginFields.oninput = check;
                } else {
                    const students = studentList.sort((a, b) => a.name.localeCompare(b.name, 'tr'));
                    const classes = [...new Set(students.map(s => s.className))].sort();
                    loginFields.innerHTML = `
                        <select id="classSelector" class="w-full p-3 border rounded-lg font-bold text-indigo-700 bg-white"><option value="">-- SÄ±nÄ±f --</option>${classes.map(c => `<option value="${sanitizeInput(c)}">${sanitizeInput(c)}</option>`).join('')}</select>
                        <select id="studentSelector" class="w-full p-3 border rounded-lg bg-gray-100" disabled><option value="">-- Ã–nce SÄ±nÄ±f --</option></select>
                        <div id="verificationArea" class="hidden mt-2"><input id="numberVerify" type="number" placeholder="Okul NumaranÄ±zÄ± Girin" class="w-full p-3 border-2 border-indigo-300 rounded-lg"></div>`;
                    
                    document.getElementById('classSelector').onchange = (e) => {
                        const cls = e.target.value;
                        const sel = document.getElementById('studentSelector');
                        sel.innerHTML = '<option value="">-- Ä°sim --</option>'; sel.disabled = !cls;
                        if(cls) sel.innerHTML += students.filter(s => s.className === cls).map(s => `<option value="${s.number}_${s.name}">${sanitizeInput(s.name)}</option>`).join('');
                    };
                    document.getElementById('studentSelector').onchange = (e) => { document.getElementById('verificationArea').classList.toggle('hidden', !e.target.value); };
                    document.getElementById('numberVerify').oninput = (e) => { btn.disabled = !e.target.value; btn.classList.toggle('opacity-50', btn.disabled); };
                }
            }, 500);
        }

        async function fetchExamData(code) {
            if (!isDbConnected) return;
            try {
                const configSnap = await getDoc(getConfigRef(code));
                currentExamConfig = configSnap.exists() ? { exam_code: code, ...configSnap.data() } : { exam_code: code, time_limit: 600, exam_description: "SÄ±nav ayarÄ± yok." };
                const questionsSnap = await getDoc(getQuestionsRef(code));
                quizQuestions = questionsSnap.exists() ? (questionsSnap.data().questions_list || []) : [];
                const listSnap = await getDoc(doc(db, "student_lists", code));
                studentList = listSnap.exists() ? (listSnap.data().students || []) : [];
            } catch(e) { console.error(e); }
        }

        async function handleStudentLogin() {
            const code = document.getElementById('examCodeInput').value;
            let name, number, className;
            
            if (document.getElementById('studentSelector')) {
                const val = document.getElementById('studentSelector').value;
                const inputNum = document.getElementById('numberVerify').value;
                if(!val || val.split('_')[0] !== inputNum) return alert("Numara eÅŸleÅŸmiyor!");
                [number, name] = val.split('_');
                className = document.getElementById('classSelector').value;
            } else {
                name = document.getElementById('nameInput').value;
                number = document.getElementById('numberInput').value;
                className = document.getElementById('classInput').value;
            }

            if (quizQuestions.length === 0) return alert("Soru yok!");
            
            studentData = { name, number, className, examCode: code };
            const studentKey = `${code}_${number}`;
            
            // SÄ±nav bitmiÅŸ mi kontrolÃ¼
            const subSnap = await getDocs(query(collection(db, "quiz_submissions"), where("studentKey", "==", studentKey)));
            if (!subSnap.empty) return alert("Bu sÄ±navÄ± zaten tamamladÄ±nÄ±z.");

            startQuiz();
        }

        // --- SINAV EKRANI (BasitleÅŸtirilmiÅŸ) ---
        function startQuiz() {
            document.getElementById('app').className = 'app-card max-w-3xl w-full';
            document.getElementById('loginHeader').innerHTML = `<div class="flex justify-between px-4"><span>${studentData.name}</span><span>${studentData.examCode}</span></div>`;
            document.getElementById('mainContentArea').innerHTML = `
                <div class="flex justify-between items-center mb-4 border-b pb-2"><span class="font-bold text-indigo-600">Soru: <span id="qCount">1</span> / ${quizQuestions.length}</span><div id="timerDisplay" class="text-xl font-mono font-bold text-white bg-indigo-600 p-1 px-3 rounded">--:--</div></div>
                <div id="questionArea" class="min-h-[250px]"></div>
                <div class="mt-6 flex justify-between"><button id="prevBtn" class="button bg-gray-500 text-white py-2 px-4 rounded">Ã–nceki</button><button id="nextBtn" class="button bg-indigo-600 text-white py-2 px-6 rounded font-bold">Sonraki</button></div>`;
            
            questionOrder = Array.from({length: quizQuestions.length}, (_, i) => i); // KarÄ±ÅŸtÄ±rma yok basitleÅŸtirildi
            selectedAnswers = Array(quizQuestions.length).fill(null);
            examendTimeStamp = Date.now() + (currentExamConfig.time_limit * 1000);
            
            renderQuestion(0);
            timerInterval = setInterval(updateTimer, 1000);
            
            document.getElementById('prevBtn').onclick = () => { if(currentQuestionIndex > 0) renderQuestion(--currentQuestionIndex); };
            document.getElementById('nextBtn').onclick = () => { 
                if(currentQuestionIndex < quizQuestions.length - 1) renderQuestion(++currentQuestionIndex);
                else finishQuiz();
            };
        }

        function renderQuestion(idx) {
            const q = quizQuestions[idx];
            document.getElementById('qCount').innerText = idx + 1;
            const labels = ['A','B','C','D','E'];
            
            document.getElementById('questionArea').innerHTML = `
                <div class="font-semibold text-lg text-gray-800 mb-4">Soru ${idx + 1}: ${sanitizeInput(q.question)}</div>
                ${q.image ? `<div class="mb-4 text-center"><img src="${q.image}" class="max-h-60 inline-block"></div>` : ''}
                <div class="space-y-3">
                    ${q.options.map((opt, i) => `
                        <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer transition-all ${selectedAnswers[idx] === opt ? 'bg-indigo-50 border-indigo-500' : 'hover:bg-gray-50'}">
                            <input type="radio" name="opt" value="${sanitizeInput(opt)}" class="hidden" ${selectedAnswers[idx] === opt ? 'checked' : ''}>
                            <div class="w-6 h-6 flex items-center justify-center border-2 rounded-full mr-3 ${selectedAnswers[idx] === opt ? 'border-indigo-600 bg-indigo-600 text-white' : 'border-gray-400'}">${labels[i]}</div>
                            <span class="text-gray-700">${sanitizeInput(opt)}</span>
                        </label>`).join('')}
                </div>`;

            document.querySelectorAll('input[name="opt"]').forEach(el => el.onchange = (e) => {
                selectedAnswers[idx] = e.target.value;
                renderQuestion(idx);
            });
            
            document.getElementById('nextBtn').innerText = (idx === quizQuestions.length - 1) ? "SINAVI BÄ°TÄ°R" : "Sonraki";
        }

        function updateTimer() {
            const diff = Math.ceil((examendTimeStamp - Date.now()) / 1000);
            if (diff <= 0) return finishQuiz();
            const m = Math.floor(diff / 60);
            const s = diff % 60;
            document.getElementById('timerDisplay').innerText = `${m}:${s < 10 ? '0'+s : s}`;
        }

        async function finishQuiz() {
            clearInterval(timerInterval);
            let c=0, i=0, e=0;
            quizQuestions.forEach((q, idx) => {
                const ans = selectedAnswers[idx];
                if(!ans) e++; else if(ans === q.answer) c++; else i++;
            });
            const score = (c * 100 / quizQuestions.length).toFixed(2);
            
            await addDoc(collection(db, "quiz_submissions"), {
                ...studentData, studentKey: `${studentData.examCode}_${studentData.number}`,
                score, correct: c, incorrect: i, empty: e, timestamp: serverTimestamp()
            });
            
            document.getElementById('mainContentArea').innerHTML = `<div class="text-center py-10"><h2 class="text-3xl font-bold text-indigo-700">${score}</h2><p>SÄ±navÄ±nÄ±z tamamlandÄ±.</p><button onclick="location.reload()" class="mt-4 bg-gray-800 text-white px-4 py-2 rounded">Ã‡Ä±kÄ±ÅŸ</button></div>`;
        }

        // --- YÃ–NETÄ°CÄ° / Ã–ÄRETMEN GÄ°RÄ°ÅÄ° (YENÄ°) ---
        function showTeacherLogin() {
            document.getElementById('mainContentArea').innerHTML = `
                <div class="space-y-4">
                    <h3 class="text-center font-bold text-gray-800 text-lg">Ã–ÄŸretmen / YÃ¶netici GiriÅŸi</h3>
                    <div class="bg-yellow-50 p-3 rounded text-xs text-yellow-800 border border-yellow-200"><strong>Not:</strong> YÃ¶netici iseniz kullanÄ±cÄ± adÄ±na "admin" yazÄ±n.</div>
                    <input id="loginUser" type="text" placeholder="KullanÄ±cÄ± AdÄ±" class="w-full p-3 border rounded-lg">
                    <input id="loginPass" type="password" placeholder="Åifre" class="w-full p-3 border rounded-lg">
                    <button id="loginBtn" class="button bg-indigo-600 text-white w-full py-3 rounded-lg font-bold hover:bg-indigo-700">GiriÅŸ Yap</button>
                    <button id="backBtn" class="button bg-gray-200 text-gray-700 w-full py-3 rounded-lg font-semibold">Geri DÃ¶n</button>
                </div>`;

            document.getElementById('backBtn').onclick = showLoginForm;
            
            document.getElementById('loginBtn').onclick = async () => {
                const u = document.getElementById('loginUser').value.trim();
                const p = document.getElementById('loginPass').value.trim();
                if(!u || !p) return alert("Bilgileri doldurun.");
                
                // 1. ADMIN KONTROLÃœ
                if (u === "admin" && p === adminMasterCode) {
                    currentUser = { username: "admin", role: "admin", name: systemPreparerName };
                    isSuperAdmin = true; isTeacherMode = true;
                    showDashboard();
                    return;
                }
                // 2. Ã–ÄRETMEN KONTROLÃœ
                try {
                    const snap = await getDocs(query(collection(db, "teachers"), where("username", "==", u), where("password", "==", p)));
                    if (!snap.empty) {
                        const tData = snap.docs[0].data();
                        currentUser = { username: tData.username, role: "teacher", name: tData.full_name };
                        isSuperAdmin = false; isTeacherMode = true;
                        showDashboard();
                    } else { alert("HatalÄ± giriÅŸ!"); }
                } catch (e) { alert("Hata: " + e.message); }
            };
        }

        // --- DASHBOARD (YÃ–NETÄ°M PANELÄ°) ---
        function showDashboard() {
            document.getElementById('connectionStatus').classList.add('hidden');
            document.getElementById('app').className = 'app-card teacher-mode';
            document.getElementById('loginHeader').innerHTML = `
                <div class="flex justify-between items-center px-4">
                    <div class="text-left"><h1 class="text-xl font-bold">YÃ¶netim Paneli</h1><p class="text-xs opacity-80">${currentUser.name} (${isSuperAdmin?'YÃ¶netici':'Ã–ÄŸretmen'})</p></div>
                    <button id="logoutBtn" class="text-sm bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded">Ã‡Ä±kÄ±ÅŸ</button>
                </div>`;
            document.getElementById('logoutBtn').onclick = resetApp;

            document.getElementById('mainContentArea').innerHTML = `
                <div class="flex flex-wrap gap-2 mb-6 border-b pb-4">
                    <button onclick="window.changeTab('results')" class="flex-1 px-3 py-2 bg-indigo-600 text-white rounded text-xs font-bold hover:bg-indigo-700">ğŸ“Š SonuÃ§lar</button>
                    <button onclick="window.changeTab('myexams')" class="flex-1 px-3 py-2 bg-purple-600 text-white rounded text-xs font-bold hover:bg-purple-700">ğŸ“‚ SÄ±navlarÄ±m</button>
                    <button onclick="window.changeTab('questions')" class="flex-1 px-3 py-2 bg-orange-600 text-white rounded text-xs font-bold hover:bg-orange-700">ğŸ“ Soru YÃ¼kle</button>
                    <button onclick="window.changeTab('lists')" class="flex-1 px-3 py-2 bg-teal-600 text-white rounded text-xs font-bold hover:bg-teal-700">ğŸ‘¥ Ã–ÄŸrenci YÃ¼kle</button>
                    <button onclick="window.changeTab('settings')" class="flex-1 px-3 py-2 bg-gray-600 text-white rounded text-xs font-bold hover:bg-gray-700">âš™ï¸ Ayarlar</button>
                    ${isSuperAdmin ? `<button onclick="window.changeTab('teachers')" class="flex-1 px-3 py-2 bg-pink-600 text-white rounded text-xs font-bold hover:bg-pink-700">ğŸ‘¨â€ğŸ« Ã–ÄŸretmenler</button>` : ''}
                </div>
                
                <div id="tab-results" class="tab-content"><div class="overflow-auto max-h-[500px] border rounded-lg"><table class="min-w-full divide-y divide-gray-200 text-sm"><thead class="bg-gray-100 sticky top-0"><tr><th class="p-3">Ã–ÄŸrenci</th><th class="p-3">Kod</th><th class="p-3">Puan</th><th class="p-3">Ä°ÅŸlem</th></tr></thead><tbody id="resultsTableBody" class="bg-white divide-y"></tbody></table></div></div>
                
                <div id="tab-myexams" class="tab-content hidden"><div id="myExamsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div></div>
                
                <div id="tab-questions" class="tab-content hidden"><div class="max-w-2xl mx-auto"><input id="uploadQCode" class="w-full p-2 border rounded mb-2 uppercase" placeholder="SÄ±nav Kodu"><textarea id="jsonInput" rows="10" class="w-full p-3 text-xs border rounded" placeholder='[{"question":"Soru?","options":["A","B"],"answer":"A"}]'></textarea><button id="btnUploadQ" class="bg-orange-600 text-white px-6 py-2 rounded font-bold w-full mt-2">YÃœKLE</button></div></div>
                
                <div id="tab-lists" class="tab-content hidden"><div class="max-w-2xl mx-auto"><input id="uploadListCode" class="w-full p-2 border rounded mb-2 uppercase" placeholder="SÄ±nav Kodu"><div class="paste-area" id="listInput" contenteditable="true"></div><button id="btnUploadList" class="w-full mt-2 bg-teal-600 text-white py-2 rounded font-bold">KAYDET</button></div></div>
                
                <div id="tab-settings" class="tab-content hidden">
                    <div class="max-w-lg mx-auto space-y-4 bg-white p-6 rounded shadow">
                        <h3 class="font-bold">Yeni SÄ±nav OluÅŸtur</h3>
                        <input id="setExamCode" class="w-full p-2 border rounded uppercase" placeholder="SÄ±nav Kodu">
                        <input id="setTime" type="number" class="w-full p-2 border rounded" value="40" placeholder="SÃ¼re (Dk)">
                        <input id="setDesc" class="w-full p-2 border rounded" placeholder="AÃ§Ä±klama">
                        <button id="btnSaveSettings" class="w-full bg-gray-800 text-white py-2 rounded font-bold">OluÅŸtur</button>
                    </div>
                </div>

                <div id="tab-teachers" class="tab-content hidden">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-pink-50 p-4 rounded h-fit"><h3 class="font-bold mb-2">Ã–ÄŸretmen Ekle</h3><input id="tUser" placeholder="KullanÄ±cÄ± AdÄ±" class="w-full p-2 border rounded mb-2"><input id="tPass" placeholder="Åifre" class="w-full p-2 border rounded mb-2"><input id="tName" placeholder="Ad Soyad" class="w-full p-2 border rounded mb-2"><button onclick="window.addTeacher()" class="w-full bg-pink-600 text-white py-2 rounded font-bold">Ekle</button></div>
                        <div class="col-span-2 border rounded overflow-hidden"><table class="min-w-full text-sm"><thead class="bg-gray-100"><tr><th class="p-3">Ad</th><th class="p-3">KullanÄ±cÄ±</th><th class="p-3">Åifre</th><th class="p-3">Sil</th></tr></thead><tbody id="teachersListBody"></tbody></table></div>
                    </div>
                </div>`;
            
            window.changeTab = (t) => {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
                const tab = document.getElementById('tab-' + t);
                if(tab) tab.classList.remove('hidden');
                if(t === 'results') loadResults();
                if(t === 'myexams') loadMyExams();
                if(t === 'teachers' && isSuperAdmin) loadTeachers();
            };
            
            loadResults();
            setupDashboardEvents();
        }

        function setupDashboardEvents() {
            // SÄ±nav OluÅŸturma
            document.getElementById('btnSaveSettings').onclick = async () => {
                const code = sanitizeExamCode(document.getElementById('setExamCode').value);
                const time = parseInt(document.getElementById('setTime').value);
                const desc = sanitizeInput(document.getElementById('setDesc').value);
                if(!code) return alert("Kod gerekli");
                try {
                    await setDoc(getConfigRef(code), {
                        teacher_name: currentUser.name,
                        owner_username: currentUser.username,
                        time_limit: time * 60,
                        exam_description: desc,
                        created_at: serverTimestamp()
                    }, { merge: true });
                    alert("SÄ±nav oluÅŸturuldu.");
                } catch(e) { alert(e.message); }
            };

            // Toplu Soru YÃ¼kleme
            document.getElementById('btnUploadQ').onclick = async () => {
                const code = sanitizeExamCode(document.getElementById('uploadQCode').value);
                const json = document.getElementById('jsonInput').value;
                try { await setDoc(getQuestionsRef(code), { questions_list: JSON.parse(json) }); alert("YÃ¼klendi"); } catch(e) { alert("JSON HatasÄ±"); }
            };

            // Toplu Liste YÃ¼kleme
            document.getElementById('btnUploadList').onclick = async () => {
                const code = sanitizeExamCode(document.getElementById('uploadListCode').value);
                const txt = document.getElementById('listInput').innerText;
                const students = [];
                txt.split('\n').forEach(line => {
                    const p = line.split(/\s+|\t/);
                    if(p.length>=3) students.push({number:p[0], className:p[1], name:p.slice(2).join(' ')});
                });
                if(students.length>0) { await setDoc(doc(db, "student_lists", code), { students }); alert("YÃ¼klendi"); }
            };
        }

        // --- SONUÃ‡LARI YÃœKLE ---
        function loadResults() {
            const tbody = document.getElementById('resultsTableBody');
            tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center">YÃ¼kleniyor...</td></tr>';
            onSnapshot(query(collection(db, "quiz_submissions"), orderBy("timestamp", "desc"), limit(100)), (snap) => {
                allSubmissions = snap.docs.map(d => ({id:d.id, ...d.data()}));
                tbody.innerHTML = allSubmissions.map(s => `
                    <tr class="hover:bg-gray-50">
                        <td class="p-3"><div class="font-bold">${s.name}</div><div class="text-xs text-gray-500">${s.number}</div></td>
                        <td class="p-3">${s.examCode}</td>
                        <td class="p-3 font-bold ${s.score>=50?'text-green-600':'text-red-600'}">${s.score}</td>
                        <td class="p-3"><button onclick="window.deleteSub('${s.id}')" class="text-red-600 text-xs">Sil</button></td>
                    </tr>`).join('');
            });
        }
        window.deleteSub = async (id) => { if(confirm("Silinsin mi?")) await deleteDoc(doc(db, "quiz_submissions", id)); };

        // --- SINAVLARIM (Ã–ZEL TASARIM & FÄ°LTRELEME) ---
        async function loadMyExams() {
            const container = document.getElementById('myExamsList');
            container.innerHTML = '<p class="col-span-full text-center">YÃ¼kleniyor...</p>';
            try {
                const [conf, qSnap, lSnap, subSnap] = await Promise.all([
                    getDocs(collection(db, "exam_settings")), getDocs(collection(db, "questions_pool")),
                    getDocs(collection(db, "student_lists")), getDocs(collection(db, "quiz_submissions"))
                ]);
                
                const qCount = {}, lCount = {}, sCount = {};
                qSnap.forEach(d => qCount[d.id] = d.data().questions_list?.length || 0);
                lSnap.forEach(d => lCount[d.id] = d.data().students?.length || 0);
                subSnap.forEach(d => { const c = d.data().examCode; if(c) sCount[c] = (sCount[c]||0)+1; });

                const exams = [];
                conf.forEach(doc => {
                    if(doc.id !== 'admin_config') {
                        const d = doc.data();
                        // FÄ°LTRELEME: Admin hepsini, Ã–ÄŸretmen sadece kendisininkini
                        if(isSuperAdmin || d.owner_username === currentUser.username || (!d.owner_username && isSuperAdmin)) {
                            exams.push({ code: doc.id, ...d, qc: qCount[doc.id]||0, sc: lCount[doc.id]||0, sub: sCount[doc.id]||0 });
                        }
                    }
                });

                if(exams.length === 0) { container.innerHTML = '<div class="col-span-full text-center py-10 text-gray-500">SÄ±nav bulunamadÄ±.</div>'; return; }

                container.innerHTML = exams.map(e => `
                    <div class="bg-white p-6 border rounded-xl shadow-sm hover:shadow-md transition flex flex-col relative">
                        <div class="flex justify-between items-start mb-4">
                            <div><h3 class="font-extrabold text-xl text-indigo-700">${e.code}</h3><p class="text-sm text-gray-500 mt-1">${e.exam_description || ''}</p></div>
                            <input type="text" class="text-xs p-2 border rounded w-24 text-right" placeholder="Ã–zel Ä°sim" value="${e.custom_name||''}" onchange="window.updateExamName('${e.code}', this.value)">
                        </div>
                        <div class="space-y-2 text-sm flex-grow">
                            <div class="flex justify-between py-1 border-b"><span class="text-gray-600">HazÄ±rlayan:</span> <span class="font-bold text-xs">${e.teacher_name}</span></div>
                            <div class="flex justify-between py-1 border-b"><span class="text-gray-600">SÃ¼re:</span> <b>${Math.floor(e.time_limit/60)} dk</b></div>
                            <div class="flex justify-between items-center py-1 border-b"><span class="text-gray-600">Soru:</span> <button onclick="window.showExamQuestions('${e.code}')" class="text-blue-600 font-bold text-lg flex items-center">${e.qc} <span class="ml-1 text-xs">âœï¸</span></button></div>
                            <div class="flex justify-between items-center py-1 border-b"><span class="text-gray-600">Ã–ÄŸrenci:</span> <button onclick="window.showExamStudents('${e.code}')" class="text-blue-600 font-bold text-lg flex items-center">${e.sc} <span class="ml-1 text-xs">ğŸ‘¥</span></button></div>
                            <div class="flex justify-between py-1"><span class="text-gray-600">KatÄ±lÄ±m:</span> <b>${e.sub}</b></div>
                        </div>
                        <button onclick="window.deleteExam('${e.code}')" class="mt-4 w-full bg-red-50 text-red-600 py-2 rounded text-xs font-bold hover:bg-red-100">SÄ°L</button>
                    </div>`).join('');
            } catch(e) { container.innerHTML = e.message; }
        }
        window.updateExamName = async (c, n) => await setDoc(getConfigRef(c), { custom_name: sanitizeInput(n) }, { merge: true });

        // --- SORU YÃ–NETÄ°MÄ° (TEK TEK - 5 ÅIKLI) ---
        window.showExamQuestions = async (code) => {
            const qSnap = await getDoc(getQuestionsRef(code));
            const questions = qSnap.exists() ? qSnap.data().questions_list : [];
            const content = `
                <div class="sticky top-0 bg-
