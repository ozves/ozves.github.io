<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SÄ±nav Sistemi V19 (Garantili Butonlar & ModÃ¼l Uyumlu)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0;}
        .app-card { background-color:white;padding:2.5rem;border-radius:1.5rem;box-shadow:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05);max-width:450px;width:90%;transition:all .3s;position:relative;}
        .header-bg { background: linear-gradient(135deg,#4f46e5 0%,#818cf8 100%); color:white;padding:1rem 0;border-radius:1rem 1rem 0 0;margin:-2.5rem -2.5rem 1.5rem -2.5rem;text-align:center;}
        .button{transition:all .2s;box-shadow:0 4px 6px rgba(0,0,0,0.1); cursor: pointer;}
        .button:active{transform:scale(0.98);}
        .teacher-mode { max-width: 1400px !important; width: 98% !important; } 
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* ButonlarÄ±n Ã§alÄ±ÅŸmadÄ±ÄŸÄ± algÄ±sÄ±nÄ± yaratmamasÄ± iÃ§in, tÄ±klanamayan butonlara Ã¶zel stil ekledik. */
        .disabled:hover { transform: none !important; box-shadow: none !important; }
    </style>
</head>
<body>

    <div id="app" class="app-card">
        <div id="loginHeader" class="header-bg">
            <h1 class="text-2xl font-extrabold">Ã–ÄŸrenci GiriÅŸi</h1>
        </div>
        
        <div id="connectionStatus" class="hidden mb-4 text-xs font-bold text-center p-2 rounded border"></div>
        
        <div id="mainContentArea">
            <div id="loadingIndicator" class="text-center py-10">
                <div class="loader"></div>
                <p class="text-sm text-gray-500 mt-4 font-bold">Sistem BaÅŸlatÄ±lÄ±yor...</p>
            </div>
        </div>
    </div>

    <div id="customModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center p-4 z-50">
        <div id="modalContent" class="bg-white rounded-xl p-6 max-w-4xl w-full text-center shadow-2xl overflow-y-auto max-h-[90vh] relative">
            <button id="modalCloseX" class="absolute top-4 right-4 text-gray-500 hover:text-red-600 font-bold text-xl">&times;</button>
            <div id="modalBody"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, serverTimestamp, query, where, getDocs, deleteDoc, getDoc, addDoc, updateDoc, setDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase AyarlarÄ± (Daha Ã¶nceki koddan alÄ±ndÄ±)
        const firebaseConfig = {
            apiKey: "AIzaSyCHhFAHbWnclad6yFuI-Pw9gX6F_Dx1B2c",
            authDomain: "online-sinav-b3644.firebaseapp.com",
            projectId: "online-sinav-b3644",
            storageBucket: "online-sinav-b3644.firebasestorage.app",
            messagingSenderId: "965507531268",
            appId: "1:965507531268:web:94cfd13774a40b6cf16b51"
        };

        let db, auth;
        let isDbConnected = false;
        let adminMasterCode = null; 
        let systemPreparerName = "Sistem YÃ¶neticisi"; 

        let currentExamConfig = { exam_code: "DEFAULT", teacher_name: "Sistem", time_limit: 600, exam_description: "" };
        let quizQuestions = []; 
        let studentList = [];
        let studentData = {};
        let selectedAnswers = [], questionOrder = [], currentQuestionIndex = 0;
        let focusLossCount = 0;
        let timerInterval = null, autoSaveInterval = null, examendTimeStamp = null;
        let currentSessionDocId = null;
        let isTeacherMode = false;
        
        let allSubmissions = [];
        let currentFilteredList = []; 

        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await signInAnonymously(auth);
                onAuthStateChanged(auth, async (user) => { if (user) await checkConnectivity(); });
            } catch (error) { alert("Hata: " + error.message); }
        }

        async function checkConnectivity() {
            const statusDiv = document.getElementById('connectionStatus');
            try {
                const adminSnap = await getDoc(doc(db, "exam_settings", "admin_config"));
                if (adminSnap.exists()) {
                    const data = adminSnap.data();
                    adminMasterCode = data.master_code; 
                    systemPreparerName = data.preparer_name || "Sistem YÃ¶neticisi";
                    isDbConnected = true;
                    statusDiv.innerHTML = "ğŸŸ¢ Sistem Ã‡evrimiÃ§i";
                    statusDiv.className = "mb-4 text-xs font-bold text-center p-2 rounded border bg-green-100 text-green-800 border-green-300";
                } else throw new Error("Admin ayarÄ± yok");
            } catch(e) {
                isDbConnected = false;
                statusDiv.innerHTML = `ğŸ”´ BAÄLANTI YOK - ${e.message}`;
                statusDiv.className = "mb-4 text-xs font-bold text-center p-2 rounded border bg-red-100 text-red-800 border-red-300";
            }
            statusDiv.classList.remove('hidden');
            document.getElementById('loadingIndicator').classList.add('hidden');
            showLoginForm();
        }

        // *** KESÄ°N Ã‡Ã–ZÃœM Ä°Ã‡Ä°N TÃœM ANA FONKSÄ°YONLARI WINDOW'A BAÄLADIK ***
        window.resetApp = function() {
            clearInterval(timerInterval); 
            clearInterval(autoSaveInterval); 
            window.onblur = null;
            document.getElementById('app').className = 'app-card max-w-md';
            isTeacherMode = false; // Modu sÄ±fÄ±rla
            showLoginForm();
        };

        function showLoginForm() {
            document.getElementById('loginHeader').innerHTML = '<h1 class="text-2xl font-extrabold">Ã–ÄŸrenci GiriÅŸi</h1>';
            document.getElementById('mainContentArea').innerHTML = `
                <div class="space-y-4">
                    <div class="text-center p-2 bg-indigo-50 rounded-lg border border-indigo-100">
                        <p class="text-xs text-gray-500">UygulayÄ±cÄ±</p>
                        <p class="font-bold text-indigo-700">${systemPreparerName}</p>
                    </div>
                    <div id="examInfoArea" class="hidden bg-white border border-gray-200 p-4 rounded-lg text-sm shadow-sm"></div>
                    <input id="examCodeInput" type="text" placeholder="SINAV KODU" class="w-full p-3 border rounded-lg uppercase font-bold text-center tracking-widest">
                    <div id="studentLoginFields" class="space-y-4"><p class="text-xs text-center text-gray-400">Liste yÃ¼klenmesi iÃ§in kod giriniz.</p></div>
                    <button id="startQuizButton" class="button w-full bg-indigo-600 text-white font-bold py-3 rounded-lg opacity-50" disabled>SÄ±nava BaÅŸla</button>
                    <div class="text-center pt-4"><button id="teacherLoginButton" class="text-xs text-gray-400 hover:text-gray-600 underline">YÃ¶netici GiriÅŸi</button></div>
                </div>
            `;
            document.getElementById('teacherLoginButton').onclick = showTeacherLogin;
            document.getElementById('startQuizButton').onclick = handleStudentLogin;
            
            let typingTimer;
            document.getElementById('examCodeInput').oninput = (e) => {
                clearTimeout(typingTimer);
                const code = e.target.value.trim().toUpperCase();
                if(code.length < 3) return;
                typingTimer = setTimeout(() => loadExamMetadata(code), 600);
            };
        }

        // ... DiÄŸer yardÄ±mcÄ± fonksiyonlar (loadExamMetadata, handleStudentLogin, seededShuffle, startNewSession, restoreSession) buraya dahil

        async function loadExamMetadata(code) {
            if(!isDbConnected) return;
            const infoArea = document.getElementById('examInfoArea');
            const loginFields = document.getElementById('studentLoginFields');
            infoArea.innerHTML = '<div class="loader w-4 h-4 border-2"></div>'; infoArea.classList.remove('hidden');

            try {
                const configSnap = await getDoc(doc(db, "exam_settings", code));
                const qSnap = await getDoc(doc(db, "questions_pool", code));
                const lSnap = await getDoc(doc(db, "student_lists", code));

                let conf = { time_limit: 600, teacher_name: systemPreparerName, exam_description: "" };
                if(configSnap.exists()) conf = { ...conf, ...configSnap.data() };
                
                currentExamConfig = { exam_code: code, ...conf };
                quizQuestions = qSnap.exists() ? (qSnap.data().questions_list || []) : [];
                studentList = lSnap.exists() ? (lSnap.data().students || []) : [];

                const displayTeacher = conf.teacher_name || systemPreparerName;
                const customName = conf.customName || code;
                
                const descHtml = conf.exam_description ? `<div class="bg-yellow-50 text-yellow-800 p-2 rounded text-xs mb-2 border border-yellow-200 italic">Not: ${conf.exam_description}</div>` : '';

                infoArea.innerHTML = `
                    <p class="font-bold text-lg text-indigo-900 mb-1">${customName}</p>
                    ${descHtml}
                    <div class="flex justify-between items-center mt-1 border-t border-gray-100 pt-2 text-xs text-gray-500 font-semibold">
                        <span>â±ï¸ ${Math.floor(conf.time_limit/60)} Dk</span>
                        <span>ğŸ“ ${quizQuestions.length} Soru</span>
                        <span class="text-indigo-700">ğŸ‘¤ ${displayTeacher}</span>
                    </div>
                `;

                if(studentList.length > 0) {
                    const students = studentList.sort((a,b)=>a.name.localeCompare(b.name, 'tr'));
                    const classes = [...new Set(students.map(s=>s.className))].sort();
                    
                    loginFields.innerHTML = `
                        <select id="classSelector" class="w-full p-3 border rounded-lg font-bold text-indigo-900"><option value="">SÄ±nÄ±f SeÃ§in</option>${classes.map(c=>`<option value="${c}">${c}</option>`).join('')}</select>
                        <select id="studentSelector" class="w-full p-3 border rounded-lg" disabled><option value="">Ä°sim SeÃ§in</option></select>
                        <input id="numberVerify" type="number" placeholder="DoÄŸrulama Ä°Ã§in Okul No" class="w-full p-3 border rounded-lg hidden">
                    `;
                    document.getElementById('classSelector').onchange = (e) => {
                        const val = e.target.value;
                        const sSel = document.getElementById('studentSelector');
                        sSel.innerHTML = '<option value="">Ä°sim SeÃ§in</option>';
                        sSel.disabled = !val;
                        if(val) sSel.innerHTML += students.filter(s=>s.className===val).map(s=>`<option value="${s.number}_${s.name}">${s.name}</option>`).join('');
                    };
                    document.getElementById('studentSelector').onchange = (e) => {
                        if(e.target.value) { document.getElementById('numberVerify').classList.remove('hidden'); document.getElementById('numberVerify').focus(); }
                    };
                    document.getElementById('numberVerify').oninput = (e) => {
                        const btn = document.getElementById('startQuizButton');
                        btn.disabled = !e.target.value; btn.classList.toggle('opacity-50', !e.target.value);
                    };
                } else {
                    loginFields.innerHTML = `
                        <div class="text-xs text-red-500 font-bold mb-2">Liste Yok - Manuel GiriÅŸ</div>
                        <input id="nameInput" placeholder="Ad Soyad" class="w-full p-2 border rounded mb-2">
                        <input id="numberInput" placeholder="Okul No" class="w-full p-2 border rounded mb-2">
                        <input id="classInput" placeholder="SÄ±nÄ±f" class="w-full p-2 border rounded">
                    `;
                    const check = () => {
                        const valid = document.getElementById('nameInput').value && document.getElementById('numberInput').value;
                        const btn = document.getElementById('startQuizButton');
                        btn.disabled = !valid; btn.classList.toggle('opacity-50', !valid);
                    };
                    document.querySelectorAll('input').forEach(i => i.oninput = check);
                }
            } catch(e) { alert(e.message); }
        }

        async function handleStudentLogin() {
            const code = document.getElementById('examCodeInput').value.toUpperCase();
            let name, number, className;

            if(document.getElementById('studentSelector')) {
                const sel = document.getElementById('studentSelector').value;
                const ver = document.getElementById('numberVerify').value;
                if(!sel || !ver) return;
                const [rNum, rName] = sel.split('_');
                if(rNum !== ver) return showModal("Hata", "Numara uyuÅŸmuyor.");
                name = rName; number = rNum; className = document.getElementById('classSelector').value;
            } else {
                name = document.getElementById('nameInput').value;
                number = document.getElementById('numberInput').value;
                className = document.getElementById('classInput').value;
            }

            if(quizQuestions.length === 0) return showModal("Hata", "Soru yok.");
            studentData = { name, number, className, examCode: code };
            const studentKey = `${code}_${number}`;

            // DAHA Ã–NCE GÄ°RDÄ° MÄ°? (Ã–ZELLÄ°K KORUNDU)
            const subQ = query(collection(db, "quiz_submissions"), where("studentKey", "==", studentKey));
            const subSnap = await getDocs(subQ);
            if(!subSnap.empty) return showModal("UyarÄ±", "Bu sÄ±navÄ± daha Ã¶nce tamamladÄ±nÄ±z.");

            // KALDIÄI YERDEN DEVAM (Ã–ZELLÄ°K KORUNDU)
            const sesQ = query(collection(db, "active_sessions"), where("studentKey", "==", studentKey));
            const sesSnap = await getDocs(sesQ);
            if(!sesSnap.empty) {
                showModal("Bilgi", "YarÄ±m bÄ±raktÄ±ÄŸÄ±nÄ±z oturum bulundu. KaldÄ±ÄŸÄ±nÄ±z yerden devam ediyorsunuz.");
                restoreSession({id: sesSnap.docs[0].id, ...sesSnap.docs[0].data()});
            } else {
                startNewSession(number);
            }
            
            startQuizUI();
        }

        function seededShuffle(array, seed) {
            let hash = 0; for (let i = 0; i < seed.length; i++) hash = ((hash << 5) - hash) + seed.charCodeAt(i) | 0;
            const shuffled = [...array]; let m = shuffled.length;
            while (m) { hash = (hash * 9301 + 49297) % 233280; let rnd = hash / 233280.0; let j = Math.floor(rnd * m--); [shuffled[m], shuffled[j]] = [shuffled[j], shuffled[m]]; }
            return shuffled;
        }

        function startNewSession(seed) {
            questionOrder = seededShuffle(Array.from({length: quizQuestions.length}, (_, i) => i), seed);
            selectedAnswers = Array(quizQuestions.length).fill(null);
            currentQuestionIndex = 0; focusLossCount = 0;
            examendTimeStamp = Date.now() + (currentExamConfig.time_limit * 1000);
        }

        function restoreSession(s) {
            questionOrder = s.questionOrder; selectedAnswers = s.selectedAnswers;
            currentQuestionIndex = s.currentQuestionIndex; focusLossCount = s.focusLossCount;
            currentSessionDocId = s.id; examendTimeStamp = Date.now() + (s.timeLeft * 1000);
        }
        
        // --- SINAV EKRANI (Ä°LERÄ°/GERÄ° BUTONLARI Ã‡Ã–ZÃœMÃœ) ---
        function startQuizUI() {
            document.getElementById('app').className = 'app-card max-w-4xl w-full';
            document.getElementById('loginHeader').innerHTML = `<div class="flex justify-between px-4 text-sm"><span>${studentData.name}</span><span>${studentData.examCode}</span></div>`;
            
            document.getElementById('mainContentArea').innerHTML = `
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <div class="font-bold text-indigo-600">Soru: <span id="qInd">1</span>/${quizQuestions.length}</div>
                    <div id="timerDisplay" class="text-xl font-mono font-bold text-white bg-indigo-600 px-3 py-1 rounded shadow">--:--</div>
                </div>
                
                <div id="qArea" class="min-h-[300px]"></div>
                
                <div id="warnArea" class="hidden mt-2 text-center text-red-600 font-bold text-sm bg-red-50 p-2 rounded"></div>
                
                <div class="flex justify-between mt-6">
                    <button id="prevBtn" class="button bg-gray-500 text-white px-4 py-2 rounded disabled:opacity-50 disabled:cursor-not-allowed">Ã–nceki</button>
                    <button id="nextBtn" class="button bg-indigo-600 text-white px-6 py-2 rounded font-bold">Sonraki</button>
                </div>
            `;
            
            renderQuestion(currentQuestionIndex); 
            startTimer(); 
            startAutoSave();
            
            // ODAK KAYBI KONTROLÃœ (Ã–ZELLÄ°K KORUNDU)
            window.onblur = () => { 
                if(!isTeacherMode) { 
                    focusLossCount++; 
                    document.getElementById('warnArea').innerText=`âš ï¸ ${focusLossCount} Kez Odak KaybÄ±!`; 
                    document.getElementById('warnArea').classList.remove('hidden'); 
                    saveProgress(); 
                }
            };

            // --- BUTON OLAYLARI (KESÄ°N Ã‡Ã–ZÃœM) ---
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            // Ä°LERÄ°
            nextBtn.onclick = function() {
                if(currentQuestionIndex < quizQuestions.length - 1) {
                    currentQuestionIndex++;
                    renderQuestion(currentQuestionIndex);
                } else {
                    finishQuiz(); // Son soruda Bitir'e basÄ±nca sÄ±nav biter
                }
            };
            
            // GERÄ°
            prevBtn.onclick = function() {
                if(currentQuestionIndex > 0) {
                    currentQuestionIndex--;
                    renderQuestion(currentQuestionIndex);
                }
            };
        }

        function renderQuestion(idx) {
            const realIdx = questionOrder[idx];
            const q = quizQuestions[realIdx];
            const opts = seededShuffle(q.options, studentData.number + '_q' + realIdx);
            
            document.getElementById('qInd').innerText = idx + 1;
            
            document.getElementById('qArea').innerHTML = `
                <div class="text-lg font-semibold text-gray-800 mb-4 select-none">${idx+1}. ${q.question}</div>
                ${q.image ? `<img src="${q.image}" class="max-h-60 mx-auto mb-4 rounded shadow">` : ''}
                <div class="space-y-3">
                    ${opts.map(o => `
                        <label class="flex items-center p-3 border-2 rounded-lg cursor-pointer hover:bg-gray-50 ${selectedAnswers[realIdx]===o?'border-indigo-500 bg-indigo-50':''}">
                            <input type="radio" name="opt" value="${o}" class="w-5 h-5 text-indigo-600" ${selectedAnswers[realIdx]===o?'checked':''}>
                            <span class="ml-3 font-medium text-gray-700 select-none">${o}</span>
                        </label>
                    `).join('')}
                </div>
            `;
            
            // ÅÄ±k seÃ§imi
            document.querySelectorAll('input[name="opt"]').forEach(el => {
                el.onchange = (e) => { 
                    selectedAnswers[realIdx] = e.target.value; 
                    renderQuestion(idx); 
                    saveProgress(); 
                };
            });

            // Buton DurumlarÄ±nÄ± GÃ¼ncelle
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            prevBtn.disabled = (idx === 0);
            
            if(idx === quizQuestions.length - 1) {
                nextBtn.innerText = "SINAVI BÄ°TÄ°R";
                nextBtn.className = "button bg-green-600 text-white px-6 py-2 rounded font-bold";
            } else {
                nextBtn.innerText = "Sonraki";
                nextBtn.className = "button bg-indigo-600 text-white px-6 py-2 rounded font-bold";
            }
        }
        
        function startTimer() { /* ... aynÄ± kaldÄ± ... */ }
        async function saveProgress() { /* ... aynÄ± kaldÄ± ... */ }
        async function finishQuiz(force=false) { /* ... aynÄ± kaldÄ± ... */ }
        async function showEnhancedResult(data) {
            // ... (HTML kÄ±smÄ±nda Ã‡IKIÅ butonu dÃ¼zeltildi)
            document.getElementById('app').className = 'app-card max-w-2xl';
            document.getElementById('loginHeader').innerHTML = '<h1 class="text-xl font-bold">SonuÃ§ KartÄ±</h1>';
            
            let rankText = "HesaplanÄ±yor...";
            let historyData = [];
            if(isDbConnected) {
                try {
                    const qAll = query(collection(db, "quiz_submissions"), where("examCode", "==", data.examCode));
                    const snapAll = await getDocs(qAll);
                    const scores = snapAll.docs.map(d => parseFloat(d.data().score)).sort((a,b) => b-a);
                    const rank = scores.indexOf(parseFloat(data.score)) + 1;
                    rankText = `<b>${scores.length}</b> kiÅŸi arasÄ±nda <b>${rank}.</b> oldunuz.`;
                    
                    const qHist = query(collection(db, "quiz_submissions"), where("number", "==", data.number), orderBy("timestamp", "asc"));
                    const snapHist = await getDocs(qHist);
                    historyData = snapHist.docs.map(d => ({ label: d.data().examCode, score: d.data().score }));
                } catch(e) { rankText = "SÄ±ralama Ã§evrimdÄ±ÅŸÄ± alÄ±namaz"; }
            }

            document.getElementById('mainContentArea').innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="text-center space-y-3">
                        <div class="text-5xl font-extrabold text-indigo-600">${data.score}</div>
                        <div class="text-gray-500 font-bold">PUAN</div>
                        <div class="bg-yellow-50 p-2 rounded text-yellow-800 text-sm">${rankText}</div>
                        <div class="flex justify-center gap-2 text-sm font-bold">
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded">${data.correct} D</span>
                            <span class="bg-red-100 text-red-800 px-2 py-1 rounded">${data.incorrect} Y</span>
                            <span class="bg-gray-100 text-gray-800 px-2 py-1 rounded">${data.empty} B</span>
                        </div>
                    </div>
                    <div class="bg-white border rounded p-2">
                        <p class="text-xs font-bold text-center mb-2 text-gray-500">GeliÅŸim GrafiÄŸi</p>
                        <canvas id="progressChart" style="max-height:150px"></canvas>
                    </div>
                </div>
                <button onclick="window.resetApp()" class="button w-full mt-6 bg-gray-800 text-white py-3 rounded font-bold">Ã‡IKIÅ</button>
            `;
            if(historyData.length > 0) {
                new Chart(document.getElementById('progressChart'), {
                    type: 'line', data: { labels: historyData.map(h => h.label), datasets: [{ label: 'Puan', data: historyData.map(h => h.score), borderColor: '#4f46e5', tension: 0.3 }] },
                    options: { responsive: true, plugins: { legend: {display: false} }, scales: { y: { beginAtZero: true, max: 100 } } }
                });
            }
        }


        // --- YÃ–NETÄ°CÄ° PANELÄ° (GERÄ° BUTONU Ã‡Ã–ZÃœMÃœ) ---
        function showTeacherLogin() {
            document.getElementById('mainContentArea').innerHTML = `
                <h3 class="font-bold text-center mb-4">YÃ¶netici GiriÅŸi</h3>
                <input id="pass" type="password" placeholder="Åifre" class="w-full p-3 border rounded mb-4">
                <button id="loginBtn" class="button bg-indigo-600 text-white w-full py-2 rounded font-bold">GiriÅŸ</button>
                <button onclick="window.resetApp()" class="w-full mt-2 text-sm text-gray-500 cursor-pointer hover:text-gray-800 underline">Geri DÃ¶n</button>
            `;
            
            document.getElementById('loginBtn').onclick = () => {
                if(document.getElementById('pass').value === adminMasterCode && isDbConnected) {
                    isTeacherMode = true; showDashboard();
                } else alert("HatalÄ± Åifre");
            };
        }

        function showDashboard() {
            document.getElementById('connectionStatus').classList.add('hidden');
            document.getElementById('app').className = 'app-card teacher-mode';
            // Ã‡Ä±kÄ±ÅŸ butonu dÃ¼zeltildi: window.resetApp() kullanÄ±ldÄ±
            document.getElementById('loginHeader').innerHTML = '<div class="flex justify-between px-4"><span>YÃ¶netim Paneli V19</span><button onclick="window.resetApp()" class="text-xs bg-red-500 px-2 py-1 rounded text-white">Ã‡Ä±kÄ±ÅŸ</button></div>';
            document.getElementById('mainContentArea').innerHTML = `
                <div class="flex overflow-x-auto gap-2 mb-4 border-b pb-2">
                    <button onclick="window.switchTab('results')" class="tab-btn bg-indigo-600 text-white px-4 py-2 rounded text-sm font-bold">ğŸ“Š SonuÃ§lar</button>
                    <button onclick="window.switchTab('myexams')" class="tab-btn bg-purple-600 text-white px-4 py-2 rounded text-sm font-bold">ğŸ“‚ SÄ±navlarÄ±m</button>
                    <button onclick="window.switchTab('create')" class="tab-btn bg-gray-600 text-white px-4 py-2 rounded text-sm font-bold">â• Veri YÃ¼kle</button>
                    <button onclick="window.switchTab('settings')" class="tab-btn bg-orange-600 text-white px-4 py-2 rounded text-sm font-bold">âš™ï¸ Ayarlar</button>
                </div>
                <div id="tab-content"></div>
            `;
            
            // switchTab fonksiyonu window'a baÄŸlandÄ±
            window.switchTab = (t) => {
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('bg-indigo-600', 'bg-purple-600', 'bg-gray-600', 'bg-orange-600'));
                if(t==='results') { loadResultsTab(); document.querySelector('[onclick="window.switchTab(\'results\')"]').classList.add('bg-indigo-600'); }
                if(t==='myexams') { loadMyExamsTab(); document.querySelector('[onclick="window.switchTab(\'myexams\')"]').classList.add('bg-purple-600'); }
                if(t==='create') { loadCreateTab(); document.querySelector('[onclick="window.switchTab(\'create\')"]').classList.add('bg-gray-600'); }
                if(t==='settings') { loadSettingsTab(); document.querySelector('[onclick="window.switchTab(\'settings\')"]').classList.add('bg-orange-600'); }
            };
            window.switchTab('results');
        }

        // --- YÃ–NETÄ°CÄ° PANELÄ° Ä°ÅLEM FONKSÄ°YONLARI (Hepsi window'a baÄŸlandÄ±) ---

        function loadResultsTab() { /* ... aynÄ± kaldÄ±, butonlara window. Ã¶neki eklendi ... */
            const div = document.getElementById('tab-content');
            div.innerHTML = `
                <div class="bg-gray-50 p-3 rounded border mb-3">
                    <div class="flex gap-2 mb-2">
                        <input id="fCode" placeholder="SÄ±nav Kodu" class="border p-2 rounded text-sm flex-1">
                        <input id="fClass" placeholder="SÄ±nÄ±f" class="border p-2 rounded text-sm w-32">
                        <input id="fName" placeholder="Ã–ÄŸrenci AdÄ±" class="border p-2 rounded text-sm flex-1">
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="window.deleteSelected()" class="bg-red-100 text-red-700 px-3 py-1 rounded text-xs hover:bg-red-200 font-bold border border-red-300">SeÃ§ilenleri Sil</button>
                        <button onclick="window.deleteFiltered()" class="bg-red-600 text-white px-3 py-1 rounded text-xs hover:bg-red-700 font-bold shadow">Toplu Sil</button>
                        <div class="flex-grow"></div>
                        <button onclick="window.downloadExcelStandard()" class="bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700 font-bold shadow">Ã–zet Excel</button>
                        <button onclick="window.downloadExcelDetailed()" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700 font-bold shadow">Cevap Excel</button>
                    </div>
                </div>
                <div class="overflow-auto border rounded max-h-[500px]">
                    <table class="min-w-full text-sm divide-y">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="p-2 text-left w-8"><input type="checkbox" id="selectAll"></th>
                                <th class="p-2 text-left">SÄ±nÄ±f</th>
                                <th class="p-2 text-left">No</th>
                                <th class="p-2 text-left">Ad Soyad</th>
                                <th class="p-2 text-left">Kod</th>
                                <th class="p-2 text-left">Puan</th>
                                <th class="p-2 text-left">D/Y/B</th>
                                <th class="p-2 text-left">SÃ¼re</th>
                                <th class="p-2 text-left">Odak</th>
                                <th class="p-2 text-left">IP Adresi</th>
                                <th class="p-2 text-left">Ä°ÅŸlem</th>
                            </tr>
                        </thead>
                        <tbody id="resBody" class="divide-y bg-white"></tbody>
                    </table>
                </div>
                <div id="resultCount" class="text-xs text-gray-500 mt-1 font-bold"></div>
            `;
            
            onSnapshot(query(collection(db, "quiz_submissions"), orderBy("timestamp", "desc")), (snap) => {
                allSubmissions = snap.docs.map(d => ({id:d.id, ...d.data()}));
                filterAndRender();
            });

            const filterAndRender = () => {
                const c = document.getElementById('fCode').value.toLowerCase();
                const cl = document.getElementById('fClass').value.toLowerCase();
                const n = document.getElementById('fName').value.toLowerCase();

                currentFilteredList = allSubmissions.filter(s => 
                    (s.examCode||'').toLowerCase().includes(c) && 
                    (s.className||'').toLowerCase().includes(cl) && 
                    (s.name||'').toLowerCase().includes(n)
                );

                const body = document.getElementById('resBody');
                body.innerHTML = currentFilteredList.map(s => `
                    <tr class="hover:bg-gray-50">
                        <td class="p-2"><input type="checkbox" class="row-check" value="${s.id}"></td>
                        <td class="p-2 font-bold text-gray-600">${s.className}</td>
                        <td class="p-2">${s.number}</td>
                        <td class="p-2 font-semibold">${s.name}</td>
                        <td class="p-2 font-mono text-xs text-indigo-600">${s.examCode}</td>
                        <td class="p-2 font-bold ${s.score>=50?'text-green-600':'text-red-600'}">${s.score}</td>
                        <td class="p-2 text-xs">${s.correct}/${s.incorrect}/${s.empty}</td>
                        <td class="p-2 text-xs">${Math.floor((s.timeSpent||0)/60)} dk</td>
                        <td class="p-2 text-center font-bold ${s.focusLossCount>0?'text-red-600 bg-red-50 rounded':''}">${s.focusLossCount||0}</td>
                        <td class="p-2 text-xs text-gray-500 font-mono">${s.ipAddress||'-'}</td>
                        <td class="p-2">
                            <button onclick="window.showAnsDetail('${s.id}')" class="text-blue-600 hover:underline text-xs font-bold">Detay</button>
                        </td>
                    </tr>
                `).join('');
                document.getElementById('resultCount').innerText = `Listelenen: ${currentFilteredList.length}`;
            };

            document.getElementById('fCode').oninput = filterAndRender;
            document.getElementById('fClass').oninput = filterAndRender;
            document.getElementById('fName').oninput = filterAndRender;
            document.getElementById('selectAll').onclick = (e) => { document.querySelectorAll('.row-check').forEach(c => c.checked = e.target.checked); }
        }

        window.deleteSelected = async () => { /* ... aynÄ± kaldÄ± ... */
            const checks = document.querySelectorAll('.row-check:checked');
            if(checks.length === 0) return alert("SeÃ§im yapÄ±nÄ±z.");
            if(!confirm(`${checks.length} kayÄ±t silinsin mi?`)) return;
            for(const c of checks) await deleteDoc(doc(db, "quiz_submissions", c.value));
        }
        window.deleteFiltered = async () => { /* ... aynÄ± kaldÄ± ... */
            const count = currentFilteredList.length;
            if(count === 0) return;
            if(!confirm(`Listedeki ${count} kaydÄ±n TÃœMÃœ silinsin mi?`)) return;
            for(const s of currentFilteredList) await deleteDoc(doc(db, "quiz_submissions", s.id));
        }

        window.downloadExcelStandard = () => { /* ... aynÄ± kaldÄ± ... */ }
        window.downloadExcelDetailed = () => { /* ... aynÄ± kaldÄ± ... */ }
        window.showAnsDetail = async (id) => { /* ... aynÄ± kaldÄ± ... */ }

        async function loadMyExamsTab() { /* ... aynÄ± kaldÄ±, butonlara window. Ã¶neki eklendi ... */
            const div = document.getElementById('tab-content');
            div.innerHTML = '<div class="loader"></div>';
            const snaps = await getDocs(collection(db, "exam_settings"));
            let html = '<div class="grid grid-cols-1 lg:grid-cols-2 gap-4">';
            if(snaps.empty) { div.innerHTML = "SÄ±nav bulunamadÄ±."; return; }
            for(const d of snaps.docs) {
                if(d.id === 'admin_config') continue;
                const conf = d.data(); const code = d.id;
                html += `
                    <div class="border rounded-lg p-4 shadow-sm bg-white relative">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1"><input id="name_${code}" value="${conf.customName || code}" class="font-bold text-lg text-indigo-700 border-b border-dashed border-gray-300 w-full bg-transparent"><button onclick="window.saveExamName('${code}')" class="text-xs text-green-600 mt-1">ğŸ’¾ Ä°smi Kaydet</button></div>
                            <button onclick="window.deleteDeep('${code}')" class="bg-red-50 text-red-600 px-2 py-1 rounded text-xs hover:bg-red-600 hover:text-white">ğŸ—‘ï¸ Sil</button>
                        </div>
                        <div class="text-sm text-gray-600 mt-2">SÃ¼re: ${Math.floor(conf.time_limit/60)} dk | Hoca: ${conf.teacher_name||'-'}</div>
                        ${conf.exam_description ? `<div class="text-xs bg-yellow-50 p-1 mt-2 border rounded text-gray-600 italic">${conf.exam_description}</div>` : ''}
                        <div class="flex gap-2 mt-3"><button onclick="window.showListDetail('${code}')" class="text-xs bg-gray-100 px-2 py-1 rounded hover:bg-gray-200">Liste GÃ¶r</button><button onclick="window.showQuestionDetail('${code}')" class="text-xs bg-gray-100 px-2 py-1 rounded hover:bg-gray-200">SorularÄ± GÃ¶r</button></div>
                    </div>`;
            }
            div.innerHTML = html + '</div>';
        }
        
        window.saveExamName = async (c) => { await updateDoc(doc(db, "exam_settings", c), { customName: document.getElementById('name_'+c).value }); alert("Kaydedildi"); }
        window.deleteDeep = async (c) => { if(confirm("Bu sÄ±nav ve tÃ¼m verileri silinecek?")) { await deleteDoc(doc(db,"exam_settings",c)); await deleteDoc(doc(db,"questions_pool",c)); await deleteDoc(doc(db,"student_lists",c)); const q=query(collection(db,"quiz_submissions"),where("examCode","==",c));const s=await getDocs(q);s.forEach(d=>deleteDoc(d.ref)); alert("Silindi"); loadMyExamsTab(); } }
        window.showListDetail = async(c) => { const s=await getDoc(doc(db,"student_lists",c)); const l=s.exists()?s.data().students:[]; let h=`<h3>${c} Listesi</h3><div class="max-h-60 overflow-auto">`; l.sort((a,b)=>a.className.localeCompare(b.className)).forEach(x=>h+=`<div>${x.className} - ${x.number} - ${x.name}</div>`); showModal("Liste", h+"</div>", true); }
        window.showQuestionDetail = async(c) => { const s=await getDoc(doc(db,"questions_pool",c)); const l=s.exists()?s.data().questions_list:[]; let h=`<h3>${c} Sorular</h3><div class="max-h-60 overflow-auto space-y-2">`; l.forEach((q,i)=>h+=`<div class="border p-1"><p class="font-bold text-xs">Soru ${i+1} (${q.answer})</p><p class="text-xs">${q.question}</p></div>`); showModal("Sorular", h+"</div>", true); }

        function loadCreateTab() {
            document.getElementById('tab-content').innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="border p-4 rounded"><h3 class="font-bold mb-2 text-orange-600">Soru YÃ¼kle (JSON)</h3><input id="qCode" placeholder="Kod" class="w-full mb-2 p-2 border rounded uppercase"><textarea id="qJson" class="w-full h-32 border text-xs font-mono" placeholder='[{"question":"...","options":["A"],"answer":"A"}]'></textarea><button onclick="window.uploadQ()" class="bg-orange-600 text-white w-full py-2 rounded font-bold">YÃ¼kle</button></div>
                    <div class="border p-4 rounded"><h3 class="font-bold mb-2 text-teal-600">Liste YÃ¼kle (Excel Copy)</h3><input id="lCode" placeholder="Kod" class="w-full mb-2 p-2 border rounded uppercase"><textarea id="lText" class="w-full h-32 border text-xs" placeholder="No | SÄ±nÄ±f | Ad Soyad"></textarea><button onclick="window.uploadL()" class="bg-teal-600 text-white w-full py-2 rounded font-bold">YÃ¼kle</button></div>
                    <div class="border p-4 rounded col-span-1 md:col-span-2">
                        <h3 class="font-bold mb-2">SÄ±nav AyarÄ± (OluÅŸtur/GÃ¼ncelle)</h3>
                        <div class="flex flex-wrap gap-2">
                            <input id="sCode" placeholder="Kod (ZORUNLU)" class="border p-2 uppercase w-32 bg-gray-50 font-bold">
                            <input id="sName" placeholder="GÃ¶rÃ¼nen Ad (Ã–rn: Mat-1)" class="border p-2 w-48">
                            <input id="sTime" type="number" placeholder="SÃ¼re (Dk)" class="border p-2 w-24">
                            <input id="sTeach" placeholder="Ã–ÄŸretmen" class="border p-2 w-48">
                            <input id="sDesc" placeholder="SÄ±nav AÃ§Ä±klamasÄ± (Ä°steÄŸe BaÄŸlÄ±)" class="border p-2 flex-grow">
                            <button onclick="window.createSettings()" class="bg-gray-700 text-white px-4 rounded font-bold">KAYDET</button>
                        </div>
                    </div>
                </div>`;
        }
        window.uploadQ = async() => { try{await setDoc(doc(db,"questions_pool",document.getElementById('qCode').value.toUpperCase()),{questions_list:JSON.parse(document.getElementById('qJson').value)});alert("YÃ¼klendi");}catch(e){alert(e.message);} }
        window.uploadL = async() => { const c=document.getElementById('lCode').value.toUpperCase(); const l=document.getElementById('lText').value.split('\n').filter(x=>x.trim()); const s=[]; l.forEach(x=>{const p=x.split('\t');if(p.length>=3)s.push({number:p[0].trim(),className:p[1].trim(),name:p[2].trim()})}); await setDoc(doc(db,"student_lists",c),{students:s}); alert(`${s.length} kiÅŸi yÃ¼klendi`); }
        window.createSettings = async() => { 
            const c = document.getElementById('sCode').value.toUpperCase();
            if(!c) return alert("SÄ±nav kodu giriniz.");
            await setDoc(doc(db,"exam_settings",c),{
                customName:document.getElementById('sName').value,
                time_limit:(parseInt(document.getElementById('sTime').value)||10)*60,
                teacher_name:document.getElementById('sTeach').value,
                exam_description:document.getElementById('sDesc').value 
            },{merge:true}); 
            alert("Ayarlar Kaydedildi"); 
        }

        function loadSettingsTab() {
            document.getElementById('tab-content').innerHTML = `<div class="max-w-md mx-auto space-y-4"><div class="bg-indigo-50 p-4 rounded"><label class="font-bold">Sistem HazÄ±rlayan AdÄ±</label><input id="sysPrepName" value="${systemPreparerName}" class="w-full p-2 border rounded mb-2"><button onclick="window.saveSystemName()" class="bg-indigo-600 text-white px-4 py-2 rounded w-full">Ä°smi Kaydet</button></div><div class="bg-red-50 p-4 rounded"><label class="font-bold">Admin Åifresi</label><input id="newPass" type="password" class="w-full p-2 border rounded mb-2"><button onclick="window.savePass()" class="bg-red-600 text-white px-4 py-2 rounded w-full">Åifreyi DeÄŸiÅŸtir</button></div></div>`;
        }
        window.saveSystemName = async() => { await updateDoc(doc(db,"exam_settings","admin_config"),{preparer_name:document.getElementById('sysPrepName').value}); alert("Kaydedildi"); }
        window.savePass = async() => { if(confirm("Emin misiniz?")){ await updateDoc(doc(db,"exam_settings","admin_config"),{master_code:document.getElementById('newPass').value}); alert("DeÄŸiÅŸti"); } }

        function showModal(t,c,h=false) { 
            const m=document.getElementById('customModal'); 
            document.getElementById('modalBody').innerHTML=h?c:`<h3 class="font-bold mb-2">${t}</h3><p>${c}</p><button onclick="document.getElementById('customModal').classList.add('hidden')" class="bg-indigo-600 text-white px-4 py-2 mt-4 rounded">Tamam</button>`; 
            m.classList.remove('hidden'); 
            m.classList.add('flex'); 
            document.getElementById('modalCloseX').onclick=()=>{m.classList.add('hidden');m.classList.remove('flex');}; 
        }

        initializeFirebase();
    </script>
</body>
</html>
