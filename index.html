<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sƒ±nav Sistemi V15 (Geli≈ümi≈ü √ñzellikler)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0;}
        .app-card { background-color:white;padding:2.5rem;border-radius:1.5rem;box-shadow:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05);max-width:450px;width:90%;transition:all .3s;position:relative;}
        .header-bg { background: linear-gradient(135deg,#4f46e5 0%,#818cf8 100%); color:white;padding:1rem 0;border-radius:1rem 1rem 0 0;margin:-2.5rem -2.5rem 1.5rem -2.5rem;text-align:center;}
        .button{transition:all .2s;box-shadow:0 4px 6px rgba(0,0,0,0.1)}
        .button:hover{transform:translateY(-1px);box-shadow:0 6px 10px rgba(0,0,0,0.15)}
        .teacher-mode { max-width: 1400px !important; width: 98% !important; } 
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .paste-area { 
            border: 2px dashed #cbd5e0; 
            border-radius: 0.5rem; 
            padding: 1rem; 
            background-color: #f9fafb; 
            cursor: text;
            min-height: 120px;
        }
        .paste-area:focus {
            outline: none;
            border-color: #4f46e5;
        }
    </style>
</head>
<body>

    <div id="app" class="app-card">
        <div id="loginHeader" class="header-bg">
            <h1 class="text-2xl font-extrabold">√ñƒürenci Giri≈üi</h1>
        </div>
        
        <div id="connectionStatus" class="hidden mb-4 text-xs font-bold text-center p-2 rounded border"></div>
        
        <div id="mainContentArea">
            <div id="loadingIndicator" class="text-center py-10">
                <div class="loader"></div>
                <p id="loadingText" class="text-sm text-gray-500 mt-4 font-bold">Sistem Ba≈ülatƒ±lƒ±yor...</p>
            </div>
        </div>
    </div>

    <div id="customModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center p-4 z-50">
        <div id="modalContent" class="bg-white rounded-xl p-6 max-w-3xl w-full text-center shadow-2xl overflow-y-auto max-h-[90vh]"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getFirestore, 
            doc, 
            collection, 
            onSnapshot, 
            serverTimestamp, 
            query, 
            where, 
            getDocs, 
            deleteDoc, 
            getDoc, 
            addDoc, 
            updateDoc, 
            setDoc, 
            orderBy,
            limit
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // D√úZELTƒ∞LMƒ∞≈û Firebase Config - Obfuscation KALDIRILDI
      const firebaseConfig = {
            apiKey: "AIzaSyCHhFAHbWnclad6yFuI-Pw9gX6F_Dx1B2c",
            authDomain: "online-sinav-b3644.firebaseapp.com",
            projectId: "online-sinav-b3644",
            storageBucket: "online-sinav-b3644.firebasestorage.app",
            messagingSenderId: "965507531268",
            appId: "1:965507531268:web:94cfd13774a40b6cf16b51"
        };

        // --- Global Deƒüi≈ükenler ---
        let db, auth;
        let isAuthReady = false, isDbConnected = false;
        let adminMasterCode = null;
        let systemPreparerName = "Sistem Y√∂neticisi";

        let currentExamConfig = {
            exam_code: "DEFAULT",
            teacher_name: "Y√ºkleniyor...",
            time_limit: 600,
            exam_description: "Sƒ±nav bilgisi bekleniyor..."
        };
        
        let quizQuestions = [];
        let studentList = [];
        
        // Sƒ±nav Oturum Deƒüi≈ükenleri
        let studentData = {};
        let selectedAnswers = [];
        let questionOrder = [];
        let currentQuestionIndex = 0;
        let focusLossCount = 0;
        let currentSessionDocId = null;
        
        // Timer Deƒüi≈ükenleri
        let timerInterval = null;
        let examendTimeStamp = null;
        let autoSaveInterval = null;
        
        // Admin ve Tablo Verileri
        let allSubmissions = [];
        let isTeacherMode = false;

        // --- INPUT VALIDATION FONKSƒ∞YONLARI ---
        function sanitizeInput(input) {
            if (typeof input !== 'string') return '';
            return input
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/'/g, '&#x27;')
                .replace(/"/g, '&quot;')
                .substring(0, 500);
        }

        function sanitizeExamCode(code) {
            if (typeof code !== 'string') return '';
            return code.replace(/[^a-zA-Z0-9_]/g, '').toUpperCase().substring(0, 20);
        }

        function validateStudentData(student) {
            if (!student || typeof student !== 'object') return false;
            
            return (
                typeof student.name === 'string' && student.name.trim().length > 0 &&
                typeof student.number === 'string' && student.number.trim().length > 0 &&
                typeof student.className === 'string' && student.className.trim().length > 0
            );
        }

        // Helper: Firebase Referanslarƒ±
        const getConfigRef = (code) => doc(db, "exam_settings", sanitizeExamCode(code));
        const getQuestionsRef = (code) => doc(db, "questions_pool", sanitizeExamCode(code));

        // --- Sƒ∞STEM BA≈ûLATMA ---
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await signInAnonymously(auth);
                onAuthStateChanged(auth, async (user) => {
                    if (user) { 
                        isAuthReady = true; 
                        await checkConnectivity(); 
                    }
                });
            } catch (error) { 
                showCustomAlert("Kritik Hata", "Firebase ba≈ülatƒ±lamadƒ±: " + error.message);
            }
        }

        // --- G√úVENLƒ∞ BAƒûLANTI KONTROL√ú ---
        async function checkConnectivity() {
            const statusDiv = document.getElementById('connectionStatus');
            try {
                // Admin config √ßekmeyi dene
                const adminSnap = await getDoc(doc(db, "exam_settings", "admin_config"));
                
                if (adminSnap.exists()) {
                    const data = adminSnap.data();
                    adminMasterCode = data.master_code;
                    systemPreparerName = data.preparer_name || "Sistem Y√∂neticisi";
                    
                    isDbConnected = true;
                    statusDiv.innerHTML = "üü¢ Sistem √áevrimi√ßi";
                    statusDiv.className = "mb-4 text-xs font-bold text-center p-2 rounded border bg-green-100 text-green-800 border-green-300";
                } else {
                    throw new Error("Admin konfig√ºrasyonu eksik.");
                }
            } catch(e) {
                isDbConnected = false;
                adminMasterCode = null;
                statusDiv.innerHTML = `üî¥ BAƒûLANTI/VERƒ∞ HATASI<br><span class='text-[10px] font-normal'>${e.message}</span>`;
                statusDiv.className = "mb-4 text-xs font-bold text-center p-2 rounded border bg-red-100 text-red-800 border-red-300";
            }
            
            statusDiv.classList.remove('hidden');
            document.getElementById('loadingIndicator').classList.add('hidden');
            showLoginForm();
        }

        // --- RESET FONKSƒ∞YONU (Geli≈ütirilmi≈ü) ---
        function resetApp() {
            // T√ºm interval'leri temizle
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
                autoSaveInterval = null;
            }
            
            // Event listener'larƒ± temizle
            window.onblur = null;
            document.oncontextmenu = null;
            
            // Global deƒüi≈ükenleri resetle
            currentExamConfig = { exam_code: "DEFAULT", teacher_name: systemPreparerName, time_limit: 600, exam_description: "..." };
            quizQuestions = [];
            studentList = [];
            studentData = {};
            selectedAnswers = [];
            questionOrder = [];
            currentQuestionIndex = 0;
            focusLossCount = 0;
            currentSessionDocId = null;
            examendTimeStamp = null;
            isTeacherMode = false;

            // UI Sƒ±fƒ±rla
            document.getElementById('app').className = 'app-card max-w-md';
            document.getElementById('connectionStatus').classList.remove('hidden');
            showLoginForm();
        }

        // --- SINAV VERƒ∞Sƒ∞ √áEKME ---
        async function fetchExamData(code) {
            if (!isDbConnected) return false;
            
            try {
                // 1. Ayarlarƒ± √áek
                const configSnap = await getDoc(getConfigRef(code));
                if (configSnap.exists()) {
                    currentExamConfig = { exam_code: sanitizeExamCode(code), ...configSnap.data() };
                } else {
                    currentExamConfig = { 
                        exam_code: sanitizeExamCode(code), 
                        teacher_name: systemPreparerName, 
                        time_limit: 600, 
                        exam_description: "Sƒ±nav ayarlarƒ± bulunamadƒ±." 
                    };
                }

                // 2. Sorularƒ± √áek
                const questionsSnap = await getDoc(getQuestionsRef(code));
                quizQuestions = questionsSnap.exists() ? (questionsSnap.data().questions_list || []) : [];
                
                // 3. √ñƒürenci Listesini √áek
                const listSnap = await getDoc(doc(db, "student_lists", sanitizeExamCode(code)));
                studentList = listSnap.exists() ? (listSnap.data().students || []) : [];

                return true;
            } catch(e) {
                console.error(e);
                return false;
            }
        }

        // --- Gƒ∞Rƒ∞≈û EKRANI ---
        function showLoginForm() {
            document.getElementById('loginHeader').innerHTML = '<h1 class="text-2xl font-extrabold">√ñƒürenci Giri≈üi</h1>';
            
            document.getElementById('mainContentArea').innerHTML = `
                <div class="space-y-4">
                    <div class="text-center p-2 bg-indigo-50 rounded-lg border border-indigo-100">
                        <p class="text-xs text-gray-500">Uygulayƒ±cƒ±</p>
                        <p class="font-bold text-indigo-700">${currentExamConfig.teacher_name}</p>
                    </div>
                    
                    <div id="examInfoArea" class="hidden bg-yellow-50 border border-yellow-200 p-3 rounded-lg text-sm text-yellow-800"></div>
                    
                    <input id="examCodeInput" type="text" placeholder="SINAV KODU (√ñrn: 9A_MAT)" class="w-full p-3 border rounded-lg uppercase font-bold text-center tracking-widest">
                    
                    <div id="studentLoginFields" class="space-y-4">
                        <p class="text-sm text-center text-gray-400 italic mt-2">Sƒ±nav kodunu girince liste a√ßƒ±lacaktƒ±r.</p>
                    </div>

                    <button id="startQuizButton" class="button w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg shadow-lg opacity-50 cursor-not-allowed" disabled>Sƒ±nava Ba≈üla</button>
                    
                    <div class="border-t pt-4 mt-4">
                        <button id="teacherLoginButton" class="text-gray-400 hover:text-gray-600 text-xs w-full text-center">Y√∂netici Giri≈üi</button>
                    </div>
                </div>
            `;

            // Event Listeners
            document.getElementById('teacherLoginButton').onclick = showTeacherLogin;
            document.getElementById('examCodeInput').oninput = handleCodeEntry;
            document.getElementById('startQuizButton').onclick = handleStudentLogin;
        }

        // Kod Girildik√ße √áalƒ±≈üan Fonksiyon
        let typingTimer;
        async function handleCodeEntry() {
            clearTimeout(typingTimer);
            const code = sanitizeExamCode(document.getElementById('examCodeInput').value.trim());
            const infoArea = document.getElementById('examInfoArea');
            const loginFields = document.getElementById('studentLoginFields');
            const btn = document.getElementById('startQuizButton');

            if (code.length < 3) {
                infoArea.classList.add('hidden');
                return;
            }

            typingTimer = setTimeout(async () => {
                const success = await fetchExamData(code);
                // --- 1. ADIM: BURAYI YAPI≈ûTIRIN (handleCodeEntry i√ßine) ---
                
                // Sƒ±navƒ±n aktiflik durumunu kontrol et (Varsayƒ±lan: true)
                const isExamActive = currentExamConfig.is_active !== false; 

                if (success && !isExamActive) {
                    infoArea.innerHTML = `
                        <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded shadow-md" role="alert">
                            <p class="font-bold text-lg">‚õî Sƒ±nav Eri≈üimi Kapalƒ±</p>
                            <p>Bu sƒ±nav ≈üu anda oturuma kapalƒ±dƒ±r. S√ºre dolmu≈ü veya sƒ±nav hen√ºz ba≈ülatƒ±lmamƒ±≈ü olabilir.</p>
                            <p class="text-xs mt-2 font-semibold">L√ºtfen √∂ƒüretmeninizle ileti≈üime ge√ßiniz.</p>
                        </div>
                    `;
                    infoArea.classList.remove('hidden');
                    loginFields.innerHTML = ''; // Giri≈ü alanlarƒ±nƒ± temizle
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                    return; // ƒ∞≈ülemi durdur
                }
                // --- 1. ADIM Bƒ∞Tƒ∞≈û ---
                // Sƒ±nav Bilgisi G√∂ster
                const mins = Math.floor(currentExamConfig.time_limit / 60);
                infoArea.innerHTML = `
                    <p class="font-bold">Sƒ±nav: ${code}</p>
                    <p>${sanitizeInput(currentExamConfig.exam_description)}</p>
                    <p class="text-xs mt-1">‚è±Ô∏è S√ºre: ${mins} Dakika | üìù Soru: ${quizQuestions.length}</p>
                `;
                infoArea.classList.remove('hidden');

                if (!success || studentList.length === 0) {
                    // Manuel Giri≈ü Modu
                    loginFields.innerHTML = `
                        <div class="bg-red-50 p-2 rounded text-xs text-red-700 mb-2">‚ö†Ô∏è Bu kod i√ßin √∂ƒürenci listesi bulunamadƒ±. Manuel giri≈ü yapƒ±nƒ±z.</div>
                        <input id="nameInput" type="text" placeholder="Ad Soyad" class="w-full p-3 border rounded-lg">
                        <input id="numberInput" type="number" placeholder="Okul No" class="w-full p-3 border rounded-lg">
                        <input id="classInput" type="text" placeholder="Sƒ±nƒ±f (√ñrn: 10A)" class="w-full p-3 border rounded-lg">
                    `;
                    // Manuel giri≈ü validasyonu
                    const checkManual = () => {
                         const valid = document.getElementById('nameInput').value && document.getElementById('numberInput').value && document.getElementById('classInput').value;
                         btn.disabled = !valid;
                         btn.classList.toggle('opacity-50', !valid);
                         btn.classList.toggle('cursor-not-allowed', !valid);
                    };
                    document.getElementById('nameInput').oninput = checkManual;
                    document.getElementById('numberInput').oninput = checkManual;
                    document.getElementById('classInput').oninput = checkManual;

                } else {
                    // Liste Modu
                    const students = studentList.sort((a, b) => a.name.localeCompare(b.name, 'tr'));
                    const classes = [...new Set(students.map(s => s.className))].sort();

                    loginFields.innerHTML = `
                        <select id="classSelector" class="w-full p-3 border rounded-lg font-bold text-indigo-700 bg-white">
                            <option value="">-- Sƒ±nƒ±fƒ±nƒ±zƒ± Se√ßin --</option>
                            ${classes.map(c => `<option value="${sanitizeInput(c)}">${sanitizeInput(c)}</option>`).join('')}
                        </select>
                        <select id="studentSelector" class="w-full p-3 border rounded-lg bg-gray-100" disabled>
                            <option value="">-- √ñnce Sƒ±nƒ±f Se√ßin --</option>
                        </select>
                        <div id="verificationArea" class="hidden mt-2">
                            <input id="numberVerify" type="number" placeholder="Doƒürulama i√ßin Okul Numaranƒ±z" class="w-full p-3 border-2 border-indigo-300 rounded-lg focus:ring-indigo-500">
                        </div>
                    `;

                    document.getElementById('classSelector').onchange = (e) => {
                        const cls = e.target.value;
                        const stuSel = document.getElementById('studentSelector');
                        stuSel.innerHTML = '<option value="">-- Adƒ±nƒ±zƒ± Se√ßin --</option>';
                        stuSel.disabled = !cls;
                        stuSel.classList.toggle('bg-gray-100', !cls);
                        document.getElementById('verificationArea').classList.add('hidden');
                        btn.disabled = true;
                        
                        if (cls) {
                            const filtered = students.filter(s => s.className === cls);
                            stuSel.innerHTML += filtered.map(s => `<option value="${s.number}_${s.name}">${sanitizeInput(s.name)}</option>`).join('');
                        }
                    };

                    document.getElementById('studentSelector').onchange = (e) => {
                         const verifArea = document.getElementById('verificationArea');
                         if(e.target.value) {
                             verifArea.classList.remove('hidden');
                             document.getElementById('numberVerify').focus();
                         } else {
                             verifArea.classList.add('hidden');
                         }
                    };

                    document.getElementById('numberVerify').oninput = (e) => {
                        const val = e.target.value;
                        btn.disabled = !val;
                        btn.classList.toggle('opacity-50', !val);
                        btn.classList.toggle('cursor-not-allowed', !val);
                    };
                }
            }, 500);
        }

        // √ñƒürenci Giri≈ü ƒ∞≈ülemi
        async function handleStudentLogin() {
            const code = sanitizeExamCode(document.getElementById('examCodeInput').value.trim());
            if (!code) {
                showCustomAlert("Hata", "Ge√ßersiz sƒ±nav kodu.");
                return;
            }

            let name, number, className;
            
            if (document.getElementById('studentSelector')) {
                // Liste Modu
                const selVal = document.getElementById('studentSelector').value;
                const inputNum = document.getElementById('numberVerify').value;
                if (!selVal || !inputNum) {
                    showCustomAlert("Hata", "Eksik bilgi.");
                    return;
                }

                const [realNum, realName] = selVal.split('_');
                
                if (realNum !== inputNum) {
                    return showCustomAlert("Hatalƒ± Doƒürulama", "Se√ßtiƒüiniz ismin okul numarasƒ± ile girdiƒüiniz numara e≈üle≈ümiyor.");
                }
                name = sanitizeInput(realName);
                number = realNum;
                className = sanitizeInput(document.getElementById('classSelector').value);
            } else {
                // Manuel Mod
                name = sanitizeInput(document.getElementById('nameInput').value);
                number = document.getElementById('numberInput').value;
                className = sanitizeInput(document.getElementById('classInput').value);
            }

            if (!name || !number || !className) {
                showCustomAlert("Hata", "T√ºm alanlarƒ± doldurun.");
                return;
            }

            if (quizQuestions.length === 0) return showCustomAlert("Hata", "Bu sƒ±navda hi√ß soru yok.");

            studentData = { name, number, className, examCode: code };
            
            // M√ºkerrer Giri≈ü ve Kaldƒ±ƒüƒ± Yerden Devam Kontrol√º
            const studentKey = `${code}_${number}`;
            const loadBtn = document.getElementById('startQuizButton');
            loadBtn.innerText = "Kontrol Ediliyor..."; loadBtn.disabled = true;

            try {
                // 1. Daha √∂nce bitirmi≈ü mi?
                const subQ = query(collection(db, "quiz_submissions"), where("studentKey", "==", studentKey));
                const subSnap = await getDocs(subQ);
                if (!subSnap.empty) {
                    loadBtn.innerText = "Giri≈ü"; loadBtn.disabled = false;
                    return showCustomAlert("Sƒ±nav Tamamlandƒ±", "Bu sƒ±navƒ± zaten tamamladƒ±nƒ±z.");
                }

                // 2. Aktif oturum var mƒ±?
                const sesQ = query(collection(db, "active_sessions"), where("studentKey", "==", studentKey));
                const sesSnap = await getDocs(sesQ);
                
                if (!sesSnap.empty) {
                    const session = sesSnap.docs[0].data();
                    showCustomAlert("Devam Ediliyor", "√ñnceki oturumunuz bulundu, kaldƒ±ƒüƒ±nƒ±z yerden devam ediyorsunuz.").then(() => {
                        restoreSession({ id: sesSnap.docs[0].id, ...session });
                        startQuiz();
                    });
                } else {
                    startNewSession(number);
                    startQuiz();
                }

            } catch(e) {
                showCustomAlert("Hata", "Giri≈ü yapƒ±lƒ±rken hata olu≈ütu: " + e.message);
                loadBtn.innerText = "Sƒ±nava Ba≈üla"; loadBtn.disabled = false;
            }
        }

        // --- OTURUM Y√ñNETƒ∞Mƒ∞ ---
        function seededShuffle(array, seed) {
            let hash = 0;
            for (let i = 0; i < seed.length; i++) hash = ((hash << 5) - hash) + seed.charCodeAt(i) | 0;
            const shuffled = [...array];
            let n = shuffled.length;
            while (n > 1) {
                hash = (hash * 9301 + 49297) % 233280;
                let random = (hash < 0 ? hash + 233280 : hash) / 233280.0;
                let k = Math.floor(random * n--);
                [shuffled[n], shuffled[k]] = [shuffled[k], shuffled[n]];
            }
            return shuffled;
        }

        function startNewSession(seed) {
            questionOrder = seededShuffle(Array.from({length: quizQuestions.length}, (_, i) => i), seed);
            selectedAnswers = Array(quizQuestions.length).fill(null);
            currentQuestionIndex = 0;
            focusLossCount = 0;
            
            const now = Date.now();
            examendTimeStamp = now + (currentExamConfig.time_limit * 1000);
        }

        function restoreSession(session) {
            questionOrder = session.questionOrder || [];
            selectedAnswers = session.selectedAnswers || [];
            currentQuestionIndex = session.currentQuestionIndex || 0;
            focusLossCount = session.focusLossCount || 0;
            currentSessionDocId = session.id;
            
            const remaining = session.timeLeft || currentExamConfig.time_limit;
            examendTimeStamp = Date.now() + (remaining * 1000);
        }

        // --- SINAV ARAY√úZ√ú ---
        function startQuiz() {
            document.getElementById('connectionStatus').classList.add('hidden');
            document.getElementById('app').className = 'app-card max-w-3xl w-full';
            document.getElementById('loginHeader').innerHTML = `<div class="flex justify-between px-4"><span class="text-sm opacity-80">${studentData.name}</span><span>${studentData.examCode}</span></div>`;

            document.getElementById('mainContentArea').innerHTML = `
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <span class="font-bold text-indigo-600">Soru: <span id="qCount">1</span> / ${quizQuestions.length}</span>
                    <div id="timerDisplay" class="text-xl font-mono font-bold text-white bg-indigo-600 p-1 px-3 rounded shadow">--:--</div>
                </div>
                <div id="questionArea" class="min-h-[250px]"></div>
                
                <div id="focusWarn" class="hidden mt-4 p-2 bg-red-100 text-red-800 text-sm font-bold text-center rounded border border-red-300"></div>
                
                <div class="mt-6 flex justify-between">
                    <button id="prevBtn" class="button bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded opacity-50" disabled>√ñnceki</button>
                    <button id="nextBtn" class="button bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-6 rounded font-bold">Sonraki</button>
                </div>
            `;

            renderQuestion(currentQuestionIndex);
            startTimer();
            setupSecurityListeners();
            startAutoSave();
            
            document.getElementById('prevBtn').onclick = () => {
                if(currentQuestionIndex > 0) { currentQuestionIndex--; renderQuestion(currentQuestionIndex); saveProgress(); }
            };
            document.getElementById('nextBtn').onclick = () => {
                if(currentQuestionIndex < quizQuestions.length - 1) {
                    currentQuestionIndex++; renderQuestion(currentQuestionIndex); saveProgress();
                } else {
                    finishQuiz(false);
                }
            };
        }

        function renderQuestion(idx) {
            const realIdx = questionOrder[idx];
            const q = quizQuestions[realIdx];
            
            const seed = studentData.number + '_q' + realIdx;
            const shuffledOpts = seededShuffle(q.options, seed);
            const currAns = selectedAnswers[realIdx];
            
            const imageHtml = q.image ? `<div class="mb-4 flex justify-center"><img src="${q.image}" class="max-h-64 rounded-lg shadow border object-contain"></div>` : '';

            document.getElementById('questionArea').innerHTML = `
                <div class="font-semibold text-lg text-gray-800 mb-4 select-none">Soru ${idx + 1}: ${sanitizeInput(q.question)}</div>
                ${imageHtml}
                <div class="space-y-3">
                    ${shuffledOpts.map(opt => `
                        <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer transition-all ${currAns === opt ? 'bg-indigo-50 border-indigo-500 shadow-md' : 'border-gray-200 hover:bg-gray-50'}">
                            <input type="radio" name="opt" value="${sanitizeInput(opt)}" class="w-5 h-5 text-indigo-600" ${currAns === opt ? 'checked' : ''}>
                            <span class="ml-3 text-gray-700 font-medium select-none">${sanitizeInput(opt)}</span>
                        </label>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('qCount').innerText = idx + 1;
            
            document.querySelectorAll('input[name="opt"]').forEach(el => {
                el.onchange = (e) => { 
                    selectedAnswers[realIdx] = e.target.value; 
                    document.querySelectorAll('label').forEach(l => l.className = "flex items-center p-4 border-2 rounded-lg cursor-pointer transition-all border-gray-200 hover:bg-gray-50");
                    e.target.closest('label').className = "flex items-center p-4 border-2 rounded-lg cursor-pointer transition-all bg-indigo-50 border-indigo-500 shadow-md";
                };
            });

            document.getElementById('prevBtn').disabled = idx === 0;
            document.getElementById('prevBtn').classList.toggle('opacity-50', idx === 0);
            
            const nextBtn = document.getElementById('nextBtn');
            if (idx === quizQuestions.length - 1) {
                nextBtn.innerText = "SINAVI Bƒ∞Tƒ∞R";
                nextBtn.className = "button bg-green-600 hover:bg-green-700 text-white py-2 px-6 rounded font-bold shadow-lg transform hover:scale-105";
            } else {
                nextBtn.innerText = "Sonraki";
                nextBtn.className = "button bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-6 rounded font-bold";
            }
        }

        // --- G√úVENLƒ∞ TIMER ---
        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            
            const updateTimerUI = () => {
                const now = Date.now();
                let diff = Math.ceil((examendTimeStamp - now) / 1000);
                
                if (diff <= 0) {
                    diff = 0;
                    clearInterval(timerInterval);
                    timerInterval = null;
                    finishQuiz(true);
                    return;
                }
                
                const timerDisplay = document.getElementById('timerDisplay');
                if (diff < 60) timerDisplay.className = "text-xl font-mono font-bold text-white bg-red-600 p-1 px-3 rounded shadow animate-pulse";
                
                const m = Math.floor(diff / 60);
                const s = diff % 60;
                timerDisplay.innerText = `${m}:${s < 10 ? '0'+s : s}`;
            };

            updateTimerUI();
            timerInterval = setInterval(updateTimerUI, 1000);
        }

        // --- G√úVENLƒ∞K √ñNLEMLERƒ∞ ---
        function setupSecurityListeners() {
            window.onblur = () => {
                if (isTeacherMode) return;
                focusLossCount++;
                const w = document.getElementById('focusWarn');
                if(w) { 
                    w.classList.remove('hidden'); 
                    w.innerText = `‚ö†Ô∏è Dƒ∞KKAT: Sƒ±nav ekranƒ±ndan ${focusLossCount} kez ayrƒ±ldƒ±nƒ±z! Bu durum kaydedilmektedir.`; 
                }
                saveProgress();
            };
            
            document.addEventListener('contextmenu', event => event.preventDefault());
        }

        // --- OTOMATƒ∞K KAYIT ---
        function startAutoSave() {
            autoSaveInterval = setInterval(() => saveProgress(), 15000);
        }

        async function saveProgress() {
            if (isTeacherMode || !isDbConnected) return;
            
            try {
                const now = Date.now();
                const remainingSeconds = Math.floor((examendTimeStamp - now) / 1000);

                // Data validation
                if (!validateStudentData(studentData)) {
                    console.warn("Ge√ßersiz √∂ƒürenci verisi");
                    return;
                }

                const data = {
                    ...studentData, 
                    studentKey: `${sanitizeExamCode(studentData.examCode)}_${studentData.number}`,
                    questionOrder, 
                    selectedAnswers, 
                    currentQuestionIndex, 
                    timeLeft: remainingSeconds > 0 ? remainingSeconds : 0, 
                    focusLossCount,
                    lastUpdated: serverTimestamp()
                };

                if (currentSessionDocId) {
                    await updateDoc(doc(db, "active_sessions", currentSessionDocId), data);
                } else { 
                    const ref = await addDoc(collection(db, "active_sessions"), data); 
                    currentSessionDocId = ref.id; 
                }
            } catch(e) { 
                console.warn("Autosave failed:", e.message);
            }
        }

        // --- SINAV Bƒ∞Tƒ∞RME ---
        async function finishQuiz(force = false) {
            // Interval'leri temizle
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
                autoSaveInterval = null;
            }
            
            window.onblur = null;
            document.oncontextmenu = null;

            if (!force && !confirm("Sƒ±navƒ± bitirmek ve cevaplarƒ±nƒ±zƒ± g√∂ndermek istediƒüinize emin misiniz?")) { 
                startTimer(); 
                setupSecurityListeners();
                return; 
            }

            document.getElementById('mainContentArea').innerHTML = `
                <div class="text-center py-10">
                    <div class="loader mb-4"></div>
                    <p class="font-bold text-gray-600">Cevaplarƒ±nƒ±z ≈üifrelenip sunucuya g√∂nderiliyor...</p>
                </div>
            `;
            
            let currentQuestions = [];
            try {
                const qSnap = await getDoc(getQuestionsRef(studentData.examCode));
                currentQuestions = qSnap.exists() ? qSnap.data().questions_list : [];
            } catch(e) { currentQuestions = quizQuestions; }

            let c=0, i=0, e=0;
            for (let idx = 0; idx < questionOrder.length; idx++) {
                const realQIdx = questionOrder[idx];
                const correctQ = currentQuestions[realQIdx];
                if(!correctQ) continue;

                const sAns = String(selectedAnswers[realQIdx] || '').trim();
                const cAns = String(correctQ.answer || '').trim();

                if(!sAns) e++;
                else if (sAns.toLowerCase() === cAns.toLowerCase()) c++;
                else i++;
            }
            
            const score = (currentQuestions.length > 0) ? (c * 100 / currentQuestions.length).toFixed(2) : 0;
            
            let ip = "Gizli";
            try { const r = await fetch('https://api.ipify.org?format=json'); const d = await r.json(); ip = d.ip; } catch(err){}

            const finalData = {
                ...studentData, 
                studentKey: `${studentData.examCode}_${studentData.number}`,
                score, correct: c, incorrect: i, empty: e, 
                timeSpent: currentExamConfig.time_limit - Math.floor((examendTimeStamp - Date.now())/1000),
                timestamp: serverTimestamp(), 
                focusLossCount, 
                ipAddress: ip, 
                questionOrder, 
                allAnswers: selectedAnswers 
            };

            if(isDbConnected) {
                try {
                    await addDoc(collection(db, "quiz_submissions"), finalData);
                    if (currentSessionDocId) await deleteDoc(doc(db, "active_sessions", currentSessionDocId));
                } catch(e) { alert("Sunucu Hatasƒ±: Sonu√ß kaydedilemedi. L√ºtfen √∂ƒüretmeninize bildirin."); }
            }

            showResultScreen(finalData);
        }

        // --- GELƒ∞≈ûMƒ∞≈û SONU√á EKRANI (Grafik ve sƒ±ralama eklendi) ---
      
// --- √áALI≈ûAN SONU√á EKRANI (Senin kodun gibi) ---
async function showResultScreen(data) {
    document.getElementById('app').className = 'app-card max-w-4xl';
    document.getElementById('loginHeader').innerHTML = '<h1 class="text-2xl font-bold">Sƒ±nav Tamamlandƒ±</h1>';
    
    let rankInfo = "Sƒ±ralama y√ºkleniyor...";
    let allStudentResults = [];

    if(isDbConnected) {
        try {
            // 1. SIRALAMA HESAPLA (senin kodun gibi)
            const currentExamQuery = query(collection(db, "quiz_submissions"), where("examCode", "==", data.examCode));
            const currentExamSnap = await getDocs(currentExamQuery);
            const scores = currentExamSnap.docs.map(d => parseFloat(d.data().score)).sort((a,b) => b-a);
            const rank = scores.indexOf(parseFloat(data.score)) + 1;
            rankInfo = `${rank}. sƒ±ra (${scores.length} ki≈üi arasƒ±nda)`;

            // 2. T√úM SINAV GE√áMƒ∞≈ûƒ∞Nƒ∞ AL (senin kodun gibi)
            const historyQuery = query(collection(db, "quiz_submissions"), where("number", "==", String(data.number)));
            const historySnap = await getDocs(historyQuery);
            allStudentResults = historySnap.docs.map(d => {
                const result = d.data();
                return {
                    examCode: result.examCode,
                    score: parseFloat(result.score) || 0,
                    timestamp: result.timestamp
                };
            }).sort((a,b) => (a.timestamp?.seconds||0) - (b.timestamp?.seconds||0));

            console.log("T√ºm sƒ±nav ge√ßmi≈üi:", allStudentResults);
            
        } catch(e) { 
            console.error("Hata:", e);
            rankInfo = "Sƒ±ralama alƒ±namadƒ±";
        }
    }

    document.getElementById('mainContentArea').innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-4">
                <div class="text-center">
                    <div class="inline-block p-4 rounded-full bg-indigo-100 mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div class="text-5xl font-extrabold text-gray-800 mb-2">${data.score}</div>
                    <p class="text-gray-500 font-medium mb-2">Puanƒ±nƒ±z</p>
                    <div class="text-sm text-gray-600 bg-gray-100 p-2 rounded">${rankInfo}</div>
                </div>
                
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div class="bg-green-50 p-3 rounded-lg border border-green-100">
                        <p class="text-2xl font-bold text-green-600">${data.correct}</p>
                        <p class="text-xs text-green-800">Doƒüru</p>
                    </div>
                    <div class="bg-red-50 p-3 rounded-lg border border-red-100">
                        <p class="text-2xl font-bold text-red-600">${data.incorrect}</p>
                        <p class="text-xs text-red-800">Yanlƒ±≈ü</p>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                        <p class="text-2xl font-bold text-gray-600">${data.empty}</p>
                        <p class="text-xs text-gray-800">Bo≈ü</p>
                    </div>
                </div>
                
                <!-- SINAV GE√áMƒ∞≈ûƒ∞ -->
                <div class="bg-white p-4 rounded-lg border shadow-sm">
                    <h3 class="font-bold text-gray-700 mb-3">Sƒ±nav Ge√ßmi≈üi</h3>
                    <div class="max-h-40 overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="p-2 text-left text-xs">Sƒ±nav Kodu</th>
                                    <th class="p-2 text-left text-xs">Puan</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${allStudentResults.map((exam, index) => `
                                    <tr class="${exam.examCode === data.examCode ? 'bg-indigo-50' : 'hover:bg-gray-50'} border-b">
                                        <td class="p-2 text-xs font-medium">${exam.examCode}</td>
                                        <td class="p-2 text-xs font-bold ${exam.score >= 50 ? 'text-green-600' : 'text-red-600'}">${exam.score}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Toplam ${allStudentResults.length} sƒ±nav</p>
                </div>
            </div>
            
            <div class="bg-white p-4 rounded-lg border shadow-sm">
                <h3 class="font-bold text-gray-700 mb-4">Geli≈üim Grafiƒüi</h3>
                <div class="h-64">
                    <canvas id="progressChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="mt-6 text-center">
            <button onclick="location.reload()" class="button bg-gray-800 text-white py-3 px-6 rounded-lg font-bold hover:bg-gray-900">√áƒ±kƒ±≈ü Yap</button>
        </div>
    `;
    
    // GRAFƒ∞K OLU≈ûTUR
    if (allStudentResults.length > 0) {
        setTimeout(() => {
            const ctx = document.getElementById('progressChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: allStudentResults.map(r => r.examCode),
                    datasets: [{
                        label: 'Puan',
                        data: allStudentResults.map(r => r.score),
                        backgroundColor: allStudentResults.map(exam => 
                            exam.examCode === data.examCode ? 'rgba(79, 70, 229, 0.8)' : 'rgba(79, 70, 229, 0.4)'
                        ),
                        borderColor: 'rgba(79, 70, 229, 1)',
                        borderWidth: 1,
                        borderRadius: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + ' puan';
                                }
                            }
                        }
                    }
                }
            });
        }, 500);
    }
}
        // --- Y√ñNETƒ∞Cƒ∞ MOD√úL√ú ---
        function showTeacherLogin() {
            document.getElementById('mainContentArea').innerHTML = `
                <div class="space-y-4">
                    <h3 class="text-center font-bold text-gray-800 text-lg">Y√∂netici Giri≈üi</h3>
                    <div class="text-center text-xs p-2 rounded ${isDbConnected ? 'bg-green-100 text-green-800':'bg-red-100 text-red-800'}">
                        ${isDbConnected ? 'Veritabanƒ± Baƒülantƒ±sƒ± Aktif' : 'Veritabanƒ± Baƒülantƒ±sƒ± YOK'}
                    </div>
                    
                    <input id="pass" type="password" placeholder="Y√∂netici ≈ûifresi" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                    
                    <button id="loginBtn" class="button bg-indigo-600 text-white w-full py-3 rounded-lg font-bold hover:bg-indigo-700">Giri≈ü Yap</button>
                    <button id="backBtn" class="button bg-gray-200 text-gray-700 w-full py-3 rounded-lg font-semibold hover:bg-gray-300">Geri D√∂n</button>
                </div>
            `;

            document.getElementById('backBtn').onclick = showLoginForm;
            
            document.getElementById('loginBtn').onclick = () => {
                const inputPass = document.getElementById('pass').value;
                
                if (!isDbConnected || adminMasterCode === null) {
                    return showCustomAlert("Hata", "Veritabanƒ±na baƒülanƒ±lamadƒ±ƒüƒ± i√ßin y√∂netici giri≈üi yapƒ±lamaz.");
                }

                if (inputPass === adminMasterCode) {
                    isTeacherMode = true;
                    showDashboard();
                } else {
                    showCustomAlert("Hatalƒ± ≈ûifre", "Girdiƒüiniz ≈üifre yanlƒ±≈ü.");
                }
            };
        }

        function showDashboard() {
            document.getElementById('connectionStatus').classList.add('hidden');
            document.getElementById('app').className = 'app-card teacher-mode';
            document.getElementById('loginHeader').innerHTML = '<h1 class="text-2xl font-bold flex justify-between items-center px-4"><span>Y√∂netim Paneli</span> <button id="logoutBtn" class="text-sm bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded">√áƒ±kƒ±≈ü</button></h1>';
            
            document.getElementById('logoutBtn').onclick = resetApp;

            const dashboardHtml = `
                <div class="flex flex-wrap gap-2 mb-6 border-b pb-4">
                    <button onclick="window.changeTab('results')" class="flex-1 min-w-[120px] px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded shadow text-sm font-semibold">üìä Sonu√ßlar</button>
                    <button onclick="window.changeTab('settings')" class="flex-1 min-w-[120px] px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded shadow text-sm font-semibold">‚öôÔ∏è Ayarlar</button>
                    <button onclick="window.changeTab('questions')" class="flex-1 min-w-[120px] px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded shadow text-sm font-semibold">üìù Sorular</button>
                    <button onclick="window.changeTab('lists')" class="flex-1 min-w-[120px] px-4 py-2 bg-teal-600 hover:bg-teal-700 text-white rounded shadow text-sm font-semibold">üë• √ñƒürenciler</button>
                    <button onclick="window.changeTab('myexams')" class="flex-1 min-w-[120px] px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded shadow text-sm font-semibold">üìÇ Sƒ±navlarƒ±m</button>
                </div>
                
                <div id="tab-results" class="tab-content">
                    <div class="flex justify-between items-center mb-4">
                         <h2 class="font-bold text-lg text-gray-700">Sonu√ß Listesi</h2>
                         <div class="flex gap-2">
                             <button onclick="window.exportToExcel()" class="bg-green-600 text-white px-3 py-1 rounded text-sm">Excel ƒ∞ndir</button>
                             <button onclick="window.exportDetailedResults()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">Detaylƒ± Excel</button>
                         </div>
                    </div>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <input id="filterCode" placeholder="Kod Ara" class="p-2 border rounded text-sm w-24">
                        <input id="filterName" placeholder="ƒ∞sim Ara" class="p-2 border rounded text-sm flex-1">
                        <select id="filterClass" class="p-2 border rounded text-sm w-32">
                            <option value="">T√ºm Sƒ±nƒ±flar</option>
                        </select>
                        <button onclick="window.bulkDeleteFiltered()" class="bg-red-600 text-white px-3 py-1 rounded text-sm">Filtrelenmi≈üleri Sil</button>
                        <button onclick="window.bulkDeleteAll()" class="bg-red-800 text-white px-3 py-1 rounded text-sm">T√ºm√ºn√º Sil</button>
                    </div>
                    <div class="overflow-auto max-h-[500px] border rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200 text-sm">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="p-3 text-left">√ñƒürenci</th>
                                    <th class="p-3 text-left">Kod</th>
                                    <th class="p-3 text-left">Puan</th>
                                    <th class="p-3 text-left">D/Y/B</th>
                                    <th class="p-3 text-left">S√ºre</th>
                                    <th class="p-3 text-left">Odak Kaybƒ±</th>
                                    <th class="p-3 text-left">IP</th>
                                    <th class="p-3 text-left">Tarih/Saat</th>
                                    <th class="p-3 text-left">ƒ∞≈ülem</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody" class="bg-white divide-y"></tbody>
                        </table>
                    </div>
                </div>

                <div id="tab-questions" class="tab-content hidden">
                     <div class="max-w-2xl mx-auto">
                        <div class="bg-orange-50 p-4 rounded-lg border border-orange-200 mb-4">
                            <label class="block font-bold text-orange-800 mb-1">Hangi Sƒ±nav Kodu ƒ∞√ßin?</label>
                            <input id="uploadQCode" class="w-full p-2 border rounded uppercase font-bold" placeholder="√ñRN: 9A_MAT">
                        </div>
                        <textarea id="jsonInput" rows="10" class="w-full p-3 font-mono text-xs border rounded bg-gray-900 text-green-400" placeholder='[{"question":"Soru?","options":["A","B"],"answer":"A"}]'></textarea>
                        <div class="flex justify-between mt-2">
                            <button onclick="window.loadSampleJson()" class="text-xs text-gray-500 underline">√ñrnek Format</button>
                            <button id="btnUploadQ" class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded font-bold shadow">SORULARI Y√úKLE</button>
                        </div>
                     </div>
                </div>

                <div id="tab-settings" class="tab-content hidden">
                    <div class="max-w-lg mx-auto space-y-4">
                         <div class="bg-gray-50 p-4 rounded border">
                            <h3 class="font-bold mb-2">Sƒ±nav Olu≈ütur / D√ºzenle</h3>
                            <input id="setExamCode" class="w-full p-2 border rounded mb-2 uppercase" placeholder="Sƒ±nav Kodu">
                            <input id="setTime" type="number" class="w-full p-2 border rounded mb-2" placeholder="S√ºre (Dakika)">
                            <input id="setDesc" class="w-full p-2 border rounded mb-2" placeholder="A√ßƒ±klama">
                            <button id="btnSaveSettings" class="w-full bg-gray-700 text-white p-2 rounded font-bold">Kaydet</button>
                         </div>
                         <div class="bg-blue-50 p-4 rounded border border-blue-200">
                            <h3 class="font-bold text-blue-700 mb-2">Sƒ±nav Hazƒ±rlayan √ñƒüretmen</h3>
                            <input id="setTeacherName" class="w-full p-2 border rounded mb-2" placeholder="√ñƒüretmen Adƒ±" value="${systemPreparerName}">
                            <button id="btnSaveTeacher" class="w-full bg-blue-600 text-white p-2 rounded font-bold">√ñƒüretmeni Kaydet</button>
                         </div>
                         <div class="bg-red-50 p-4 rounded border border-red-200">
                            <h3 class="font-bold text-red-700 mb-2">Y√∂netici ≈ûifresi Deƒüi≈ütir</h3>
                            <input id="newAdminPass" type="password" class="w-full p-2 border rounded mb-2" placeholder="Yeni ≈ûifre">
                            <button id="btnChangePass" class="w-full bg-red-600 text-white p-2 rounded font-bold">≈ûifreyi G√ºncelle</button>
                         </div>
                    </div>
                </div>

                <div id="tab-lists" class="tab-content hidden">
                    <div class="max-w-2xl mx-auto">
                        <div class="bg-teal-50 p-4 rounded border border-teal-200 mb-4">
                            <label class="font-bold text-teal-800">Hangi Sƒ±nav Kodu?</label>
                            <input id="uploadListCode" class="w-full p-2 border rounded uppercase" placeholder="√ñRN: 9A_MAT">
                        </div>
                        <div class="paste-area" id="listInput" contenteditable="true" placeholder="Excel'den Kopyala (No | Sƒ±nƒ±f | Ad Soyad)"></div>
                        <div class="text-xs text-gray-500 mt-1">E.okuldan indirdiƒüiniz excel dosyanƒ±zƒ± buraya s√ºr√ºkleyip bƒ±rakƒ±n veya verileri kopyalayƒ±p bu alana yapƒ±≈ütƒ±rƒ±n (Ctrl+V)</div>
                        <button id="btnUploadList" class="w-full mt-2 bg-teal-600 text-white py-2 rounded font-bold">Listeyi Kaydet</button>
                    </div>
                </div>

                 <div id="tab-myexams" class="tab-content hidden">
                    <div id="myExamsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">Y√ºkleniyor...</div>
                </div>
            `;
            
            document.getElementById('mainContentArea').innerHTML = dashboardHtml;
            
            // --- TAB Y√ñNETƒ∞Mƒ∞ ---
            window.changeTab = (t) => {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
                document.getElementById('tab-' + t).classList.remove('hidden');
                if(t === 'results') loadResults();
                if(t === 'myexams') loadMyExams();
            };

            // --- SORU Y√úKLEME ---
            window.loadSampleJson = () => {
                document.getElementById('jsonInput').value = `[\n  {\n    "question": "T√ºrkiye'nin ba≈ükenti neresidir?",\n    "options": ["ƒ∞stanbul", "Ankara", "ƒ∞zmir", "Bursa"],\n    "answer": "Ankara"\n  }\n]`;
            };

            document.getElementById('btnUploadQ').onclick = async () => {
                const code = sanitizeExamCode(document.getElementById('uploadQCode').value);
                const rawJson = document.getElementById('jsonInput').value;
                
                if(!code) return alert("Sƒ±nav kodu girin.");
                
                try {
                    const parsed = JSON.parse(rawJson);
                    if(!Array.isArray(parsed)) throw new Error("JSON bir liste [...] ile ba≈ülamalƒ±.");
                    
                    await setDoc(getQuestionsRef(code), { questions_list: parsed });
                    alert(`‚úÖ ${code} i√ßin ${parsed.length} soru ba≈üarƒ±yla y√ºklendi.`);
                    document.getElementById('jsonInput').value = '';
                } catch(e) {
                    alert(`‚ùå JSON Format Hatasƒ±:\n${e.message}\n\nL√ºtfen virg√ºllere ve parantezlere dikkat edin.`);
                }
            };

            // --- AYARLAR KAYDETME ---
            document.getElementById('btnSaveSettings').onclick = async () => {
                const code = sanitizeExamCode(document.getElementById('setExamCode').value);
                if(!code) return alert("Kod gerekli");
                await setDoc(getConfigRef(code), {
                    teacher_name: systemPreparerName,
                    time_limit: parseInt(document.getElementById('setTime').value) * 60,
                    exam_description: sanitizeInput(document.getElementById('setDesc').value)
                }, { merge: true });
                alert("Ayarlar kaydedildi.");
            };

            // --- √ñƒûRETMEN ADI KAYDETME ---
            document.getElementById('btnSaveTeacher').onclick = async () => {
                const teacherName = sanitizeInput(document.getElementById('setTeacherName').value);
                if(!teacherName) return alert("√ñƒüretmen adƒ± gerekli");
                
                await setDoc(doc(db, "exam_settings", "admin_config"), { 
                    preparer_name: teacherName 
                }, { merge: true });
                
                systemPreparerName = teacherName;
                alert("√ñƒüretmen adƒ± g√ºncellendi.");
            };
// --- ≈ûƒ∞FRE DEƒûƒ∞≈ûTƒ∞RME ---
            document.getElementById('btnChangePass').onclick = async () => {
                const newP = document.getElementById('newAdminPass').value;
                if(newP.length < 4) return alert("≈ûifre √ßok kƒ±sa.");
                if(confirm("≈ûifreyi deƒüi≈ütirmek istediƒüinize emin misiniz?")) {
                    await setDoc(doc(db, "exam_settings", "admin_config"), { master_code: newP }, { merge: true });
                    adminMasterCode = newP;
                    alert("≈ûifre g√ºncellendi.");
                }
            };

            // --- GELƒ∞≈ûMƒ∞≈û Lƒ∞STE Y√úKLEME (AKILLI AYRI≈ûTIRICI - SON G√úVENƒ∞Lƒ∞R VERSƒ∞YON) ---
            document.getElementById('btnUploadList').onclick = async () => {
                const code = sanitizeExamCode(document.getElementById('uploadListCode').value);
                // paste-area i√ßindeki metni al (S√ºr√ºkle bƒ±rak veya kopyala yapƒ±≈ütƒ±r ile gelen)
                const txt = document.getElementById('listInput').innerText || document.getElementById('listInput').textContent;
                
                if(!code) return alert("L√ºtfen bir sƒ±nav kodu giriniz (√ñrn: 9A_MAT).");
                if(!txt.trim()) return alert("L√ºtfen Excel'den kopyaladƒ±ƒüƒ±nƒ±z listeyi yapƒ±≈ütƒ±rƒ±n.");
                
                const students = [];
                const lines = txt.split('\n');
                let currentClass = "";
                
                const btn = document.getElementById('btnUploadList');
                btn.innerText = "Ayrƒ±≈ütƒ±rƒ±lƒ±yor...";
                btn.disabled = true;

                try {
                    for (let i = 0; i < lines.length; i++) {
                        let line = lines[i].trim();
                        if (!line) continue;
                        
                        // Garip kodlarƒ± (OOG01001R020 gibi) temizle
                        line = line.replace(/(\d{3,}[A-Z]{3,}\d{3,})$/, '').trim();
                        
                        // 1. SINIF TESPƒ∞Tƒ∞ (√ñrn: AL - 9. Sƒ±nƒ±f / A ≈ûubesi)
                        const classMatch = line.match(/(\d+)\.\s*Sƒ±nƒ±f\s*\/\s*([A-Z])/i);
                        if (classMatch) {
                            currentClass = classMatch[1] + classMatch[2]; 
                            continue;
                        }

                        if (!currentClass) continue;

                        // 2. √ñƒûRENCƒ∞ TESPƒ∞Tƒ∞ (G√ú√áL√ú REGEX ile Adƒ± ve Soyadƒ± birlikte yakalanƒ±r)
                        // √ñrnek Satƒ±r: 1 175 ƒ∞BRAHƒ∞M EFE YILDIRIM Erkek
                        const studentMatch = line.match(/^\s*\d+\s+(\d+)\s+(.+)\s+(Erkek|Kƒ±z)/i);

                        if (studentMatch) {
                            const num = studentMatch[1].trim(); 
                            const rawName = studentMatch[2].trim(); // Adƒ± ve Soyadƒ± birlikte gelir
                            
                            // Ba≈ülƒ±k satƒ±rlarƒ±nƒ± veya toplam satƒ±rlarƒ±nƒ± atla
                            if (rawName.includes("Adƒ± Soyadƒ± Cinsiyeti") || line.includes("√ñƒürenci Sayƒ±sƒ±")) {
                                continue;
                            }

                            // --- GE√áERLƒ∞Lƒ∞K KONTROL√ú VE EKLEME ---
                            if (!isNaN(num) && rawName.length > 2) {
                                students.push({ 
                                    number: num, 
                                    className: currentClass, 
                                    name: rawName 
                                });
                            }
                        }
                    }

                    if(students.length === 0) {
                        throw new Error(`Listeden √∂ƒürenci √ßƒ±karƒ±lamadƒ±. Toplam ${lines.length} satƒ±r i≈ülendi, 0 √∂ƒürenci bulundu.\nKopyaladƒ±ƒüƒ±nƒ±z listeye dikkat edin.`);
                    }
                    
                    await setDoc(doc(db, "student_lists", code), { students });
                    
                    const uniqueClasses = [...new Set(students.map(s => s.className))].join(", ");
                    alert(`‚úÖ BA≈ûARILI!\n\nToplam ${students.length} √∂ƒürenci eklendi.\nAlgƒ±lanan Sƒ±nƒ±flar: ${uniqueClasses}`);
                    document.getElementById('listInput').innerText = '';

                } catch(e) { 
                    alert("Hata: " + e.message); 
                } finally {
                    btn.innerText = "Listeyi Kaydet";
                    btn.disabled = false;
                }
            };
            
            // --- S√úR√úKLE BIRAK ƒ∞≈ûLEVSELLƒ∞ƒûƒ∞ (D&D) KODU ---
            const listInputArea = document.getElementById('listInput');
            // 1. Varsayƒ±lan davranƒ±≈üƒ± engelle (Dosyanƒ±n indirilmesini √∂nler)
            listInputArea.addEventListener('dragover', (e) => {
                e.preventDefault(); 
                listInputArea.classList.add('border-indigo-500', 'bg-indigo-50');
            });
            listInputArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                listInputArea.classList.remove('border-indigo-500', 'bg-indigo-50'); 
            });
            // 2. Dosya bƒ±rakƒ±ldƒ±ƒüƒ±nda i√ßeriƒüi oku
            listInputArea.addEventListener('drop', (e) => {
                e.preventDefault();
                listInputArea.classList.remove('border-indigo-500', 'bg-indigo-50'); 
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    readExcelFile(files[0]);
                }
            });

            // 3. Dosya okuma fonksiyonu
            const readExcelFile = (file) => {
                if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls') && !file.name.endsWith('.csv')) {
                    alert('L√ºtfen bir Excel (.xlsx, .xls) veya CSV (.csv) dosyasƒ± s√ºr√ºkleyiniz.');
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        // **√ñNEMLƒ∞:** XLSX k√ºt√ºphanesinin √ßalƒ±≈ütƒ±ƒüƒ± varsayƒ±lƒ±r. (HTML ba≈ülƒ±ƒüƒ±nda olmalƒ±)
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        // ƒ∞√ßeriƒüi metin olarak al (TSV - Tab Separated Values formatƒ±nda)
                        const rawText = XLSX.utils.sheet_to_csv(worksheet, { FS: ' ' }); // Tab yerine Bo≈üluk kullanƒ±ldƒ±
                        listInputArea.innerText = rawText;
                        alert('‚úÖ Excel dosyasƒ±nƒ±n i√ßeriƒüi ba≈üarƒ±yla y√ºklendi. ≈ûimdi "Listeyi Kaydet" butonuna basabilirsiniz.');
                    } catch (error) {
                        alert('Dosya okuma hatasƒ±: ' + error.message);
                        console.error(error);
                    }
                };
                reader.readAsArrayBuffer(file);
            };


            // Initial Load
            loadResults();
        } // <-- showDashboard fonksiyonunun kapanƒ±≈ü parantezi burada bitiyor

        // --- DASHBOARD YARDIMCILARI ---
        function loadResults() {
            const tbody = document.getElementById('resultsTableBody');
            tbody.innerHTML = '<tr><td colspan="9" class="p-4 text-center">Y√ºkleniyor...</td></tr>';
            
            // OPTƒ∞Mƒ∞ZE EDƒ∞LMƒ∞≈û QUERY: Son 500 kayƒ±t ile sƒ±nƒ±rlƒ±
            onSnapshot(query(
                collection(db, "quiz_submissions"), 
                orderBy("timestamp", "desc"),
                limit(500)
            ), (snap) => {
                allSubmissions = snap.docs.map(d => {
                    const data = d.data();
                    // Tarih formatƒ±nƒ± d√ºzenle
                    let dateTime = "Bilinmiyor";
                    if (data.timestamp && data.timestamp.toDate) {
                        const date = data.timestamp.toDate();
                        dateTime = `${date.toLocaleDateString('tr-TR')} ${date.toLocaleTimeString('tr-TR')}`;
                    }
                    return {
                        id: d.id,
                        ...data,
                        formattedDateTime: dateTime
                    };
                });
                renderResultsTable();
                updateClassFilter();
            });
            
            document.getElementById('filterCode').oninput = renderResultsTable;
            document.getElementById('filterName').oninput = renderResultsTable;
            document.getElementById('filterClass').onchange = renderResultsTable;
        }

        function updateClassFilter() {
            const classFilter = document.getElementById('filterClass');
            const classes = [...new Set(allSubmissions.map(s => s.className))].filter(c => c).sort();
            
            classFilter.innerHTML = '<option value="">T√ºm Sƒ±nƒ±flar</option>';
            classes.forEach(c => {
                classFilter.innerHTML += `<option value="${c}">${c}</option>`;
            });
        }

        function renderResultsTable() {
            const fCode = document.getElementById('filterCode').value.toLowerCase();
            const fName = document.getElementById('filterName').value.toLowerCase();
            const fClass = document.getElementById('filterClass').value;
            const tbody = document.getElementById('resultsTableBody');
            
            const filtered = allSubmissions.filter(s => 
                (s.examCode||'').toLowerCase().includes(fCode) && 
                (s.name||'').toLowerCase().includes(fName) &&
                (!fClass || s.className === fClass)
            ).sort((a,b) => b.score - a.score);
            
            tbody.innerHTML = filtered.map(s => {
                const timeSpent = s.timeSpent || 0;
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                const timeDisplay = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                
                return `
                <tr class="hover:bg-gray-50">
                    <td class="p-3">
                        <div class="font-bold text-gray-800">${s.name}</div>
                        <div class="text-xs text-gray-500">${s.number} - ${s.className}</div>
                    </td>
                    <td class="p-3 font-mono text-xs">${s.examCode}</td>
                    <td class="p-3 font-bold ${s.score >= 50 ? 'text-green-600':'text-red-600'}">${s.score}</td>
                    <td class="p-3 text-xs">${s.correct}D / ${s.incorrect}Y / ${s.empty}B</td>
                    <td class="p-3 text-xs">${timeDisplay}</td>
                    <td class="p-3 text-xs">${s.focusLossCount || 0}</td>
                    <td class="p-3 text-xs font-mono">${s.ipAddress || 'N/A'}</td>
                    <td class="p-3 text-xs">${s.formattedDateTime}</td>
                    <td class="p-3">
                        <button onclick="window.deleteSub('${s.id}')" class="text-red-600 hover:underline text-xs">Sil</button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        window.deleteSub = async (id) => {
            if(confirm("Bu kaydƒ± silmek istiyor musunuz?")) await deleteDoc(doc(db, "quiz_submissions", id));
        }

        window.bulkDeleteFiltered = async () => {
            const fCode = document.getElementById('filterCode').value.toLowerCase();
            const fName = document.getElementById('filterName').value.toLowerCase();
            const fClass = document.getElementById('filterClass').value;
            
            const filtered = allSubmissions.filter(s => 
                (s.examCode||'').toLowerCase().includes(fCode) && 
                (s.name||'').toLowerCase().includes(fName) &&
                (!fClass || s.className === fClass)
            );
            
            if(filtered.length === 0) return alert("Filtreye uygun kayƒ±t yok.");
            
            if(confirm(`${filtered.length} kaydƒ± silmek istediƒüinize emin misiniz?`)) {
                for(const item of filtered) {
                    await deleteDoc(doc(db, "quiz_submissions", item.id));
                }
                alert(`${filtered.length} kayƒ±t silindi.`);
            }
        }

        window.bulkDeleteAll = async () => {
            if(allSubmissions.length === 0) return alert("Silinecek kayƒ±t yok.");
            
            if(confirm(`T√úM kayƒ±tlarƒ± (${allSubmissions.length} adet) silmek istediƒüinize emin misiniz?`)) {
                for(const item of allSubmissions) {
                    await deleteDoc(doc(db, "quiz_submissions", item.id));
                }
                alert("T√ºm kayƒ±tlar silindi.");
            }
        }
        
        window.exportToExcel = () => {
            // Excel formatƒ±nda export
            const data = allSubmissions.map(s => {
                const timeSpent = s.timeSpent || 0;
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                
                let dateTime = "Bilinmiyor";
                if (s.timestamp && s.timestamp.toDate) {
                    const date = s.timestamp.toDate();
                    dateTime = `${date.toLocaleDateString('tr-TR')} ${date.toLocaleTimeString('tr-TR')}`;
                }
                
                return {
                    'Ad Soyad': s.name || '',
                    'Numara': s.number || '',
                    'Sƒ±nƒ±f': s.className || '',
                    'Sƒ±nav Kodu': s.examCode || '',
                    'Puan': s.score || 0,
                    'Doƒüru Sayƒ±sƒ±': s.correct || 0,
                    'Yanlƒ±≈ü Sayƒ±sƒ±': s.incorrect || 0,
                    'Bo≈ü Sayƒ±sƒ±': s.empty || 0,
                    'Toplam S√ºre (saniye)': timeSpent,
                    'Dakika': minutes,
                    'Saniye': seconds,
                    'Odak Kaybƒ±': s.focusLossCount || 0,
                    'IP Adresi': s.ipAddress || '',
                    'Tarih/Saat': dateTime
                };
            });
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sƒ±nav Sonu√ßlarƒ±");
            
            // Excel dosyasƒ±nƒ± indir
            XLSX.writeFile(wb, "sinav_sonuclari.xlsx");
        }

        window.exportDetailedResults = () => {
            const fCode = document.getElementById('filterCode').value.toLowerCase();
            const fName = document.getElementById('filterName').value.toLowerCase();
            const fClass = document.getElementById('filterClass').value;
            
            const filtered = allSubmissions.filter(s => 
                (s.examCode||'').toLowerCase().includes(fCode) && 
                (s.name||'').toLowerCase().includes(fName) &&
                (!fClass || s.className === fClass)
            );
            
            if(filtered.length === 0) {
                alert("Filtreye uygun kayƒ±t yok.");
                return;
            }
            
            // Detaylƒ± Excel export
            const data = filtered.map(s => {
                const timeSpent = s.timeSpent || 0;
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;
                
                let dateTime = "Bilinmiyor";
                if (s.timestamp && s.timestamp.toDate) {
                    const date = s.timestamp.toDate();
                    dateTime = `${date.toLocaleDateString('tr-TR')} ${date.toLocaleTimeString('tr-TR')}`;
                }
                
                const result = {
                    'Ad Soyad': s.name || '',
                    'Numara': s.number || '',
                    'Sƒ±nƒ±f': s.className || '',
                    'Sƒ±nav Kodu': s.examCode || '',
                    'Puan': s.score || 0,
                    'Doƒüru Sayƒ±sƒ±': s.correct || 0,
                    'Yanlƒ±≈ü Sayƒ±sƒ±': s.incorrect || 0,
                    'Bo≈ü Sayƒ±sƒ±': s.empty || 0,
                    'Toplam S√ºre (saniye)': timeSpent,
                    'Dakika': minutes,
                    'Saniye': seconds,
                    'Odak Kaybƒ±': s.focusLossCount || 0,
                    'IP Adresi': s.ipAddress || '',
                    'Tarih/Saat': dateTime
                };
                
                // Soru cevaplarƒ±nƒ± ekle
                if(s.allAnswers && s.allAnswers.length > 0) {
                    s.allAnswers.forEach((answer, index) => {
                        result[`Soru ${index + 1}`] = answer || '';
                    });
                }
                
                return result;
            });
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Detaylƒ± Sonu√ßlar");
            
            // Excel dosyasƒ±nƒ± indir
            XLSX.writeFile(wb, "detayli_sinav_sonuclari.xlsx");
        }

       // --- GELƒ∞≈ûMƒ∞≈û SINAVLARIM SEKMESƒ∞ (G√úNCELLENMƒ∞≈û) ---
        async function loadMyExams() {
            const container = document.getElementById('myExamsList');
            // Y√ºkleniyor animasyonu
            container.innerHTML = `
                <div class="col-span-1 md:col-span-2 lg:col-span-3 text-center py-10">
                    <div class="loader mb-4"></div>
                    <p class="font-bold text-gray-600">Sƒ±navlar listeleniyor, l√ºtfen bekleyin...</p>
                </div>`;
            
            try {
                // 1. VERƒ∞LERƒ∞ √áEKME (Bu kƒ±sƒ±m √ßok √∂nemli, silinmemeli)
                const [configSnap, questionsSnap, listsSnap, submissionsSnap] = await Promise.all([
                    getDocs(collection(db, "exam_settings")),
                    getDocs(collection(db, "questions_pool")),
                    getDocs(collection(db, "student_lists")),
                    getDocs(collection(db, "quiz_submissions"))
                ]);
                
                const exams = [];
                const questionsData = {};
                const studentLists = {};
                const submissionCounts = {};
                
                // Veri haritalarƒ±nƒ± olu≈ütur
                questionsSnap.forEach(doc => {
                    questionsData[doc.id] = doc.data().questions_list?.length || 0;
                });
                
                listsSnap.forEach(doc => {
                    studentLists[doc.id] = doc.data().students?.length || 0;
                });
                
                submissionsSnap.forEach(doc => {
                    const data = doc.data();
                    const code = data.examCode;
                    if (code) {
                        if(!submissionCounts[code]) submissionCounts[code] = 0;
                        submissionCounts[code]++;
                    }
                });
                
                // Ana sƒ±nav listesini derle
                configSnap.forEach(doc => {
                    if(doc.id !== 'admin_config') {
                        const data = doc.data();
                        exams.push({
                            code: doc.id,
                            teacher_name: data.teacher_name || systemPreparerName,
                            time_limit: data.time_limit || 600,
                            exam_description: data.exam_description || "",
                            custom_name: data.custom_name || "",
                            is_active: data.is_active, // Senin eklediƒüin √∂zellik buraya da lazƒ±m
                            question_count: questionsData[doc.id] || 0,
                            student_count: studentLists[doc.id] || 0,
                            submission_count: submissionCounts[doc.id] || 0
                        });
                    }
                });
                
                if(exams.length === 0) {
                    container.innerHTML = '<div class="col-span-full text-center text-gray-500 py-10 font-bold">Hen√ºz olu≈üturulmu≈ü bir sƒ±nav bulunmamaktadƒ±r.</div>';
                    return;
                }
                
                // 2. HTML OLU≈ûTURMA (Senin g√∂nderdiƒüin ve d√ºzenlediƒüin kƒ±sƒ±m burasƒ±)
                container.innerHTML = exams.map(exam => {
                    // Aktiflik durumu kontrol√º (Veritabanƒ±nda yoksa varsayƒ±lan true kabul et)
                    const isActive = exam.is_active !== false; 
                    
                    return `
                    <div class="bg-white p-6 border rounded-xl shadow-sm hover:shadow-md transition-all relative flex flex-col ${isActive ? 'border-l-4 border-l-green-500' : 'border-l-4 border-l-red-500 bg-gray-50'}">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <div class="flex items-center gap-2">
                                    <h3 class="font-extrabold text-xl text-indigo-700 tracking-tight">${exam.code}</h3>
                                    ${!isActive ? '<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-red-100 text-red-600 border border-red-200">KAPALI</span>' : '<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-green-100 text-green-600 border border-green-200">AKTƒ∞F</span>'}
                                </div>
                                <p class="text-sm text-gray-500 italic mt-1">${exam.exam_description || 'A√ßƒ±klama girilmemi≈ü.'}</p>
                            </div>
                            
                            <button onclick="window.toggleExamStatus('${exam.code}', ${isActive})" 
                                class="text-xs font-bold px-3 py-1 rounded-full transition-colors shadow-sm border ${isActive ? 'bg-red-50 text-red-600 border-red-200 hover:bg-red-100' : 'bg-green-50 text-green-600 border-green-200 hover:bg-green-100'}">
                                ${isActive ? '‚õî Eri≈üimi Kapat' : '‚úÖ Eri≈üimi A√ß'}
                            </button>
                        </div>
                        
                        <div class="space-y-3 text-sm flex-grow ${!isActive ? 'opacity-60 grayscale-[50%]' : ''}">
                            <div class="flex items-center justify-between py-1 border-b border-gray-50">
                                <span class="text-gray-600 font-medium w-1/3">√ñzel ƒ∞sim:</span>
                                <input type="text" 
                                   class="text-xs p-1 border rounded w-32 text-right focus:border-indigo-500 outline-none" 
                                   placeholder="√ñzel sƒ±nav adƒ±" 
                                   value="${exam.custom_name || ''}"
                                   onchange="window.updateExamName('${exam.code}', this.value)">
                            </div>
                            <div class="flex items-center justify-between py-1 border-b border-gray-50">
                                <span class="text-gray-600 font-medium w-1/3">Hazƒ±rlayan:</span>
                                <div class="flex-1 flex space-x-2">
                                    <input id="teacherName-${exam.code}" type="text" value="${exam.teacher_name}" class="p-1 px-2 border rounded text-sm flex-1 outline-none">
                                    <button onclick="window.updateExamTeacher('${exam.code}')" class="bg-green-500 text-white px-2 rounded text-xs hover:bg-green-600">üíæ</button>
                                </div>
                            </div>
                            <div class="flex justify-between py-1 border-b border-gray-50">
                                <span class="text-gray-600 font-medium">S√ºre:</span>
                                <span class="font-bold text-gray-800">${Math.floor(exam.time_limit/60)} dk</span>
                            </div>
                            <div class="flex justify-between items-center py-1 border-b border-gray-50">
                                <span class="text-gray-600 font-medium">Soru Sayƒ±sƒ±:</span>
                                <button onclick="window.showExamQuestions('${exam.code}')" class="text-blue-600 font-bold hover:underline">${exam.question_count} Soru</button>
                            </div>
                            <div class="flex justify-between items-center py-1 border-b border-gray-50">
                                <span class="text-gray-600 font-medium">√ñƒürenci Sayƒ±sƒ±:</span>
                                <button onclick="window.showExamStudents('${exam.code}')" class="text-blue-600 font-bold hover:underline">${exam.student_count} √ñƒürenci</button>
                            </div>
                             <div class="flex justify-between py-1">
                                <span class="text-gray-600 font-medium">Katƒ±lƒ±m:</span>
                                <span class="font-bold text-lg text-gray-800">${exam.submission_count}</span>
                            </div>
                        </div>
                        
                        <button onclick="window.deleteExam('${exam.code}')" class="mt-4 w-full bg-white text-gray-400 text-xs py-2 rounded border hover:bg-red-50 hover:text-red-500 transition">
                            Sƒ±navƒ± Tamamen Sil
                        </button>
                    </div>
                `}).join('');
                
            } catch (error) {
                console.error(error);
                container.innerHTML = `<div class="col-span-full text-center text-red-500 py-10 font-bold">Veriler y√ºklenirken hata olu≈ütu.<br><span class="text-sm font-normal">${error.message}</span></div>`;
            }
        }
        
        // √ñzel isim g√ºncelleme
        window.updateExamName = async (code, name) => {
            try {
                await setDoc(getConfigRef(code), { custom_name: sanitizeInput(name) }, { merge: true });
            } catch(e) { alert("ƒ∞sim g√ºncellenemedi: " + e.message); }
        }
        
        // YENƒ∞: Hazƒ±rlayan √∂ƒüretmeni g√ºncelleme
        window.updateExamTeacher = async (code) => {
            const inputBtn = document.getElementById(`teacherName-${code}`);
            const newName = sanitizeInput(inputBtn.value);
            if(!newName.trim()) return alert("√ñƒüretmen adƒ± bo≈ü olamaz.");
            
            try {
                inputBtn.disabled = true;
                await setDoc(getConfigRef(code), { teacher_name: newName }, { merge: true });
                
                // G√∂rsel geri bildirim (Ye≈üil yanƒ±p s√∂nme)
                inputBtn.classList.add('bg-green-100', 'text-green-800', 'border-green-300');
                setTimeout(() => {
                    inputBtn.classList.remove('bg-green-100', 'text-green-800', 'border-green-300');
                    inputBtn.disabled = false;
                }, 1500);
            } catch(e) {
                alert("Hata: " + e.message);
                inputBtn.disabled = false;
            }
        }

        // YENƒ∞: ƒ∞lgili sekmeye y√∂nlendirme yardƒ±mcƒ±sƒ±
        window.redirectToTab = (tabName, code) => {
            document.getElementById('customModal').classList.add('hidden'); // Modalƒ± kapat
            window.changeTab(tabName); // Sekmeyi deƒüi≈ütir
            
            // ƒ∞lgili inputu doldur
            setTimeout(() => {
                if(tabName === 'questions') document.getElementById('uploadQCode').value = code;
                if(tabName === 'lists') document.getElementById('uploadListCode').value = code;
            }, 100);
        }
        
     // --- TEK TEK D√úZENLEME (SORU & √ñƒûRENCƒ∞) - 5 ≈ûIKLI VE D√úZELTƒ∞LMƒ∞≈û VERSƒ∞YON ---

        // 1. SORULARI Y√ñNETME PENCERESƒ∞ (Ekle/Sil/D√ºzenle)
        window.showExamQuestions = async (code) => {
            try {
                const qSnap = await getDoc(getQuestionsRef(code));
                const questions = qSnap.exists() ? qSnap.data().questions_list : [];
                
                let content = `
                    <div class="sticky top-0 bg-white z-20 pb-4 border-b mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-xl font-bold text-indigo-700">${code} - Soru Y√∂netimi</h3>
                            <button onclick="document.getElementById('customModal').classList.add('hidden')" class="text-gray-500 hover:text-gray-800 font-bold text-xl">&times;</button>
                        </div>
                        
                        <div class="bg-orange-50 p-3 rounded border border-orange-200 text-sm shadow-inner">
                            <h4 class="font-bold text-orange-800 mb-2 flex items-center">
                                <span id="formTitle">Yeni Soru Ekle</span>
                                <button onclick="window.clearQuestionForm()" class="ml-auto text-xs text-gray-500 underline">Formu Temizle</button>
                            </h4>
                            <input type="hidden" id="editIndex" value="-1">
                            
                            <textarea id="qText" class="w-full p-2 border rounded mb-2 text-sm focus:ring-2 focus:ring-orange-300 outline-none" rows="2" placeholder="Soru metnini buraya yazƒ±n..."></textarea>
                            
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-2">
                                <div class="flex items-center"><span class="w-6 font-bold text-gray-500">A)</span><input id="optA" class="flex-1 p-1 border rounded" placeholder="Se√ßenek A"></div>
                                <div class="flex items-center"><span class="w-6 font-bold text-gray-500">B)</span><input id="optB" class="flex-1 p-1 border rounded" placeholder="Se√ßenek B"></div>
                                <div class="flex items-center"><span class="w-6 font-bold text-gray-500">C)</span><input id="optC" class="flex-1 p-1 border rounded" placeholder="Se√ßenek C"></div>
                                <div class="flex items-center"><span class="w-6 font-bold text-gray-500">D)</span><input id="optD" class="flex-1 p-1 border rounded" placeholder="Se√ßenek D"></div>
                                <div class="flex items-center col-span-1 sm:col-span-2"><span class="w-6 font-bold text-gray-500">E)</span><input id="optE" class="flex-1 p-1 border rounded bg-gray-50" placeholder="Se√ßenek E (ƒ∞steƒüe Baƒülƒ±)"></div>
                            </div>
                            
                            <div class="flex gap-2 mb-2">
                                <input id="qImg" class="flex-1 p-1 border rounded text-xs" placeholder="Resim Linki (Opsiyonel)">
                                <select id="qAns" class="p-1 border rounded font-bold text-indigo-700 bg-white">
                                    <option value="">Doƒüru Cevap</option>
                                    <option value="A">A ≈ûƒ±kkƒ±</option>
                                    <option value="B">B ≈ûƒ±kkƒ±</option>
                                    <option value="C">C ≈ûƒ±kkƒ±</option>
                                    <option value="D">D ≈ûƒ±kkƒ±</option>
                                    <option value="E">E ≈ûƒ±kkƒ±</option>
                                </select>
                            </div>
                            
                            <button onclick="window.saveQuestion('${code}')" id="saveBtn" class="w-full bg-orange-600 text-white py-2 rounded font-bold hover:bg-orange-700 transition shadow">Soruyu Kaydet</button>
                        </div>
                    </div>
                `;
                
                // Liste Kƒ±smƒ± (Dinamik ≈ûƒ±k G√∂sterimi)
                content += `<div class="max-h-[40vh] overflow-y-auto space-y-3 pr-1 pb-2">`;
                if(questions.length === 0) {
                    content += `<p class="text-gray-400 text-center py-4 italic">Bu sƒ±nava hen√ºz soru eklenmemi≈ü.</p>`;
                } else {
                    questions.forEach((q, i) => {
                        const labels = ['A', 'B', 'C', 'D', 'E'];
                        content += `
                            <div class="p-3 border rounded bg-white hover:shadow-md transition relative group border-l-4 border-l-indigo-500">
                                <div class="flex justify-between items-start mb-1">
                                    <span class="font-bold text-xs text-white bg-indigo-500 px-2 py-0.5 rounded-full">Soru ${i+1}</span>
                                    <div class="flex gap-1 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                                        <button onclick="window.editQuestion('${code}', ${i})" class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200 font-bold">D√ºzenle</button>
                                        <button onclick="window.deleteQuestion('${code}', ${i})" class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded hover:bg-red-200 font-bold">Sil</button>
                                    </div>
                                </div>
                                <p class="text-sm font-bold text-gray-800 mb-2">${sanitizeInput(q.question)}</p>
                                
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-1 text-xs text-gray-600">
                                    ${q.options.map((opt, idx) => `
                                        <div class="${q.answer === opt ? 'text-green-700 font-bold bg-green-50 p-1 rounded border border-green-200' : 'p-1'}">
                                            ${labels[idx]}) ${sanitizeInput(opt)}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    });
                }
                content += `</div>`;
                
                showCustomAlert(``, content);
                document.getElementById('modalContent').classList.remove('max-w-3xl');
                document.getElementById('modalContent').classList.add('max-w-4xl');
            } catch(e) { alert("Hata: " + e.message); }
        }

        // Soru Kaydetme Mantƒ±ƒüƒ± (5 ≈ûƒ±k Destekli)
        window.saveQuestion = async (code) => {
            const qText = document.getElementById('qText').value.trim();
            const optA = document.getElementById('optA').value.trim();
            const optB = document.getElementById('optB').value.trim();
            const optC = document.getElementById('optC').value.trim();
            const optD = document.getElementById('optD').value.trim();
            const optE = document.getElementById('optE').value.trim(); // Yeni ≈ûƒ±k
            const ansKey = document.getElementById('qAns').value;
            const img = document.getElementById('qImg').value.trim();
            const editIndex = parseInt(document.getElementById('editIndex').value);

            // Temel Doƒürulama (En az 4 ≈üƒ±k ve cevap gerekli)
            if(!qText || !optA || !optB || !optC || !optD || !ansKey) {
                return alert("L√ºtfen soru metnini, en az 4 ≈üƒ±kkƒ± (A,B,C,D) ve doƒüru cevabƒ± doldurun.");
            }
            
            // E ≈üƒ±kkƒ± se√ßildiyse ama metni bo≈üsa hata ver
            if(ansKey === 'E' && !optE) {
                return alert("Doƒüru cevap olarak E ≈üƒ±kkƒ±nƒ± se√ßtiniz ama E ≈üƒ±kkƒ± metnini girmediniz.");
            }

            // ≈ûƒ±k Dizisini Olu≈ütur
            let finalOptions = [optA, optB, optC, optD];
            if(optE) finalOptions.push(optE); // E ≈üƒ±kkƒ± doluysa ekle, yoksa 4 ≈üƒ±klƒ± kalƒ±r.

            // Doƒüru Cevap Metnini Bul
            let correctText = "";
            if(ansKey === 'A') correctText = optA;
            else if(ansKey === 'B') correctText = optB;
            else if(ansKey === 'C') correctText = optC;
            else if(ansKey === 'D') correctText = optD;
            else if(ansKey === 'E') correctText = optE;

            const newQ = { 
                question: qText, 
                options: finalOptions, 
                answer: correctText, 
                image: img || "" 
            };

            try {
                const ref = getQuestionsRef(code);
                const snap = await getDoc(ref);
                let list = snap.exists() ? snap.data().questions_list : [];

                if(editIndex > -1) list[editIndex] = newQ; // G√ºncelle
                else list.push(newQ); // Yeni Ekle

                await setDoc(ref, { questions_list: list }, { merge: true });
                window.showExamQuestions(code); // Ekranƒ± yenile
            } catch(e) { alert("Kaydedilemedi: " + e.message); }
        }

        // D√ºzenleme Moduna Ge√ßi≈ü
        window.editQuestion = async (code, index) => {
            const snap = await getDoc(getQuestionsRef(code));
            const q = snap.data().questions_list[index];
            
            document.getElementById('qText').value = q.question;
            document.getElementById('optA').value = q.options[0] || "";
            document.getElementById('optB').value = q.options[1] || "";
            document.getElementById('optC').value = q.options[2] || "";
            document.getElementById('optD').value = q.options[3] || "";
            document.getElementById('optE').value = q.options[4] || ""; // 5. ≈ûƒ±k varsa getir
            document.getElementById('qImg').value = q.image || "";
            
            // Cevabƒ± harfe d√∂n√º≈üt√ºr
            let ansKey = "";
            if(q.answer === q.options[0]) ansKey = "A";
            else if(q.answer === q.options[1]) ansKey = "B";
            else if(q.answer === q.options[2]) ansKey = "C";
            else if(q.answer === q.options[3]) ansKey = "D";
            else if(q.options[4] && q.answer === q.options[4]) ansKey = "E";
            
            document.getElementById('qAns').value = ansKey;
            document.getElementById('editIndex').value = index;
            
            // UI G√ºncellemeleri
            document.getElementById('formTitle').innerText = `Soru ${index+1} D√ºzenleniyor`;
            const btn = document.getElementById('saveBtn');
            btn.innerText = "Deƒüi≈üiklikleri Kaydet";
            btn.classList.replace('bg-orange-600', 'bg-blue-600');
            btn.classList.replace('hover:bg-orange-700', 'hover:bg-blue-700');
            
            document.querySelector('.bg-orange-50').scrollIntoView({behavior: 'smooth'});
        }

        // Form Temizleme (D√úZELTƒ∞LEN KISIM BURASI)
        window.clearQuestionForm = () => {
            document.getElementById('qText').value = "";
            document.getElementById('optA').value = "";
            document.getElementById('optB').value = "";
            document.getElementById('optC').value = "";
            document.getElementById('optD').value = "";
            document.getElementById('optE').value = "";
            document.getElementById('qImg').value = "";
            document.getElementById('qAns').value = "";
            document.getElementById('editIndex').value = "-1";
            
            document.getElementById('formTitle').innerText = "Yeni Soru Ekle";
            const btn = document.getElementById('saveBtn');
            btn.innerText = "Soruyu Kaydet";
            if(btn.classList.contains('bg-blue-600')) {
                btn.classList.replace('bg-blue-600', 'bg-orange-600');
                btn.classList.replace('hover:bg-blue-700', 'hover:bg-orange-700');
            }
        }

        // Soru Silme
        window.deleteQuestion = async (code, index) => {
            if(!confirm("Bu soruyu silmek istediƒüinize emin misiniz?")) return;
            const ref = getQuestionsRef(code);
            const snap = await getDoc(ref);
            let list = snap.data().questions_list;
            list.splice(index, 1);
            await setDoc(ref, { questions_list: list }, { merge: true });
            window.showExamQuestions(code);
        }

        // 2. √ñƒûRENCƒ∞ Y√ñNETME PENCERESƒ∞ (Deƒüi≈üiklik Yok, Aynen Korundu)
        window.showExamStudents = async (code) => {
            try {
                const snap = await getDoc(doc(db, "student_lists", code));
                const students = snap.exists() ? snap.data().students : [];
                students.sort((a,b) => a.className.localeCompare(b.className) || a.name.localeCompare(b.name));

                let content = `
                    <div class="sticky top-0 bg-white z-20 pb-4 border-b mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-xl font-bold text-teal-700">${code} - √ñƒürenci Y√∂netimi</h3>
                            <button onclick="document.getElementById('customModal').classList.add('hidden')" class="text-gray-500 font-bold text-xl">&times;</button>
                        </div>
                        <div class="bg-teal-50 p-3 rounded border border-teal-200 text-sm shadow-inner">
                            <h4 class="font-bold text-teal-800 mb-2">√ñƒürenci Ekle</h4>
                            <div class="flex gap-2">
                                <input id="addNum" placeholder="No" class="w-20 p-2 border rounded focus:border-teal-500 outline-none">
                                <input id="addClass" placeholder="Sƒ±nƒ±f" class="w-20 p-2 border rounded focus:border-teal-500 outline-none">
                                <input id="addName" placeholder="Ad Soyad" class="flex-1 p-2 border rounded focus:border-teal-500 outline-none">
                                <button onclick="window.addStudent('${code}')" class="bg-teal-600 text-white px-4 py-2 rounded font-bold hover:bg-teal-700 shadow">Ekle</button>
                            </div>
                        </div>
                    </div>
                    <div class="max-h-[50vh] overflow-y-auto border rounded-lg shadow-sm">
                        <table class="min-w-full text-sm divide-y divide-gray-200">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="p-3 text-left font-bold text-gray-600">No</th>
                                    <th class="p-3 text-left font-bold text-gray-600">Sƒ±nƒ±f</th>
                                    <th class="p-3 text-left font-bold text-gray-600">Ad Soyad</th>
                                    <th class="p-3 text-right font-bold text-gray-600">ƒ∞≈ülem</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-100">`;
                if(students.length === 0) content += `<tr><td colspan="4" class="p-4 text-center text-gray-400">Liste bo≈ü.</td></tr>`;
                else {
                    students.forEach(s => {
                        content += `
                            <tr class="hover:bg-teal-50 transition">
                                <td class="p-3 font-mono font-bold text-teal-700">${s.number}</td>
                                <td class="p-3">${s.className}</td>
                                <td class="p-3 font-medium">${s.name}</td>
                                <td class="p-3 text-right">
                                    <button onclick="window.deleteStudent('${code}', '${s.number}')" class="bg-red-50 text-red-600 border border-red-200 px-3 py-1 rounded text-xs font-bold hover:bg-red-600 hover:text-white transition">Sil</button>
                                </td>
                            </tr>`;
                    });
                }
                content += `</tbody></table></div>`;
                showCustomAlert(``, content);
            } catch(e) { alert("Hata: " + e.message); }
        }

        window.addStudent = async (code) => {
            const num = document.getElementById('addNum').value.trim();
            const cls = document.getElementById('addClass').value.trim();
            const name = document.getElementById('addName').value.trim();
            if(!num || !cls || !name) return alert("T√ºm alanlarƒ± doldurun.");

            const ref = doc(db, "student_lists", code);
            const snap = await getDoc(ref);
            let students = snap.exists() ? snap.data().students : [];
            
            if(students.some(s => s.number === num)) return alert("Bu numara zaten var!");
            
            students.push({ number: num, className: cls, name: name });
            await setDoc(ref, { students }, { merge: true });
            window.showExamStudents(code);
        }

        window.deleteStudent = async (code, num) => {
            if(!confirm("Bu √∂ƒürenci silinsin mi?")) return;
            const ref = doc(db, "student_lists", code);
            const snap = await getDoc(ref);
            let students = snap.data().students.filter(s => s.number !== num);
            await setDoc(ref, { students }, { merge: true });
            window.showExamStudents(code);
        }

        // SINAV Sƒ∞LME FONKSƒ∞YONU
        window.deleteExam = async (code) => {
            if(confirm(`‚ö†Ô∏è Dƒ∞KKAT!\n\n"${code}" kodlu sƒ±navƒ± silmek √ºzeresiniz.\n\nBuna baƒülƒ± T√úM SORULAR, √ñƒûRENCƒ∞ Lƒ∞STESƒ∞ ve SINAV SONU√áLARI kalƒ±cƒ± olarak silinecektir.\n\nBu i≈ülem geri alƒ±namaz. Onaylƒ±yor musunuz?`)) {
                const btn = document.activeElement;
                btn.innerText = "Siliniyor..."; btn.disabled = true;
                try {
                    await deleteDoc(doc(db, "exam_settings", code));
                    await deleteDoc(doc(db, "questions_pool", code));
                    await deleteDoc(doc(db, "student_lists", code));
                    
                    const submissions = await getDocs(query(collection(db, "quiz_submissions"), where("examCode", "==", code)));
                    const deletePromises = [];
                    submissions.forEach(doc => deletePromises.push(deleteDoc(doc.ref)));
                    await Promise.all(deletePromises);
                    
                    alert("‚úÖ Sƒ±nav ve t√ºm verileri ba≈üarƒ±yla silindi.");
                    loadMyExams(); // Listeyi yenile
                } catch(e) {
                    alert("Silme i≈ülemi sƒ±rasƒ±nda hata olu≈ütu: " + e.message);
                    btn.innerText = "Bu Sƒ±navƒ± Sil"; btn.disabled = false;
                }
            }
        }

        // --- YENƒ∞ √ñZELLƒ∞K: SINAVI AKTƒ∞F/PASƒ∞F YAPMA ---
        window.toggleExamStatus = async (code, currentStatus) => {
            const newStatus = !currentStatus; // Durumu tersine √ßevir
            const btn = document.activeElement;
            const originalText = btn.innerText;
            
            btn.innerText = "Wait...";
            btn.disabled = true;

            try {
                await setDoc(getConfigRef(code), { is_active: newStatus }, { merge: true });
                await loadMyExams(); // Listeyi yenile
            } catch (e) {
                alert("Hata: " + e.message);
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }
        // --- TEK TEK D√úZENLEME Bƒ∞Tƒ∞≈û ---
        // --- UI HELPERS ---
        function showCustomAlert(title, msg) {
            return new Promise(resolve => {
                const modal = document.getElementById('customModal');
                const content = document.getElementById('modalContent');
                content.innerHTML = `
                    <h3 class="text-xl font-bold text-gray-800 mb-2">${title}</h3>
                    <div class="text-left">${msg}</div>
                    <button id="modalCloseBtn" class="mt-4 bg-indigo-600 text-white px-6 py-2 rounded font-bold hover:bg-indigo-700">Tamam</button>
                `;
                modal.classList.remove('hidden'); modal.classList.add('flex');
                document.getElementById('modalCloseBtn').onclick = () => {
                    modal.classList.add('hidden'); modal.classList.remove('flex');
                    resolve();
                };
            });
        }

        // Ba≈ülat
        initializeFirebase();

    </script>
</body>
</html>



