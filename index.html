<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <!-- CACHE ÖNLEME EKLENDİ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Öğrenci Sınav Uygulaması (Gelişmiş)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0;}
        .app-card { background-color:white;padding:2.5rem;border-radius:1.5rem;box-shadow:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05);max-width:450px;width:90%;transition:all .3s;position:relative;}
        .header-bg { background: linear-gradient(135deg,#4f46e5 0%,#818cf8 100%); color:white;padding:1rem 0;border-radius:1rem 1rem 0 0;margin:-2.5rem -2.5rem 1.5rem -2.5rem;text-align:center;}
        .button{transition:all .2s;box-shadow:0 4px 6px rgba(0,0,0,0.1)}
        .button:hover{transform:translateY(-1px);box-shadow:0 6px 10px rgba(0,0,0,0.15)}
        @media (max-width:640px){ .app-card{padding:1.5rem;border-radius:1rem} .header-bg{margin:-1.5rem -1.5rem 1rem -1.5rem;padding:.75rem 0} }
    </style>
</head>
<body>

    <div id="app" class="app-card">
        <div id="loginHeader" class="header-bg">
            <h1 class="text-2xl font-extrabold">Öğrenci Girişi</h1>
        </div>
        <div id="mainContentArea">
            <div id="loadingIndicator" class="text-center py-10">
                <svg class="animate-spin h-5 w-5 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="text-sm text-gray-500 mt-2">Sistem Başlatılıyor...</p>
                <p id="systemStatus" class="text-xs text-gray-400 mt-4"></p>
            </div>
        </div>
    </div>

    <div id="customModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center p-4 z-50">
        <div id="modalContent" class="bg-white rounded-xl p-8 max-w-sm w-full text-center shadow-2xl transform transition-all scale-100"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, serverTimestamp, query, where, getDocs, deleteDoc, getDoc, addDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        const TEACHER_CODE = 'OGRETMEN34';
        const EXAM_CODE = 'biyoloji';
        const TEACHER_NAME = 'Öztürk sevinç (biyoloji Öğretmeni)';
        const TIME_LIMIT_SECONDS = 600;

        const firebaseConfig = {
            apiKey: "AIzaSyCHhFAHbWnclad6yFuI-Pw9gX6F_Dx1B2c",
            authDomain: "online-sinav-b3644.firebaseapp.com",
            projectId: "online-sinav-b3644",
            storageBucket: "online-sinav-b3644.firebasestorage.app",
            messagingSenderId: "965507531268",
            appId: "1:965507531268:web:94cfd13774a40b6cf16b51"
        };

        const quizQuestions = [        
  {
    "question": "Canlıları benzerlik, farklılık ve akrabalık derecelerine göre gruplara ayırma ilke ve ölçütlerini belirleyen bilim dalına ne ad verilir?",
    "options": ["Morfoloji", "Histoloji", "Biyokimya", "Taksonomi", "Fizyoloji"],
    "answer": "Taksonomi"
  },
  {
    "question": "Aşağıdakilerden hangisi, ortak özelliklere, genetik mirasa sahip olan ve birbirleriyle çiftleşip **verimli döl verebilen** canlılar grubu olarak tanımlanan sınıflandırmadaki temel kategoridir?",
    "options": ["Cins", "Aile", "Şube", "Âlem", "Tür"],
    "answer": "Tür"
  },
  {
    "question": "Günümüzde canlıların akrabalık ilişkilerine göre yapılan, morfolojik, anatomik ve genetik gibi birçok özelliğin dikkate alındığı sınıflandırma sistemi ne olarak adlandırılır?",
    "options": ["Yapısal Sınıflandırma", "Yapay Sınıflandırma", "Sistematik Sınıflandırma", "Doğal (Filogenetik) Sınıflandırma", "Ekolojik Sınıflandırma"],
    "answer": "Doğal (Filogenetik) Sınıflandırma"
  },
  {
    "question": "Türlerin isimlendirilmesinde kullanılan ikili (binominal) adlandırma yöntemini öneren İsveçli doğa bilimci aşağıdakilerden hangisidir?",
    "options": ["Aristoteles", "Galileo Galilei", "Carl Linneaus", "Charles Darwin", "Gregor Mendel"],
    "answer": "Carl Linneaus"
  },
  {
    "question": "Metinde verilen 'Fritillaria imperialis' tür adında, 'imperialis' kelimesi hangi görevi ifade eder?",
    "options": ["Cins Adı", "Aile Adı", "Tamamlayıcı Ad", "Takım Adı", "Tür Adı"],
    "answer": "Tamamlayıcı Ad"
  },
  {
    "question": "İkili adlandırma yöntemine göre, bir tür adının birinci kelimesi (Cins adı) ile ilgili doğru kural aşağıdakilerden hangisidir?",
    "options": ["Tamamen büyük harflerle yazılır.", "İlk harfi küçük yazılır.", "Akrabalık derecesini ifade eder.", "İlk harfi büyük yazılır.", "Tek başına türü ifade eder."],
    "answer": "İlk harfi büyük yazılır"
  },
  {
    "question": "Sınıflandırma bilimi, mikroorganizmaların doğru tanımlanması ve tehlike altındaki türlerin korunması gibi konulara katkı sağlayarak hangi iki alandaki araştırmaların temelini oluşturur?",
    "options": ["Ekonomi ve Hukuk", "Eğitim ve Kültür", "Sağlık ve Çevre Koruma", "Ulaşım ve İletişim", "Sanayi ve Tarım"],
    "answer": "Sağlık ve Çevre Koruma"
  },
  {
    "question": "Metinde bahsedilen taksonomik hiyerarşi sıralamasına göre, birbirine yakın türlerin bir araya gelmesiyle oluşan kategoriden başlayarak doğru sıralama (küçükten büyüğe) hangi seçenekte verilmiştir?",
    "options": ["Tür, Cins, Aile, Takım, Sınıf, Şube, Âlem", "Cins, Aile, Takım, Sınıf, Şube, Âlem", "Cins, Sınıf, Aile, Takım, Şube, Âlem", "Cins, Aile, Sınıf, Takım, Şube, Âlem", "Âlem, Şube, Sınıf, Takım, Aile, Cins"],
    "answer": "Cins, Aile, Takım, Sınıf, Şube, Âlem"
  },
  {
    "question": "Doğal (filogenetik) sınıflandırmada canlılar arasındaki akrabalık ilişkilerinin moleküler düzeyde belirlenmesine en önemli katkıyı sağlayan inceleme yöntemi aşağıdakilerden hangisidir?",
    "options": ["Morfolojik yapıların karşılaştırılması", "Yaşadıkları habitatların incelenmesi", "Fiziksel özelliklerin ölçülmesi", "Beslenme alışkanlıklarının gözlemlenmesi", "DNA ve RNA dizilerinin incelenmesi"],
    "answer": "DNA ve RNA dizilerinin incelenmesi"
  },
  {
    "question": "Aşağıdakilerden hangisi, taksonomi biliminin canlıları tanımlama çalışmalarında yararlandığı biyolojinin alt dalları arasında **sayılmamıştır**?",
    "options": ["Morfoloji", "Anatomi", "Histoloji", "Biyokimya", "Ekoloji"],
    "answer": "Ekoloji"
  }
        ];

        let selectedAnswers = Array(quizQuestions.length).fill(null);
        let questionOrder = Array.from({length: quizQuestions.length}, (_, i) => i);
        let currentQuestionIndex = 0;
        let timerInterval = null;
        let timeLeft = TIME_LIMIT_SECONDS;
        let isTeacherMode = false;
        let studentData = {};
        let focusLossCount = 0;
        let autoSaveInterval = null;
        let currentSessionDocId = null;

        function seededShuffle(array, seed) {
            let hash = 0;
            for (let i = 0; i < seed.length; i++) {
                hash = ((hash << 5) - hash) + seed.charCodeAt(i);
                hash |= 0;
            }
            const shuffled = [...array];
            let n = shuffled.length;
            while (n > 1) {
                hash = (hash * 9301 + 49297) % 233280;
                let random = hash / 233280.0;
                let k = Math.floor(random * n);
                n--;
                [shuffled[n], shuffled[k]] = [shuffled[k], shuffled[n]];
            }
            return shuffled;
        }

        async function initializeFirebase() {
            try {
                if (!firebaseConfig || !firebaseConfig.apiKey) {
                    document.getElementById('systemStatus').textContent = 'Hata: Firebase yapılandırması eksik.';
                    return;
                }
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                document.getElementById('systemStatus').textContent = 'Oturum açılıyor...';
                await signInAnonymously(auth);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        document.getElementById('loadingIndicator')?.classList.add('hidden');
                        document.getElementById('systemStatus').textContent = `Kullanıcı ID: ${userId}`;
                        showLoginForm();
                    } else {
                        userId = null;
                        isAuthReady = true;
                        document.getElementById('loadingIndicator')?.classList.add('hidden');
                        document.getElementById('systemStatus').textContent = 'Oturum Açılamadı (Anonim)';
                        showLoginForm();
                    }
                });
            } catch (error) {
                console.error("Firebase başlatılırken hata oluştu:", error);
                document.getElementById('mainContentArea').innerHTML = `
                    <p class="text-red-600 text-center text-lg font-bold">Sistem Hatası: Bağlantı Kurulamadı</p>
                    <p class="text-sm text-red-500 text-center mt-2">Detay: ${error.message}</p>
                `;
            }
        }

        function showLoginForm() {
            if (!isAuthReady) return;
            document.getElementById('app').classList.remove('max-w-3xl', 'max-w-4xl');
            document.getElementById('app').classList.add('max-w-md');
            document.getElementById('loginHeader').innerHTML = '<h1 class="text-2xl font-extrabold">Öğrenci Girişi</h1>';
            const timeInMinutes = Math.floor(TIME_LIMIT_SECONDS / 60);

            const content = `
                <div class="space-y-4">
                    <div class="text-center p-2 bg-indigo-50 rounded-lg shadow-sm">
                        <p class="text-xs text-gray-500">Sınavı Hazırlayan:</p>
                        <p class="font-bold text-indigo-700">${TEACHER_NAME}</p>
                    </div>
                    <div class="p-3 bg-red-100 border border-red-300 rounded-lg text-red-700 font-medium text-sm text-center shadow-inner">
                        <p class="font-bold">ÖNEMLİ UYARI:</p>
                        <p>Sınav süreniz tam olarak <span class="text-red-900">${timeInMinutes} dakika</span>'dır. Süre dolduğunda sınavınız otomatik olarak sonlandırılır.</p>
                    </div>
                    <input id="examCodeInput" type="text" placeholder="Sınav Kodu (Örn: ${EXAM_CODE})" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm uppercase" required>
                    <input id="nameInput" type="text" placeholder="Adınız Soyadınız" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm" required>
                    <input id="numberInput" type="number" placeholder="Okul Numaranız" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm" required>
                    <input id="classInput" type="text" placeholder="Sınıfınız (Örn: 10A)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm" required>
                    <button id="startQuizButton" class="button w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-lg shadow-md">Sınava Başla</button>
                    <button id="teacherLoginButton" class="button w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 rounded-lg text-sm shadow-sm">Öğretmen Girişi</button>
                </div>
            `;
            document.getElementById('mainContentArea').innerHTML = content;
            document.getElementById('startQuizButton').addEventListener('click', handleStudentLogin);
            document.getElementById('teacherLoginButton').addEventListener('click', showTeacherLogin);
        }

        async function handleStudentLogin() {
            const name = document.getElementById('nameInput').value.trim();
            const number = document.getElementById('numberInput').value.trim();
            const className = document.getElementById('classInput').value.trim();
            const examCode = document.getElementById('examCodeInput').value.trim().toUpperCase();

            if (!name || !number || !className || !examCode) {
                showCustomAlert("Eksik Bilgi", "Lütfen tüm alanları doldurun.");
                return;
            }

            if (examCode !== EXAM_CODE) {
                showCustomAlert("Hatalı Sınav Kodu", `Girdiğiniz sınav kodu ("${examCode}") geçersizdir. Lütfen doğru kodu giriniz.`);
                return;
            }

            studentData = { name, number, className, examCode };
            isTeacherMode = false;

            // ÖNEMLİ: Öğrenci numarasına göre kontrol et (aynı öğrenci tekrar giremez)
            const studentKey = `${examCode}_${number}`;
            
            console.log("Öğrenci kontrolü başlatılıyor:", studentKey);
            
            // 1. Önce tamamlanmış sınavları kontrol et
            const completedExam = await checkCompletedExam(studentKey);
            if (completedExam) {
                console.log("Tamamlanmış sınav bulundu:", completedExam);
                await showCustomAlert("Sınav Tamamlandı", 
                    `Bu sınavı daha önce tamamladınız!\n\nPuanınız: ${completedExam.score}\nTarih: ${completedExam.timestamp}`);
                return;
            }

            // 2. Devam eden oturum var mı kontrol et
            console.log("Devam eden oturum kontrol ediliyor...");
            const existingSession = await checkExistingSession(studentKey);
            
            if (existingSession) {
                console.log("Devam eden oturum bulundu:", existingSession);
                const shouldResume = await showCustomConfirmation(
                    `Daha önce bu sınava başlamışsınız.\n\nKalan süre: ${Math.floor(existingSession.timeLeft / 60)} dk ${existingSession.timeLeft % 60} sn\nTamamlanan soru: ${existingSession.currentQuestionIndex + 1}/${quizQuestions.length}\n\nKaldığınız yerden devam etmek ister misiniz?`
                );
                
                if (shouldResume) {
                    console.log("Kullanıcı devam etmeyi seçti, oturum yükleniyor...");
                    // Önceki oturumu yükle
                    studentData = { 
                        name: existingSession.name || name, 
                        number: existingSession.number || number, 
                        className: existingSession.className || className, 
                        examCode: existingSession.examCode || examCode 
                    };
                    questionOrder = existingSession.questionOrder || [];
                    selectedAnswers = existingSession.selectedAnswers || Array(quizQuestions.length).fill(null);
                    currentQuestionIndex = existingSession.currentQuestionIndex || 0;
                    timeLeft = existingSession.timeLeft || TIME_LIMIT_SECONDS;
                    focusLossCount = existingSession.focusLossCount || 0;
                    currentSessionDocId = existingSession.id;
                    
                    console.log("Oturum bilgileri:", {
                        questionOrder,
                        selectedAnswers,
                        currentQuestionIndex,
                        timeLeft,
                        focusLossCount
                    });
                    
                    showQuiz();
                    return;
                } else {
                    console.log("Kullanıcı yeniden başlamayı seçti, eski oturum siliniyor...");
                    // Önceki oturumu sil, yeniden başlat
                    try {
                        await deleteDoc(doc(db, "active_sessions", existingSession.id));
                        console.log("Eski oturum silindi");
                    } catch (error) {
                        console.error("Eski oturum silinirken hata:", error);
                    }
                }
            } else {
                console.log("Devam eden oturum bulunamadı, yeni oturum başlatılıyor");
            }

            // Yeni oturum başlat
            questionOrder = seededShuffle(Array.from({length: quizQuestions.length}, (_, i) => i), number);
            selectedAnswers = Array(quizQuestions.length).fill(null);
            currentQuestionIndex = 0;
            focusLossCount = 0;
            timeLeft = TIME_LIMIT_SECONDS;
            currentSessionDocId = null;

            console.log("Yeni oturum başlatılıyor");
            showQuiz();
        }

        async function checkCompletedExam(studentKey) {
            if (!db) return null;
            
            const q = query(
                collection(db, "quiz_submissions"),
                where("studentKey", "==", studentKey)
            );
            
            try {
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    const docData = querySnapshot.docs[0].data();
                    const timestamp = docData.timestamp?.toDate ? 
                        docData.timestamp.toDate().toLocaleString('tr-TR') : 'Bilinmiyor';
                    return {
                        score: docData.score,
                        timestamp: timestamp
                    };
                }
                return null;
            } catch (error) {
                console.error("Tamamlanmış sınav kontrolü hatası:", error);
                return null;
            }
        }

        async function checkExistingSession(studentKey) {
            if (!db) return null;
            
            const q = query(
                collection(db, "active_sessions"),
                where("studentKey", "==", studentKey)
            );
            
            try {
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    const doc = querySnapshot.docs[0];
                    return { id: doc.id, ...doc.data() };
                }
                return null;
            } catch (error) {
                console.error("Oturum kontrolü hatası:", error);
                return null;
            }
        }

        function showTeacherLogin() {
            document.getElementById('loginHeader').innerHTML = '<h1 class="text-2xl font-extrabold">Öğretmen Girişi</h1>';
            const content = `
                <div class="space-y-4">
                    <p class="text-sm text-gray-600 text-center">Canlı sonuç paneline erişmek için öğretmen kodunu girin.</p>
                    <input id="teacherCodeInput" type="password" placeholder="Öğretmen Kodu" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition duration-150 shadow-sm" required>
                    <button id="teacherLoginButtonExecute" class="button w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 rounded-lg shadow-md">Giriş Yap</button>
                    <button id="backToStudentLogin" class="button w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 rounded-lg text-sm shadow-sm">Öğrenci Girişine Dön</button>
                </div>
            `;
            document.getElementById('mainContentArea').innerHTML = content;
            document.getElementById('teacherLoginButtonExecute').addEventListener('click', handleTeacherLogin);
            document.getElementById('backToStudentLogin').addEventListener('click', showLoginForm);
        }

        function handleTeacherLogin() {
            const code = document.getElementById('teacherCodeInput').value.trim();
            if (code === TEACHER_CODE) {
                isTeacherMode = true;
                showTeacherPanel();
            } else {
                showCustomAlert("Hata", "Girdiğiniz öğretmen kodu yanlış.");
            }
        }

        function showQuiz() {
            document.getElementById('app').classList.remove('max-w-md');
            document.getElementById('app').classList.add('max-w-3xl');
            document.getElementById('loginHeader').innerHTML = `<h1 class="text-2xl font-extrabold">${studentData.name} - Sınav (${studentData.examCode})</h1>`;

            const quizHtml = `
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 border-b pb-3 space-y-2 sm:space-y-0">
                    <p class="text-base text-gray-600">${studentData.className} / ${studentData.number}</p>
                    <p class="text-sm font-medium text-indigo-600">Soru: <span id="questionCounter">1/${quizQuestions.length}</span></p>
                    <div id="timerDisplay" class="text-xl font-bold text-red-600 bg-red-100 p-2 rounded-lg shadow-md">10:00</div>
                </div>
                <div id="questionsContainer" class="space-y-8 min-h-[250px] flex flex-col justify-between"></div>
                <div id="focusWarning" class="hidden mt-4 p-2 bg-yellow-100 border border-yellow-400 text-yellow-800 rounded-lg text-sm font-medium text-center">
                    UYARI: Sayfadan ayrıldınız. Lütfen sınava geri dönün! (Kayıp: ${focusLossCount})
                </div>
                <div id="autoSaveIndicator" class="mt-2 p-2 bg-green-50 border border-green-300 text-green-700 rounded-lg text-xs text-center">
                    ✓ Otomatik kaydetme aktif - İlerlemeniz güvende
                </div>
                <div class="mt-8 pt-4 border-t flex justify-between">
                    <button id="prevButton" class="button bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md disabled:opacity-50" disabled>Önceki</button>
                    <button id="nextButton" class="button bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-xl">Sonraki</button>
                </div>
            `;
            document.getElementById('mainContentArea').innerHTML = quizHtml;

            renderQuestion(currentQuestionIndex);
            startTimer();
            setupFocusCheck();
            startAutoSave();

            document.getElementById('prevButton').addEventListener('click', handlePrevQuestion);
            document.getElementById('nextButton').addEventListener('click', handleNextQuestion);
        }

        async function startAutoSave() {
            await saveProgress();
            autoSaveInterval = setInterval(async () => {
                await saveProgress();
            }, 10000);
        }

        async function saveProgress() {
            if (!db || isTeacherMode) return;

            const studentKey = `${studentData.examCode}_${studentData.number}`;
            const progressData = {
                ...studentData,
                studentKey: studentKey,
                questionOrder,
                selectedAnswers,
                currentQuestionIndex,
                timeLeft,
                focusLossCount,
                isCompleted: false,
                lastUpdated: serverTimestamp()
            };

            try {
                if (currentSessionDocId) {
                    await updateDoc(doc(db, "active_sessions", currentSessionDocId), progressData);
                } else {
                    const docRef = await addDoc(collection(db, "active_sessions"), progressData);
                    currentSessionDocId = docRef.id;
                }
                
                const indicator = document.getElementById('autoSaveIndicator');
                if (indicator) {
                    indicator.classList.add('bg-green-200');
                    setTimeout(() => {
                        indicator.classList.remove('bg-green-200');
                    }, 300);
                }
            } catch (error) {
                console.error("İlerleme kaydedilemedi:", error);
            }
        }

        function setupFocusCheck() {
            const warningElement = document.getElementById('focusWarning');
            let hasWarned = false;
            const handleBlur = () => {
                if (!isTeacherMode) {
                    focusLossCount++;
                    if (focusLossCount > 0) {
                        warningElement.classList.remove('hidden');
                        warningElement.innerHTML = `UYARI: Sayfadan ${focusLossCount} kez ayrıldınız. Lütfen sınava geri dönün!`;
                    }
                    if (focusLossCount >= 5 && !hasWarned) {
                        showCustomAlert("Güvenlik Uyarısı", "Çok fazla odak kaybı tespit edildi. Lütfen sınava odaklanın. (Sonuçlarınıza kaydedilecektir!)");
                        hasWarned = true;
                    }
                    saveProgress();
                }
            };
            const handleFocus = () => { warningElement.classList.add('hidden'); };
            window.addEventListener('blur', handleBlur);
            window.addEventListener('focus', handleFocus);
            document.getElementById('app').addEventListener('quiz-ended', () => {
                window.removeEventListener('blur', handleBlur);
                window.removeEventListener('focus', handleFocus);
            });
        }

        function renderQuestion(quizIndex) {
            const container = document.getElementById('questionsContainer');
            if (!container) return;
            const originalIndex = questionOrder[quizIndex];
            const q = quizQuestions[originalIndex];
            const shuffledOptions = seededShuffle(q.options, studentData.number + 'options' + originalIndex);
            const currentAnswer = selectedAnswers[originalIndex];

            const questionHtml = `
                <div class="question-card p-6 border-4 border-indigo-200 rounded-xl bg-white shadow-xl flex-grow">
                    <div class="text-2xl font-bold text-indigo-700 mb-4">Soru ${quizIndex + 1}:</div>
                    <p class="font-semibold text-gray-800 text-lg mb-6">${q.question}</p>
                    <div class="options-container space-y-3" data-original-index="${originalIndex}">
                        ${shuffledOptions.map((option, oIndex) => {
                            const isChecked = currentAnswer === option;
                            return `
                                <label class="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-indigo-50 transition duration-150 ${isChecked ? 'bg-indigo-100 border-indigo-500 shadow-md' : 'bg-white'}">
                                    <input type="radio" name="q_current" value="${option}" class="text-indigo-600 focus:ring-indigo-500 h-5 w-5" ${isChecked ? 'checked' : ''}>
                                    <span class="text-gray-700 font-medium">${option}</span>
                                </label>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            container.innerHTML = questionHtml;
            document.getElementById('questionCounter').textContent = `${quizIndex + 1}/${quizQuestions.length}`;
            container.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.addEventListener('change', async (e) => {
                    selectedAnswers[originalIndex] = e.target.value;
                    container.querySelectorAll('label').forEach(label => {
                        label.classList.remove('bg-indigo-100', 'border-indigo-500', 'shadow-md');
                        label.classList.add('bg-white', 'border-gray-200');
                    });
                    e.target.closest('label').classList.add('bg-indigo-100', 'border-indigo-500', 'shadow-md');
                    e.target.closest('label').classList.remove('bg-white', 'border-gray-200');
                    await saveProgress();
                });
            });
            updateNavigationButtons(quizIndex);
        }

        function updateNavigationButtons(quizIndex) {
            const prevButton = document.getElementById('prevButton');
            const nextButton = document.getElementById('nextButton');
            prevButton.disabled = quizIndex === 0;
            if (quizIndex === quizQuestions.length - 1) {
                nextButton.textContent = "Sınavı Bitir ve Gönder";
                nextButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                nextButton.classList.add('bg-green-600', 'hover:bg-green-700');
            } else {
                nextButton.textContent = "Sonraki";
                nextButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                nextButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            }
        }

        async function handleNextQuestion() {
            if (currentQuestionIndex < quizQuestions.length - 1) {
                currentQuestionIndex++;
                renderQuestion(currentQuestionIndex);
                await saveProgress();
            } else {
                finishQuiz(false);
            }
        }
        
        async function handlePrevQuestion() { 
            if (currentQuestionIndex > 0) { 
                currentQuestionIndex--; 
                renderQuestion(currentQuestionIndex);
                await saveProgress();
            } 
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            const timerDisplay = document.getElementById('timerDisplay');
            timerInterval = setInterval(() => {
                timeLeft--;
                if (timeLeft < 0) {
                    clearInterval(timerInterval);
                    timeLeft = 0;
                    finishQuiz(true);
                }
                updateTimerDisplay(timerDisplay);
            }, 1000);
            updateTimerDisplay(timerDisplay);
        }

        function updateTimerDisplay(displayElement) {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const timeString = `${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
            displayElement.textContent = timeString;
            if (timeLeft <= 60) {
                displayElement.classList.remove('text-red-600','bg-red-100','text-yellow-700','bg-yellow-100');
                displayElement.classList.add('text-white','bg-red-700');
            } else if (timeLeft <= 180) {
                displayElement.classList.remove('text-white','bg-red-700','text-red-600','bg-red-100');
                displayElement.classList.add('text-yellow-700','bg-yellow-100');
            } else {
                displayElement.classList.remove('text-yellow-700','bg-yellow-100','text-white','bg-red-700');
                displayElement.classList.add('text-red-600','bg-red-100');
            }
        }

        async function finishQuiz(isTimeUp = false) {
            clearInterval(timerInterval);
            if (autoSaveInterval) clearInterval(autoSaveInterval);
            document.getElementById('app').dispatchEvent(new Event('quiz-ended'));
            
            const confirmationMessage = isTimeUp ? 'Süre doldu! Sonuçlarınız otomatik olarak gönderiliyor.' : 'Sınavı bitirmek istediğinizden emin misiniz? Cevapsız sorularınız kalmış olabilir.';
            const confirmed = isTimeUp ? true : await showCustomConfirmation(confirmationMessage);
            
            if (confirmed) {
                const results = calculateScore();
                await saveSubmission(results);
                
                if (currentSessionDocId) {
                    try {
                        await deleteDoc(doc(db, "active_sessions", currentSessionDocId));
                    } catch (error) {
                        console.error("Oturum temizleme hatası:", error);
                    }
                }
                
                await showResultScreen(results, isTimeUp);
            } else {
                if (!isTimeUp) startTimer();
                updateNavigationButtons(currentQuestionIndex);
            }
        }

        function calculateScore() {
            let correctCount = 0, incorrectCount = 0, emptyCount = 0;
            quizQuestions.forEach((q, originalIndex) => {
                const answer = selectedAnswers[originalIndex];
                if (answer === null) emptyCount++;
                else if (answer === q.answer) correctCount++;
                else incorrectCount++;
            });
            return { correct: correctCount, incorrect: incorrectCount, empty: emptyCount, total: quizQuestions.length, score: correctCount * 100 / quizQuestions.length };
        }

        async function saveSubmission(results) {
            if (!db || isTeacherMode) {
                console.error("Veritabanı hazır değil veya öğretmen modu.");
                return;
            }

            const timeSpent = TIME_LIMIT_SECONDS - timeLeft;
            const studentKey = `${studentData.examCode}_${studentData.number}`;
            
            const submissionData = {
                ...studentData,
                studentKey: studentKey,
                score: results.score.toFixed(2),
                correct: results.correct,
                incorrect: results.incorrect,
                empty: results.empty,
                timeSpent: timeSpent,
                timestamp: serverTimestamp(),
                focusLossCount: focusLossCount,
                questionOrder: questionOrder,
                allAnswers: selectedAnswers
            };

            try {
                await addDoc(collection(db, "quiz_submissions"), submissionData);
                console.log("Sonuç başarıyla kaydedildi.");
            } catch (e) {
                console.error("Sonuç kaydedilirken hata oluştu: ", e);
                await showCustomAlert("Hata!", "Sonuçlar kaydedilemedi. Konsolu kontrol edin.");
            }
        }

        async function getRankingData(examCode) {
            if (!db) return [];
            const collectionRef = collection(db, 'quiz_submissions');
            const q = query(collectionRef, where('examCode', '==', examCode));
            try {
                const querySnapshot = await getDocs(q);
                return querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), score: parseFloat(doc.data().score) || 0, timeSpent: doc.data().timeSpent || 0 }));
            } catch (error) {
                console.error("Sıralama verisi çekilirken hata oluştu:", error);
                return [];
            }
        }

        async function showResultScreen(results, isTimeUp) {
            document.getElementById('app').classList.remove('max-w-3xl','max-w-4xl');
            document.getElementById('app').classList.add('max-w-md');
            document.getElementById('loginHeader').innerHTML = '<h1 class="text-2xl font-extrabold">Sınav Sonucu</h1>';
            const timeSpent = TIME_LIMIT_SECONDS - timeLeft;
            const timeSpentMinutes = Math.floor(timeSpent / 60);
            const timeSpentSeconds = timeSpent % 60;
            const rankingData = await getRankingData(studentData.examCode);
            const rankedList = rankingData.sort((a,b)=>{ const sc = parseFloat(b.score)-parseFloat(a.score); if (sc!==0) return sc; return a.timeSpent - b.timeSpent; });
            const totalStudents = rankedList.length;
            const studentKey = `${studentData.examCode}_${studentData.number}`;
            const studentRank = rankedList.findIndex(sub => sub.studentKey === studentKey) + 1;
            const top5 = rankedList.slice(0,5);
            const top5Html = top5.map((s,index) => `
                <li class="flex justify-between p-2 rounded-lg text-gray-700 ${index < 3 ? 'bg-yellow-200/50 font-bold border-l-4 border-yellow-500' : 'bg-gray-100'} ${s.studentKey === studentKey ? 'bg-indigo-200/70 border-l-4 border-indigo-600' : ''}">
                    <span class="text-sm">${index + 1}. ${s.name} (${s.className})</span>
                    <span class="text-sm font-semibold ${parseFloat(s.score) >= 50 ? 'text-green-700' : 'text-red-700'}">${parseFloat(s.score).toFixed(2)} Puan</span>
                </li>
            `).join('');

            const resultHtml = `
                <div class="text-center py-6">
                    <h2 class="text-3xl font-bold ${results.score >= 50 ? 'text-green-600' : 'text-red-600'} mb-2">Sınav Bitti!</h2>
                    ${isTimeUp ? '<p class="text-red-500 font-semibold mb-4">Süreniz Dolduğu İçin Otomatik Gönderildi.</p>' : ''}
                    <p class="text-lg text-gray-700 mb-6">${studentData.name}, sonuçlarınız kaydedildi.</p>
                    <div class="grid grid-cols-2 gap-4 text-left max-w-sm mx-auto p-4 bg-gray-50 rounded-xl shadow-inner mb-6">
                        <div class="font-semibold text-gray-600">Puanınız:</div>
                        <div class="font-bold text-2xl ${results.score >= 50 ? 'text-green-600' : 'text-red-600'}">${results.score.toFixed(2)} / 100</div>
                        <div class="font-semibold text-gray-600">Doğru/Yanlış/Boş:</div>
                        <div class="font-bold text-lg text-gray-800">${results.correct}D / ${results.incorrect}Y / ${results.empty}B</div>
                        <div class="font-semibold text-gray-600">Harcanan Süre:</div>
                        <div class="font-bold text-lg text-indigo-600">${timeSpentMinutes} dk ${String(timeSpentSeconds).padStart(2,'0')} sn</div>
                    </div>
                    <div class="bg-indigo-50 p-4 rounded-xl shadow-lg mb-6 max-w-sm mx-auto border-t-4 border-indigo-500">
                        <h3 class="text-xl font-bold text-indigo-800 mb-3">Sınav İstatistikleri (${studentData.examCode})</h3>
                        <p class="text-md font-semibold text-gray-700 mb-2">Toplam Katılımcı: <span class="text-indigo-600 font-extrabold">${totalStudents}</span> öğrenci</p>
                        <div class="p-3 bg-indigo-500 rounded-lg text-white my-3">
                            <p class="text-sm">Bu sınavdaki sıralamanız:</p>
                            <p class="text-3xl font-extrabold">#${studentRank}</p>
                        </div>
                        <div class="mt-4">
                            <h4 class="font-bold text-gray-700 mb-2 text-left">En İyi 5 Derece:</h4>
                            <ul class="space-y-1 text-left">${top5Html}</ul>
                        </div>
                    </div>
                    ${focusLossCount > 0 ? `<div class="mt-6 p-3 bg-red-100 border border-red-400 rounded-lg text-red-800 text-sm font-semibold max-w-sm mx-auto">⚠️ Sayfadan Ayrılma Sayısı (Kopya Önleme Kaydı): ${focusLossCount}</div>` : ''}
                </div>
                <div class="mt-8 text-center"><button id="returnToLogin" class="button bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md">Ana Ekrana Dön</button></div>
            `;
            document.getElementById('mainContentArea').innerHTML = resultHtml;
            document.getElementById('returnToLogin').addEventListener('click', showLoginForm);
        }

let currentSubmissions = [];

function showTeacherPanel() {
    document.getElementById('app').classList.remove('max-w-md');
    document.getElementById('app').classList.add('max-w-4xl');
    document.getElementById('loginHeader').innerHTML = '<h1 class="text-2xl font-extrabold">Öğretmen Sonuç Paneli (Canlı)</h1>';

    const teacherHtml = `
        <p class="text-sm text-gray-600 text-center mb-4">Yeni sonuçlar sayfayı yenilemeden anında görünür (Firebase onSnapshot).</p>
        <div class="flex justify-start items-center mb-4 gap-2 flex-wrap">
            <input type="text" id="filterExamCode" placeholder="Sınav Kodu ile filtrele" class="border border-gray-300 rounded-lg px-3 py-1 text-sm" />
            <input type="text" id="filterStudentNumber" placeholder="Öğrenci No ile filtrele" class="border border-gray-300 rounded-lg px-3 py-1 text-sm" />
        </div>
        <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
            <button id="downloadCsvButton" class="button bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg text-sm shadow-md">Tüm Sonuçları Excel (CSV) İndir</button>
            <button id="teacherLogout" class="button bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg text-sm shadow-md">Çıkış Yap</button>
        </div>
        <div class="overflow-x-auto bg-white rounded-lg shadow-lg border border-indigo-100">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-indigo-100">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Sınav Kodu</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Ad Soyad</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Puan</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Doğru</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Süre</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Odak Kaybı</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Sınıf / No</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">İşlem</th>
                    </tr>
                </thead>
                <tbody id="submissionsTableBody" class="bg-white divide-y divide-gray-200">
                    <tr><td colspan="8" class="text-center py-4 text-gray-500">Sonuçlar yükleniyor...</td></tr>
                </tbody>
            </table>
        </div>
    `;

    document.getElementById('mainContentArea').innerHTML = teacherHtml;

    document.getElementById('teacherLogout').addEventListener('click', showLoginForm);
    document.getElementById('downloadCsvButton').addEventListener('click', downloadSubmissionsAsCsv);
    document.getElementById('filterExamCode').addEventListener('input', renderSubmissionsTable);
    document.getElementById('filterStudentNumber').addEventListener('input', renderSubmissionsTable);

    loadSubmissions();
}

function loadSubmissions() {
    if (!db || !isAuthReady) return;
    const collectionRef = collection(db, `quiz_submissions`);
    const q = query(collectionRef);

    onSnapshot(q, (snapshot) => {
        currentSubmissions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        currentSubmissions.sort((a, b) => {
            const scoreCompare = parseFloat(b.score) - parseFloat(a.score);
            if (scoreCompare !== 0) return scoreCompare;
            return a.timeSpent - b.timeSpent;
        });
        renderSubmissionsTable();
    }, (error) => {
        console.error("Sonuçlar dinlenirken hata oluştu: ", error);
        document.getElementById('submissionsTableBody').innerHTML = `<tr><td colspan="8" class="text-center py-4 text-red-500">Veritabanı bağlantı hatası.</td></tr>`;
    });
}

function renderSubmissionsTable() {
    const tableBody = document.getElementById('submissionsTableBody');
    if (!tableBody) return;

    const examCodeFilter = document.getElementById('filterExamCode')?.value.toLowerCase() || '';
    const studentNumberFilter = document.getElementById('filterStudentNumber')?.value.toLowerCase() || '';

    const filteredSubmissions = currentSubmissions.filter(sub => {
        const matchesExamCode = sub.examCode?.toLowerCase().includes(examCodeFilter);
        const matchesNumber = sub.number?.toString().toLowerCase().includes(studentNumberFilter);
        return matchesExamCode && matchesNumber;
    });

    if (filteredSubmissions.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-gray-500">Filtreye uyan sonuç bulunamadı.</td></tr>';
        return;
    }

    tableBody.innerHTML = filteredSubmissions.map(submission => {
        const scoreColor = parseFloat(submission.score) >= 50 ? 'text-green-600' : 'text-red-600';
        const timeSpentMinutes = Math.floor(submission.timeSpent / 60);
        const timeSpentSeconds = submission.timeSpent % 60;
        const focusLossText = submission.focusLossCount > 0 ? `⚠️ ${submission.focusLossCount}` : 'Yok';
        const focusLossColor = submission.focusLossCount > 0 ? 'bg-yellow-100 text-yellow-800 font-bold' : 'text-gray-500';

        return `
            <tr class="hover:bg-gray-50 transition duration-150">
                <td class="px-4 py-3 whitespace-nowrap text-sm text-indigo-700 font-semibold">${submission.examCode || '-'}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${submission.name || 'Bilinmiyor'}</td>
                <td class="px-4 py-3 whitespace-nowrap text-lg font-bold ${scoreColor}">${submission.score}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-green-500">${submission.correct}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-indigo-600">${timeSpentMinutes} dk ${String(timeSpentSeconds).padStart(2,'0')} sn</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm ${focusLossColor}">${focusLossText}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${submission.className || '-'} / ${submission.number || '-'}</td>
                <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                    <button data-id="${submission.id}" class="delete-btn text-red-600 hover:text-red-900 transition duration-150">Sil</button>
                </td>
            </tr>
        `;
    }).join('');

    tableBody.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', handleDeleteSubmission);
    });
}

async function handleDeleteSubmission(event) {
    const submissionId = event.target.dataset.id;
    if (!db) return;
    const docRef = doc(db, `quiz_submissions`, submissionId);
    const confirmed = await showCustomConfirmation('Bu kaydı silmek istediğinizden emin misiniz?');
    if (confirmed) {
        try {
            await deleteDoc(docRef);
            await showCustomAlert("Başarılı", "Kayıt silindi.");
        } catch (e) {
            console.error("Kaydı silerken hata oluştu: ", e);
            await showCustomAlert("Hata", "Kaydı silerken bir hata oluştu.");
        }
    }
}

function downloadSubmissionsAsCsv() {
    if (currentSubmissions.length === 0) {
        showCustomAlert("Uyarı", "İndirilecek veri bulunmamaktadır.");
        return;
    }

    const header = [
        'Sınav Kodu', 'Öğrenci Adı', 'Okul No', 'Sınıf', 'Puan', 'Doğru', 'Yanlış', 'Boş',
        'Harcanan Süre (sn)', 'Harcanan Süre (dk:sn)', 'Odak Kaybı Sayısı', 'Soru Sırası', 'Tarih', 'Öğrenci Key'
    ];
    const csvRows = [header.join(';')];

    currentSubmissions.forEach(sub => {
        const timestamp = sub.timestamp?.toDate ? sub.timestamp.toDate().toLocaleString('tr-TR') : (sub.timestamp || 'N/A');
        const timeStr = `${Math.floor(sub.timeSpent / 60)}:${String(sub.timeSpent % 60).padStart(2,'0')}`;
        const row = [
            sub.examCode || EXAM_CODE,
            `"${sub.name}"`,
            sub.number,
            sub.className,
            sub.score,
            sub.correct,
            sub.incorrect,
            sub.empty,
            sub.timeSpent,
            timeStr,
            sub.focusLossCount || 0,
            `"${sub.questionOrder?.join(',') || 'N/A'}"`,
            `"${timestamp}"`,
            sub.studentKey || 'N/A'
        ];
        csvRows.push(row.map(item => String(item).replace(/"/g, '""')).join(';'));
    });

    const csvString = csvRows.join('\n');
    const blob = new Blob(["\ufeff" + csvString], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.setAttribute('href', url);
    link.setAttribute('download', 'sinav_sonuclari_detayli_guvenlik.csv');
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function showCustomConfirmation(message) {
    return new Promise(resolve => {
        const modal = document.getElementById('customModal');
        const modalContent = document.getElementById('modalContent');
        modalContent.innerHTML = `
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Onay Gerekli</h3>
            <p class="text-gray-600 mb-6 whitespace-pre-line">${message}</p>
            <div class="flex justify-center space-x-4">
                <button id="modalConfirm" class="button bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md">Evet</button>
                <button id="modalCancel" class="button bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md">Hayır</button>
            </div>
        `;
        modal.classList.remove('hidden'); modal.classList.add('flex');
        document.getElementById('modalConfirm').onclick = () => { modal.classList.add('hidden'); modal.classList.remove('flex'); resolve(true); };
        document.getElementById('modalCancel').onclick = () => { modal.classList.add('hidden'); modal.classList.remove('flex'); resolve(false); };
    });
}

function showCustomAlert(title, message) {
    return new Promise(resolve => {
        const modal = document.getElementById('customModal');
        const modalContent = document.getElementById('modalContent');
        modalContent.innerHTML = `
            <h3 class="text-xl font-semibold text-gray-800 mb-4">${title}</h3>
            <p class="text-gray-600 mb-6 whitespace-pre-line">${message}</p>
            <button id="modalClose" class="button bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md">Tamam</button>
        `;
        modal.classList.remove('hidden'); modal.classList.add('flex');
        document.getElementById('modalClose').onclick = () => { modal.classList.add('hidden'); modal.classList.remove('flex'); resolve(); };
    });
}

initializeFirebase();

    </script>
</body>
</html>

