<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Öğrenci Sınav Uygulaması</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0;}
        .app-card { background-color:white;padding:2.5rem;border-radius:1.5rem;box-shadow:0 10px 15px -3px rgba(0,0,0,0.1);max-width:450px;width:90%;}
        .header-bg { background: linear-gradient(135deg,#4f46e5 0%,#818cf8 100%); color:white;padding:1rem 0;border-radius:1rem 1rem 0 0;margin:-2.5rem -2.5rem 1.5rem -2.5rem;text-align:center;}
        .button { transition:all .2s; }
        .button:hover { transform:translateY(-2px); }
    </style>
</head>
<body>
    <div id="app" class="app-card">
        <div id="loginHeader" class="header-bg">
            <h1 class="text-2xl font-extrabold">Öğrenci Girişi</h1>
        </div>
        <div id="mainContentArea">
            <div id="loadingIndicator" class="text-center py-10">
                <svg class="animate-spin h-5 w-5 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="text-sm text-gray-500 mt-2">Sistem Başlatılıyor...</p>
                <p id="systemStatus" class="text-xs text-gray-400 mt-4"></p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, addDoc, updateDoc, deleteDoc, doc, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        let db, auth, userId = null, isAuthReady = false;
        const TEACHER_CODE = 'OGRETMEN34';
        const EXAM_CODE = '111';
        const TEACHER_NAME = 'Öztürk sevinç (biyoloji Öğretmeni)';
        const TIME_LIMIT_SECONDS = 600;
        
        const firebaseConfig = {
            apiKey: "AIzaSyCHhFAHbWnclad6yFuI-Pw9gX6F_Dx1B2c",
            authDomain: "online-sinav-b3644.firebaseapp.com",
            projectId: "online-sinav-b3644",
            storageBucket: "online-sinav-b3644.firebasestorage.app",
            messagingSenderId: "965507531268",
            appId: "1:965507531268:web:94cfd13774a40b6cf16b51"
        };

        const quizQuestions = [
          { "question": "Canlıları benzerlik, farklılık ve akrabalılık derecelerine göre gruplara ayırma ilke ve ölçütlerini belirleyen bilim dalına ne ad verilir?", "options": ["Morfoloji", "Histoloji", "Biyokimya", "Taksonomi", "Fizyoloji"], "answer": "Taksonomi" },
          { "question": "Aşağıdakilerden hangisi, ortak özelliklere, genetik mirasa sahip olan ve birbirleriyle çiftleşip verimli döl verebilen canlılar grubu?", "options": ["Cins", "Aile", "Şube", "Âlem", "Tür"], "answer": "Tür" },
          { "question": "Günümüzde canlıların akrabalılık ilişkilerine göre yapılan sınıflandırma sistemi?", "options": ["Yapısal", "Yapay", "Sistematik", "Doğal (Filogenetik)", "Ekolojik"], "answer": "Doğal (Filogenetik)" },
          { "question": "İkili adlandırma yöntemini öneren İsveçli doğa bilimci kimdir?", "options": ["Aristoteles", "Galileo", "Carl Linneaus", "Darwin", "Mendel"], "answer": "Carl Linneaus" },
        ];

        let selectedAnswers = Array(quizQuestions.length).fill(null);
        let questionOrder = Array.from({length: quizQuestions.length}, (_, i) => i);
        let currentQuestionIndex = 0, resumeStartIndex = 0, timeLeft = TIME_LIMIT_SECONDS, isTeacherMode = false;
        let studentData = {}, focusLossCount = 0, currentSessionDocId = null, timerInterval;

        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                document.getElementById('systemStatus').textContent = 'Oturum açılıyor...';
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (user) => {
                    userId = user?.uid || null;
                    isAuthReady = true;
                    document.getElementById('loadingIndicator')?.classList.add('hidden');
                    showLoginForm();
                });
            } catch (error) {
                console.error("Firebase hatası:", error);
                document.getElementById('mainContentArea').innerHTML = `<p class="text-red-600">Hata: ${error.message}</p>`;
            }
        }

        function showLoginForm() {
            if (!isAuthReady) return;
            document.getElementById('app').classList.remove('max-w-3xl');
            document.getElementById('app').classList.add('max-w-md');
            const content = `
                <div class="space-y-4">
                    <div class="text-center p-2 bg-indigo-50 rounded-lg">
                        <p class="text-xs text-gray-500">Sınavı Hazırlayan:</p>
                        <p class="font-bold text-indigo-700">${TEACHER_NAME}</p>
                    </div>
                    <input id="examCodeInput" type="text" placeholder="Sınav Kodu (111)" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    <input id="nameInput" type="text" placeholder="Adınız Soyadınız" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    <input id="numberInput" type="number" placeholder="Okul Numaranız" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    <input id="classInput" type="text" placeholder="Sınıfınız (10A)" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    <button id="startQuizButton" class="button w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-lg">Sınava Başla</button>
                    <button id="teacherLoginButton" class="button w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 rounded-lg text-sm">Öğretmen Girişi</button>
                </div>
            `;
            document.getElementById('mainContentArea').innerHTML = content;
            document.getElementById('startQuizButton').addEventListener('click', handleStudentLogin);
            document.getElementById('teacherLoginButton').addEventListener('click', showTeacherLogin);
        }

        async function handleStudentLogin() {
            const name = document.getElementById('nameInput').value.trim();
            const number = document.getElementById('numberInput').value.trim();
            const className = document.getElementById('classInput').value.trim();
            const examCode = document.getElementById('examCodeInput').value.trim().toUpperCase();
            
            if (!name || !number || !className || !examCode) {
                alert("Lütfen tüm alanları doldurun.");
                return;
            }
            if (examCode !== EXAM_CODE) {
                alert("Hatalı sınav kodu!");
                return;
            }

            studentData = { name, number, className, examCode };
            isTeacherMode = false;
            const studentKey = `${examCode}_${number}`;
            
            const completed = await checkCompletedExam(studentKey);
            if (completed) {
                alert(`Bu sınavı tamamladınız!\nPuan: ${completed.score}`);
                return;
            }

            const existing = await checkExistingSession(studentKey);
            if (existing) {
                alert(`Daha önce başladınız.\nKalan süre: ${Math.floor(existing.timeLeft / 60)} dk`);
                questionOrder = existing.questionOrder || [];
                selectedAnswers = existing.selectedAnswers || Array(quizQuestions.length).fill(null);
                currentQuestionIndex = existing.currentQuestionIndex || 0;
                timeLeft = existing.timeLeft || TIME_LIMIT_SECONDS;
                focusLossCount = existing.focusLossCount || 0;
                currentSessionDocId = existing.id;
                resumeStartIndex = currentQuestionIndex;
                showQuiz();
                return;
            }

            questionOrder = seededShuffle(Array.from({length: quizQuestions.length}, (_, i) => i), number);
            selectedAnswers = Array(quizQuestions.length).fill(null);
            currentQuestionIndex = 0;
            resumeStartIndex = 0;
            focusLossCount = 0;
            timeLeft = TIME_LIMIT_SECONDS;
            currentSessionDocId = null;
            showQuiz();
        }

        async function checkCompletedExam(studentKey) {
            if (!db) return null;
            try {
                const q = query(collection(db, "quiz_submissions"), where("studentKey", "==", studentKey));
                const snap = await getDocs(q);
                return snap.empty ? null : { score: snap.docs[0].data().score };
            } catch (e) { console.error(e); return null; }
        }

        async function checkExistingSession(studentKey) {
            if (!db) return null;
            try {
                const q = query(collection(db, "active_sessions"), where("studentKey", "==", studentKey));
                const snap = await getDocs(q);
                return snap.empty ? null : { id: snap.docs[0].id, ...snap.docs[0].data() };
            } catch (e) { console.error(e); return null; }
        }

        function seededShuffle(array, seed) {
            let hash = 0;
            for (let i = 0; i < seed.length; i++) {
                hash = ((hash << 5) - hash) + seed.charCodeAt(i);
                hash |= 0;
            }
            const shuffled = [...array];
            let n = shuffled.length;
            while (n > 1) {
                hash = (hash * 9301 + 49297) % 233280;
                if (hash < 0) hash += 233280;
                let random = hash / 233280.0;
                let k = Math.floor(random * n);
                n--;
                [shuffled[n], shuffled[k]] = [shuffled[k], shuffled[n]];
            }
            return shuffled;
        }

        function showTeacherLogin() {
            document.getElementById('loginHeader').innerHTML = '<h1 class="text-2xl font-extrabold">Öğretmen Girişi</h1>';
            const content = `
                <div class="space-y-4">
                    <input id="teacherCodeInput" type="password" placeholder="Öğretmen Kodu" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    <button id="teacherLoginButtonExecute" class="button w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 rounded-lg">Giriş Yap</button>
                    <button id="backToStudentLogin" class="button w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 rounded-lg text-sm">Öğrenci Girişine Dön</button>
                </div>
            `;
            document.getElementById('mainContentArea').innerHTML = content;
            document.getElementById('teacherLoginButtonExecute').addEventListener('click', () => {
                if (document.getElementById('teacherCodeInput').value === TEACHER_CODE) {
                    isTeacherMode = true;
                    showTeacherPanel();
                } else {
                    alert("Hatalı kod!");
                }
            });
            document.getElementById('backToStudentLogin').addEventListener('click', showLoginForm);
        }

        function showQuiz() {
            document.getElementById('app').classList.remove('max-w-md');
            document.getElementById('app').classList.add('max-w-3xl');
            document.getElementById('loginHeader').innerHTML = `<h1 class="text-2xl font-extrabold">${studentData.name}</h1>`;
            
            const quizHtml = `
                <div class="mb-6 pb-3 border-b flex justify-between items-center">
                    <p class="text-gray-600">${studentData.className} / ${studentData.number}</p>
                    <p class="text-indigo-600">Soru: <span id="questionCounter">1/${quizQuestions.length}</span></p>
                    <div id="timerDisplay" class="text-2xl font-bold text-red-600 bg-red-100 p-2 rounded-lg">10:00</div>
                </div>
                <div id="questionsContainer" class="min-h-[250px]"></div>
                <div class="mt-8 pt-4 border-t flex justify-between">
                    <button id="prevButton" class="button bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg disabled:opacity-50" disabled>Önceki</button>
                    <button id="nextButton" class="button bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg">Sonraki</button>
                </div>
            `;
            document.getElementById('mainContentArea').innerHTML = quizHtml;
            
            renderQuestion(currentQuestionIndex);
            startTimer();
            setupFocusCheck();
            
            document.getElementById('prevButton').addEventListener('click', handlePrevQuestion);
            document.getElementById('nextButton').addEventListener('click', handleNextQuestion);
        }

        function renderQuestion(index) {
            const container = document.getElementById('questionsContainer');
            if (!container) return;
            
            const origIdx = questionOrder[index];
            const q = quizQuestions[origIdx];
            const shuffledOpts = seededShuffle(q.options, studentData.number + origIdx);
            const currAns = selectedAnswers[origIdx];

            const html = `
                <div class="p-6 border-4 border-indigo-200 rounded-xl bg-white">
                    <div class="text-2xl font-bold text-indigo-700 mb-4">Soru ${index + 1}:</div>
                    <p class="text-lg mb-6">${q.question}</p>
                    <div class="space-y-3">
                        ${shuffledOpts.map(opt => `
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-indigo-50 ${currAns === opt ? 'bg-indigo-100 border-indigo-500' : 'border-gray-200'}">
                                <input type="radio" name="answer" value="${opt}" ${currAns === opt ? 'checked' : ''} class="mr-3">
                                <span>${opt}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
            `;
            container.innerHTML = html;
            document.getElementById('questionCounter').textContent = `${index + 1}/${quizQuestions.length}`;
            
            container.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.addEventListener('change', async (e) => {
                    selectedAnswers[origIdx] = e.target.value;
                    await saveProgress();
                });
            });
            
            updateNavButtons(index);
        }

        function updateNavButtons(index) {
            document.getElementById('prevButton').disabled = index <= resumeStartIndex;
            const nextBtn = document.getElementById('nextButton');
            if (index === quizQuestions.length - 1) {
                nextBtn.textContent = "Bitir ve Gönder";
                nextBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            } else {
                nextBtn.textContent = "Sonraki";
            }
        }

        async function handleNextQuestion() {
            if (currentQuestionIndex < quizQuestions.length - 1) {
                currentQuestionIndex++;
                renderQuestion(currentQuestionIndex);
                await saveProgress();
            } else {
                finishQuiz();
            }
        }

        async function handlePrevQuestion() {
            if (currentQuestionIndex > resumeStartIndex) {
                currentQuestionIndex--;
                renderQuestion(currentQuestionIndex);
                await saveProgress();
            }
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            const display = document.getElementById('timerDisplay');
            timerInterval = setInterval(() => {
                timeLeft--;
                if (timeLeft < 0) {
                    clearInterval(timerInterval);
                    finishQuiz();
                }
                const m = Math.floor(timeLeft / 60);
                const s = timeLeft % 60;
                display.textContent = `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            }, 1000);
        }

        async function saveProgress() {
            if (!db || isTeacherMode) return;
            const key = `${studentData.examCode}_${studentData.number}`;
            const data = {
                ...studentData,
                studentKey: key,
                questionOrder,
                selectedAnswers,
                currentQuestionIndex,
                timeLeft,
                focusLossCount,
                lastUpdated: serverTimestamp()
            };
            try {
                if (currentSessionDocId) {
                    await updateDoc(doc(db, "active_sessions", currentSessionDocId), data);
                } else {
                    const ref = await addDoc(collection(db, "active_sessions"), data);
                    currentSessionDocId = ref.id;
                }
            } catch (e) { console.error(e); }
        }

        async function finishQuiz() {
            clearInterval(timerInterval);
            const correct = selectedAnswers.filter((a, i) => a === quizQuestions[i].answer).length;
            const score = (correct / quizQuestions.length) * 100;
            
            await saveSubmission(correct, score);
            if (currentSessionDocId) await deleteDoc(doc(db, "active_sessions", currentSessionDocId));
            
            document.getElementById('mainContentArea').innerHTML = `
                <div class="text-center py-6">
                    <h2 class="text-3xl font-bold ${score >= 50 ? 'text-green-600' : 'text-red-600'} mb-4">Sınav Bitti!</h2>
                    <p class="text-lg mb-6">Puanınız: <span class="text-2xl font-bold">${score.toFixed(2)}</span> / 100</p>
                    <p class="text-gray-600 mb-6">Doğru: ${correct} / ${quizQuestions.length}</p>
                    <button onclick="location.reload()" class="button bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg">Başa Dön</button>
                </div>
            `;
        }

        async function saveSubmission(correct, score) {
            if (!db || isTeacherMode) return;
            const key = `${studentData.examCode}_${studentData.number}`;
            try {
                await addDoc(collection(db, "quiz_submissions"), {
                    ...studentData,
                    studentKey: key,
                    score: score.toFixed(2),
                    correct,
                    timeSpent: TIME_LIMIT_SECONDS - timeLeft,
                    timestamp: serverTimestamp()
                });
            } catch (e) { console.error(e); }
        }

        function setupFocusCheck() {
            window.addEventListener('blur', () => { focusLossCount++; });
        }

        function showTeacherPanel() {
            document.getElementById('app').classList.remove('max-w-md');
            document.getElementById('app').classList.add('max-w-4xl');
            document.getElementById('loginHeader').innerHTML = '<h1 class="text-2xl font-extrabold">Öğretmen Paneli</h1>';
            
            const content = `
                <div class="space-y-4">
                    <button id="teacherLogout" class="button bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg">Çıkış Yap</button>
                    <div id="submissionsTable" class="bg-white rounded-lg shadow overflow-auto">
                        <p class="p-4 text-gray-500">Sonuçlar yükleniyor...</p>
                    </div>
                </div>
            `;
            document.getElementById('mainContentArea').innerHTML = content;
            document.getElementById('teacherLogout').addEventListener('click', showLoginForm);
            
            loadTeacherData();
        }

        function loadTeacherData() {
            if (!db || !isAuthReady) return;
            const q = query(collection(db, "quiz_submissions"));
            onSnapshot(q, (snap) => {
                const subs = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => parseFloat(b.score) - parseFloat(a.score));
                const html = `
                    <table class="min-w-full border-collapse">
                        <thead class="bg-indigo-100"><tr>
                            <th class="border p-2 text-left">Ad</th>
                            <th class="border p-2 text-left">Puan</th>
                            <th class="border p-2 text-left">Doğru</th>
                            <th class="border p-2 text-left">Sınıf</th>
                        </tr></thead>
                        <tbody>
                            ${subs.map(s => `<tr class="hover:bg-gray-50">
                                <td class="border p-2">${s.name}</td>
                                <td class="border p-2 font-bold">${s.score}</td>
                                <td class="border p-2">${s.correct}/${quizQuestions.length}</td>
                                <td class="border p-2">${s.className}</td>
                            </tr>`).join('')}
                        </tbody>
                    </table>
                `;
                document.getElementById('submissionsTable').innerHTML = html;
            });
        }

        initializeFirebase();
    </script>
</body>
</html>
