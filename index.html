<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SÄ±nav Sistemi V13 (GÃ¼venli & Optimize)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0;}
        .app-card { background-color:white;padding:2.5rem;border-radius:1.5rem;box-shadow:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05);max-width:450px;width:90%;transition:all .3s;position:relative;}
        .header-bg { background: linear-gradient(135deg,#4f46e5 0%,#818cf8 100%); color:white;padding:1rem 0;border-radius:1rem 1rem 0 0;margin:-2.5rem -2.5rem 1.5rem -2.5rem;text-align:center;}
        .button{transition:all .2s;box-shadow:0 4px 6px rgba(0,0,0,0.1)}
        .button:hover{transform:translateY(-1px);box-shadow:0 6px 10px rgba(0,0,0,0.15)}
        .teacher-mode { max-width: 1400px !important; width: 98% !important; } 
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="app" class="app-card">
        <div id="loginHeader" class="header-bg">
            <h1 class="text-2xl font-extrabold">Ã–ÄŸrenci GiriÅŸi</h1>
        </div>
        
        <div id="connectionStatus" class="hidden mb-4 text-xs font-bold text-center p-2 rounded border"></div>
        
        <div id="mainContentArea">
            <div id="loadingIndicator" class="text-center py-10">
                <div class="loader"></div>
                <p id="loadingText" class="text-sm text-gray-500 mt-4 font-bold">Sistem BaÅŸlatÄ±lÄ±yor...</p>
            </div>
        </div>
    </div>

    <div id="customModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center p-4 z-50">
        <div id="modalContent" class="bg-white rounded-xl p-6 max-w-3xl w-full text-center shadow-2xl overflow-y-auto max-h-[90vh]"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, serverTimestamp, query, where, getDocs, deleteDoc, getDoc, addDoc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCHhFAHbWnclad6yFuI-Pw9gX6F_Dx1B2c",
            authDomain: "online-sinav-b3644.firebaseapp.com",
            projectId: "online-sinav-b3644",
            storageBucket: "online-sinav-b3644.firebasestorage.app",
            messagingSenderId: "965507531268",
            appId: "1:965507531268:web:94cfd13774a40b6cf16b51"
        };

        // --- Global DeÄŸiÅŸkenler ---
        let db, auth;
        let isAuthReady = false, isDbConnected = false;
        let adminMasterCode = null; // GÃœVENLÄ°K: VarsayÄ±lan ÅŸifre kaldÄ±rÄ±ldÄ±.
        let systemPreparerName = "Sistem YÃ¶neticisi";

        let currentExamConfig = {
            exam_code: "DEFAULT",
            teacher_name: "YÃ¼kleniyor...",
            time_limit: 600,
            exam_description: "SÄ±nav bilgisi bekleniyor..."
        };
        
        let quizQuestions = []; // Sorular (Cevaplar dahil olabilir ama UI'da gizlenecek)
        let studentList = [];
        
        // SÄ±nav Oturum DeÄŸiÅŸkenleri
        let studentData = {};
        let selectedAnswers = [];
        let questionOrder = [];
        let currentQuestionIndex = 0;
        let focusLossCount = 0;
        let currentSessionDocId = null;
        
        // Timer DeÄŸiÅŸkenleri (GÃœVENLÄ°K GÃœNCELLEMESÄ°)
        let timerInterval = null;
        let examendTimeStamp = null; // SÄ±navÄ±n kesin biteceÄŸi timestamp
        let autoSaveInterval = null;
        
        // Admin ve Tablo Verileri
        let allSubmissions = [];
        let isTeacherMode = false;

        // Helper: Firebase ReferanslarÄ±
        const getConfigRef = (code) => doc(db, "exam_settings", code.toUpperCase());
        const getQuestionsRef = (code) => doc(db, "questions_pool", code.toUpperCase());

        // --- SÄ°STEM BAÅLATMA ---
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await signInAnonymously(auth);
                onAuthStateChanged(auth, async (user) => {
                    if (user) { 
                        isAuthReady = true; 
                        await checkConnectivity(); 
                    }
                });
            } catch (error) { 
                showCustomAlert("Kritik Hata", "Firebase baÅŸlatÄ±lamadÄ±: " + error.message);
            }
        }

        // --- GÃœVENLÄ° BAÄLANTI KONTROLÃœ ---
        async function checkConnectivity() {
            const statusDiv = document.getElementById('connectionStatus');
            try {
                // Admin config Ã§ekmeyi dene
                const adminSnap = await getDoc(doc(db, "exam_settings", "admin_config"));
                
                if (adminSnap.exists()) {
                    const data = adminSnap.data();
                    adminMasterCode = data.master_code; // Sadece DB'den gelirse dolar
                    systemPreparerName = data.preparer_name || "Sistem YÃ¶neticisi";
                    
                    isDbConnected = true;
                    statusDiv.innerHTML = "ğŸŸ¢ Sistem Ã‡evrimiÃ§i";
                    statusDiv.className = "mb-4 text-xs font-bold text-center p-2 rounded border bg-green-100 text-green-800 border-green-300";
                } else {
                    throw new Error("Admin konfigÃ¼rasyonu eksik.");
                }
            } catch(e) {
                isDbConnected = false;
                adminMasterCode = null; // Veri yoksa ÅŸifre de yok
                statusDiv.innerHTML = `ğŸ”´ BAÄLANTI/VERÄ° HATASI<br><span class='text-[10px] font-normal'>${e.message}</span>`;
                statusDiv.className = "mb-4 text-xs font-bold text-center p-2 rounded border bg-red-100 text-red-800 border-red-300";
            }
            
            statusDiv.classList.remove('hidden');
            document.getElementById('loadingIndicator').classList.add('hidden');
            showLoginForm();
        }

        // --- RESET FONKSÄ°YONU (Sayfa Yenilemeden BaÅŸa DÃ¶nme) ---
        function resetApp() {
            // TÃ¼m state'i sÄ±fÄ±rla
            clearInterval(timerInterval);
            clearInterval(autoSaveInterval);
            window.onblur = null;
            
            currentExamConfig = { exam_code: "DEFAULT", teacher_name: systemPreparerName, time_limit: 600, exam_description: "..." };
            quizQuestions = [];
            studentList = [];
            studentData = {};
            selectedAnswers = [];
            questionOrder = [];
            currentQuestionIndex = 0;
            focusLossCount = 0;
            currentSessionDocId = null;
            examendTimeStamp = null;
            isTeacherMode = false;

            // UI SÄ±fÄ±rla
            document.getElementById('app').className = 'app-card max-w-md'; // Kart boyutunu kÃ¼Ã§Ã¼lt
            document.getElementById('connectionStatus').classList.remove('hidden'); // Durum Ã§ubuÄŸunu geri getir
            showLoginForm();
        }

        // --- SINAV VERÄ°SÄ° Ã‡EKME ---
        async function fetchExamData(code) {
            if (!isDbConnected) return false;
            
            try {
                // 1. AyarlarÄ± Ã‡ek
                const configSnap = await getDoc(getConfigRef(code));
                if (configSnap.exists()) {
                    currentExamConfig = { exam_code: code.toUpperCase(), ...configSnap.data() };
                } else {
                    currentExamConfig = { 
                        exam_code: code.toUpperCase(), 
                        teacher_name: systemPreparerName, 
                        time_limit: 600, 
                        exam_description: "SÄ±nav ayarlarÄ± bulunamadÄ±." 
                    };
                }

                // 2. SorularÄ± Ã‡ek
                const questionsSnap = await getDoc(getQuestionsRef(code));
                quizQuestions = questionsSnap.exists() ? (questionsSnap.data().questions_list || []) : [];
                
                // 3. Ã–ÄŸrenci Listesini Ã‡ek
                const listSnap = await getDoc(doc(db, "student_lists", code));
                studentList = listSnap.exists() ? (listSnap.data().students || []) : [];

                return true;
            } catch(e) {
                console.error(e);
                return false;
            }
        }

        // --- GÄ°RÄ°Å EKRANI ---
        function showLoginForm() {
            document.getElementById('loginHeader').innerHTML = '<h1 class="text-2xl font-extrabold">Ã–ÄŸrenci GiriÅŸi</h1>';
            
            document.getElementById('mainContentArea').innerHTML = `
                <div class="space-y-4">
                    <div class="text-center p-2 bg-indigo-50 rounded-lg border border-indigo-100">
                        <p class="text-xs text-gray-500">UygulayÄ±cÄ±</p>
                        <p class="font-bold text-indigo-700">${systemPreparerName}</p>
                    </div>
                    
                    <div id="examInfoArea" class="hidden bg-yellow-50 border border-yellow-200 p-3 rounded-lg text-sm text-yellow-800"></div>
                    
                    <input id="examCodeInput" type="text" placeholder="SINAV KODU (Ã–rn: 9A_MAT)" class="w-full p-3 border rounded-lg uppercase font-bold text-center tracking-widest">
                    
                    <div id="studentLoginFields" class="space-y-4">
                        <p class="text-sm text-center text-gray-400 italic mt-2">SÄ±nav kodunu girince liste aÃ§Ä±lacaktÄ±r.</p>
                    </div>

                    <button id="startQuizButton" class="button w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg shadow-lg opacity-50 cursor-not-allowed" disabled>SÄ±nava BaÅŸla</button>
                    
                    <div class="border-t pt-4 mt-4">
                        <button id="teacherLoginButton" class="text-gray-400 hover:text-gray-600 text-xs w-full text-center">YÃ¶netici GiriÅŸi</button>
                    </div>
                </div>
            `;

            // Event Listeners
            document.getElementById('teacherLoginButton').onclick = showTeacherLogin;
            document.getElementById('examCodeInput').oninput = handleCodeEntry;
            document.getElementById('startQuizButton').onclick = handleStudentLogin;
        }

        // Kod GirildikÃ§e Ã‡alÄ±ÅŸan Fonksiyon
        let typingTimer;
        async function handleCodeEntry() {
            clearTimeout(typingTimer);
            const code = document.getElementById('examCodeInput').value.trim().toUpperCase();
            const infoArea = document.getElementById('examInfoArea');
            const loginFields = document.getElementById('studentLoginFields');
            const btn = document.getElementById('startQuizButton');

            if (code.length < 3) {
                infoArea.classList.add('hidden');
                return;
            }

            typingTimer = setTimeout(async () => {
                const success = await fetchExamData(code);
                
                // SÄ±nav Bilgisi GÃ¶ster
                const mins = Math.floor(currentExamConfig.time_limit / 60);
                infoArea.innerHTML = `
                    <p class="font-bold">SÄ±nav: ${code}</p>
                    <p>${currentExamConfig.exam_description}</p>
                    <p class="text-xs mt-1">â±ï¸ SÃ¼re: ${mins} Dakika | ğŸ“ Soru: ${quizQuestions.length}</p>
                `;
                infoArea.classList.remove('hidden');

                if (!success || studentList.length === 0) {
                    // Manuel GiriÅŸ Modu
                    loginFields.innerHTML = `
                        <div class="bg-red-50 p-2 rounded text-xs text-red-700 mb-2">âš ï¸ Bu kod iÃ§in Ã¶ÄŸrenci listesi bulunamadÄ±. Manuel giriÅŸ yapÄ±nÄ±z.</div>
                        <input id="nameInput" type="text" placeholder="Ad Soyad" class="w-full p-3 border rounded-lg">
                        <input id="numberInput" type="number" placeholder="Okul No" class="w-full p-3 border rounded-lg">
                        <input id="classInput" type="text" placeholder="SÄ±nÄ±f (Ã–rn: 10A)" class="w-full p-3 border rounded-lg">
                    `;
                    // Manuel giriÅŸ validasyonu
                    const checkManual = () => {
                         const valid = document.getElementById('nameInput').value && document.getElementById('numberInput').value && document.getElementById('classInput').value;
                         btn.disabled = !valid;
                         btn.classList.toggle('opacity-50', !valid);
                         btn.classList.toggle('cursor-not-allowed', !valid);
                    };
                    document.getElementById('nameInput').oninput = checkManual;
                    document.getElementById('numberInput').oninput = checkManual;
                    document.getElementById('classInput').oninput = checkManual;

                } else {
                    // Liste Modu
                    const students = studentList.sort((a, b) => a.name.localeCompare(b.name, 'tr'));
                    const classes = [...new Set(students.map(s => s.className))].sort();

                    loginFields.innerHTML = `
                        <select id="classSelector" class="w-full p-3 border rounded-lg font-bold text-indigo-700 bg-white">
                            <option value="">-- SÄ±nÄ±fÄ±nÄ±zÄ± SeÃ§in --</option>
                            ${classes.map(c => `<option value="${c}">${c}</option>`).join('')}
                        </select>
                        <select id="studentSelector" class="w-full p-3 border rounded-lg bg-gray-100" disabled>
                            <option value="">-- Ã–nce SÄ±nÄ±f SeÃ§in --</option>
                        </select>
                        <div id="verificationArea" class="hidden mt-2">
                            <input id="numberVerify" type="number" placeholder="DoÄŸrulama iÃ§in Okul NumaranÄ±z" class="w-full p-3 border-2 border-indigo-300 rounded-lg focus:ring-indigo-500">
                        </div>
                    `;

                    document.getElementById('classSelector').onchange = (e) => {
                        const cls = e.target.value;
                        const stuSel = document.getElementById('studentSelector');
                        stuSel.innerHTML = '<option value="">-- AdÄ±nÄ±zÄ± SeÃ§in --</option>';
                        stuSel.disabled = !cls;
                        stuSel.classList.toggle('bg-gray-100', !cls);
                        document.getElementById('verificationArea').classList.add('hidden');
                        btn.disabled = true;
                        
                        if (cls) {
                            const filtered = students.filter(s => s.className === cls);
                            stuSel.innerHTML += filtered.map(s => `<option value="${s.number}_${s.name}">${s.name}</option>`).join('');
                        }
                    };

                    document.getElementById('studentSelector').onchange = (e) => {
                         const verifArea = document.getElementById('verificationArea');
                         if(e.target.value) {
                             verifArea.classList.remove('hidden');
                             document.getElementById('numberVerify').focus();
                         } else {
                             verifArea.classList.add('hidden');
                         }
                    };

                    document.getElementById('numberVerify').oninput = (e) => {
                        const val = e.target.value;
                        btn.disabled = !val;
                        btn.classList.toggle('opacity-50', !val);
                        btn.classList.toggle('cursor-not-allowed', !val);
                    };
                }
            }, 500);
        }

        // Ã–ÄŸrenci GiriÅŸ Ä°ÅŸlemi
        async function handleStudentLogin() {
            const code = document.getElementById('examCodeInput').value.trim().toUpperCase();
            if (!code) return;

            let name, number, className;
            
            if (document.getElementById('studentSelector')) {
                // Liste Modu
                const selVal = document.getElementById('studentSelector').value;
                const inputNum = document.getElementById('numberVerify').value;
                if (!selVal || !inputNum) return alert("Eksik bilgi.");

                const [realNum, realName] = selVal.split('_');
                
                if (realNum !== inputNum) {
                    return showCustomAlert("HatalÄ± DoÄŸrulama", "SeÃ§tiÄŸiniz ismin okul numarasÄ± ile girdiÄŸiniz numara eÅŸleÅŸmiyor.");
                }
                name = realName;
                number = realNum;
                className = document.getElementById('classSelector').value;
            } else {
                // Manuel Mod
                name = document.getElementById('nameInput').value;
                number = document.getElementById('numberInput').value;
                className = document.getElementById('classInput').value;
            }

            if (quizQuestions.length === 0) return showCustomAlert("Hata", "Bu sÄ±navda hiÃ§ soru yok.");

            studentData = { name, number, className, examCode: code };
            
            // MÃ¼kerrer GiriÅŸ ve KaldÄ±ÄŸÄ± Yerden Devam KontrolÃ¼
            const studentKey = `${code}_${number}`;
            const loadBtn = document.getElementById('startQuizButton');
            loadBtn.innerText = "Kontrol Ediliyor..."; loadBtn.disabled = true;

            try {
                // 1. Daha Ã¶nce bitirmiÅŸ mi?
                const subQ = query(collection(db, "quiz_submissions"), where("studentKey", "==", studentKey));
                const subSnap = await getDocs(subQ);
                if (!subSnap.empty) {
                    loadBtn.innerText = "GiriÅŸ"; loadBtn.disabled = false;
                    return showCustomAlert("SÄ±nav TamamlandÄ±", "Bu sÄ±navÄ± zaten tamamladÄ±nÄ±z.");
                }

                // 2. Aktif oturum var mÄ±?
                const sesQ = query(collection(db, "active_sessions"), where("studentKey", "==", studentKey));
                const sesSnap = await getDocs(sesQ);
                
                if (!sesSnap.empty) {
                    const session = sesSnap.docs[0].data();
                    showCustomAlert("Devam Ediliyor", "Ã–nceki oturumunuz bulundu, kaldÄ±ÄŸÄ±nÄ±z yerden devam ediyorsunuz.").then(() => {
                        restoreSession({ id: sesSnap.docs[0].id, ...session });
                        startQuiz();
                    });
                } else {
                    startNewSession(number);
                    startQuiz();
                }

            } catch(e) {
                showCustomAlert("Hata", "GiriÅŸ yapÄ±lÄ±rken hata oluÅŸtu: " + e.message);
                loadBtn.innerText = "SÄ±nava BaÅŸla"; loadBtn.disabled = false;
            }
        }

        // --- OTURUM YÃ–NETÄ°MÄ° ---
        function seededShuffle(array, seed) {
            // Basit ve tutarlÄ± karÄ±ÅŸtÄ±rma (Her Ã¶ÄŸrenci her giriÅŸte aynÄ± sÄ±rayÄ± gÃ¶rsÃ¼n diye)
            let hash = 0;
            for (let i = 0; i < seed.length; i++) hash = ((hash << 5) - hash) + seed.charCodeAt(i) | 0;
            const shuffled = [...array];
            let n = shuffled.length;
            while (n > 1) {
                hash = (hash * 9301 + 49297) % 233280;
                let random = (hash < 0 ? hash + 233280 : hash) / 233280.0;
                let k = Math.floor(random * n--);
                [shuffled[n], shuffled[k]] = [shuffled[k], shuffled[n]];
            }
            return shuffled;
        }

        function startNewSession(seed) {
            // SorularÄ±n indekslerini karÄ±ÅŸtÄ±r
            questionOrder = seededShuffle(Array.from({length: quizQuestions.length}, (_, i) => i), seed);
            selectedAnswers = Array(quizQuestions.length).fill(null);
            currentQuestionIndex = 0;
            focusLossCount = 0;
            
            // ZAMANLAYICI BAÅLANGIÃ‡ (Date.now() temelli)
            const now = Date.now();
            examendTimeStamp = now + (currentExamConfig.time_limit * 1000);
        }

        function restoreSession(session) {
            questionOrder = session.questionOrder || [];
            selectedAnswers = session.selectedAnswers || [];
            currentQuestionIndex = session.currentQuestionIndex || 0;
            focusLossCount = session.focusLossCount || 0;
            currentSessionDocId = session.id;
            
            // Kalan sÃ¼reyi timestamp'e Ã§evir
            // EÄŸer session.timeLeft varsa, ÅŸu andan itibaren o kadar sÃ¼re ekle
            // (Not: Ä°dealde server timestamp kullanÄ±lÄ±r ama basitlik iÃ§in client gÃ¼veniyoruz burada)
            const remaining = session.timeLeft || currentExamConfig.time_limit;
            examendTimeStamp = Date.now() + (remaining * 1000);
        }

        // --- SINAV ARAYÃœZÃœ ---
        function startQuiz() {
            document.getElementById('connectionStatus').classList.add('hidden');
            document.getElementById('app').className = 'app-card max-w-3xl w-full'; // GeniÅŸlet
            document.getElementById('loginHeader').innerHTML = `<div class="flex justify-between px-4"><span class="text-sm opacity-80">${studentData.name}</span><span>${studentData.examCode}</span></div>`;

            document.getElementById('mainContentArea').innerHTML = `
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <span class="font-bold text-indigo-600">Soru: <span id="qCount">1</span> / ${quizQuestions.length}</span>
                    <div id="timerDisplay" class="text-xl font-mono font-bold text-white bg-indigo-600 p-1 px-3 rounded shadow">--:--</div>
                </div>
                <div id="questionArea" class="min-h-[250px]"></div>
                
                <div id="focusWarn" class="hidden mt-4 p-2 bg-red-100 text-red-800 text-sm font-bold text-center rounded border border-red-300"></div>
                
                <div class="mt-6 flex justify-between">
                    <button id="prevBtn" class="button bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded opacity-50" disabled>Ã–nceki</button>
                    <button id="nextBtn" class="button bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-6 rounded font-bold">Sonraki</button>
                </div>
            `;

            renderQuestion(currentQuestionIndex);
            startTimer(); // Yeni gÃ¼venli timer
            setupSecurityListeners();
            startAutoSave();
            
            // Butonlar
            document.getElementById('prevBtn').onclick = () => {
                if(currentQuestionIndex > 0) { currentQuestionIndex--; renderQuestion(currentQuestionIndex); saveProgress(); }
            };
            document.getElementById('nextBtn').onclick = () => {
                if(currentQuestionIndex < quizQuestions.length - 1) {
                    currentQuestionIndex++; renderQuestion(currentQuestionIndex); saveProgress();
                } else {
                    finishQuiz(false); // Normal bitiÅŸ
                }
            };
        }

        function renderQuestion(idx) {
            const realIdx = questionOrder[idx];
            const q = quizQuestions[realIdx];
            
            // ÅÄ±klarÄ± karÄ±ÅŸtÄ±r (Ã–ÄŸrenci numarasÄ±nÄ± seed olarak kullan)
            const seed = studentData.number + '_q' + realIdx;
            const shuffledOpts = seededShuffle(q.options, seed);
            const currAns = selectedAnswers[realIdx];
            
            const imageHtml = q.image ? `<div class="mb-4 flex justify-center"><img src="${q.image}" class="max-h-64 rounded-lg shadow border object-contain"></div>` : '';

            document.getElementById('questionArea').innerHTML = `
                <div class="font-semibold text-lg text-gray-800 mb-4 select-none">Soru ${idx + 1}: ${q.question}</div>
                ${imageHtml}
                <div class="space-y-3">
                    ${shuffledOpts.map(opt => `
                        <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer transition-all ${currAns === opt ? 'bg-indigo-50 border-indigo-500 shadow-md' : 'border-gray-200 hover:bg-gray-50'}">
                            <input type="radio" name="opt" value="${opt}" class="w-5 h-5 text-indigo-600" ${currAns === opt ? 'checked' : ''}>
                            <span class="ml-3 text-gray-700 font-medium select-none">${opt}</span>
                        </label>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('qCount').innerText = idx + 1;
            
            // ÅÄ±k seÃ§imi
            document.querySelectorAll('input[name="opt"]').forEach(el => {
                el.onchange = (e) => { 
                    selectedAnswers[realIdx] = e.target.value; 
                    // GÃ¶rsel gÃ¼ncelleme iÃ§in tÃ¼m classlarÄ± temizle ve seÃ§iliye ekle
                    document.querySelectorAll('label').forEach(l => l.className = "flex items-center p-4 border-2 rounded-lg cursor-pointer transition-all border-gray-200 hover:bg-gray-50");
                    e.target.closest('label').className = "flex items-center p-4 border-2 rounded-lg cursor-pointer transition-all bg-indigo-50 border-indigo-500 shadow-md";
                };
            });

            // Buton durumlarÄ±
            document.getElementById('prevBtn').disabled = idx === 0;
            document.getElementById('prevBtn').classList.toggle('opacity-50', idx === 0);
            
            const nextBtn = document.getElementById('nextBtn');
            if (idx === quizQuestions.length - 1) {
                nextBtn.innerText = "SINAVI BÄ°TÄ°R";
                nextBtn.className = "button bg-green-600 hover:bg-green-700 text-white py-2 px-6 rounded font-bold shadow-lg transform hover:scale-105";
            } else {
                nextBtn.innerText = "Sonraki";
                nextBtn.className = "button bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-6 rounded font-bold";
            }
        }

        // --- GÃœVENLÄ° TIMER (Date.now() KullanÄ±r) ---
        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            
            const updateTimerUI = () => {
                const now = Date.now();
                let diff = Math.ceil((examendTimeStamp - now) / 1000);
                
                if (diff <= 0) {
                    diff = 0;
                    clearInterval(timerInterval);
                    finishQuiz(true); // Zorunlu bitiÅŸ (SÃ¼re bitti)
                    return;
                }
                
                // Renk deÄŸiÅŸimi (Son 1 dakika kÄ±rmÄ±zÄ±)
                const timerDisplay = document.getElementById('timerDisplay');
                if (diff < 60) timerDisplay.className = "text-xl font-mono font-bold text-white bg-red-600 p-1 px-3 rounded shadow animate-pulse";
                
                const m = Math.floor(diff / 60);
                const s = diff % 60;
                timerDisplay.innerText = `${m}:${s < 10 ? '0'+s : s}`;
            };

            updateTimerUI(); // Ä°lk Ã§aÄŸrÄ±
            timerInterval = setInterval(updateTimerUI, 1000);
        }

        // --- GÃœVENLÄ°K Ã–NLEMLERÄ° ---
        function setupSecurityListeners() {
            window.onblur = () => {
                if (isTeacherMode) return;
                focusLossCount++;
                const w = document.getElementById('focusWarn');
                if(w) { 
                    w.classList.remove('hidden'); 
                    w.innerText = `âš ï¸ DÄ°KKAT: SÄ±nav ekranÄ±ndan ${focusLossCount} kez ayrÄ±ldÄ±nÄ±z! Bu durum kaydedilmektedir.`; 
                }
                saveProgress();
            };
            
            // SaÄŸ tÄ±k engelleme (Basit bir caydÄ±rÄ±cÄ±)
            document.addEventListener('contextmenu', event => event.preventDefault());
        }

        // --- OTOMATÄ°K KAYIT ---
        function startAutoSave() {
            autoSaveInterval = setInterval(() => saveProgress(), 15000); // 15 saniyede bir
        }

        async function saveProgress() {
            if (isTeacherMode || !isDbConnected) return;
            
            const now = Date.now();
            const remainingSeconds = Math.floor((examendTimeStamp - now) / 1000);

            const data = {
                ...studentData, 
                studentKey: `${studentData.examCode}_${studentData.number}`,
                questionOrder, 
                selectedAnswers, 
                currentQuestionIndex, 
                timeLeft: remainingSeconds > 0 ? remainingSeconds : 0, 
                focusLossCount,
                lastUpdated: serverTimestamp()
            };

            try {
                if (currentSessionDocId) {
                    await updateDoc(doc(db, "active_sessions", currentSessionDocId), data);
                } else { 
                    const ref = await addDoc(collection(db, "active_sessions"), data); 
                    currentSessionDocId = ref.id; 
                }
            } catch(e) { console.log("Autosave fail (minor)"); }
        }

        // --- SINAV BÄ°TÄ°RME ---
        async function finishQuiz(force = false) {
            clearInterval(timerInterval); 
            clearInterval(autoSaveInterval); 
            window.onblur = null;
            document.oncontextmenu = null;

            if (!force && !confirm("SÄ±navÄ± bitirmek ve cevaplarÄ±nÄ±zÄ± gÃ¶ndermek istediÄŸinize emin misiniz?")) { 
                // Ä°ptal edilirse timer'Ä± tekrar dÃ¼zgÃ¼n baÅŸlatmak iÃ§in UI'Ä± gÃ¼ncellemek yeterli
                // ama Date.now() kullandÄ±ÄŸÄ±mÄ±z iÃ§in arka planda zaman zaten aktÄ±.
                startTimer(); 
                setupSecurityListeners();
                return; 
            }

            document.getElementById('mainContentArea').innerHTML = `
                <div class="text-center py-10">
                    <div class="loader mb-4"></div>
                    <p class="font-bold text-gray-600">CevaplarÄ±nÄ±z ÅŸifrelenip sunucuya gÃ¶nderiliyor...</p>
                </div>
            `;
            
            // SonuÃ§ Hesaplama
            // Not: GerÃ§ek gÃ¼venlik iÃ§in bu hesaplama Cloud Functions'da yapÄ±lmalÄ±dÄ±r.
            // Client-side hesaplamada "currentQuestions" taze Ã§ekilir.
            let currentQuestions = [];
            try {
                const qSnap = await getDoc(getQuestionsRef(studentData.examCode));
                currentQuestions = qSnap.exists() ? qSnap.data().questions_list : [];
            } catch(e) { currentQuestions = quizQuestions; } // Fallback

            let c=0, i=0, e=0;
            for (let idx = 0; idx < questionOrder.length; idx++) {
                const realQIdx = questionOrder[idx];
                const correctQ = currentQuestions[realQIdx];
                if(!correctQ) continue;

                const sAns = String(selectedAnswers[realQIdx] || '').trim();
                const cAns = String(correctQ.answer || '').trim();

                if(!sAns) e++;
                else if (sAns.toLowerCase() === cAns.toLowerCase()) c++;
                else i++;
            }
            
            const score = (currentQuestions.length > 0) ? (c * 100 / currentQuestions.length).toFixed(2) : 0;
            
            // IP Alma (Opsiyonel)
            let ip = "Gizli";
            try { const r = await fetch('https://api.ipify.org?format=json'); const d = await r.json(); ip = d.ip; } catch(err){}

            const finalData = {
                ...studentData, 
                studentKey: `${studentData.examCode}_${studentData.number}`,
                score, correct: c, incorrect: i, empty: e, 
                timeSpent: currentExamConfig.time_limit - Math.floor((examendTimeStamp - Date.now())/1000),
                timestamp: serverTimestamp(), 
                focusLossCount, 
                ipAddress: ip, 
                questionOrder, 
                allAnswers: selectedAnswers 
            };

            if(isDbConnected) {
                try {
                    await addDoc(collection(db, "quiz_submissions"), finalData);
                    if (currentSessionDocId) await deleteDoc(doc(db, "active_sessions", currentSessionDocId));
                } catch(e) { alert("Sunucu HatasÄ±: SonuÃ§ kaydedilemedi. LÃ¼tfen Ã¶ÄŸretmeninize bildirin."); }
            }

            showResultScreen(finalData);
        }

        function showResultScreen(data) {
            document.getElementById('app').className = 'app-card max-w-md';
            document.getElementById('loginHeader').innerHTML = '<h1 class="text-2xl font-bold">SÄ±nav TamamlandÄ±</h1>';
            
            document.getElementById('mainContentArea').innerHTML = `
                <div class="text-center">
                    <div class="inline-block p-4 rounded-full bg-indigo-100 mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div class="text-5xl font-extrabold text-gray-800 mb-2">${data.score}</div>
                    <p class="text-gray-500 font-medium mb-6">PuanÄ±nÄ±z</p>
                    
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="bg-green-50 p-3 rounded-lg border border-green-100">
                            <p class="text-2xl font-bold text-green-600">${data.correct}</p>
                            <p class="text-xs text-green-800">DoÄŸru</p>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg border border-red-100">
                            <p class="text-2xl font-bold text-red-600">${data.incorrect}</p>
                            <p class="text-xs text-red-800">YanlÄ±ÅŸ</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                            <p class="text-2xl font-bold text-gray-600">${data.empty}</p>
                            <p class="text-xs text-gray-800">BoÅŸ</p>
                        </div>
                    </div>
                    
                    <button id="exitExamBtn" class="button w-full bg-gray-800 text-white py-3 px-6 rounded-lg font-bold hover:bg-gray-900">Ã‡Ä±kÄ±ÅŸ Yap</button>
                </div>
            `;
            
            document.getElementById('exitExamBtn').onclick = resetApp;
        }

        // --- YÃ–NETÄ°CÄ° MODÃœLÃœ ---
        function showTeacherLogin() {
            document.getElementById('mainContentArea').innerHTML = `
                <div class="space-y-4">
                    <h3 class="text-center font-bold text-gray-800 text-lg">YÃ¶netici GiriÅŸi</h3>
                    <div class="text-center text-xs p-2 rounded ${isDbConnected ? 'bg-green-100 text-green-800':'bg-red-100 text-red-800'}">
                        ${isDbConnected ? 'VeritabanÄ± BaÄŸlantÄ±sÄ± Aktif' : 'VeritabanÄ± BaÄŸlantÄ±sÄ± YOK'}
                    </div>
                    
                    <input id="pass" type="password" placeholder="YÃ¶netici Åifresi" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                    
                    <button id="loginBtn" class="button bg-indigo-600 text-white w-full py-3 rounded-lg font-bold hover:bg-indigo-700">GiriÅŸ Yap</button>
                    <button id="backBtn" class="button bg-gray-200 text-gray-700 w-full py-3 rounded-lg font-semibold hover:bg-gray-300">Geri DÃ¶n</button>
                </div>
            `;

            document.getElementById('backBtn').onclick = showLoginForm;
            
            document.getElementById('loginBtn').onclick = () => {
                const inputPass = document.getElementById('pass').value;
                
                if (!isDbConnected || adminMasterCode === null) {
                    return showCustomAlert("Hata", "VeritabanÄ±na baÄŸlanÄ±lamadÄ±ÄŸÄ± iÃ§in yÃ¶netici giriÅŸi yapÄ±lamaz.");
                }

                if (inputPass === adminMasterCode) {
                    isTeacherMode = true;
                    showDashboard();
                } else {
                    showCustomAlert("HatalÄ± Åifre", "GirdiÄŸiniz ÅŸifre yanlÄ±ÅŸ.");
                }
            };
        }

        function showDashboard() {
            document.getElementById('connectionStatus').classList.add('hidden');
            document.getElementById('app').className = 'app-card teacher-mode';
            document.getElementById('loginHeader').innerHTML = '<h1 class="text-2xl font-bold flex justify-between items-center px-4"><span>YÃ¶netim Paneli</span> <button id="logoutBtn" class="text-sm bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded">Ã‡Ä±kÄ±ÅŸ</button></h1>';
            
            document.getElementById('logoutBtn').onclick = resetApp;

            const dashboardHtml = `
                <div class="flex flex-wrap gap-2 mb-6 border-b pb-4">
                    <button onclick="window.changeTab('results')" class="flex-1 min-w-[120px] px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded shadow text-sm font-semibold">ğŸ“Š SonuÃ§lar</button>
                    <button onclick="window.changeTab('settings')" class="flex-1 min-w-[120px] px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded shadow text-sm font-semibold">âš™ï¸ Ayarlar</button>
                    <button onclick="window.changeTab('questions')" class="flex-1 min-w-[120px] px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded shadow text-sm font-semibold">ğŸ“ Sorular</button>
                    <button onclick="window.changeTab('lists')" class="flex-1 min-w-[120px] px-4 py-2 bg-teal-600 hover:bg-teal-700 text-white rounded shadow text-sm font-semibold">ğŸ‘¥ Ã–ÄŸrenciler</button>
                    <button onclick="window.changeTab('myexams')" class="flex-1 min-w-[120px] px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded shadow text-sm font-semibold">ğŸ“‚ SÄ±navlarÄ±m</button>
                </div>
                
                <div id="tab-results" class="tab-content">
                    <div class="flex justify-between items-center mb-4">
                         <h2 class="font-bold text-lg text-gray-700">SonuÃ§ Listesi</h2>
                         <button onclick="window.exportToExcel()" class="bg-green-600 text-white px-3 py-1 rounded text-sm">Excel Ä°ndir</button>
                    </div>
                    <div class="flex gap-2 mb-4">
                        <input id="filterCode" placeholder="Kod Ara" class="p-2 border rounded text-sm w-24">
                        <input id="filterName" placeholder="Ä°sim Ara" class="p-2 border rounded text-sm flex-1">
                    </div>
                    <div class="overflow-auto max-h-[500px] border rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200 text-sm">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="p-3 text-left">Ã–ÄŸrenci</th>
                                    <th class="p-3 text-left">Kod</th>
                                    <th class="p-3 text-left">Puan</th>
                                    <th class="p-3 text-left">D/Y/B</th>
                                    <th class="p-3 text-left">Ä°ÅŸlem</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody" class="bg-white divide-y"></tbody>
                        </table>
                    </div>
                </div>

                <div id="tab-questions" class="tab-content hidden">
                     <div class="max-w-2xl mx-auto">
                        <div class="bg-orange-50 p-4 rounded-lg border border-orange-200 mb-4">
                            <label class="block font-bold text-orange-800 mb-1">Hangi SÄ±nav Kodu Ä°Ã§in?</label>
                            <input id="uploadQCode" class="w-full p-2 border rounded uppercase font-bold" placeholder="Ã–RN: 9A_MAT">
                        </div>
                        <textarea id="jsonInput" rows="10" class="w-full p-3 font-mono text-xs border rounded bg-gray-900 text-green-400" placeholder='[{"question":"Soru?","options":["A","B"],"answer":"A"}]'></textarea>
                        <div class="flex justify-between mt-2">
                            <button onclick="window.loadSampleJson()" class="text-xs text-gray-500 underline">Ã–rnek Format</button>
                            <button id="btnUploadQ" class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded font-bold shadow">SORULARI YÃœKLE</button>
                        </div>
                     </div>
                </div>

                <div id="tab-settings" class="tab-content hidden">
                    <div class="max-w-lg mx-auto space-y-4">
                         <div class="bg-gray-50 p-4 rounded border">
                            <h3 class="font-bold mb-2">SÄ±nav OluÅŸtur / DÃ¼zenle</h3>
                            <input id="setExamCode" class="w-full p-2 border rounded mb-2 uppercase" placeholder="SÄ±nav Kodu">
                            <input id="setTime" type="number" class="w-full p-2 border rounded mb-2" placeholder="SÃ¼re (Dakika)">
                            <input id="setDesc" class="w-full p-2 border rounded mb-2" placeholder="AÃ§Ä±klama">
                            <button id="btnSaveSettings" class="w-full bg-gray-700 text-white p-2 rounded font-bold">Kaydet</button>
                         </div>
                         <div class="bg-red-50 p-4 rounded border border-red-200">
                            <h3 class="font-bold text-red-700 mb-2">YÃ¶netici Åifresi DeÄŸiÅŸtir</h3>
                            <input id="newAdminPass" type="password" class="w-full p-2 border rounded mb-2" placeholder="Yeni Åifre">
                            <button id="btnChangePass" class="w-full bg-red-600 text-white p-2 rounded font-bold">Åifreyi GÃ¼ncelle</button>
                         </div>
                    </div>
                </div>

                <div id="tab-lists" class="tab-content hidden">
                    <div class="max-w-2xl mx-auto">
                        <div class="bg-teal-50 p-4 rounded border border-teal-200 mb-4">
                            <label class="font-bold text-teal-800">Hangi SÄ±nav Kodu?</label>
                            <input id="uploadListCode" class="w-full p-2 border rounded uppercase" placeholder="Ã–RN: 9A_MAT">
                        </div>
                        <textarea id="listInput" rows="10" class="w-full p-3 text-xs border rounded" placeholder="Excel'den Kopyala (No | SÄ±nÄ±f | Ad Soyad)"></textarea>
                        <button id="btnUploadList" class="w-full mt-2 bg-teal-600 text-white py-2 rounded font-bold">Listeyi Kaydet</button>
                    </div>
                </div>

                 <div id="tab-myexams" class="tab-content hidden">
                    <div id="myExamsList" class="grid grid-cols-1 md:grid-cols-2 gap-4">YÃ¼kleniyor...</div>
                </div>
            `;
            
            document.getElementById('mainContentArea').innerHTML = dashboardHtml;
            
            // --- TAB YÃ–NETÄ°MÄ° ---
            window.changeTab = (t) => {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
                document.getElementById('tab-' + t).classList.remove('hidden');
                if(t === 'results') loadResults();
                if(t === 'myexams') loadMyExams();
            };

            // --- SORU YÃœKLEME (JSON VALIDATOR EKLENDÄ°) ---
            window.loadSampleJson = () => {
                document.getElementById('jsonInput').value = `[\n  {\n    "question": "TÃ¼rkiye'nin baÅŸkenti neresidir?",\n    "options": ["Ä°stanbul", "Ankara", "Ä°zmir", "Bursa"],\n    "answer": "Ankara"\n  }\n]`;
            };

            document.getElementById('btnUploadQ').onclick = async () => {
                const code = document.getElementById('uploadQCode').value.toUpperCase();
                const rawJson = document.getElementById('jsonInput').value;
                
                if(!code) return alert("SÄ±nav kodu girin.");
                
                try {
                    const parsed = JSON.parse(rawJson);
                    if(!Array.isArray(parsed)) throw new Error("JSON bir liste [...] ile baÅŸlamalÄ±.");
                    
                    await setDoc(getQuestionsRef(code), { questions_list: parsed });
                    alert(`âœ… ${code} iÃ§in ${parsed.length} soru baÅŸarÄ±yla yÃ¼klendi.`);
                    document.getElementById('jsonInput').value = '';
                } catch(e) {
                    alert(`âŒ JSON Format HatasÄ±:\n${e.message}\n\nLÃ¼tfen virgÃ¼llere ve parantezlere dikkat edin.`);
                }
            };

            // --- AYARLAR KAYDETME ---
            document.getElementById('btnSaveSettings').onclick = async () => {
                const code = document.getElementById('setExamCode').value.toUpperCase();
                if(!code) return alert("Kod gerekli");
                await setDoc(getConfigRef(code), {
                    teacher_name: systemPreparerName,
                    time_limit: parseInt(document.getElementById('setTime').value) * 60,
                    exam_description: document.getElementById('setDesc').value
                }, { merge: true });
                alert("Ayarlar kaydedildi.");
            };

            // --- ÅÄ°FRE DEÄÄ°ÅTÄ°RME ---
            document.getElementById('btnChangePass').onclick = async () => {
                const newP = document.getElementById('newAdminPass').value;
                if(newP.length < 4) return alert("Åifre Ã§ok kÄ±sa.");
                if(confirm("Åifreyi deÄŸiÅŸtirmek istediÄŸinize emin misiniz?")) {
                    await setDoc(doc(db, "exam_settings", "admin_config"), { master_code: newP }, { merge: true });
                    adminMasterCode = newP;
                    alert("Åifre gÃ¼ncellendi.");
                }
            };

            // --- LÄ°STE YÃœKLEME ---
            document.getElementById('btnUploadList').onclick = async () => {
                const code = document.getElementById('uploadListCode').value.toUpperCase();
                const txt = document.getElementById('listInput').value;
                if(!code || !txt) return alert("Eksik bilgi");
                
                const students = [];
                const lines = txt.split('\n').filter(x => x.trim());
                
                lines.forEach(line => {
                    const p = line.split('\t');
                    if(p.length >= 3) {
                        students.push({ number: p[0].trim(), className: p[1].trim(), name: p[2].trim() });
                    }
                });
                
                if(students.length === 0) return alert("Liste formatÄ± hatalÄ±. Excel'den kopyaladÄ±ÄŸÄ±nÄ±za emin olun.");
                
                await setDoc(doc(db, "student_lists", code), { students });
                alert(`${students.length} Ã¶ÄŸrenci listeye eklendi.`);
            };
            
            // Initial Load
            loadResults();
        }

        // --- DASHBOARD YARDIMCILARI ---
        function loadResults() {
            const tbody = document.getElementById('resultsTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center">YÃ¼kleniyor...</td></tr>';
            
            onSnapshot(query(collection(db, "quiz_submissions"), where("timestamp", ">", new Date(0))), (snap) => {
                allSubmissions = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderResultsTable();
            });
            
            document.getElementById('filterCode').oninput = renderResultsTable;
            document.getElementById('filterName').oninput = renderResultsTable;
        }

        function renderResultsTable() {
            const fCode = document.getElementById('filterCode').value.toLowerCase();
            const fName = document.getElementById('filterName').value.toLowerCase();
            const tbody = document.getElementById('resultsTableBody');
            
            const filtered = allSubmissions.filter(s => 
                (s.examCode||'').toLowerCase().includes(fCode) && 
                (s.name||'').toLowerCase().includes(fName)
            ).sort((a,b) => b.score - a.score);
            
            tbody.innerHTML = filtered.map(s => `
                <tr class="hover:bg-gray-50">
                    <td class="p-3">
                        <div class="font-bold text-gray-800">${s.name}</div>
                        <div class="text-xs text-gray-500">${s.number} - ${s.className}</div>
                    </td>
                    <td class="p-3 font-mono text-xs">${s.examCode}</td>
                    <td class="p-3 font-bold ${s.score >= 50 ? 'text-green-600':'text-red-600'}">${s.score}</td>
                    <td class="p-3 text-xs">${s.correct}D / ${s.incorrect}Y / ${s.empty}B</td>
                    <td class="p-3">
                        <button onclick="window.deleteSub('${s.id}')" class="text-red-600 hover:underline text-xs">Sil</button>
                    </td>
                </tr>
            `).join('');
        }

        window.deleteSub = async (id) => {
            if(confirm("Bu kaydÄ± silmek istiyor musunuz?")) await deleteDoc(doc(db, "quiz_submissions", id));
        }
        
        window.exportToExcel = () => {
            let csv = "\uFEFFAd Soyad,Numara,Sinif,Kod,Puan,Dogru,Yanlis,Bos\n";
            allSubmissions.forEach(s => {
                csv += `"${s.name}",${s.number},${s.className},${s.examCode},${s.score},${s.correct},${s.incorrect},${s.empty}\n`;
            });
            const link = document.createElement("a");
            link.href = "data:text/csv;charset=utf-8," + encodeURIComponent(csv);
            link.download = "sinav_sonuclari.csv";
            link.click();
        }

        async function loadMyExams() {
            const container = document.getElementById('myExamsList');
            container.innerHTML = "YÃ¼kleniyor...";
            
            const qSnap = await getDocs(collection(db, "exam_settings"));
            const exams = [];
            
            qSnap.forEach(doc => {
                if(doc.id !== 'admin_config') exams.push({code: doc.id, ...doc.data()});
            });
            
            if(exams.length === 0) {
                container.innerHTML = "HenÃ¼z sÄ±nav yok.";
                return;
            }
            
            container.innerHTML = exams.map(e => `
                <div class="bg-white p-4 border rounded shadow-sm hover:shadow-md transition">
                    <h3 class="font-bold text-lg text-indigo-700">${e.exam_code || e.code}</h3>
                    <p class="text-xs text-gray-500 mb-2">${e.exam_description}</p>
                    <p class="text-sm font-semibold">SÃ¼re: ${Math.floor(e.time_limit/60)} dk</p>
                    <button onclick="window.deleteExam('${e.code}')" class="mt-3 w-full bg-red-100 text-red-700 text-xs py-2 rounded hover:bg-red-200">SÄ±navÄ± Sil</button>
                </div>
            `).join('');
        }
        
        window.deleteExam = async (code) => {
            if(confirm(`${code} sÄ±navÄ±nÄ± ve tÃ¼m sorularÄ±nÄ± silmek istediÄŸinize emin misiniz?`)) {
                await deleteDoc(doc(db, "exam_settings", code));
                await deleteDoc(doc(db, "questions_pool", code));
                await deleteDoc(doc(db, "student_lists", code));
                alert("SÄ±nav silindi.");
                loadMyExams();
            }
        }

        // --- UI HELPERS ---
        function showCustomAlert(title, msg) {
            return new Promise(resolve => {
                const modal = document.getElementById('customModal');
                const content = document.getElementById('modalContent');
                content.innerHTML = `
                    <h3 class="text-xl font-bold text-gray-800 mb-2">${title}</h3>
                    <p class="text-gray-600 mb-6">${msg}</p>
                    <button id="modalCloseBtn" class="bg-indigo-600 text-white px-6 py-2 rounded font-bold hover:bg-indigo-700">Tamam</button>
                `;
                modal.classList.remove('hidden'); modal.classList.add('flex');
                document.getElementById('modalCloseBtn').onclick = () => {
                    modal.classList.add('hidden'); modal.classList.remove('flex');
                    resolve();
                };
            });
        }

        // BaÅŸlat
        initializeFirebase();

    </script>
</body>
</html>
