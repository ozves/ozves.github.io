<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SÄ±nav Sistemi V12 (Okul No DoÄŸrulamalÄ± GiriÅŸ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0;}
        .app-card { background-color:white;padding:2.5rem;border-radius:1.5rem;box-shadow:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05);max-width:450px;width:90%;transition:all .3s;position:relative;}
        .header-bg { background: linear-gradient(135deg,#4f46e5 0%,#818cf8 100%); color:white;padding:1rem 0;border-radius:1rem 1rem 0 0;margin:-2.5rem -2.5rem 1.5rem -2.5rem;text-align:center;}
        .button{transition:all .2s;box-shadow:0 4px 6px rgba(0,0,0,0.1)}
        .button:hover{transform:translateY(-1px);box-shadow:0 6px 10px rgba(0,0,0,0.15)}
        .teacher-mode { max-width: 1400px !important; width: 98% !important; } 
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body>

    <div id="app" class="app-card">
        <div id="loginHeader" class="header-bg">
            <h1 class="text-2xl font-extrabold">Ã–ÄŸrenci GiriÅŸi</h1>
        </div>
        
        <div id="connectionStatus" class="hidden mb-4 text-xs font-bold text-center p-2 rounded border"></div>
        
        <div id="mainContentArea">
            <div id="loadingIndicator" class="text-center py-10">
                <svg class="animate-spin h-8 w-8 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p id="loadingText" class="text-sm text-gray-500 mt-4 font-bold">Sistem BaÅŸlatÄ±lÄ±yor...</p>
            </div>
        </div>
    </div>

    <div id="customModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center p-4 z-50">
        <div id="modalContent" class="bg-white rounded-xl p-6 max-w-3xl w-full text-center shadow-2xl overflow-y-auto max-h-[90vh]"></div>
    </div>

    <script type="module">
       import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, collection, onSnapshot, serverTimestamp, query, where, getDocs, deleteDoc, getDoc, addDoc, updateDoc, setDoc, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; // deleteField EKLENDÄ°

const firebaseConfig = {
    apiKey: "AIzaSyCHhFAHbWnclad6yFuI-Pw9gX6F_Dx1B2c",
    authDomain: "online-sinav-b3644.firebaseapp.com",
    projectId: "online-sinav-b3644",
    storageBucket: "online-sinav-b3644.firebasestorage.app",
    messagingSenderId: "965507531268",
    appId: "1:965507531268:web:94cfd13774a40b6cf16b51"
};

let db, auth;
let isAuthReady = false, isDbConnected = false;

let adminMasterCode = "123456";
let systemPreparerName = "Sistem YÃ¶neticisi";

let currentExamConfig = {
    exam_code: "DEFAULT",
    teacher_name: "Sistem YÃ¶neticisi",
    time_limit: 600,
    exam_description: "VarsayÄ±lan sÄ±nav. LÃ¼tfen yeni bir sÄ±nav kodu oluÅŸturun."
};
let quizQuestions = [];

let selectedAnswers = [], questionOrder = [], currentQuestionIndex = 0, resumeStartIndex = 0;
let timerInterval = null, timeLeft = 0, isTeacherMode = false, studentData = {};
let focusLossCount = 0, autoSaveInterval = null, currentSessionDocId = null;
let allSubmissions = [];
let studentList = []; // Yeni: SÄ±nav koduna ait tÃ¼m Ã¶ÄŸrenci listesi

// Firebase Referans FonksiyonlarÄ±
const getConfigRef = (code) => doc(db, "exam_settings", code.toUpperCase());
const getQuestionsRef = (code) => doc(db, "questions_pool", code.toUpperCase());
const getSubmissionRef = (id) => doc(db, "quiz_submissions", id);
const getStudentListRef = (code) => doc(db, "student_lists", code.toUpperCase()); // YENÄ°: Ã–ÄŸrenci listesi referansÄ±

function seededShuffle(array, seed) {
    let hash = 0;
    for (let i = 0; i < seed.length; i++) { hash = ((hash << 5) - hash) + seed.charCodeAt(i); hash |= 0; }
    const shuffled = [...array];
    let n = shuffled.length;
    while (n > 1) {
        hash = (hash * 9301 + 49297) % 233280;
        if (hash < 0) hash += 233280;
        let random = hash / 233280.0;
        let k = Math.floor(random * n);
        n--;
        [shuffled[n], shuffled[k]] = [shuffled[k], shuffled[n]];
    }
    return shuffled;
}

// --- MODAL FONKSÄ°YONLARI (KullanÄ±cÄ± etkileÅŸimi iÃ§in) ---
function showCustomAlert(title, message, isHtml = false) {
    return new Promise(resolve => {
        const modal = document.getElementById('customModal');
        const modalContent = document.getElementById('modalContent');
        
        let contentHtml = `
            <h3 class="text-xl font-semibold text-gray-800 mb-4">${title}</h3>
        `;
        if (isHtml) {
            contentHtml += `<div class="text-gray-600 mb-6 text-left">${message}</div>`;
        } else {
            contentHtml += `<p class="text-gray-600 mb-6 whitespace-pre-line">${message}</p>`;
        }
        contentHtml += `
            <button id="modalClose" class="button bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md">Tamam</button>
        `;

        modalContent.innerHTML = contentHtml;
        modal.classList.remove('hidden'); modal.classList.add('flex');
        document.getElementById('modalClose').onclick = () => { modal.classList.add('hidden'); modal.classList.remove('flex'); resolve(); };
    });
}

// --- BAÅLATMA ---
async function initializeFirebase() {
    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        await signInAnonymously(auth);
        onAuthStateChanged(auth, async (user) => {
            if (user) { isAuthReady = true; await checkConnectivity(); }
        });
    } catch (error) { alert("Kritik BaÅŸlatma HatasÄ±: " + error.message); }
}

async function checkConnectivity() {
    const statusDiv = document.getElementById('connectionStatus');
    try {
        const adminSnap = await getDoc(doc(db, "exam_settings", "admin_config"));
        if (adminSnap.exists()) {
            const data = adminSnap.data();
            adminMasterCode = data.master_code || "123456";
            systemPreparerName = data.preparer_name || "Sistem YÃ¶neticisi";
        }

        isDbConnected = true;
        statusDiv.innerHTML = "ğŸŸ¢ VeritabanÄ± BaÄŸlÄ± (CanlÄ± Mod)";
        statusDiv.className = "mb-4 text-xs font-bold text-center p-2 rounded border bg-green-100 text-green-800 border-green-300";
    } catch(e) {
        isDbConnected = false;
        statusDiv.innerHTML = `ğŸ”´ BAÄLANTI YOK - VarsayÄ±lan ModdasÄ±nÄ±z<br><span class='text-[10px] font-normal'>${e.message || 'Veri bulunamadÄ±'}</span>`;
        statusDiv.className = "mb-4 text-xs font-bold text-center p-2 rounded border bg-red-100 text-red-800 border-red-300";
    }
    statusDiv.classList.remove('hidden');
    document.getElementById('loadingIndicator').classList.add('hidden');
    showLoginForm();
}

async function fetchExamData(code) {
    if (!isDbConnected) {
        currentExamConfig = { exam_code: code.toUpperCase(), teacher_name: systemPreparerName, time_limit: 600, exam_description: "Ã‡evrimdÄ±ÅŸÄ± modda varsayÄ±lan ayarlar kullanÄ±lÄ±yor." };
        quizQuestions = [];
        studentList = [];
        return true;
    }
    try {
        const configSnap = await getDoc(getConfigRef(code));
        if (!configSnap.exists()) {
            currentExamConfig = { exam_code: code.toUpperCase(), teacher_name: systemPreparerName, time_limit: 600, exam_description: "SÄ±nav ayarlarÄ± bulunamadÄ±. VarsayÄ±lan sÃ¼re (10dk) kullanÄ±lÄ±yor." };
        } else {
            currentExamConfig = { exam_code: code.toUpperCase(), ...configSnap.data() };
        }
        
        const questionsSnap = await getDoc(getQuestionsRef(code));
        quizQuestions = questionsSnap.exists() ? (questionsSnap.data().questions_list || []) : [];
        
        const listRef = doc(db, "student_lists", code);
        const listSnap = await getDoc(listRef);
        studentList = listSnap.exists() ? (listSnap.data().students || []) : [];

        return true;
    } catch(e) {
        alert("SÄ±nav verisi Ã§ekilirken hata: " + e.message);
        return false;
    }
}

// --- GÄ°RÄ°Å EKRANI ---
function showLoginForm() {
    if (!isAuthReady) return;
    document.getElementById('app').className = 'app-card max-w-md';
    document.getElementById('loginHeader').innerHTML = '<h1 class="text-2xl font-extrabold">Ã–ÄŸrenci GiriÅŸi</h1>';
    const timeInMinutes = Math.floor(currentExamConfig.time_limit / 60);
    
    document.getElementById('mainContentArea').innerHTML = `
        <div class="space-y-4">
            <div class="text-center p-2 bg-indigo-50 rounded-lg border border-indigo-100">
                <p class="text-xs text-gray-500">SÄ±navÄ± HazÄ±rlayan</p>
                <p class="font-bold text-indigo-700">${systemPreparerName}</p>
            </div>
            <div id="examInfoArea" class="bg-yellow-50 border border-yellow-200 p-3 rounded-lg text-sm text-yellow-800">
                <p class="font-bold mb-1">âš ï¸ SÄ±nav Bilgisi:</p>
                <p class="mb-2">${currentExamConfig.exam_description}</p>
                <p class="font-semibold">SÃ¼re: ${timeInMinutes} Dakika</p>
            </div>
            
            <input id="examCodeInput" type="text" placeholder="SÄ±nav Kodu" class="w-full p-3 border rounded-lg uppercase">
            
            <div id="studentLoginFields" class="space-y-4">
                <p class="text-sm text-center text-gray-500 font-semibold border-t pt-4">SÄ±nav kodunu girdikten sonra listeyi gÃ¶receksiniz.</p>
            </div>

            <button id="startQuizButton" class="button w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg" disabled>SÄ±nava BaÅŸla</button>
            <button id="teacherLoginButton" class="button w-full bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm py-2 rounded-lg">Ã–ÄŸretmen GiriÅŸi</button>
        </div>
    `;
    document.getElementById('teacherLoginButton').onclick = showTeacherLogin;
    document.getElementById('examCodeInput').oninput = handleCodeEntry;
    document.getElementById('startQuizButton').onclick = handleStudentLogin;
}

async function updateExamInfoArea(code) {
    const timeInMinutes = Math.floor(currentExamConfig.time_limit / 60);
    document.getElementById('examInfoArea').innerHTML = `
        <p class="font-bold mb-1">âš ï¸ SÄ±nav Bilgisi: <span class="text-indigo-900">${code}</span></p>
        <p class="mb-2">${currentExamConfig.exam_description}</p>
        <p class="font-semibold">SÃ¼re: ${timeInMinutes} Dakika</p>
    `;
}

async function handleCodeEntry() {
    const code = document.getElementById('examCodeInput').value.trim().toUpperCase();
    const studentLoginFields = document.getElementById('studentLoginFields');
    const startButton = document.getElementById('startQuizButton');
    
    startButton.disabled = true;

    if (code.length < 3) {
        studentLoginFields.innerHTML = '<p class="text-sm text-center text-gray-500 font-semibold border-t pt-4">SÄ±nav kodunu girdikten sonra listeyi gÃ¶receksiniz.</p>';
        await fetchExamData("DEFAULT");
        updateExamInfoArea(code);
        return;
    }
    
    await fetchExamData(code);
    updateExamInfoArea(code);

    if (!isDbConnected || studentList.length === 0) {
        studentLoginFields.innerHTML = `
            <p class="text-sm text-center text-red-500 font-semibold border-t pt-4">âš ï¸ Liste Yok / Ã‡evrimdÄ±ÅŸÄ±. Manuel GiriÅŸ (Riskli).</p>
            <input id="nameInput" type="text" placeholder="Ad Soyad" class="w-full p-3 border rounded-lg">
            <input id="numberInput" type="number" placeholder="Okul No" class="w-full p-3 border rounded-lg">
            <input id="classInput" type="text" placeholder="SÄ±nÄ±f (Ã–rn: 10A)" class="w-full p-3 border rounded-lg">
        `;
        startButton.disabled = !!(document.getElementById('nameInput')?.value && document.getElementById('numberInput')?.value && document.getElementById('classInput')?.value);
        return;
    }

    // --- YENÄ° LÄ°STE SEÃ‡Ä°M UI'I ---
    studentLoginFields.innerHTML = '<p class="text-center text-indigo-600 font-bold mt-4">Ã–ÄŸrenci Listesi yÃ¼kleniyor...</p>';
    
    try {
        const students = studentList.sort((a, b) => a.name.localeCompare(b.name, 'tr', { sensitivity: 'base' }));
        const classes = [...new Set(students.map(s => s.className))].sort();

        studentLoginFields.innerHTML = `
            <select id="classSelector" class="w-full p-3 border rounded-lg font-bold text-indigo-700">
                <option value="">-- SÄ±nÄ±fÄ±nÄ±zÄ± SeÃ§in --</option>
                ${classes.map(cls => `<option value="${cls}">${cls}</option>`).join('')}
            </select>
            
            <select id="studentSelector" class="w-full p-3 border rounded-lg" disabled>
                <option value="">-- AdÄ±nÄ±zÄ± SeÃ§in --</option>
            </select>
            
            <div id="numberConfirmArea" class="hidden space-y-2">
                <input id="numberConfirmInput" type="number" placeholder="Okul NumaranÄ±zÄ± (Onay Ä°Ã§in) Tekrar Girin" class="w-full p-3 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                <p class="text-xs text-indigo-600 font-semibold">LÃ¼tfen listeden seÃ§tiÄŸiniz Ã¶ÄŸrenci olduÄŸunuzu doÄŸrulamak iÃ§in numaranÄ±zÄ± girin.</p>
            </div>

            <p class="text-sm text-green-600 text-center font-bold">LÃ¼tfen Ã¶nce sÄ±nÄ±fÄ±nÄ±zÄ±, sonra kendinizi seÃ§in.</p>
        `;
        
        document.getElementById('classSelector').onchange = (e) => {
            const selectedClass = e.target.value;
            const studentSelector = document.getElementById('studentSelector');
            const numberConfirmArea = document.getElementById('numberConfirmArea');

            studentSelector.innerHTML = '<option value="">-- AdÄ±nÄ±zÄ± SeÃ§in --</option>';
            studentSelector.disabled = true;
            startButton.disabled = true;
            numberConfirmArea.classList.add('hidden');
            document.getElementById('numberConfirmInput').value = '';

            if (selectedClass) {
                const filteredStudents = students.filter(s => s.className === selectedClass);
                studentSelector.innerHTML += filteredStudents.map(s => 
                    `<option value="${s.number}_${s.className}_${s.name}">${s.name} (${s.number})</option>`
                ).join('');
                studentSelector.disabled = false;
            }
        };

        document.getElementById('studentSelector').onchange = (e) => {
            const numberConfirmArea = document.getElementById('numberConfirmArea');
            if (e.target.value) {
                startButton.disabled = false;
                numberConfirmArea.classList.remove('hidden');
            } else {
                startButton.disabled = true;
                numberConfirmArea.classList.add('hidden');
            }
        };
    } catch(e) {
        studentLoginFields.innerHTML = `<p class="text-sm text-center text-red-500 font-semibold border-t pt-4">Liste yÃ¼klenirken hata: ${e.message}</p>`;
    }
}

async function handleStudentLogin() {
    const code = document.getElementById('examCodeInput').value.trim().toUpperCase();
    
    const studentSelector = document.getElementById('studentSelector');
    let name, number, className;
    let isListMode = !!studentSelector; // Listeden seÃ§im modu aktif mi?

    if (!code) return alert("LÃ¼tfen SÄ±nav Kodu girin.");

    if (isListMode) {
        const selectedValue = studentSelector.value;
        if (!selectedValue) return alert("LÃ¼tfen listeden kendinizi seÃ§in.");

        // Okul NumarasÄ± OnayÄ±
        const numberConfirmInput = document.getElementById('numberConfirmInput')?.value.trim();
        if (!numberConfirmInput) { 
            await showCustomAlert("Eksik Bilgi", "LÃ¼tfen listeden seÃ§tiÄŸiniz Ã¶ÄŸrenci olduÄŸunuzu doÄŸrulamak iÃ§in Okul NumaranÄ±zÄ± girin.");
            return; 
        }

        // Parse the combined value: number_className_name
        const [num, cls, ...nparts] = selectedValue.split('_');
        number = num;
        className = cls;
        name = nparts.join('_'); 
        
        // *** YENÄ° DOÄRULAMA KONTROLÃœ ***
        if (String(number).trim() !== String(numberConfirmInput).trim()) {
            await showCustomAlert(
                "DoÄŸrulama HatasÄ±", 
                `GirdiÄŸiniz Okul NumarasÄ± (**${numberConfirmInput}**) ile listeden seÃ§tiÄŸiniz Ã¶ÄŸrencinin numarasÄ± (**${number}**) eÅŸleÅŸmiyor.\n\nLÃ¼tfen:\n1. Listedeki doÄŸru adÄ±nÄ±zÄ± seÃ§tiÄŸinizden\n2. NumaranÄ±zÄ± doÄŸru girdiÄŸinizden emin olun.`
            );
            return; // Login sÃ¼recini durdur.
        }
        
    } else if (document.getElementById('nameInput')) {
        // Manuel GiriÅŸ Modu (Ã‡evrimdÄ±ÅŸÄ± veya Liste TanÄ±mlanmamÄ±ÅŸsa)
        name = document.getElementById('nameInput')?.value.trim();
        number = document.getElementById('numberInput')?.value.trim();
        className = document.getElementById('classInput')?.value.trim();
        
        if (!name || !number || !className) return alert("LÃ¼tfen tÃ¼m giriÅŸ alanlarÄ±nÄ± doldurun.");

    } else {
        return alert("LÃ¼tfen geÃ§erli bir sÄ±nav kodu girin ve listeden kendinizi seÃ§in.");
    }
    
    // SÄ±nav Verilerini Ã‡ekme
    const success = await fetchExamData(code);
    if (!success) return; 

    if (quizQuestions.length === 0) {
         await showCustomAlert("Soru Yok", `SÄ±nav kodu '${code}' bulundu ama hiÃ§ soru yok! LÃ¼tfen Ã¶ÄŸretmeninizle iletiÅŸime geÃ§in.`);
         return;
    }

    studentData = { name, number, className, examCode: code };
    const studentKey = `${code}_${number}`;

    try {
        if(isDbConnected) {
            const qSub = query(collection(db, "quiz_submissions"), where("studentKey", "==", studentKey));
            const subSnap = await getDocs(qSub);
            if (!subSnap.empty) {
                await showCustomAlert("UyarÄ±", `Bu sÄ±navÄ± zaten tamamladÄ±nÄ±z.`);
                return;
            }

            const qSes = query(collection(db, "active_sessions"), where("studentKey", "==", studentKey));
            const sesSnap = await getDocs(qSes);
            if (!sesSnap.empty) {
                alert("KaldÄ±ÄŸÄ±nÄ±z yerden devam ediyorsunuz.");
                restoreSession({ id: sesSnap.docs[0].id, ...sesSnap.docs[0].data() });
            } else startNewSession(number);
        } else startNewSession(number);
        showQuiz();
    } catch (e) { alert("GiriÅŸ hatasÄ±: " + e.message); }
}

function restoreSession(session) {
    questionOrder = session.questionOrder || [];
    selectedAnswers = session.selectedAnswers || [];
    currentQuestionIndex = session.currentQuestionIndex || 0;
    timeLeft = session.timeLeft || currentExamConfig.time_limit;
    focusLossCount = session.focusLossCount || 0;
    currentSessionDocId = session.id;
    resumeStartIndex = currentQuestionIndex;
}

function startNewSession(number) {
    questionOrder = seededShuffle(Array.from({length: quizQuestions.length}, (_, i) => i), number);
    selectedAnswers = Array(quizQuestions.length).fill(null);
    currentQuestionIndex = 0;
    resumeStartIndex = 0;
    timeLeft = currentExamConfig.time_limit;
    currentSessionDocId = null;
}

// --- SINAV EKRANI VE Ä°ÅLEMLERÄ° (Kalan kÄ±sÄ±mlar V11 ile aynÄ±dÄ±r.) ---
function showQuiz() {
    document.getElementById('connectionStatus').classList.add('hidden');
    document.getElementById('app').className = 'app-card max-w-3xl';
    document.getElementById('loginHeader').innerHTML = `<h1 class="text-xl font-bold">${studentData.name} - ${studentData.examCode}</h1>`;
    
    document.getElementById('mainContentArea').innerHTML = `
        <div class="flex justify-between items-center mb-4 border-b pb-2">
            <span class="font-bold text-indigo-600">Soru: <span id="qCount"></span></span>
            <div id="timerDisplay" class="text-xl font-bold text-red-600 bg-red-100 p-1 px-3 rounded">--:--</div>
        </div>
        <div id="questionArea" class="min-h-[250px]"></div>
        <div id="focusWarn" class="hidden mt-4 p-2 bg-yellow-100 text-yellow-800 text-sm font-bold text-center rounded"></div>
        <div class="mt-6 flex justify-between">
            <button id="prevBtn" class="button bg-gray-500 text-white py-2 px-4 rounded" disabled>Ã–nceki</button>
            <button id="nextBtn" class="button bg-indigo-600 text-white py-2 px-4 rounded">Sonraki</button>
        </div>
    `;
    renderQuestion(currentQuestionIndex);
    startTimer();
    setupFocusCheck();
    startAutoSave();

    document.getElementById('prevBtn').onclick = () => {
        if (currentQuestionIndex > resumeStartIndex) { currentQuestionIndex--; renderQuestion(currentQuestionIndex); }
    };
    document.getElementById('nextBtn').onclick = () => {
        if (currentQuestionIndex < quizQuestions.length - 1) {
            currentQuestionIndex++; renderQuestion(currentQuestionIndex); saveProgress();
        } else finishQuiz();
    };
}

function renderQuestion(idx) {
    const realIdx = questionOrder[idx];
    const q = quizQuestions[realIdx];
    if(!q) return;
    const shuffledOpts = seededShuffle(q.options, studentData.number + 'opt' + realIdx);
    const currAns = selectedAnswers[realIdx];
    const imageHtml = q.image ? `<div class="mb-4 flex justify-center"><img src="${q.image}" class="max-h-64 rounded-lg shadow border"></div>` : '';

    document.getElementById('questionArea').innerHTML = `
        <div class="font-semibold text-lg text-gray-800 mb-4">Soru ${idx + 1}: ${q.question}</div>
        ${imageHtml}
        <div class="space-y-2">
            ${shuffledOpts.map(opt => `
                <label class="flex items-center p-3 border rounded cursor-pointer hover:bg-indigo-50 ${currAns === opt ? 'bg-indigo-100 border-indigo-500' : ''}">
                    <input type="radio" name="opt" value="${opt}" class="mr-3" ${currAns === opt ? 'checked' : ''}>
                    ${opt}
                </label>
            `).join('')}
        </div>
    `;
    document.getElementById('qCount').innerText = `${idx + 1} / ${quizQuestions.length}`;
    document.querySelectorAll('input[name="opt"]').forEach(el => {
        el.onchange = (e) => { selectedAnswers[realIdx] = e.target.value; renderQuestion(idx); saveProgress(); };
    });
    document.getElementById('prevBtn').disabled = idx <= resumeStartIndex;
    const nextBtn = document.getElementById('nextBtn');
    if (idx === quizQuestions.length - 1) {
        nextBtn.innerText = "BÄ°TÄ°R VE GÃ–NDER";
        nextBtn.className = "button bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded";
    } else {
        nextBtn.innerText = "Sonraki";
        nextBtn.className = "button bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded";
    }
}

function startTimer() {
    if (timerInterval) clearInterval(timerInterval);
    timeLeft = timeLeft || currentExamConfig.time_limit; 
    timerInterval = setInterval(() => {
        timeLeft--;
        const m = Math.floor(timeLeft / 60), s = timeLeft % 60;
        document.getElementById('timerDisplay').innerText = `${m}:${s < 10 ? '0'+s : s}`;
        if (timeLeft <= 0) { clearInterval(timerInterval); finishQuiz(true); }
    }, 1000);
}

function setupFocusCheck() {
    window.onblur = () => {
        if (!isTeacherMode) {
            focusLossCount++;
            const w = document.getElementById('focusWarn');
            if(w) { w.classList.remove('hidden'); w.innerText = `UYARI: Ekrandan ${focusLossCount} kez ayrÄ±ldÄ±nÄ±z!`; }
            saveProgress();
        }
    };
}

async function startAutoSave() {
    saveProgress();
    autoSaveInterval = setInterval(saveProgress, 10000);
}

async function saveProgress() {
    if (isTeacherMode || !isDbConnected || !db) return;
    const data = {
        ...studentData, studentKey: `${studentData.examCode}_${studentData.number}`,
        questionOrder, selectedAnswers, currentQuestionIndex, timeLeft, focusLossCount,
        lastUpdated: serverTimestamp()
    };
    try {
        if (currentSessionDocId) await updateDoc(doc(db, "active_sessions", currentSessionDocId), data);
        else { const ref = await addDoc(collection(db, "active_sessions"), data); currentSessionDocId = ref.id; }
    } catch(e) {}
}

async function finishQuiz(force = false) {
    clearInterval(timerInterval); clearInterval(autoSaveInterval); window.onblur = null;
    if (!force && !confirm("SÄ±navÄ± bitirmek istediÄŸinize emin misiniz?")) { startTimer(); setupFocusCheck(); return; }

    document.getElementById('mainContentArea').innerHTML = `<div class="text-center py-10 font-bold text-gray-600">SonuÃ§lar iÅŸleniyor...</div>`;
    
    // SÄ±navÄ±n gÃ¼ncel sorularÄ±nÄ± Ã§ek (EÄŸer sÄ±nav sÄ±rasÄ±nda soru havuzu deÄŸiÅŸtiyse!)
    const examCode = studentData.examCode;
    const questionsSnap = await getDoc(getQuestionsRef(examCode));
    const currentQuestions = questionsSnap.exists() ? (questionsSnap.data().questions_list || []) : [];
    
    let c = 0, i = 0, e = 0;
    
    for (let idx = 0; idx < questionOrder.length; idx++) {
        
        const realQIdx = questionOrder[idx]; 
        
        // **Ã–NEMLÄ°** Burada quizQuestions yerine, sÄ±nav biterken Ã§ekilen gÃ¼ncel sorularÄ± (currentQuestions) kullanÄ±yoruz.
        // Bu, sÄ±nav baÅŸladÄ±ktan sonra sorularÄ±n deÄŸiÅŸtirilmesi durumunda dahi doÄŸru puanlama yapÄ±lmasÄ±nÄ± saÄŸlar.
        const correctQuestion = currentQuestions[realQIdx]; 
        
        if (!correctQuestion) continue; // Soru bulunamazsa atla.

        const studentAnsVal = selectedAnswers[realQIdx]; 

        const studentAns = String(studentAnsVal || '').trim().toLowerCase();
        const correctAns = String(correctQuestion.answer || '').trim().toLowerCase();
        
        if (!studentAnsVal) { 
            e++;
        } else if (studentAns === correctAns) { 
            c++;
        } else { 
            i++;
        }
    }
    
    const score = (c * 100 / currentQuestions.length).toFixed(2);

    let ip = "Bilinmiyor";
    try { const r = await fetch('https://api.ipify.org?format=json'); const d = await r.json(); ip = d.ip; } catch(err){}

    const finalData = {
        ...studentData, studentKey: `${studentData.examCode}_${studentData.number}`,
        score, correct: c, incorrect: i, empty: e, timeSpent: currentExamConfig.time_limit - timeLeft, 
        timestamp: serverTimestamp(), focusLossCount, ipAddress: ip, 
        // Sorunun karÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ sÄ±rasÄ± ve Ã¶ÄŸrencinin bu sÄ±raya gÃ¶re verdiÄŸi cevaplarÄ± kaydediyoruz.
        questionOrder, allAnswers: selectedAnswers 
    };

    if(isDbConnected) {
        try {
            await addDoc(collection(db, "quiz_submissions"), finalData);
            if (currentSessionDocId) await deleteDoc(doc(db, "active_sessions", currentSessionDocId));
        } catch(e) {
            alert("Kaydetme hatasÄ±: " + e.message);
        }
    }
    showResult(finalData);
}

async function showResult(data) {
    document.getElementById('app').className = 'app-card max-w-md';
    document.getElementById('loginHeader').innerHTML = '<h1 class="text-2xl font-bold">SÄ±nav Bitti</h1>';

    let rankMsg = isDbConnected ? "SÄ±ralama yÃ¼kleniyor..." : "Ã‡evrimdÄ±ÅŸÄ± modda sÄ±ralama gÃ¶rÃ¼lemez.";
    let history = [];

    if(isDbConnected) {
        try {
            const q = query(collection(db, "quiz_submissions"), where("examCode", "==", data.examCode));
            const snap = await getDocs(q);
            
            // SÄ±ralamayÄ± hesapla
            const scores = snap.docs.map(d => parseFloat(d.data().score)).sort((a,b) => b-a);
            const rank = scores.indexOf(parseFloat(data.score)) + 1;
            rankMsg = `${scores.length} kiÅŸi arasÄ±ndan ${rank}. oldunuz.`;
            
            // GeÃ§miÅŸi Ã§ek
            const hSnap = await getDocs(query(collection(db, "quiz_submissions"), where("number", "==", String(data.number))));
            history = hSnap.docs.map(d => d.data()).sort((a,b) => (a.timestamp?.seconds||0) - (b.timestamp?.seconds||0));
            
        } catch(e) {
            rankMsg = "SÄ±ralama alÄ±namadÄ±.";
        }
    }

    document.getElementById('mainContentArea').innerHTML = `
        <div class="text-center">
            <div class="text-4xl font-extrabold text-indigo-600 mb-2">${data.score}</div>
            <p class="text-gray-600 font-semibold mb-4">Puan</p>
            <div class="grid grid-cols-3 gap-2 text-sm mb-4">
                <div class="bg-green-100 p-2 rounded text-green-800">D: ${data.correct}</div>
                <div class="bg-red-100 p-2 rounded text-red-800">Y: ${data.incorrect}</div>
                <div class="bg-gray-100 p-2 rounded text-gray-800">B: ${data.empty}</div>
            </div>
            <div class="bg-yellow-50 p-3 rounded text-yellow-800 mb-4 font-medium">${rankMsg}</div>
            <canvas id="resChart" class="mb-4"></canvas>
            <button onclick="location.reload()" class="button bg-gray-800 text-white py-2 px-6 rounded">Ã‡Ä±kÄ±ÅŸ</button>
        </div>
    `;

    if(history.length > 0) {
        new Chart(document.getElementById('resChart'), {
            type: 'line',
            data: {
                labels: history.map(h => h.examCode),
                datasets: [{
                    label: 'Puan',
                    data: history.map(h => h.score),
                    borderColor: '#4f46e5',
                    tension: 0.1
                }]
            }
        });
    }
}

// --- YÃ–NETÄ°M PANELÄ° (Ã‡oklu SÄ±nav YÃ¶netimi - V11 ile aynÄ±) ---

function showTeacherLogin() {
    document.getElementById('mainContentArea').innerHTML = `
        <div class="space-y-4">
            <h3 class="text-center font-bold">YÃ¶netici GiriÅŸi</h3>
            <div class="text-center text-xs mb-2 ${isDbConnected ? 'text-green-600':'text-red-600 font-bold'}">
                ${isDbConnected ? 'VeritabanÄ± Aktif' : 'VeritabanÄ± BaÄŸlÄ± DeÄŸil!'}
            </div>
            <input id="pass" type="password" placeholder="YÃ¶netici Åifresi" class="w-full p-3 border rounded">
            <button id="login" class="button bg-red-600 text-white w-full py-3 rounded">GiriÅŸ</button>
            <button onclick="location.reload()" class="button bg-gray-200 w-full py-2 rounded">Geri</button>
        </div>
    `;
    document.getElementById('login').onclick = () => {
        if (document.getElementById('pass').value === adminMasterCode) {
            isTeacherMode = true;
            showDashboard();
        } else alert("HatalÄ± ÅŸifre!");
    }
}

function showDashboard() {
    if(!isDbConnected) return alert("VeritabanÄ± baÄŸlÄ± deÄŸilken panele eriÅŸemezsiniz.");
    document.getElementById('connectionStatus').classList.add('hidden');
    document.getElementById('app').className = 'app-card teacher-mode';
    document.getElementById('loginHeader').innerHTML = '<h1 class="text-2xl font-bold">YÃ¶netim Paneli (Ã‡oklu SÄ±nav)</h1>';

    const dashboard = `
        <div class="flex gap-2 mb-4 border-b pb-2 overflow-x-auto">
            <button onclick="changeTab('results')" class="px-4 py-2 bg-indigo-600 text-white rounded text-sm">SonuÃ§lar</button>
            <button onclick="changeTab('settings')" class="px-4 py-2 bg-gray-600 text-white rounded text-sm">SÄ±nav AyarlarÄ±</button>
            <button onclick="changeTab('questions')" class="px-4 py-2 bg-orange-600 text-white rounded text-sm">Soru YÃ¼kleme</button>
            <button onclick="changeTab('lists')" class="px-4 py-2 bg-teal-600 text-white rounded text-sm">Ã–ÄŸrenci Listeleri</button>
            <button onclick="changeTab('myexams')" class="px-4 py-2 bg-purple-600 text-white rounded text-sm font-bold">SÄ±navlarÄ±m (YÃ¶netim) ğŸ†•</button> <button onclick="location.reload()" class="px-4 py-2 bg-red-600 text-white rounded text-sm ml-auto">Ã‡Ä±kÄ±ÅŸ</button>
        </div>
        
        <div id="tab-results" class="tab-content">
            <h3 class="text-xl font-bold text-indigo-700 mb-4 border-b pb-2">SonuÃ§lar ve Aktif Oturumlar</h3>
            <div id="statsArea" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 text-center"></div>
            <div class="flex flex-wrap gap-2 mb-4 items-center bg-gray-50 p-3 rounded border">
                <input id="fCode" placeholder="SÄ±nav Kodu" class="p-2 border rounded text-sm w-32">
                <input id="fClass" placeholder="SÄ±nÄ±f" class="p-2 border rounded text-sm w-24">
                <input id="fName" placeholder="Ad Soyad" class="p-2 border rounded text-sm w-32">
                <button id="btnExport" class="bg-green-600 text-white px-3 py-2 rounded text-sm shadow">Excel Ä°ndir</button>
                <button id="btnDelAll" onclick="deleteFilteredSubmissions()" class="bg-red-600 text-white px-3 py-2 rounded text-sm shadow">FiltrelenmiÅŸ SonuÃ§larÄ± Sil</button>
            </div>
            <div class="overflow-x-auto border rounded max-h-[50vh] overflow-y-auto shadow mb-6">
                <table id="resultsTable" class="min-w-full divide-y divide-gray-200 text-sm"></table>
            </div>
            
            <h3 class="text-xl font-bold text-yellow-700 mb-4 border-b pb-2 mt-8">Aktif Oturumlar ğŸ”´</h3>
            <div class="overflow-x-auto border rounded max-h-[30vh] overflow-y-auto shadow">
                <table id="activeSessionsTable" class="min-w-full divide-y divide-gray-200 text-sm"></table>
            </div>
        </div>

        <div id="tab-settings" class="tab-content hidden">
            <h3 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">SÄ±nav AyarlarÄ±</h3>
            </div>

        <div id="tab-questions" class="tab-content hidden">
            <h3 class="text-xl font-bold text-orange-700 mb-4 border-b pb-2">Soru YÃ¼kleme</h3>
            </div>

        <div id="tab-lists" class="tab-content hidden">
            <h3 class="text-xl font-bold text-teal-700 mb-4 border-b pb-2">Ã–ÄŸrenci Listeleri (Okul No, Ad, SÄ±nÄ±f)</h3>
            </div>

        <div id="tab-myexams" class="tab-content hidden"> <h3 class="text-xl font-bold text-purple-700 mb-4 border-b pb-2">ğŸ“‹ HazÄ±rladÄ±ÄŸÄ±m SÄ±navlar ve YÃ¶netimi</h3>
            <div id="myExamsContent" class="space-y-4">
                <p class="text-center text-gray-500 font-semibold">SÄ±nav kodlarÄ± yÃ¼kleniyor...</p>
            </div>
        </div>
    `;
    document.getElementById('mainContentArea').innerHTML = dashboard;
    
    // YENÄ° SEKMEYÄ° BAÅLATMA
    setupMyExamsTab(); // YENÄ°: Sekme iÃ§eriÄŸini yÃ¼kle
    
    setupResultsTable();
    setupActiveSessionsListener();
    setupExamSettings();
    setupQuestionUpload();
    setupStudentLists();

    window.changeTab = (tabId) => {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.getElementById(`tab-${tabId}`).classList.remove('hidden');
        document.querySelectorAll('.flex.gap-2 button').forEach(btn => btn.classList.remove('bg-indigo-600', 'bg-gray-600', 'bg-orange-600', 'bg-teal-600', 'bg-purple-600'));
        
        let bgColor = 'bg-indigo-600';
        if (tabId === 'settings') bgColor = 'bg-gray-600';
        else if (tabId === 'questions') bgColor = 'bg-orange-600';
        else if (tabId === 'lists') bgColor = 'bg-teal-600';
        else if (tabId === 'myexams') bgColor = 'bg-purple-600';

        document.querySelector(`button[onclick="changeTab('${tabId}')"]`).classList.add(bgColor);
    };

    changeTab('results'); // BaÅŸlangÄ±Ã§ta SonuÃ§lar sekmesi aÃ§Ä±k
}

// ... (setupResultsTable, setupActiveSessionsListener, setupExamSettings, setupQuestionUpload, setupStudentLists, vb. mevcut fonksiyonlar)

// --- SINAVLARIM SEKME YÃ–NETÄ°MÄ° ---

/**
 * SÄ±navlarÄ±m sekmesini yÃ¶neten ve sÄ±nav verilerini tabloya dÃ¶ken fonksiyon.
 */
async function setupMyExamsTab() {
    const contentDiv = document.getElementById('myExamsContent');
    if (!contentDiv) return;

    if (!isDbConnected) {
        contentDiv.innerHTML = '<p class="text-center text-red-600 font-bold">VeritabanÄ± baÄŸlantÄ±sÄ± yok. Bu bÃ¶lÃ¼m kullanÄ±lamaz.</p>';
        return;
    }

    contentDiv.innerHTML = '<p class="text-center text-indigo-600 font-bold">SÄ±nav kodlarÄ± taranÄ±yor...</p>';

    try {
        // TÃ¼m olasÄ± sÄ±nav kodlarÄ±nÄ± toplama
        let allExamCodes = new Set();
        
        // 1. TÃ¼m SÄ±nav AyarlarÄ±nÄ± Ã‡ek
        const settingsSnap = await getDocs(collection(db, "exam_settings")); 
        settingsSnap.docs.filter(d => d.id !== 'admin_config').forEach(d => allExamCodes.add(d.id.toUpperCase()));

        // 2. TÃ¼m Soru HavuzlarÄ±nÄ± Kontrol Et
        const questionPoolSnap = await getDocs(collection(db, "questions_pool"));
        questionPoolSnap.docs.forEach(d => allExamCodes.add(d.id.toUpperCase()));

        // 3. TÃ¼m Ã–ÄŸrenci Listelerini Kontrol Et
        const studentListSnap = await getDocs(collection(db, "student_lists"));
        studentListSnap.docs.forEach(d => allExamCodes.add(d.id.toUpperCase()));
        
        if (allExamCodes.size === 0) {
            contentDiv.innerHTML = '<p class="text-center text-gray-500 font-semibold">HenÃ¼z tanÄ±mlÄ± bir sÄ±nav kodu bulunmamaktadÄ±r.</p>';
            return;
        }

        const examsData = [];
        const settingsMap = new Map(settingsSnap.docs.map(d => [d.id, d.data()]));
        const questionsMap = new Map(questionPoolSnap.docs.map(d => [d.id, d.data()]));
        const listsMap = new Map(studentListSnap.docs.map(d => [d.id, d.data()]));
        
        for (const code of Array.from(allExamCodes).sort()) {
            const configData = settingsMap.get(code) || { exam_description: 'Ayarlar TanÄ±mlanmamÄ±ÅŸ', teacher_name: 'Bilinmiyor', customName: '' };
            
            const questionsData = questionsMap.get(code);
            const questionCount = questionsData ? (questionsData.questions_list?.length || 0) : 0;
            
            const listData = listsMap.get(code);
            const studentCount = listData ? (listData.students?.length || 0) : 0;
            const classNames = listData ? [...new Set(listData.students.map(s => s.className))] : [];
            
            examsData.push({
                code: code,
                customName: configData.customName || '', 
                teacher: configData.teacher_name,
                description: configData.exam_description,
                questionCount: questionCount,
                studentCount: studentCount,
                classNames: classNames.join(', ')
            });
        }
        
        // Tabloyu OluÅŸturma
        contentDiv.innerHTML = `
            <div class="overflow-x-auto border rounded max-h-[75vh] overflow-y-auto shadow">
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                    <thead class="bg-gray-100 sticky top-0">
                        <tr>
                            <th class="p-3 text-left font-bold text-gray-600 w-1/4">SÄ±nav Kodu / Ä°sim</th>
                            <th class="p-3 text-left font-bold text-gray-600">HazÄ±rlayan</th>
                            <th class="p-3 text-center font-bold text-gray-600">Soru SayÄ±sÄ±</th>
                            <th class="p-3 text-left font-bold text-gray-600 w-1/4">TanÄ±mlÄ± SÄ±nÄ±flar/Ã–ÄŸr. SayÄ±sÄ±</th>
                            <th class="p-3 text-center font-bold text-gray-600">Ä°ÅŸlem</th>
                        </tr>
                    </thead>
                    <tbody id="myExamsTableBody" class="bg-white divide-y">
                        ${examsData.map(exam => `
                            <tr class="hover:bg-purple-50">
                                <td class="p-3">
                                    <p class="font-extrabold text-purple-700">${exam.code}</p>
                                    <div class="flex items-center gap-1 mt-1">
                                        <input type="text" id="name-${exam.code}" class="p-1 border rounded text-xs w-full" 
                                            placeholder="SÄ±nav AdÄ± Ekle/DÃ¼zenle" value="${exam.customName || ''}">
                                        <button onclick="saveCustomName('${exam.code}')" class="bg-indigo-500 text-white p-1 rounded text-xs shadow hover:bg-indigo-600">Kaydet</button>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">${exam.description.substring(0, 50)}...</p>
                                </td>
                                <td class="p-3 text-xs">${exam.teacher}</td>
                                <td class="p-3 text-center font-bold ${exam.questionCount > 0 ? 'text-green-600' : 'text-red-600'}">
                                    ${exam.questionCount}
                                </td>
                                <td class="p-3 text-left text-xs text-gray-600">
                                    <span class="font-bold text-gray-800">${exam.studentCount}</span> Ã–ÄŸrenci
                                    ${exam.studentCount > 0 ? `<br><span class="text-[10px]">${exam.classNames}</span>` : ''}
                                </td>
                                <td class="p-3 text-center">
                                    <button onclick="deleteAllExamData('${exam.code}')" class="bg-red-600 text-white px-3 py-1 rounded text-xs font-bold shadow hover:bg-red-700">TÃœM VERÄ°YÄ° SÄ°L</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            <p class="mt-4 text-xs text-red-600 font-semibold">âš ï¸ SÄ°LME Ä°ÅLEMÄ°: SÄ±nav ayarlarÄ±nÄ±, sorularÄ±nÄ±, Ã¶ÄŸrenci listesini, o sÄ±nava ait tÃ¼m sonuÃ§larÄ± (quiz_submissions) ve aktif oturumlarÄ± (active_sessions) KALICI olarak siler.</p>
        `;

    } catch(e) {
        contentDiv.innerHTML = `<p class="text-center text-red-600 font-bold">Veri Ã§ekme hatasÄ±: ${e.message}</p>`;
    }
}


/**
 * SÄ±nav koduna Ã¶zel bir isim kaydeder veya siler.
 * @param {string} code SÄ±nav Kodu
 */
window.saveCustomName = async (code) => {
    const customName = document.getElementById(`name-${code}`).value.trim();
    const configRef = getConfigRef(code);

    if (!customName) {
        if (confirm(`'${code}' kodlu sÄ±navÄ±n Ã¶zel ismini SÄ°LMEK istediÄŸinizden emin misiniz?`)) {
            try {
                // Sadece customName alanÄ±nÄ± siler
                await updateDoc(configRef, { customName: deleteField() }); 
                alert(`'${code}' sÄ±nav kodunun Ã¶zel ismi silindi.`);
                setupMyExamsTab(); // Listeyi yenile
                return;
            } catch (e) {
                 alert("Ä°sim silinirken hata oluÅŸtu: " + e.message);
                 return;
            }
        }
        return; 
    }

    try {
        // EÄŸer exam_settings belgesi yoksa bile merge: true ile oluÅŸturulup isim eklenir
        await setDoc(configRef, { customName: customName }, { merge: true });
        alert(`'${code}' kodlu sÄ±nava '${customName}' ismi baÅŸarÄ±yla kaydedildi!`);
    } catch(e) {
        alert("Ä°sim kaydederken hata oluÅŸtu: " + e.message);
    }
};

/**
 * Ä°lgili sÄ±nav koduna ait tÃ¼m veritabanÄ± kayÄ±tlarÄ±nÄ± siler.
 * @param {string} code SÄ±nav Kodu
 */
window.deleteAllExamData = async (code) => {
    const examCode = code.toUpperCase();
    
    if (!confirm(`âš ï¸ SON UYARI: '${examCode}' kodlu sÄ±nava ait TÃœM VERÄ° (Ayarlar, Sorular, Liste, Aktif Oturumlar ve SONUÃ‡LAR dahil) KALICI olarak silinecektir. Bu iÅŸlem geri alÄ±namaz! Emin misiniz?`)) {
        return;
    }

    try {
        const deletePromises = [];

        // 1. AyarlarÄ± Sil (exam_settings)
        deletePromises.push(deleteDoc(getConfigRef(examCode)).catch(e => console.log(`Ayarlar silinemedi: ${e.message}`))); 
        
        // 2. SorularÄ± Sil (questions_pool)
        deletePromises.push(deleteDoc(getQuestionsRef(examCode)).catch(e => console.log(`Sorular silinemedi: ${e.message}`)));
        
        // 3. Ã–ÄŸrenci Listesini Sil (student_lists)
        deletePromises.push(deleteDoc(getStudentListRef(examCode)).catch(e => console.log(`Liste silinemedi: ${e.message}`)));

        // 4. SonuÃ§larÄ± Sil (quiz_submissions)
        const subQuery = query(collection(db, "quiz_submissions"), where("examCode", "==", examCode));
        const subSnap = await getDocs(subQuery);
        subSnap.docs.forEach(d => deletePromises.push(deleteDoc(getSubmissionRef(d.id)).catch(e => console.log(`SonuÃ§ silinemedi (${d.id}): ${e.message}`))));

        // 5. Aktif OturumlarÄ± Sil (active_sessions)
        const activeQuery = query(collection(db, "active_sessions"), where("examCode", "==", examCode));
        const activeSnap = await getDocs(activeQuery);
        activeSnap.docs.forEach(d => deletePromises.push(deleteDoc(doc(db, "active_sessions", d.id)).catch(e => console.log(`Oturum silinemedi (${d.id}): ${e.message}`))));
        
        // TÃ¼m silme iÅŸlemlerini aynÄ± anda bekle
        await Promise.all(deletePromises);

        await showCustomAlert("BaÅŸarÄ±lÄ±", `'${examCode}' kodlu sÄ±nava ait tÃ¼m veriler baÅŸarÄ±yla silinmiÅŸtir.`);
        
        // Ä°lgili sekmeleri yenile
        setupMyExamsTab(); 
        setupResultsTable(); 

    } catch(e) {
        await showCustomAlert("Kritik Silme HatasÄ±", `Veri silinirken beklenmedik bir hata oluÅŸtu: ${e.message}`);
    }
};


// ... (Kalan mevcut fonksiyonlar)

initializeFirebase();
    </script>
</body>
</html>
