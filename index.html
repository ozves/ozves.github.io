<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0, pre-check=0, post-check=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="-1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Öğrenci Sınav Uygulaması (Firestore Destekli)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0;}
        .app-card { background-color:white;padding:2.5rem;border-radius:1.5rem;box-shadow:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05);max-width:450px;width:90%;transition:all .3s;position:relative;}
        .header-bg { background: linear-gradient(135deg,#4f46e5 0%,#818cf8 100%); color:white;padding:1rem 0;border-radius:1rem 1rem 0 0;margin:-2.5rem -2.5rem 1.5rem -2.5rem;text-align:center;}
        .button{transition:all .2s;box-shadow:0 4px 6px rgba(0,0,0,0.1)}
        .button:hover{transform:translateY(-1px);box-shadow:0 6px 10px rgba(0,0,0,0.15)}
        @media (max-width:640px){ .app-card{padding:1.5rem;border-radius:1rem} .header-bg{margin:-1.5rem -1.5rem 1rem -1.5rem;padding:.75rem 0} }
    </style>
</head>
<body>

    <div id="app" class="app-card">
        <div id="loginHeader" class="header-bg">
            <h1 class="text-2xl font-extrabold">Öğrenci Girişi</h1>
        </div>
        <div id="mainContentArea">
            <div id="loadingIndicator" class="text-center py-10">
                <svg class="animate-spin h-8 w-8 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="text-sm text-gray-500 mt-4 font-semibold">Sınav Verileri Yükleniyor...</p>
                <p id="systemStatus" class="text-xs text-gray-400 mt-2">Sunucu bağlantısı kuruluyor</p>
            </div>
        </div>
    </div>

    <div id="customModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center p-4 z-50">
        <div id="modalContent" class="bg-white rounded-xl p-8 max-w-sm w-full text-center shadow-2xl transform transition-all scale-100"></div>
    </div>

    <div style="position:fixed; bottom:10px; right:10px; opacity:0.5;">
        <button id="adminUploadBtn" class="bg-red-500 text-white text-xs p-2 rounded">Veritabanına Soruları Yükle (Admin)</button>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, serverTimestamp, query, where, getDocs, deleteDoc, getDoc, addDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // --- ARTIK SABİT DEĞİŞKENLER YOK, HEPSİ BOŞ ---
        // Bu veriler Firestore'dan çekilecek
        let TEACHER_CODE = null;
        let EXAM_CODE = null;
        let TEACHER_NAME = null;
        let TIME_LIMIT_SECONDS = null;
        let quizQuestions = [];
        // ----------------------------------------------

        const firebaseConfig = {
            apiKey: "AIzaSyCHhFAHbWnclad6yFuI-Pw9gX6F_Dx1B2c",
            authDomain: "online-sinav-b3644.firebaseapp.com",
            projectId: "online-sinav-b3644",
            storageBucket: "online-sinav-b3644.firebasestorage.app",
            messagingSenderId: "965507531268",
            appId: "1:965507531268:web:94cfd13774a40b6cf16b51"
        };

        let selectedAnswers = [];
        let questionOrder = [];
        let currentQuestionIndex = 0;
        let resumeStartIndex = 0; 
        let timerInterval = null;
        let timeLeft = 0;
        let isTeacherMode = false;
        let studentData = {};
        let focusLossCount = 0;
        let autoSaveInterval = null;
        let currentSessionDocId = null;

        function seededShuffle(array, seed) {
            let hash = 0;
            for (let i = 0; i < seed.length; i++) {
                hash = ((hash << 5) - hash) + seed.charCodeAt(i);
                hash |= 0;
            }
            const shuffled = [...array];
            let n = shuffled.length;
            while (n > 1) {
                hash = (hash * 9301 + 49297) % 233280;
                if (hash < 0) hash += 233280;
                let random = hash / 233280.0;
                let k = Math.floor(random * n);
                n--;
                [shuffled[n], shuffled[k]] = [shuffled[k], shuffled[n]];
            }
            return shuffled;
        }

        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                document.getElementById('systemStatus').textContent = 'Oturum açılıyor...';
                await signInAnonymously(auth);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        document.getElementById('systemStatus').textContent = 'Veriler indiriliyor...';
                        // Önce verileri çek, sonra ekranı göster
                        await loadExamData();
                    }
                });
            } catch (error) {
                console.error("Firebase başlatılırken hata oluştu:", error);
                document.getElementById('mainContentArea').innerHTML = `<p class="text-red-600 text-center">Bağlantı Hatası: ${error.message}</p>`;
            }
        }

        // --- YENİ FONKSİYON: Veritabanından Ayarları ve Soruları Çek ---
        async function loadExamData() {
            try {
                // 1. Ayarları Çek (Config)
                const configRef = doc(db, "exam_settings", "config");
                const configSnap = await getDoc(configRef);

                if (configSnap.exists()) {
                    const data = configSnap.data();
                    TEACHER_CODE = data.teacher_code;
                    EXAM_CODE = data.exam_code;
                    TEACHER_NAME = data.teacher_name;
                    TIME_LIMIT_SECONDS = data.time_limit;
                } else {
                    throw new Error("Sınav ayarları bulunamadı! (Veritabanı boş)");
                }

                // 2. Soruları Çek
                const questionsRef = doc(db, "questions_pool", "biology_exam");
                const questionsSnap = await getDoc(questionsRef);

                if (questionsSnap.exists()) {
                    const qData = questionsSnap.data();
                    quizQuestions = qData.questions_list;
                } else {
                    // Eğer soru yoksa boş array (veya hata)
                    console.warn("Soru havuzu boş.");
                    quizQuestions = [];
                }

                // Yükleme bitti, giriş ekranını göster
                document.getElementById('loadingIndicator').classList.add('hidden');
                showLoginForm();

            } catch (error) {
                console.error("Veri çekme hatası:", error);
                document.getElementById('loadingIndicator').innerHTML = `
                    <p class="text-red-600 font-bold">Sınav Yüklenemedi</p>
                    <p class="text-xs text-gray-500 mt-2">Lütfen internet bağlantınızı kontrol edin veya öğretmeninize haber verin.</p>
                    <p class="text-xs text-red-400 mt-2">${error.message}</p>
                `;
            }
        }

        function showLoginForm() {
            if (!isAuthReady || !EXAM_CODE) return; // Veriler gelmediyse açma

            document.getElementById('app').classList.remove('max-w-3xl', 'max-w-4xl');
            document.getElementById('app').classList.add('max-w-md');
            document.getElementById('loginHeader').innerHTML = '<h1 class="text-2xl font-extrabold">Öğrenci Girişi</h1>';
            const timeInMinutes = Math.floor(TIME_LIMIT_SECONDS / 60);
            
            const content = `
                <div class="space-y-4">
                    <div class="text-center p-2 bg-indigo-50 rounded-lg shadow-sm">
                        <p class="text-xs text-gray-500">Sınavı Hazırlayan:</p>
                        <p class="font-bold text-indigo-700">${TEACHER_NAME}</p>
                    </div>
                    <div class="p-3 bg-red-100 border border-red-300 rounded-lg text-red-700 font-medium text-sm text-center shadow-inner">
                        <p class="font-bold">ÖNEMLİ UYARI:</p>
                        <p>Sınav süreniz tam olarak <span class="text-red-900">${timeInMinutes} dakika</span>'dır.</p>
                    </div>
                    <input id="examCodeInput" type="text" placeholder="Sınav Kodu (Örn: ${EXAM_CODE})" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm uppercase" required>
                    <input id="nameInput" type="text" placeholder="Adınız Soyadınız" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm" required>
                    <input id="numberInput" type="number" placeholder="Okul Numaranız" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm" required>
                    <input id="classInput" type="text" placeholder="Sınıfınız (Örn: 10A)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm" required>
                    <button id="startQuizButton" class="button w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-lg shadow-md">Sınava Başla</button>
                    <button id="teacherLoginButton" class="button w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 rounded-lg text-sm shadow-sm">Öğretmen Girişi</button>
                </div>
            `;
            document.getElementById('mainContentArea').innerHTML = content;
            document.getElementById('startQuizButton').addEventListener('click', handleStudentLogin);
            document.getElementById('teacherLoginButton').addEventListener('click', showTeacherLogin);
        }

        async function handleStudentLogin() {
            const name = document.getElementById('nameInput').value.trim();
            const number = document.getElementById('numberInput').value.trim();
            const className = document.getElementById('classInput').value.trim();
            const examCodeInput = document.getElementById('examCodeInput').value.trim().toUpperCase();
            
            if (!name || !number || !className || !examCodeInput) {
                showCustomAlert("Eksik Bilgi", "Lütfen tüm alanları doldurun.");
                return;
            }

            if (examCodeInput !== EXAM_CODE) {
                showCustomAlert("Hatalı Sınav Kodu", `Girdiğiniz sınav kodu geçersizdir.`);
                return;
            }

            studentData = { name, number, className, examCode: EXAM_CODE };
            isTeacherMode = false;
            const studentKey = `${EXAM_CODE}_${number}`;
            
            // Veritabanı kontrolleri
            const completedExam = await checkCompletedExam(studentKey);
            if (completedExam) {
                await showCustomAlert("Sınav Tamamlandı", `Bu sınavı daha önce tamamladınız!\nPuanınız: ${completedExam.score}`);
                return;
            }

            const existingSession = await checkExistingSession(studentKey);
            if (existingSession) {
                await showCustomAlert("Oturum Bulundu", `Kaldığınız yerden devam ediyorsunuz.`);
                
                studentData = { 
                    name: existingSession.name || name, 
                    number: existingSession.number || number, 
                    className: existingSession.className || className, 
                    examCode: existingSession.examCode || EXAM_CODE 
                };
                questionOrder = existingSession.questionOrder || [];
                selectedAnswers = existingSession.selectedAnswers || Array(quizQuestions.length).fill(null);
                currentQuestionIndex = existingSession.currentQuestionIndex || 0;
                timeLeft = existingSession.timeLeft || TIME_LIMIT_SECONDS;
                focusLossCount = existingSession.focusLossCount || 0;
                currentSessionDocId = existingSession.id;
                resumeStartIndex = currentQuestionIndex;

                showQuiz();
                return;
            }

            // Yeni Oturum
            questionOrder = seededShuffle(Array.from({length: quizQuestions.length}, (_, i) => i), number);
            selectedAnswers = Array(quizQuestions.length).fill(null);
            currentQuestionIndex = 0;
            resumeStartIndex = 0;
            focusLossCount = 0;
            timeLeft = TIME_LIMIT_SECONDS;
            currentSessionDocId = null;

            showQuiz();
        }

        async function checkCompletedExam(studentKey) {
            if (!db) return null;
            const q = query(collection(db, "quiz_submissions"), where("studentKey", "==", studentKey));
            const snap = await getDocs(q);
            if (!snap.empty) return snap.docs[0].data();
            return null;
        }

        async function checkExistingSession(studentKey) {
            if (!db) return null;
            const q = query(collection(db, "active_sessions"), where("studentKey", "==", studentKey));
            const snap = await getDocs(q);
            if (!snap.empty) return { id: snap.docs[0].id, ...snap.docs[0].data() };
            return null;
        }

        function showTeacherLogin() {
            document.getElementById('loginHeader').innerHTML = '<h1 class="text-2xl font-extrabold">Öğretmen Girişi</h1>';
            const content = `
                <div class="space-y-4">
                    <input id="teacherCodeInput" type="password" placeholder="Öğretmen Kodu" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 shadow-sm" required>
                    <button id="teacherLoginButtonExecute" class="button w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 rounded-lg shadow-md">Giriş Yap</button>
                    <button id="backToStudentLogin" class="button w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 rounded-lg text-sm shadow-sm">Öğrenci Girişine Dön</button>
                </div>
            `;
            document.getElementById('mainContentArea').innerHTML = content;
            document.getElementById('teacherLoginButtonExecute').addEventListener('click', handleTeacherLogin);
            document.getElementById('backToStudentLogin').addEventListener('click', showLoginForm);
        }

        function handleTeacherLogin() {
            const code = document.getElementById('teacherCodeInput').value.trim();
            if (code === TEACHER_CODE) {
                isTeacherMode = true;
                showTeacherPanel();
            } else {
                showCustomAlert("Hata", "Girdiğiniz öğretmen kodu yanlış.");
            }
        }

        function showQuiz() {
            document.getElementById('app').classList.remove('max-w-md');
            document.getElementById('app').classList.add('max-w-3xl');
            document.getElementById('loginHeader').innerHTML = `<h1 class="text-2xl font-extrabold">${studentData.name}</h1>`;

            const quizHtml = `
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 border-b pb-3 space-y-2 sm:space-y-0">
                    <p class="text-base text-gray-600">${studentData.className} / ${studentData.number}</p>
                    <p class="text-sm font-medium text-indigo-600">Soru: <span id="questionCounter">1/${quizQuestions.length}</span></p>
                    <div id="timerDisplay" class="text-xl font-bold text-red-600 bg-red-100 p-2 rounded-lg shadow-md">--:--</div>
                </div>
                <div id="questionsContainer" class="space-y-8 min-h-[250px] flex flex-col justify-between"></div>
                <div id="focusWarning" class="hidden mt-4 p-2 bg-yellow-100 border border-yellow-400 text-yellow-800 rounded-lg text-sm font-medium text-center"></div>
                <div id="autoSaveIndicator" class="mt-2 p-2 bg-green-50 border border-green-300 text-green-700 rounded-lg text-xs text-center">✓ İlerlemeniz güvende</div>
                <div class="mt-8 pt-4 border-t flex justify-between">
                    <button id="prevButton" class="button bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md disabled:opacity-50" disabled>Önceki</button>
                    <button id="nextButton" class="button bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-xl">Sonraki</button>
                </div>
            `;
            document.getElementById('mainContentArea').innerHTML = quizHtml;

            renderQuestion(currentQuestionIndex);
            startTimer();
            setupFocusCheck();
            startAutoSave();

            document.getElementById('prevButton').addEventListener('click', handlePrevQuestion);
            document.getElementById('nextButton').addEventListener('click', handleNextQuestion);
        }

        async function startAutoSave() {
            await saveProgress();
            autoSaveInterval = setInterval(async () => {
                await saveProgress();
            }, 10000);
        }

        async function saveProgress() {
            if (!db || isTeacherMode) return;
            const studentKey = `${studentData.examCode}_${studentData.number}`;
            const progressData = {
                ...studentData,
                studentKey: studentKey,
                questionOrder,
                selectedAnswers,
                currentQuestionIndex,
                timeLeft,
                focusLossCount,
                lastUpdated: serverTimestamp()
            };
            try {
                if (currentSessionDocId) {
                    await updateDoc(doc(db, "active_sessions", currentSessionDocId), progressData);
                } else {
                    const docRef = await addDoc(collection(db, "active_sessions"), progressData);
                    currentSessionDocId = docRef.id;
                }
                const indicator = document.getElementById('autoSaveIndicator');
                if(indicator) { indicator.classList.add('bg-green-200'); setTimeout(() => indicator.classList.remove('bg-green-200'), 300); }
            } catch (error) { console.error("Kaydetme hatası", error); }
        }

        function setupFocusCheck() {
            const warningElement = document.getElementById('focusWarning');
            const handleBlur = () => {
                if (!isTeacherMode) {
                    focusLossCount++;
                    warningElement.classList.remove('hidden');
                    warningElement.innerHTML = `UYARI: Sayfadan ${focusLossCount} kez ayrıldınız!`;
                    saveProgress();
                }
            };
            const handleFocus = () => { warningElement.classList.add('hidden'); };
            window.addEventListener('blur', handleBlur);
            window.addEventListener('focus', handleFocus);
            document.getElementById('app').addEventListener('quiz-ended', () => {
                window.removeEventListener('blur', handleBlur);
                window.removeEventListener('focus', handleFocus);
            });
        }

        function renderQuestion(quizIndex) {
            const container = document.getElementById('questionsContainer');
            const originalIndex = questionOrder[quizIndex];
            const q = quizQuestions[originalIndex];
            
            // Options'ları karıştır
            const shuffledOptions = seededShuffle(q.options, studentData.number + 'options' + originalIndex);
            const currentAnswer = selectedAnswers[originalIndex];

            const questionHtml = `
                <div class="question-card p-6 border-4 border-indigo-200 rounded-xl bg-white shadow-xl flex-grow">
                    <div class="text-2xl font-bold text-indigo-700 mb-4">Soru ${quizIndex + 1}:</div>
                    <p class="font-semibold text-gray-800 text-lg mb-6">${q.question}</p>
                    <div class="options-container space-y-3">
                        ${shuffledOptions.map((option) => {
                            const isChecked = currentAnswer === option;
                            return `
                                <label class="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-indigo-50 transition duration-150 ${isChecked ? 'bg-indigo-100 border-indigo-500 shadow-md' : 'bg-white'}">
                                    <input type="radio" name="q_current" value="${option}" class="text-indigo-600 h-5 w-5" ${isChecked ? 'checked' : ''}>
                                    <span class="text-gray-700 font-medium">${option}</span>
                                </label>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            container.innerHTML = questionHtml;
            document.getElementById('questionCounter').textContent = `${quizIndex + 1}/${quizQuestions.length}`;
            
            container.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.addEventListener('change', async (e) => {
                    selectedAnswers[originalIndex] = e.target.value;
                    renderQuestion(quizIndex); // UI güncellemek için yeniden render (basit çözüm)
                    await saveProgress();
                });
            });
            
            updateNavigationButtons(quizIndex);
        }

        function updateNavigationButtons(quizIndex) {
            const prevButton = document.getElementById('prevButton');
            const nextButton = document.getElementById('nextButton');
            prevButton.disabled = quizIndex <= resumeStartIndex;

            if (quizIndex === quizQuestions.length - 1) {
                nextButton.textContent = "Sınavı Bitir ve Gönder";
                nextButton.classList.replace('bg-indigo-600', 'bg-green-600');
                nextButton.classList.replace('hover:bg-indigo-700', 'hover:bg-green-700');
            } else {
                nextButton.textContent = "Sonraki";
                nextButton.classList.replace('bg-green-600', 'bg-indigo-600');
                nextButton.classList.replace('hover:bg-green-700', 'hover:bg-indigo-700');
            }
        }

        async function handleNextQuestion() {
            if (currentQuestionIndex < quizQuestions.length - 1) {
                currentQuestionIndex++;
                renderQuestion(currentQuestionIndex);
                await saveProgress();
            } else {
                finishQuiz(false);
            }
        }
        
        async function handlePrevQuestion() { 
            if (currentQuestionIndex > resumeStartIndex) { 
                currentQuestionIndex--;
                renderQuestion(currentQuestionIndex);
                await saveProgress();
            } 
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            const timerDisplay = document.getElementById('timerDisplay');
            timerInterval = setInterval(() => {
                timeLeft--;
                if (timeLeft < 0) {
                    clearInterval(timerInterval);
                    timeLeft = 0;
                    finishQuiz(true);
                }
                updateTimerDisplay(timerDisplay);
            }, 1000);
            updateTimerDisplay(timerDisplay);
        }

        function updateTimerDisplay(displayElement) {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            displayElement.textContent = `${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
        }

        async function finishQuiz(isTimeUp = false) {
            clearInterval(timerInterval);
            if (autoSaveInterval) clearInterval(autoSaveInterval);
            document.getElementById('app').dispatchEvent(new Event('quiz-ended'));
            
            const confirmationMessage = isTimeUp ? 'Süre doldu!' : 'Sınavı bitirmek istediğinizden emin misiniz?';
            const confirmed = isTimeUp ? true : await showCustomConfirmation(confirmationMessage);
            
            if (confirmed) {
                const results = calculateScore();
                await saveSubmission(results);
                if (currentSessionDocId) await deleteDoc(doc(db, "active_sessions", currentSessionDocId));
                showResultScreen(results, isTimeUp);
            } else {
                if (!isTimeUp) startTimer();
            }
        }

        function calculateScore() {
            let correctCount = 0, incorrectCount = 0, emptyCount = 0;
            quizQuestions.forEach((q, originalIndex) => {
                const answer = selectedAnswers[originalIndex];
                if (answer === null) emptyCount++;
                else if (answer === q.answer) correctCount++;
                else incorrectCount++;
            });
            return { correct: correctCount, incorrect: incorrectCount, empty: emptyCount, total: quizQuestions.length, score: correctCount * 100 / quizQuestions.length };
        }

        async function saveSubmission(results) {
            const timeSpent = TIME_LIMIT_SECONDS - timeLeft;
            const submissionData = {
                ...studentData,
                studentKey: `${studentData.examCode}_${studentData.number}`,
                score: results.score.toFixed(2),
                correct: results.correct,
                incorrect: results.incorrect,
                empty: results.empty,
                timeSpent: timeSpent,
                timestamp: serverTimestamp(),
                focusLossCount: focusLossCount,
                questionOrder: questionOrder,
                allAnswers: selectedAnswers
            };
            await addDoc(collection(db, "quiz_submissions"), submissionData);
        }

        function showResultScreen(results, isTimeUp) {
            document.getElementById('app').classList.add('max-w-md');
            document.getElementById('loginHeader').innerHTML = '<h1 class="text-2xl font-extrabold">Sonuç</h1>';
            
            const resultHtml = `
                <div class="text-center py-6">
                    <h2 class="text-3xl font-bold mb-2">Sınav Bitti!</h2>
                    ${isTimeUp ? '<p class="text-red-500 font-semibold">Süre Doldu.</p>' : ''}
                    <div class="grid grid-cols-2 gap-4 text-left max-w-sm mx-auto p-4 bg-gray-50 rounded-xl shadow-inner mb-6 mt-4">
                        <div class="font-semibold text-gray-600">Puan:</div>
                        <div class="font-bold text-2xl text-indigo-600">${results.score.toFixed(2)}</div>
                    </div>
                    <button id="returnToLogin" class="button bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md">Çıkış</button>
                </div>
            `;
            document.getElementById('mainContentArea').innerHTML = resultHtml;
            document.getElementById('returnToLogin').addEventListener('click', () => location.reload());
        }

        function showTeacherPanel() {
            document.getElementById('app').classList.remove('max-w-md');
            document.getElementById('app').classList.add('max-w-4xl');
            document.getElementById('loginHeader').innerHTML = '<h1 class="text-2xl font-extrabold">Öğretmen Paneli</h1>';

            const teacherHtml = `
                <div class="flex justify-between items-center mb-4">
                    <p class="text-sm text-gray-600">Sonuçlar canlı güncellenir.</p>
                    <button id="teacherLogout" class="button bg-red-600 text-white text-sm py-2 px-4 rounded">Çıkış</button>
                </div>
                <div class="overflow-x-auto bg-white rounded-lg shadow border border-indigo-100">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-indigo-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-indigo-700 uppercase">Ad Soyad</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-indigo-700 uppercase">Puan</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-indigo-700 uppercase">Süre</th>
                            </tr>
                        </thead>
                        <tbody id="submissionsTableBody" class="bg-white divide-y divide-gray-200">
                             <tr><td colspan="3" class="p-4 text-center">Yükleniyor...</td></tr>
                        </tbody>
                    </table>
                </div>
            `;
            document.getElementById('mainContentArea').innerHTML = teacherHtml;
            document.getElementById('teacherLogout').addEventListener('click', () => location.reload());
            
            // Sonuçları dinle
            const q = query(collection(db, "quiz_submissions"));
            onSnapshot(q, (snapshot) => {
                const subs = snapshot.docs.map(doc => doc.data()).sort((a,b) => parseFloat(b.score) - parseFloat(a.score));
                const tbody = document.getElementById('submissionsTableBody');
                if(tbody) {
                    tbody.innerHTML = subs.map(s => `
                        <tr>
                            <td class="px-4 py-2 text-sm font-medium">${s.name}</td>
                            <td class="px-4 py-2 text-sm font-bold text-indigo-600">${s.score}</td>
                            <td class="px-4 py-2 text-sm text-gray-500">${Math.floor(s.timeSpent/60)}dk</td>
                        </tr>
                    `).join('');
                }
            });
        }

        // --- YARDIMCI ARAÇLAR ---
        function showCustomConfirmation(message) {
            return new Promise(resolve => {
                const modal = document.getElementById('customModal');
                const content = document.getElementById('modalContent');
                content.innerHTML = `<p class="mb-4">${message}</p> <div class="flex justify-center gap-2"><button id="mYes" class="bg-green-600 text-white px-4 py-2 rounded">Evet</button><button id="mNo" class="bg-gray-300 px-4 py-2 rounded">Hayır</button></div>`;
                modal.classList.remove('hidden'); modal.classList.add('flex');
                document.getElementById('mYes').onclick = () => { modal.classList.add('hidden'); resolve(true); };
                document.getElementById('mNo').onclick = () => { modal.classList.add('hidden'); resolve(false); };
            });
        }
        
        function showCustomAlert(title, message) {
            return new Promise(resolve => {
                const modal = document.getElementById('customModal');
                document.getElementById('modalContent').innerHTML = `<h3 class="font-bold mb-2">${title}</h3><p class="mb-4">${message}</p><button id="mOk" class="bg-indigo-600 text-white px-4 py-2 rounded">Tamam</button>`;
                modal.classList.remove('hidden'); modal.classList.add('flex');
                document.getElementById('mOk').onclick = () => { modal.classList.add('hidden'); resolve(); };
            });
        }

        // --- GEÇİCİ YÖNETİCİ FONKSİYONU: Veritabanına Soruları Bas ---
        // Bunu sadece bir kere kullanın sonra butonu HTML'den silin.
        document.getElementById('adminUploadBtn').addEventListener('click', async () => {
            if(!confirm("Soruları veritabanına yüklemek istiyor musunuz? Bu işlem mevcut soruların üzerine yazar.")) return;
            
            const questionsToUpload = [        
              { "question": "Canlıları benzerlik, farklılık ve akrabalık derecelerine göre gruplara ayırma ilke ve ölçütlerini belirleyen bilim dalına ne ad verilir?", "options": ["Morfoloji", "Histoloji", "Biyokimya", "Taksonomi", "Fizyoloji"], "answer": "Taksonomi" },
              { "question": "Aşağıdakilerden hangisi, ortak özelliklere, genetik mirasa sahip olan ve birbirleriyle çiftleşip **verimli döl verebilen** canlılar grubu olarak tanımlanan sınıflandırmadaki temel kategoridir?", "options": ["Cins", "Aile", "Şube", "Âlem", "Tür"], "answer": "Tür" },
              { "question": "Günümüzde canlıların akrabalık ilişkilerine göre yapılan, morfolojik, anatomik ve genetik gibi birçok özelliğin dikkate alındığı sınıflandırma sistemi ne olarak adlandırılır?", "options": ["Yapısal Sınıflandırma", "Yapay Sınıflandırma", "Sistematik Sınıflandırma", "Doğal (Filogenetik) Sınıflandırma", "Ekolojik Sınıflandırma"], "answer": "Doğal (Filogenetik) Sınıflandırma" },
              { "question": "Türlerin isimlendirilmesinde kullanılan ikili (binominal) adlandırma yöntemini öneren İsveçli doğa bilimci aşağıdakilerden hangisidir?", "options": ["Aristoteles", "Galileo Galilei", "Carl Linneaus", "Charles Darwin", "Gregor Mendel"], "answer": "Carl Linneaus" },
              { "question": "Metinde verilen 'Fritillaria imperialis' tür adında, 'imperialis' kelimesi hangi görevi ifade eder?", "options": ["Cins Adı", "Aile Adı", "Tamamlayıcı Ad", "Takım Adı", "Tür Adı"], "answer": "Tamamlayıcı Ad" },
              { "question": "İkili adlandırma yöntemine göre, bir tür adının birinci kelimesi (Cins adı) ile ilgili doğru kural aşağıdakilerden hangisidir?", "options": ["Tamamen büyük harflerle yazılır.", "İlk harfi küçük yazılır.", "Akrabalık derecesini ifade eder.", "İlk harfi büyük yazılır.", "Tek başına türü ifade eder."], "answer": "İlk harfi büyük yazılır" },
              { "question": "Sınıflandırma bilimi, mikroorganizmaların doğru tanımlanması ve tehlike altındaki türlerin korunması gibi konulara katkı sağlayarak hangi iki alandaki araştırmaların temelini oluşturur?", "options": ["Ekonomi ve Hukuk", "Eğitim ve Kültür", "Sağlık ve Çevre Koruma", "Ulaşım ve İletişim", "Sanayi ve Tarım"], "answer": "Sağlık ve Çevre Koruma" },
              { "question": "Metinde bahsedilen taksonomik hiyerarşi sıralamasına göre, birbirine yakın türlerin bir araya gelmesiyle oluşan kategoriden başlayarak doğru sıralama (küçükten büyüğe) hangi seçenekte verilmiştir?", "options": ["Tür, Cins, Aile, Takım, Sınıf, Şube, Âlem", "Cins, Aile, Takım, Sınıf, Şube, Âlem", "Cins, Sınıf, Aile, Takım, Şube, Âlem", "Cins, Aile, Sınıf, Takım, Şube, Âlem", "Âlem, Şube, Sınıf, Takım, Aile, Cins"], "answer": "Cins, Aile, Takım, Sınıf, Şube, Âlem" },
              { "question": "Doğal (filogenetik) sınıflandırmada canlılar arasındaki akrabalık ilişkilerinin moleküler düzeyde belirlenmesine en önemli katkıyı sağlayan inceleme yöntemi aşağıdakilerden hangisidir?", "options": ["Morfolojik yapıların karşılaştırılması", "Yaşadıkları habitatların incelenmesi", "Fiziksel özelliklerin ölçülmesi", "Beslenme alışkanlıklarının gözlemlenmesi", "DNA ve RNA dizilerinin incelenmesi"], "answer": "DNA ve RNA dizilerinin incelenmesi" },
              { "question": "Aşağıdakilerden hangisi, taksonomi biliminin canlıları tanımlama çalışmalarında yararlandığı biyolojinin alt dalları arasında **sayılmamıştır**?", "options": ["Morfoloji", "Anatomi", "Histoloji", "Biyokimya", "Ekoloji"], "answer": "Ekoloji" }
            ];

            try {
                await setDoc(doc(db, "questions_pool", "biology_exam"), {
                    questions_list: questionsToUpload
                });
                alert("BAŞARILI: Sorular veritabanına yüklendi! Şimdi bu butonu koddan silin ve Firebase Kurallarından 'questions_pool' için 'write' iznini 'false' yapın.");
                location.reload();
            } catch (e) {
                alert("HATA: " + e.message);
            }
        });

        initializeFirebase();
    </script>
</body>
</html>
