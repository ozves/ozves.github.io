<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sƒ±nav Sistemi V6 (Full √ñzellik)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0;}
        .app-card { background-color:white;padding:2.5rem;border-radius:1.5rem;box-shadow:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05);max-width:450px;width:90%;transition:all .3s;position:relative;}
        .header-bg { background: linear-gradient(135deg,#4f46e5 0%,#818cf8 100%); color:white;padding:1rem 0;border-radius:1rem 1rem 0 0;margin:-2.5rem -2.5rem 1.5rem -2.5rem;text-align:center;}
        .button{transition:all .2s;box-shadow:0 4px 6px rgba(0,0,0,0.1)}
        .button:hover{transform:translateY(-1px);box-shadow:0 6px 10px rgba(0,0,0,0.15)}
        .teacher-mode { max-width: 1400px !important; width: 98% !important; } /* Panel Geni≈ületildi */
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body>

    <div id="app" class="app-card">
        <div id="loginHeader" class="header-bg">
            <h1 class="text-2xl font-extrabold">√ñƒürenci Giri≈üi</h1>
        </div>
        
        <div id="connectionStatus" class="hidden mb-4 text-xs font-bold text-center p-2 rounded border"></div>
        
        <div id="mainContentArea">
            <div id="loadingIndicator" class="text-center py-10">
                <svg class="animate-spin h-8 w-8 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p id="loadingText" class="text-sm text-gray-500 mt-4 font-bold">Sistem Ba≈ülatƒ±lƒ±yor...</p>
            </div>
        </div>
    </div>

    <div id="customModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center p-4 z-50">
        <div id="modalContent" class="bg-white rounded-xl p-6 max-w-3xl w-full text-center shadow-2xl overflow-y-auto max-h-[90vh]"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, serverTimestamp, query, where, getDocs, deleteDoc, getDoc, addDoc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyCHhFAHbWnclad6yFuI-Pw9gX6F_Dx1B2c",
            authDomain: "online-sinav-b3644.firebaseapp.com",
            projectId: "online-sinav-b3644",
            storageBucket: "online-sinav-b3644.firebasestorage.app",
            messagingSenderId: "965507531268",
            appId: "1:965507531268:web:94cfd13774a40b6cf16b51"
        };

        let db, auth;
        let isAuthReady = false, isDbConnected = false;

        // Varsayƒ±lan Deƒüerler
        let TEACHER_CODE = "123456"; 
        let EXAM_CODE = "TEST";
        let TEACHER_NAME = "Sistem Y√∂neticisi";
        let TIME_LIMIT_SECONDS = 600;
        let EXAM_DESC = "Sƒ±nav a√ßƒ±klamasƒ± y√ºklenemedi.";
        let quizQuestions = [];

        // Deƒüi≈ükenler
        let selectedAnswers = [], questionOrder = [], currentQuestionIndex = 0, resumeStartIndex = 0;
        let timerInterval = null, timeLeft = 0, isTeacherMode = false, studentData = {};
        let focusLossCount = 0, autoSaveInterval = null, currentSessionDocId = null;
        let allSubmissions = [];

        // ≈ûƒ±k Karƒ±≈ütƒ±rma
        function seededShuffle(array, seed) {
            let hash = 0;
            for (let i = 0; i < seed.length; i++) { hash = ((hash << 5) - hash) + seed.charCodeAt(i); hash |= 0; }
            const shuffled = [...array];
            let n = shuffled.length;
            while (n > 1) {
                hash = (hash * 9301 + 49297) % 233280;
                if (hash < 0) hash += 233280;
                let random = hash / 233280.0;
                let k = Math.floor(random * n);
                n--;
                [shuffled[n], shuffled[k]] = [shuffled[k], shuffled[n]];
            }
            return shuffled;
        }

        // --- BA≈ûLATMA ---
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await signInAnonymously(auth);
                onAuthStateChanged(auth, async (user) => {
                    if (user) { isAuthReady = true; await loadExamData(); }
                });
            } catch (error) { alert("Kritik Ba≈ülatma Hatasƒ±: " + error.message); }
        }

        async function loadExamData() {
            const statusDiv = document.getElementById('connectionStatus');
            try {
                const configSnap = await getDoc(doc(db, "exam_settings", "config"));
                if (configSnap.exists()) {
                    isDbConnected = true;
                    const data = configSnap.data();
                    TEACHER_CODE = data.teacher_code || TEACHER_CODE;
                    EXAM_CODE = data.exam_code || EXAM_CODE;
                    TEACHER_NAME = data.teacher_name || TEACHER_NAME;
                    TIME_LIMIT_SECONDS = data.time_limit || TIME_LIMIT_SECONDS;
                    EXAM_DESC = data.exam_description || EXAM_DESC;
                    statusDiv.innerHTML = "üü¢ Veritabanƒ± Baƒülƒ± (Canlƒ± Mod)";
                    statusDiv.className = "mb-4 text-xs font-bold text-center p-2 rounded border bg-green-100 text-green-800 border-green-300";
                    statusDiv.classList.remove('hidden');
                } else {
                    throw new Error("Veritabanƒ± bo≈ü");
                }
                const questionsSnap = await getDoc(doc(db, "questions_pool", "biology_exam"));
                if (questionsSnap.exists()) quizQuestions = questionsSnap.data().questions_list || [];
            } catch(e) {
                isDbConnected = false;
                statusDiv.innerHTML = `üî¥ BAƒûLANTI YOK - Varsayƒ±lan Moddasƒ±nƒ±z<br><span class='text-[10px] font-normal'>${e.message}</span>`;
                statusDiv.className = "mb-4 text-xs font-bold text-center p-2 rounded border bg-red-100 text-red-800 border-red-300";
                statusDiv.classList.remove('hidden');
            }
            document.getElementById('loadingIndicator').classList.add('hidden');
            showLoginForm();
        }

        // --- Gƒ∞Rƒ∞≈û EKRANI ---
        function showLoginForm() {
            if (!isAuthReady) return;
            document.getElementById('app').className = 'app-card max-w-md';
            document.getElementById('loginHeader').innerHTML = '<h1 class="text-2xl font-extrabold">√ñƒürenci Giri≈üi</h1>';
            const timeInMinutes = Math.floor(TIME_LIMIT_SECONDS / 60);
            
            document.getElementById('mainContentArea').innerHTML = `
                <div class="space-y-4">
                    <div class="text-center p-2 bg-indigo-50 rounded-lg border border-indigo-100">
                        <p class="text-xs text-gray-500">√ñƒüretmen</p>
                        <p class="font-bold text-indigo-700">${TEACHER_NAME}</p>
                    </div>
                    <div class="bg-yellow-50 border border-yellow-200 p-3 rounded-lg text-sm text-yellow-800">
                        <p class="font-bold mb-1">‚ö†Ô∏è Sƒ±nav Bilgisi:</p>
                        <p class="mb-2">${EXAM_DESC}</p>
                        <p class="font-semibold">S√ºre: ${timeInMinutes} Dakika</p>
                    </div>
                    <input id="examCodeInput" type="text" placeholder="Sƒ±nav Kodu (√ñrn: ${EXAM_CODE})" class="w-full p-3 border rounded-lg uppercase">
                    <input id="nameInput" type="text" placeholder="Ad Soyad" class="w-full p-3 border rounded-lg">
                    <input id="numberInput" type="number" placeholder="Okul No" class="w-full p-3 border rounded-lg">
                    <input id="classInput" type="text" placeholder="Sƒ±nƒ±f (√ñrn: 10A)" class="w-full p-3 border rounded-lg">
                    <button id="startQuizButton" class="button w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg">Sƒ±nava Ba≈üla</button>
                    <button id="teacherLoginButton" class="button w-full bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm py-2 rounded-lg">√ñƒüretmen Giri≈üi</button>
                </div>
            `;
            document.getElementById('startQuizButton').onclick = handleStudentLogin;
            document.getElementById('teacherLoginButton').onclick = showTeacherLogin;
        }

        async function handleStudentLogin() {
            if(!isDbConnected && !confirm("UYARI: Veritabanƒ± baƒülantƒ±sƒ± yok. Devam etmek istiyor musunuz?")) return;
            const name = document.getElementById('nameInput').value.trim();
            const number = document.getElementById('numberInput').value.trim();
            const className = document.getElementById('classInput').value.trim();
            const code = document.getElementById('examCodeInput').value.trim().toUpperCase();

            if (!name || !number || !className || !code) return alert("L√ºtfen t√ºm alanlarƒ± doldurun.");
            if (code !== EXAM_CODE) return alert(`Hatalƒ± Sƒ±nav Kodu!`);
            if (quizQuestions.length === 0) return alert("Sƒ±navda hi√ß soru yok!");

            studentData = { name, number, className, examCode: code };
            const studentKey = `${code}_${number}`;

            try {
                if(isDbConnected) {
                    const qSub = query(collection(db, "quiz_submissions"), where("studentKey", "==", studentKey));
                    const subSnap = await getDocs(qSub);
                    if (!subSnap.empty) return alert(`Bu sƒ±navƒ± zaten tamamladƒ±nƒ±z.`);

                    const qSes = query(collection(db, "active_sessions"), where("studentKey", "==", studentKey));
                    const sesSnap = await getDocs(qSes);
                    if (!sesSnap.empty) {
                        alert("Kaldƒ±ƒüƒ±nƒ±z yerden devam ediyorsunuz.");
                        restoreSession({ id: sesSnap.docs[0].id, ...sesSnap.docs[0].data() });
                    } else startNewSession(number);
                } else startNewSession(number);
                showQuiz();
            } catch (e) { alert("Giri≈ü hatasƒ±: " + e.message); }
        }

        function restoreSession(session) {
            questionOrder = session.questionOrder || [];
            selectedAnswers = session.selectedAnswers || [];
            currentQuestionIndex = session.currentQuestionIndex || 0;
            timeLeft = session.timeLeft || TIME_LIMIT_SECONDS;
            focusLossCount = session.focusLossCount || 0;
            currentSessionDocId = session.id;
            resumeStartIndex = currentQuestionIndex;
        }

        function startNewSession(number) {
            questionOrder = seededShuffle(Array.from({length: quizQuestions.length}, (_, i) => i), number);
            selectedAnswers = Array(quizQuestions.length).fill(null);
            currentQuestionIndex = 0;
            resumeStartIndex = 0;
            timeLeft = TIME_LIMIT_SECONDS;
            currentSessionDocId = null;
        }

        // --- SINAV EKRANI ---
        function showQuiz() {
            document.getElementById('connectionStatus').classList.add('hidden');
            document.getElementById('app').className = 'app-card max-w-3xl';
            document.getElementById('loginHeader').innerHTML = `<h1 class="text-xl font-bold">${studentData.name}</h1>`;
            
            document.getElementById('mainContentArea').innerHTML = `
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <span class="font-bold text-indigo-600">Soru: <span id="qCount"></span></span>
                    <div id="timerDisplay" class="text-xl font-bold text-red-600 bg-red-100 p-1 px-3 rounded">--:--</div>
                </div>
                <div id="questionArea" class="min-h-[250px]"></div>
                <div id="focusWarn" class="hidden mt-4 p-2 bg-yellow-100 text-yellow-800 text-sm font-bold text-center rounded"></div>
                <div class="mt-6 flex justify-between">
                    <button id="prevBtn" class="button bg-gray-500 text-white py-2 px-4 rounded" disabled>√ñnceki</button>
                    <button id="nextBtn" class="button bg-indigo-600 text-white py-2 px-4 rounded">Sonraki</button>
                </div>
            `;
            renderQuestion(currentQuestionIndex);
            startTimer();
            setupFocusCheck();
            startAutoSave();

            document.getElementById('prevBtn').onclick = () => {
                if (currentQuestionIndex > resumeStartIndex) { currentQuestionIndex--; renderQuestion(currentQuestionIndex); }
            };
            document.getElementById('nextBtn').onclick = () => {
                if (currentQuestionIndex < quizQuestions.length - 1) {
                    currentQuestionIndex++; renderQuestion(currentQuestionIndex); saveProgress();
                } else finishQuiz();
            };
        }

        function renderQuestion(idx) {
            const realIdx = questionOrder[idx];
            const q = quizQuestions[realIdx];
            if(!q) return;
            const shuffledOpts = seededShuffle(q.options, studentData.number + 'opt' + realIdx);
            const currAns = selectedAnswers[realIdx];
            const imageHtml = q.image ? `<div class="mb-4 flex justify-center"><img src="${q.image}" class="max-h-64 rounded-lg shadow border"></div>` : '';

            document.getElementById('questionArea').innerHTML = `
                <div class="font-semibold text-lg text-gray-800 mb-4">Soru ${idx + 1}: ${q.question}</div>
                ${imageHtml}
                <div class="space-y-2">
                    ${shuffledOpts.map(opt => `
                        <label class="flex items-center p-3 border rounded cursor-pointer hover:bg-indigo-50 ${currAns === opt ? 'bg-indigo-100 border-indigo-500' : ''}">
                            <input type="radio" name="opt" value="${opt}" class="mr-3" ${currAns === opt ? 'checked' : ''}>
                            ${opt}
                        </label>
                    `).join('')}
                </div>
            `;
            document.getElementById('qCount').innerText = `${idx + 1} / ${quizQuestions.length}`;
            document.querySelectorAll('input[name="opt"]').forEach(el => {
                el.onchange = (e) => { selectedAnswers[realIdx] = e.target.value; renderQuestion(idx); saveProgress(); };
            });
            document.getElementById('prevBtn').disabled = idx <= resumeStartIndex;
            const nextBtn = document.getElementById('nextBtn');
            if (idx === quizQuestions.length - 1) {
                nextBtn.innerText = "Bƒ∞Tƒ∞R VE G√ñNDER";
                nextBtn.className = "button bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded";
            } else {
                nextBtn.innerText = "Sonraki";
                nextBtn.className = "button bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded";
            }
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                const m = Math.floor(timeLeft / 60), s = timeLeft % 60;
                document.getElementById('timerDisplay').innerText = `${m}:${s < 10 ? '0'+s : s}`;
                if (timeLeft <= 0) { clearInterval(timerInterval); finishQuiz(true); }
            }, 1000);
        }

        function setupFocusCheck() {
            window.onblur = () => {
                if (!isTeacherMode) {
                    focusLossCount++;
                    const w = document.getElementById('focusWarn');
                    if(w) { w.classList.remove('hidden'); w.innerText = `UYARI: Ekrandan ${focusLossCount} kez ayrƒ±ldƒ±nƒ±z!`; }
                    saveProgress();
                }
            };
        }

        async function startAutoSave() {
            saveProgress();
            autoSaveInterval = setInterval(saveProgress, 10000);
        }

        async function saveProgress() {
            if (isTeacherMode || !isDbConnected || !db) return;
            const data = {
                ...studentData, studentKey: `${studentData.examCode}_${studentData.number}`,
                questionOrder, selectedAnswers, currentQuestionIndex, timeLeft, focusLossCount,
                lastUpdated: serverTimestamp()
            };
            try {
                if (currentSessionDocId) await updateDoc(doc(db, "active_sessions", currentSessionDocId), data);
                else { const ref = await addDoc(collection(db, "active_sessions"), data); currentSessionDocId = ref.id; }
            } catch(e) {}
        }

        async function finishQuiz(force = false) {
            clearInterval(timerInterval); clearInterval(autoSaveInterval); window.onblur = null;
            if (!force && !confirm("Sƒ±navƒ± bitirmek istediƒüinize emin misiniz?")) { startTimer(); setupFocusCheck(); return; }

            document.getElementById('mainContentArea').innerHTML = `<div class="text-center py-10 font-bold text-gray-600">Sonu√ßlar i≈üleniyor...</div>`;
            
            let c = 0, i = 0, e = 0;
            quizQuestions.forEach((q, idx) => {
                const ans = selectedAnswers[idx];
                if (!ans) e++; else if (ans === q.answer) c++; else i++;
            });
            const score = (c * 100 / quizQuestions.length).toFixed(2);

            let ip = "Bilinmiyor";
            try { const r = await fetch('https://api.ipify.org?format=json'); const d = await r.json(); ip = d.ip; } catch(err){}

            const finalData = {
                ...studentData, studentKey: `${studentData.examCode}_${studentData.number}`,
                score, correct: c, incorrect: i, empty: e, timeSpent: TIME_LIMIT_SECONDS - timeLeft,
                timestamp: serverTimestamp(), focusLossCount, ipAddress: ip, questionOrder, allAnswers: selectedAnswers
            };

            if(isDbConnected) {
                try {
                    await addDoc(collection(db, "quiz_submissions"), finalData);
                    if (currentSessionDocId) await deleteDoc(doc(db, "active_sessions", currentSessionDocId));
                } catch(e) { alert("Kaydetme hatasƒ±: " + e.message); }
            }
            showResult(finalData);
        }

        async function showResult(data) {
            document.getElementById('app').className = 'app-card max-w-md';
            document.getElementById('loginHeader').innerHTML = '<h1 class="text-2xl font-bold">Sƒ±nav Bitti</h1>';
            let rankMsg = isDbConnected ? "Sƒ±ralama y√ºkleniyor..." : "√áevrimdƒ±≈üƒ± modda sƒ±ralama g√∂r√ºlemez.";
            let history = [];

            if(isDbConnected) {
                try {
                    const q = query(collection(db, "quiz_submissions"), where("examCode", "==", data.examCode));
                    const snap = await getDocs(q);
                    const scores = snap.docs.map(d => parseFloat(d.data().score)).sort((a,b) => b-a);
                    const rank = scores.indexOf(parseFloat(data.score)) + 1;
                    rankMsg = `${scores.length} ki≈üi arasƒ±ndan ${rank}. oldunuz.`;
                    const hSnap = await getDocs(query(collection(db, "quiz_submissions"), where("number", "==", String(data.number))));
                    history = hSnap.docs.map(d => d.data()).sort((a,b) => (a.timestamp?.seconds||0) - (b.timestamp?.seconds||0));
                } catch(e) { rankMsg = "Sƒ±ralama alƒ±namadƒ±."; }
            }

            document.getElementById('mainContentArea').innerHTML = `
                <div class="text-center">
                    <div class="text-4xl font-extrabold text-indigo-600 mb-2">${data.score}</div>
                    <p class="text-gray-600 font-semibold mb-4">Puan</p>
                    <div class="grid grid-cols-3 gap-2 text-sm mb-4">
                        <div class="bg-green-100 p-2 rounded text-green-800">D: ${data.correct}</div>
                        <div class="bg-red-100 p-2 rounded text-red-800">Y: ${data.incorrect}</div>
                        <div class="bg-gray-100 p-2 rounded text-gray-800">B: ${data.empty}</div>
                    </div>
                    <div class="bg-yellow-50 p-3 rounded text-yellow-800 mb-4 font-medium">${rankMsg}</div>
                    <canvas id="resChart" class="mb-4"></canvas>
                    <button onclick="location.reload()" class="button bg-gray-800 text-white py-2 px-6 rounded">√áƒ±kƒ±≈ü</button>
                </div>
            `;
            if(history.length > 0) {
                new Chart(document.getElementById('resChart'), {
                    type: 'line',
                    data: { labels: history.map(h => h.examCode), datasets: [{ label: 'Geli≈üim', data: history.map(h => h.score), borderColor: '#4f46e5', tension: 0.1 }] }
                });
            }
        }

        // --- √ñƒûRETMEN PANELƒ∞ (FULL VERSƒ∞YON) ---
        function showTeacherLogin() {
            document.getElementById('mainContentArea').innerHTML = `
                <div class="space-y-4">
                    <h3 class="text-center font-bold">Y√∂netici Giri≈üi</h3>
                    <div class="text-center text-xs mb-2 ${isDbConnected ? 'text-green-600':'text-red-600 font-bold'}">
                        ${isDbConnected ? 'Veritabanƒ± Aktif' : 'Veritabanƒ± Baƒülƒ± Deƒüil!'}
                    </div>
                    <input id="pass" type="password" placeholder="≈ûifre" class="w-full p-3 border rounded">
                    <button id="login" class="button bg-red-600 text-white w-full py-3 rounded">Giri≈ü</button>
                    <button onclick="location.reload()" class="button bg-gray-200 w-full py-2 rounded">Geri</button>
                </div>
            `;
            document.getElementById('login').onclick = () => {
                if (document.getElementById('pass').value === TEACHER_CODE) {
                    isTeacherMode = true;
                    showDashboard();
                } else alert("Hatalƒ± ≈üifre!");
            }
        }

        function showDashboard() {
            if(!isDbConnected) return alert("Veritabanƒ± baƒülƒ± deƒüil.");
            document.getElementById('connectionStatus').classList.add('hidden');
            document.getElementById('app').className = 'app-card teacher-mode';
            document.getElementById('loginHeader').innerHTML = '<h1 class="text-2xl font-bold">Y√∂netim Paneli</h1>';

            const dashboard = `
                <div class="flex gap-2 mb-4 border-b pb-2 overflow-x-auto">
                    <button onclick="changeTab('results')" class="px-4 py-2 bg-indigo-600 text-white rounded text-sm">Sonu√ßlar</button>
                    <button onclick="changeTab('settings')" class="px-4 py-2 bg-gray-600 text-white rounded text-sm">Ayarlar</button>
                    <button onclick="changeTab('questions')" class="px-4 py-2 bg-orange-600 text-white rounded text-sm">Sorular</button>
                    <button onclick="location.reload()" class="px-4 py-2 bg-red-600 text-white rounded text-sm ml-auto">√áƒ±kƒ±≈ü</button>
                </div>
                
                <div id="tab-results" class="tab-content">
                    <div id="statsArea" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 text-center"></div>

                    <div class="flex flex-wrap gap-2 mb-4 items-center bg-gray-50 p-3 rounded border">
                        <input id="fCode" placeholder="Sƒ±nav Kodu" class="p-2 border rounded text-sm w-32">
                        <input id="fClass" placeholder="Sƒ±nƒ±f" class="p-2 border rounded text-sm w-24">
                        <input id="fName" placeholder="Ad Soyad" class="p-2 border rounded text-sm w-32">
                        <button id="btnExport" class="bg-green-600 text-white px-3 py-2 rounded text-sm shadow">Excel ƒ∞ndir</button>
                        <button id="btnDel" class="bg-red-600 text-white px-3 py-2 rounded text-sm shadow">Se√ßilenleri Sil</button>
                    </div>

                    <div class="overflow-x-auto border rounded max-h-[600px] overflow-y-auto shadow">
                        <table class="min-w-full divide-y divide-gray-200 text-sm">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="p-3 text-left"><input type="checkbox" id="selectAll"></th>
                                    <th class="p-3 text-left font-bold text-gray-600">Sƒ±nƒ±f/No</th>
                                    <th class="p-3 text-left font-bold text-gray-600">Ad Soyad</th>
                                    <th class="p-3 text-left font-bold text-gray-600">Kod</th>
                                    <th class="p-3 text-left font-bold text-gray-600">Puan</th>
                                    <th class="p-3 text-left font-bold text-gray-600">D/Y/B</th>
                                    <th class="p-3 text-left font-bold text-gray-600">S√ºre</th>
                                    <th class="p-3 text-left font-bold text-gray-600">IP Adresi</th>
                                    <th class="p-3 text-left font-bold text-gray-600">Tarih</th>
                                    <th class="p-3 text-left font-bold text-gray-600">ƒ∞≈ülem</th>
                                </tr>
                            </thead>
                            <tbody id="resTable" class="bg-white divide-y"></tbody>
                        </table>
                    </div>
                </div>

                <div id="tab-settings" class="tab-content hidden">
                    <div class="space-y-4 max-w-lg mx-auto bg-gray-50 p-6 rounded border">
                        <h3 class="font-bold text-lg">Sƒ±nav Ayarlarƒ±</h3>
                        <div><label class="text-xs font-bold">√ñƒüretmen Adƒ±</label><input id="setTeacher" class="w-full p-2 border rounded"></div>
                        <div><label class="text-xs font-bold">Sƒ±nav Kodu</label><input id="setCode" class="w-full p-2 border rounded uppercase"></div>
                        <div><label class="text-xs font-bold">√ñƒüretmen ≈ûifresi</label><input id="setPass" class="w-full p-2 border rounded"></div>
                        <div><label class="text-xs font-bold">S√ºre (Dakika)</label><input id="setTime" type="number" class="w-full p-2 border rounded"></div>
                        <div><label class="text-xs font-bold">A√ßƒ±klama</label><textarea id="setDesc" rows="3" class="w-full p-2 border rounded"></textarea></div>
                        <button id="saveSettingsBtn" class="w-full bg-indigo-600 text-white py-3 rounded font-bold shadow">KAYDET</button>
                    </div>
                </div>

                <div id="tab-questions" class="tab-content hidden">
                    <div class="space-y-4">
                        <textarea id="jsonInput" rows="15" class="w-full p-3 font-mono text-xs border rounded bg-gray-800 text-green-400" placeholder="Sorularƒ± buraya yapƒ±≈ütƒ±rƒ±n..."></textarea>
                        <div class="flex gap-2">
                            <button id="loadSampleBtn" class="bg-gray-500 text-white px-4 py-2 rounded">√ñrnek Format</button>
                            <button id="uploadQuestionsBtn" class="bg-orange-600 text-white px-4 py-2 rounded font-bold flex-grow shadow">SORULARI G√úNCELLE</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('mainContentArea').innerHTML = dashboard;
            
            window.changeTab = (t) => { document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden')); document.getElementById('tab-'+t).classList.remove('hidden'); };
            
            // Ayarlarƒ± Doldur
            document.getElementById('setTeacher').value = TEACHER_NAME;
            document.getElementById('setCode').value = EXAM_CODE;
            document.getElementById('setPass').value = TEACHER_CODE;
            document.getElementById('setTime').value = Math.floor(TIME_LIMIT_SECONDS/60);
            document.getElementById('setDesc').value = EXAM_DESC;

            document.getElementById('saveSettingsBtn').onclick = async () => {
                try {
                    await updateDoc(doc(db, "exam_settings", "config"), {
                        teacher_name: document.getElementById('setTeacher').value,
                        exam_code: document.getElementById('setCode').value,
                        teacher_code: document.getElementById('setPass').value,
                        time_limit: parseInt(document.getElementById('setTime').value)*60,
                        exam_description: document.getElementById('setDesc').value
                    });
                    alert("Kaydedildi!"); location.reload();
                } catch(e) { alert("Hata: " + e.message); }
            };

            document.getElementById('loadSampleBtn').onclick = () => {
                document.getElementById('jsonInput').value = `[
  { "question": "Soru?", "options": ["A","B"], "answer": "A" },
  { "question": "Resimli?", "image": "https://link.com/img.jpg", "options": ["X","Y"], "answer": "X" }
]`;
            };

            document.getElementById('uploadQuestionsBtn').onclick = async () => {
                try {
                    const parsed = JSON.parse(document.getElementById('jsonInput').value);
                    if(!Array.isArray(parsed)) throw new Error("Liste [...] formatƒ±nda olmalƒ±");
                    if(confirm("Sorular g√ºncellensin mi?")) {
                        await setDoc(doc(db, "questions_pool", "biology_exam"), { questions_list: parsed });
                        alert("G√ºncellendi!"); location.reload();
                    }
                } catch(e) { alert("Format Hatasƒ±: " + e.message); }
            };

            setupResultsTable();
        }

        function setupResultsTable() {
            const tbody = document.getElementById('resTable');
            const statsArea = document.getElementById('statsArea');

            const render = () => {
                const fCode = (document.getElementById('fCode')?.value||'').toLowerCase();
                const fClass = (document.getElementById('fClass')?.value||'').toLowerCase();
                const fName = (document.getElementById('fName')?.value||'').toLowerCase();
                
                const filtered = allSubmissions.filter(s => 
                    (s.examCode||'').toLowerCase().includes(fCode) && 
                    (s.className||'').toLowerCase().includes(fClass) &&
                    (s.name||'').toLowerCase().includes(fName)
                );

                // ƒ∞statistikleri Hesapla
                const classStats = {};
                filtered.forEach(s => {
                    const cls = s.className || "Belirsiz";
                    if(!classStats[cls]) classStats[cls] = { count:0, sum:0 };
                    classStats[cls].count++;
                    classStats[cls].sum += parseFloat(s.score);
                });

                let statsHtml = `
                    <div class="bg-indigo-100 p-3 rounded border border-indigo-200">
                        <p class="text-xs text-indigo-800 font-bold">Toplam</p>
                        <p class="text-2xl font-extrabold text-indigo-900">${filtered.length}</p>
                    </div>
                `;
                Object.keys(classStats).forEach(cls => {
                    const avg = (classStats[cls].sum / classStats[cls].count).toFixed(1);
                    statsHtml += `
                        <div class="bg-white p-3 rounded border shadow-sm">
                            <p class="text-xs text-gray-500 font-bold">${cls} Ort.</p>
                            <p class="text-xl font-bold text-gray-800">${avg}</p>
                        </div>
                    `;
                });
                statsArea.innerHTML = statsHtml;

                // Tabloyu Doldur
                tbody.innerHTML = filtered.map(s => {
                    const date = s.timestamp ? new Date(s.timestamp.seconds*1000).toLocaleString('tr-TR') : '-';
                    const mins = Math.floor((s.timeSpent||0)/60);
                    return `
                        <tr class="hover:bg-gray-50">
                            <td class="p-3"><input type="checkbox" class="selRow" value="${s.id}"></td>
                            <td class="p-3">${s.className} / ${s.number}</td>
                            <td class="p-3 font-medium">${s.name}</td>
                            <td class="p-3">${s.examCode}</td>
                            <td class="p-3 font-bold ${parseFloat(s.score)>=50?'text-green-600':'text-red-600'}">${s.score}</td>
                            <td class="p-3 text-xs">${s.correct}D / ${s.incorrect}Y / ${s.empty}B</td>
                            <td class="p-3 text-xs text-gray-500">${mins} dk</td>
                            <td class="p-3 text-xs font-mono bg-gray-50 rounded">${s.ipAddress || '-'}</td>
                            <td class="p-3 text-xs text-gray-500">${date}</td>
                            <td class="p-3 flex gap-2">
                                <button onclick="showGraph('${s.number}','${s.name}')" class="text-blue-600 text-xs hover:underline font-bold">Grafik</button>
                                <button onclick="delSub('${s.id}')" class="text-red-600 text-xs hover:underline">Sil</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            };

            onSnapshot(query(collection(db, "quiz_submissions")), (snap) => {
                allSubmissions = snap.docs.map(d => ({id:d.id, ...d.data()})).sort((a,b) => (b.timestamp?.seconds||0)-(a.timestamp?.seconds||0));
                render();
            });

            document.getElementById('fCode').oninput = render;
            document.getElementById('fClass').oninput = render;
            document.getElementById('fName').oninput = render;
            
            document.getElementById('selectAll').onclick = (e) => document.querySelectorAll('.selRow').forEach(c => c.checked = e.target.checked);
            
            document.getElementById('btnDel').onclick = async () => {
                const ids = Array.from(document.querySelectorAll('.selRow:checked')).map(c=>c.value);
                if(ids.length && confirm(`${ids.length} kayƒ±t silinsin mi?`)) ids.forEach(id => deleteDoc(doc(db, "quiz_submissions", id)));
            };

            document.getElementById('btnExport').onclick = () => {
                const fCode = (document.getElementById('fCode')?.value||'').toLowerCase();
                const fClass = (document.getElementById('fClass')?.value||'').toLowerCase();
                const fName = (document.getElementById('fName')?.value||'').toLowerCase();
                const filtered = allSubmissions.filter(s => (s.examCode||'').toLowerCase().includes(fCode) && (s.className||'').toLowerCase().includes(fClass) && (s.name||'').toLowerCase().includes(fName));
                
                let csv = "\uFEFFSinif,No,Ad Soyad,Kod,Puan,Dogru,Yanlis,Bos,Sure(dk),IP,Tarih\n";
                filtered.forEach(s => {
                    csv += `${s.className},${s.number},"${s.name}",${s.examCode},${s.score},${s.correct},${s.incorrect},${s.empty},${Math.floor((s.timeSpent||0)/60)},${s.ipAddress},"${new Date(s.timestamp?.seconds*1000).toLocaleString()}"\n`;
                });
                const link = document.createElement("a");
                link.href = encodeURI("data:text/csv;charset=utf-8," + csv);
                link.download = "sonuclar_detayli.csv";
                link.click();
            };

            window.delSub = async (id) => { if(confirm("Silinsin mi?")) await deleteDoc(doc(db, "quiz_submissions", id)); };
            
            window.showGraph = async (num, name) => {
                const hSnap = await getDocs(query(collection(db, "quiz_submissions"), where("number", "==", String(num))));
                const history = hSnap.docs.map(d => d.data()).sort((a,b) => (a.timestamp?.seconds||0)-(b.timestamp?.seconds||0));
                
                const modal = document.getElementById('customModal');
                document.getElementById('modalContent').innerHTML = `
                    <h3 class="text-lg font-bold mb-4">${name} - Geli≈üim</h3>
                    <canvas id="modalChart"></canvas>
                    <button onclick="document.getElementById('customModal').classList.add('hidden')" class="mt-4 bg-gray-200 px-4 py-2 rounded">Kapat</button>
                `;
                modal.classList.remove('hidden');
                new Chart(document.getElementById('modalChart'), {
                    type: 'line',
                    data: { labels: history.map(h => h.examCode), datasets: [{ label: 'Puan', data: history.map(h => h.score), borderColor: '#4f46e5', tension: 0.1 }] }
                });
            };
        }

        initializeFirebase();
    </script>
</body>
</html>
