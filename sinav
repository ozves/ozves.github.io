<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sƒ±nav Sistemi V14 (Full √ñzellikli)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0;}
        .app-card { background-color:white;padding:2.5rem;border-radius:1.5rem;box-shadow:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05);max-width:450px;width:90%;transition:all .3s;position:relative;}
        .header-bg { background: linear-gradient(135deg,#4f46e5 0%,#818cf8 100%); color:white;padding:1rem 0;border-radius:1rem 1rem 0 0;margin:-2.5rem -2.5rem 1.5rem -2.5rem;text-align:center;}
        .button{transition:all .2s;box-shadow:0 4px 6px rgba(0,0,0,0.1)}
        .button:hover{transform:translateY(-1px);box-shadow:0 6px 10px rgba(0,0,0,0.15)}
        .teacher-mode { max-width: 1400px !important; width: 98% !important; } 
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body>

    <div id="app" class="app-card">
        <div id="loginHeader" class="header-bg">
            <h1 class="text-2xl font-extrabold">√ñƒürenci Giri≈üi</h1>
        </div>
        
        <div id="connectionStatus" class="hidden mb-4 text-xs font-bold text-center p-2 rounded border"></div>
        
        <div id="mainContentArea">
            <div id="loadingIndicator" class="text-center py-10">
                <div class="loader"></div>
                <p class="text-sm text-gray-500 mt-4 font-bold">Sistem Ba≈ülatƒ±lƒ±yor...</p>
            </div>
        </div>
    </div>

    <div id="customModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center p-4 z-50">
        <div id="modalContent" class="bg-white rounded-xl p-6 max-w-4xl w-full text-center shadow-2xl overflow-y-auto max-h-[90vh] relative">
            <button id="modalCloseX" class="absolute top-4 right-4 text-gray-500 hover:text-red-600 font-bold text-xl">&times;</button>
            <div id="modalBody"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, serverTimestamp, query, where, getDocs, deleteDoc, getDoc, addDoc, updateDoc, setDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCHhFAHbWnclad6yFuI-Pw9gX6F_Dx1B2c",
            authDomain: "online-sinav-b3644.firebaseapp.com",
            projectId: "online-sinav-b3644",
            storageBucket: "online-sinav-b3644.firebasestorage.app",
            messagingSenderId: "965507531268",
            appId: "1:965507531268:web:94cfd13774a40b6cf16b51"
        };

        let db, auth;
        let isDbConnected = false;
        let adminMasterCode = null; 
        let systemPreparerName = "Sistem Y√∂neticisi"; // Varsayƒ±lan

        let currentExamConfig = {
            exam_code: "DEFAULT",
            teacher_name: "Sistem",
            time_limit: 600,
            exam_description: "..."
        };
        
        let quizQuestions = []; 
        let studentList = [];
        let studentData = {};
        let selectedAnswers = [], questionOrder = [], currentQuestionIndex = 0;
        let focusLossCount = 0;
        let timerInterval = null, autoSaveInterval = null, examendTimeStamp = null;
        let currentSessionDocId = null;
        let isTeacherMode = false;
        let allSubmissions = [];

        // --- BA≈ûLATMA ---
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await signInAnonymously(auth);
                onAuthStateChanged(auth, async (user) => {
                    if (user) await checkConnectivity();
                });
            } catch (error) { alert("Ba≈ülatma Hatasƒ±: " + error.message); }
        }

        async function checkConnectivity() {
            const statusDiv = document.getElementById('connectionStatus');
            try {
                const adminSnap = await getDoc(doc(db, "exam_settings", "admin_config"));
                if (adminSnap.exists()) {
                    const data = adminSnap.data();
                    adminMasterCode = data.master_code; 
                    // 4. ƒ∞STEK: Ayarlardan gelen global √∂ƒüretmen adƒ±
                    systemPreparerName = data.preparer_name || "Sistem Y√∂neticisi";
                    
                    isDbConnected = true;
                    statusDiv.innerHTML = "üü¢ Sistem √áevrimi√ßi";
                    statusDiv.className = "mb-4 text-xs font-bold text-center p-2 rounded border bg-green-100 text-green-800 border-green-300";
                } else throw new Error("Admin ayarƒ± yok");
            } catch(e) {
                isDbConnected = false;
                statusDiv.innerHTML = `üî¥ BAƒûLANTI YOK - ${e.message}`;
                statusDiv.className = "mb-4 text-xs font-bold text-center p-2 rounded border bg-red-100 text-red-800 border-red-300";
            }
            statusDiv.classList.remove('hidden');
            document.getElementById('loadingIndicator').classList.add('hidden');
            showLoginForm();
        }

        function resetApp() {
            clearInterval(timerInterval); clearInterval(autoSaveInterval); window.onblur = null;
            document.getElementById('app').className = 'app-card max-w-md';
            showLoginForm();
        }

        // --- Gƒ∞Rƒ∞≈û EKRANI ---
        function showLoginForm() {
            document.getElementById('loginHeader').innerHTML = '<h1 class="text-2xl font-extrabold">√ñƒürenci Giri≈üi</h1>';
            document.getElementById('mainContentArea').innerHTML = `
                <div class="space-y-4">
                    <div class="text-center p-2 bg-indigo-50 rounded-lg border border-indigo-100">
                        <p class="text-xs text-gray-500">Sistem Sorumlusu</p>
                        <p class="font-bold text-indigo-700">${systemPreparerName}</p>
                    </div>
                    
                    <div id="examInfoArea" class="hidden bg-yellow-50 border border-yellow-200 p-3 rounded-lg text-sm text-yellow-800"></div>
                    
                    <input id="examCodeInput" type="text" placeholder="SINAV KODU Gƒ∞Rƒ∞N" class="w-full p-3 border rounded-lg uppercase font-bold text-center tracking-widest">
                    
                    <div id="studentLoginFields" class="space-y-4"><p class="text-xs text-center text-gray-400">Liste y√ºklenmesi i√ßin kod giriniz.</p></div>
                    <button id="startQuizButton" class="button w-full bg-indigo-600 text-white font-bold py-3 rounded-lg opacity-50" disabled>Sƒ±nava Ba≈üla</button>
                    <div class="text-center pt-4"><button id="teacherLoginButton" class="text-xs text-gray-400 hover:text-gray-600">Y√∂netici Giri≈üi</button></div>
                </div>
            `;

            document.getElementById('teacherLoginButton').onclick = showTeacherLogin;
            document.getElementById('startQuizButton').onclick = handleStudentLogin;
            
            let typingTimer;
            document.getElementById('examCodeInput').oninput = (e) => {
                clearTimeout(typingTimer);
                const code = e.target.value.trim().toUpperCase();
                if(code.length < 3) return;
                typingTimer = setTimeout(() => loadExamMetadata(code), 600);
            };
        }

        async function loadExamMetadata(code) {
            if(!isDbConnected) return;
            const infoArea = document.getElementById('examInfoArea');
            const loginFields = document.getElementById('studentLoginFields');
            
            infoArea.innerHTML = '<div class="loader w-4 h-4 border-2"></div>'; infoArea.classList.remove('hidden');

            try {
                // Sƒ±nav Ayarlarƒ±nƒ± √áek
                const configSnap = await getDoc(doc(db, "exam_settings", code));
                if(configSnap.exists()) {
                    const conf = configSnap.data();
                    currentExamConfig = { exam_code: code, ...conf };
                    
                    // 4. ƒ∞STEK: O sƒ±nava √∂zel √∂ƒüretmen adƒ± varsa onu, yoksa global adƒ± g√∂ster
                    const displayTeacher = conf.teacher_name || systemPreparerName;
                    const customExamName = conf.customName || code;

                    infoArea.innerHTML = `
                        <p class="font-bold text-lg text-indigo-900">${customExamName}</p>
                        <p class="text-xs text-gray-600 mb-1">${conf.exam_description || ''}</p>
                        <div class="flex justify-between items-center mt-2 border-t border-yellow-200 pt-1">
                            <span class="font-semibold">‚è±Ô∏è ${Math.floor(conf.time_limit/60)} Dk</span>
                            <span class="font-semibold text-indigo-700">üë§ ${displayTeacher}</span>
                        </div>
                    `;
                } else {
                    infoArea.innerHTML = `<p class="text-red-600 font-bold">Sƒ±nav ayarƒ± bulunamadƒ± (Varsayƒ±lanlar y√ºklendi)</p>`;
                    currentExamConfig = { exam_code: code, time_limit: 600, teacher_name: systemPreparerName };
                }

                // Sorularƒ± √áek
                const qSnap = await getDoc(doc(db, "questions_pool", code));
                quizQuestions = qSnap.exists() ? (qSnap.data().questions_list || []) : [];

                // Listeyi √áek
                const lSnap = await getDoc(doc(db, "student_lists", code));
                studentList = lSnap.exists() ? (lSnap.data().students || []) : [];

                // UI G√ºncelle
                if(studentList.length > 0) {
                    const students = studentList.sort((a,b)=>a.name.localeCompare(b.name, 'tr'));
                    const classes = [...new Set(students.map(s=>s.className))].sort();
                    
                    loginFields.innerHTML = `
                        <select id="classSelector" class="w-full p-3 border rounded-lg font-bold text-indigo-900"><option value="">Sƒ±nƒ±f Se√ßin</option>${classes.map(c=>`<option value="${c}">${c}</option>`).join('')}</select>
                        <select id="studentSelector" class="w-full p-3 border rounded-lg" disabled><option value="">ƒ∞sim Se√ßin</option></select>
                        <input id="numberVerify" type="number" placeholder="Doƒürulama ƒ∞√ßin Okul No" class="w-full p-3 border rounded-lg hidden">
                    `;

                    document.getElementById('classSelector').onchange = (e) => {
                        const val = e.target.value;
                        const sSel = document.getElementById('studentSelector');
                        sSel.innerHTML = '<option value="">ƒ∞sim Se√ßin</option>';
                        sSel.disabled = !val;
                        if(val) sSel.innerHTML += students.filter(s=>s.className===val).map(s=>`<option value="${s.number}_${s.name}">${s.name}</option>`).join('');
                    };

                    document.getElementById('studentSelector').onchange = (e) => {
                        if(e.target.value) {
                            document.getElementById('numberVerify').classList.remove('hidden');
                            document.getElementById('numberVerify').focus();
                        }
                    };

                    document.getElementById('numberVerify').oninput = (e) => {
                        const btn = document.getElementById('startQuizButton');
                        btn.disabled = !e.target.value;
                        btn.classList.toggle('opacity-50', !e.target.value);
                    };

                } else {
                    loginFields.innerHTML = `
                        <div class="text-xs text-red-500 font-bold mb-2">Liste Yok - Manuel Giri≈ü</div>
                        <input id="nameInput" placeholder="Ad Soyad" class="w-full p-2 border rounded mb-2">
                        <input id="numberInput" placeholder="Okul No" class="w-full p-2 border rounded mb-2">
                        <input id="classInput" placeholder="Sƒ±nƒ±f" class="w-full p-2 border rounded">
                    `;
                    const check = () => {
                        const valid = document.getElementById('nameInput').value && document.getElementById('numberInput').value;
                        const btn = document.getElementById('startQuizButton');
                        btn.disabled = !valid; btn.classList.toggle('opacity-50', !valid);
                    };
                    document.querySelectorAll('input').forEach(i => i.oninput = check);
                }

            } catch(e) { alert("Veri √ßekme hatasƒ±: " + e.message); }
        }

        // --- Gƒ∞Rƒ∞≈û VE SINAV BA≈ûLATMA ---
        async function handleStudentLogin() {
            const code = document.getElementById('examCodeInput').value.toUpperCase();
            let name, number, className;

            if(document.getElementById('studentSelector')) {
                const sel = document.getElementById('studentSelector').value;
                const ver = document.getElementById('numberVerify').value;
                if(!sel || !ver) return;
                const [rNum, rName] = sel.split('_');
                if(rNum !== ver) return showModal("Hata", "Se√ßilen ismin numarasƒ± ile girdiƒüiniz numara uyu≈ümuyor.");
                name = rName; number = rNum; className = document.getElementById('classSelector').value;
            } else {
                name = document.getElementById('nameInput').value;
                number = document.getElementById('numberInput').value;
                className = document.getElementById('classInput').value;
            }

            if(quizQuestions.length === 0) return showModal("Hata", "Soru yok.");

            studentData = { name, number, className, examCode: code };
            const studentKey = `${code}_${number}`;

            // Kontrol: Daha √∂nce girmi≈ü mi?
            const subQ = query(collection(db, "quiz_submissions"), where("studentKey", "==", studentKey));
            const subSnap = await getDocs(subQ);
            if(!subSnap.empty) return showModal("Tamamlandƒ±", "Bu sƒ±navƒ± zaten tamamladƒ±nƒ±z.");

            // Kontrol: Yarƒ±m kalan oturum?
            const sesQ = query(collection(db, "active_sessions"), where("studentKey", "==", studentKey));
            const sesSnap = await getDocs(sesQ);
            
            if(!sesSnap.empty) {
                restoreSession({id: sesSnap.docs[0].id, ...sesSnap.docs[0].data()});
            } else {
                startNewSession(number);
            }
            startQuizUI();
        }

        // --- SINAV Y√ñNETƒ∞Mƒ∞ ---
        function seededShuffle(array, seed) {
            let hash = 0, i, char;
            for (i = 0; i < seed.length; i++) { char = seed.charCodeAt(i); hash = ((hash << 5) - hash) + char; hash |= 0; }
            const shuffled = [...array];
            let m = shuffled.length, t, j;
            while (m) {
                hash = (hash * 9301 + 49297) % 233280;
                let rnd = hash / 233280.0;
                j = Math.floor(rnd * m--);
                t = shuffled[m]; shuffled[m] = shuffled[j]; shuffled[j] = t;
            }
            return shuffled;
        }

        function startNewSession(seed) {
            questionOrder = seededShuffle(Array.from({length: quizQuestions.length}, (_, i) => i), seed);
            selectedAnswers = Array(quizQuestions.length).fill(null);
            currentQuestionIndex = 0;
            focusLossCount = 0;
            examendTimeStamp = Date.now() + (currentExamConfig.time_limit * 1000);
        }

        function restoreSession(s) {
            questionOrder = s.questionOrder; selectedAnswers = s.selectedAnswers;
            currentQuestionIndex = s.currentQuestionIndex; focusLossCount = s.focusLossCount;
            currentSessionDocId = s.id;
            examendTimeStamp = Date.now() + (s.timeLeft * 1000);
        }

        function startQuizUI() {
            document.getElementById('app').className = 'app-card max-w-4xl w-full';
            document.getElementById('loginHeader').innerHTML = `<div class="flex justify-between px-4 text-sm"><span>${studentData.name}</span><span>${studentData.examCode}</span></div>`;
            
            document.getElementById('mainContentArea').innerHTML = `
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <div class="font-bold text-indigo-600">Soru: <span id="qInd">1</span>/${quizQuestions.length}</div>
                    <div id="timerDisplay" class="text-xl font-mono font-bold text-white bg-indigo-600 px-3 py-1 rounded shadow">--:--</div>
                </div>
                <div id="qArea" class="min-h-[300px]"></div>
                <div id="warnArea" class="hidden mt-2 text-center text-red-600 font-bold text-sm bg-red-50 p-2 rounded"></div>
                <div class="flex justify-between mt-6">
                    <button id="prevBtn" class="button bg-gray-500 text-white px-4 py-2 rounded" disabled>√ñnceki</button>
                    <button id="nextBtn" class="button bg-indigo-600 text-white px-6 py-2 rounded font-bold">Sonraki</button>
                </div>
            `;

            renderQuestion(currentQuestionIndex);
            startTimer();
            startAutoSave();
            
            window.onblur = () => { if(!isTeacherMode) { focusLossCount++; document.getElementById('warnArea').innerText=`‚ö†Ô∏è ${focusLossCount} Kez Odak Kaybƒ±!`; document.getElementById('warnArea').classList.remove('hidden'); saveProgress(); }};

            document.getElementById('prevBtn').onclick = () => { if(currentQuestionIndex>0) renderQuestion(--currentQuestionIndex); };
            document.getElementById('nextBtn').onclick = () => {
                if(currentQuestionIndex < quizQuestions.length-1) renderQuestion(++currentQuestionIndex);
                else finishQuiz();
            };
        }

        function renderQuestion(idx) {
            const realIdx = questionOrder[idx];
            const q = quizQuestions[realIdx];
            const seed = studentData.number + '_q' + realIdx;
            const opts = seededShuffle(q.options, seed);
            
            document.getElementById('qInd').innerText = idx + 1;
            document.getElementById('qArea').innerHTML = `
                <div class="text-lg font-semibold text-gray-800 mb-4 select-none">${idx+1}. ${q.question}</div>
                ${q.image ? `<img src="${q.image}" class="max-h-60 mx-auto mb-4 rounded shadow">` : ''}
                <div class="space-y-3">
                    ${opts.map(o => `
                        <label class="flex items-center p-3 border-2 rounded-lg cursor-pointer hover:bg-gray-50 ${selectedAnswers[realIdx]===o?'border-indigo-500 bg-indigo-50':''}">
                            <input type="radio" name="opt" value="${o}" class="w-5 h-5 text-indigo-600" ${selectedAnswers[realIdx]===o?'checked':''}>
                            <span class="ml-3 font-medium text-gray-700 select-none">${o}</span>
                        </label>
                    `).join('')}
                </div>
            `;
            
            document.querySelectorAll('input[name="opt"]').forEach(el => el.onchange = (e) => {
                selectedAnswers[realIdx] = e.target.value;
                renderQuestion(idx); // UI Refresh
                saveProgress();
            });

            document.getElementById('prevBtn').disabled = idx === 0;
            const nBtn = document.getElementById('nextBtn');
            if(idx === quizQuestions.length-1) { nBtn.innerText = "SINAVI Bƒ∞Tƒ∞R"; nBtn.className = "button bg-green-600 text-white px-6 py-2 rounded font-bold"; }
            else { nBtn.innerText = "Sonraki"; nBtn.className = "button bg-indigo-600 text-white px-6 py-2 rounded font-bold"; }
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                const diff = Math.ceil((examendTimeStamp - Date.now())/1000);
                if(diff <= 0) { clearInterval(timerInterval); finishQuiz(true); return; }
                const m = Math.floor(diff/60), s = diff%60;
                const disp = document.getElementById('timerDisplay');
                disp.innerText = `${m}:${s<10?'0'+s:s}`;
                if(diff<60) disp.className = "text-xl font-mono font-bold text-white bg-red-600 px-3 py-1 rounded animate-pulse";
            }, 1000);
        }

        async function saveProgress() {
            if(isTeacherMode) return;
            const data = {
                ...studentData, studentKey: `${studentData.examCode}_${studentData.number}`,
                questionOrder, selectedAnswers, currentQuestionIndex, focusLossCount,
                timeLeft: Math.ceil((examendTimeStamp - Date.now())/1000),
                lastUpdated: serverTimestamp()
            };
            try {
                if(currentSessionDocId) await updateDoc(doc(db, "active_sessions", currentSessionDocId), data);
                else { const r = await addDoc(collection(db, "active_sessions"), data); currentSessionDocId = r.id; }
            } catch(e) {}
        }

        // --- SONU√á VE Bƒ∞Tƒ∞RME ---
        async function finishQuiz(force=false) {
            clearInterval(timerInterval); clearInterval(autoSaveInterval); window.onblur = null;
            if(!force && !confirm("Sƒ±navƒ± bitirmek istiyor musunuz?")) { startTimer(); return; }

            document.getElementById('mainContentArea').innerHTML = `<div class="text-center py-10"><div class="loader"></div><p>Sonu√ßlar Hesaplanƒ±yor...</p></div>`;
            
            // Puanlama (Client-Side - G√ºvenlik i√ßin Cloud Function √∂nerilir ama burada JS yapƒ±yoruz)
            let c=0, w=0, e=0;
            // G√ºncel sorularƒ± son kez √ßek (deƒüi≈üiklik ihtimaline kar≈üƒ±)
            let questions = quizQuestions;
            try { const qSnap = await getDoc(doc(db, "questions_pool", studentData.examCode)); if(qSnap.exists()) questions = qSnap.data().questions_list; } catch(err){}

            questionOrder.forEach((realIdx) => {
                const sAns = (selectedAnswers[realIdx]||"").trim().toLowerCase();
                const cAns = (questions[realIdx]?.answer||"").trim().toLowerCase();
                if(!selectedAnswers[realIdx]) e++;
                else if(sAns === cAns) c++;
                else w++;
            });
            
            const score = (c * 100 / questions.length).toFixed(2);
            let ip = "Gizli"; try{const r=await fetch('https://api.ipify.org?format=json');const j=await r.json();ip=j.ip;}catch(er){}

            const finalData = {
                ...studentData, studentKey: `${studentData.examCode}_${studentData.number}`,
                score, correct: c, incorrect: w, empty: e,
                timestamp: serverTimestamp(),
                timeSpent: currentExamConfig.time_limit - Math.ceil((examendTimeStamp - Date.now())/1000),
                focusLossCount, ipAddress: ip,
                questionOrder, allAnswers: selectedAnswers
            };

            if(isDbConnected) {
                await addDoc(collection(db, "quiz_submissions"), finalData);
                if(currentSessionDocId) await deleteDoc(doc(db, "active_sessions", currentSessionDocId));
            }

            // 2. ƒ∞STEK: SONU√á EKRANINDA GRAFƒ∞K VE SIRALAMA G√ñSTERME
            await showEnhancedResult(finalData);
        }

        async function showEnhancedResult(data) {
            document.getElementById('app').className = 'app-card max-w-2xl';
            document.getElementById('loginHeader').innerHTML = '<h1 class="text-xl font-bold">Sonu√ß Kartƒ±</h1>';
            
            // Sƒ±ralama ve Ge√ßmi≈ü Verisi √áekme
            let rankText = "Hesaplanƒ±yor...";
            let historyData = [];
            
            if(isDbConnected) {
                // 1. Sƒ±ralama
                try {
                    const qAll = query(collection(db, "quiz_submissions"), where("examCode", "==", data.examCode));
                    const snapAll = await getDocs(qAll);
                    const scores = snapAll.docs.map(d => parseFloat(d.data().score)).sort((a,b) => b-a);
                    const myScore = parseFloat(data.score);
                    const rank = scores.indexOf(myScore) + 1;
                    rankText = `<b>${scores.length}</b> ki≈üi arasƒ±nda <b>${rank}.</b> oldunuz.`;
                } catch(e) { rankText = "Sƒ±ralama alƒ±namadƒ±"; }

                // 2. Geli≈üim (Ge√ßmi≈ü Sƒ±navlar)
                try {
                    const qHist = query(collection(db, "quiz_submissions"), where("number", "==", data.number), orderBy("timestamp", "asc"));
                    const snapHist = await getDocs(qHist);
                    historyData = snapHist.docs.map(d => ({ label: d.data().examCode, score: d.data().score }));
                } catch(e) {}
            }

            document.getElementById('mainContentArea').innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="text-center space-y-3">
                        <div class="text-5xl font-extrabold text-indigo-600">${data.score}</div>
                        <div class="text-gray-500 font-bold">PUAN</div>
                        <div class="bg-yellow-50 p-2 rounded text-yellow-800 text-sm">${rankText}</div>
                        <div class="flex justify-center gap-2 text-sm font-bold">
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded">${data.correct} D</span>
                            <span class="bg-red-100 text-red-800 px-2 py-1 rounded">${data.incorrect} Y</span>
                            <span class="bg-gray-100 text-gray-800 px-2 py-1 rounded">${data.empty} B</span>
                        </div>
                    </div>
                    <div class="bg-white border rounded p-2">
                        <p class="text-xs font-bold text-center mb-2 text-gray-500">Geli≈üim Grafiƒüi</p>
                        <canvas id="progressChart" style="max-height:150px"></canvas>
                    </div>
                </div>
                <button onclick="location.reload()" class="button w-full mt-6 bg-gray-800 text-white py-3 rounded font-bold">√áIKI≈û</button>
            `;

            if(historyData.length > 0) {
                new Chart(document.getElementById('progressChart'), {
                    type: 'line',
                    data: {
                        labels: historyData.map(h => h.label),
                        datasets: [{
                            label: 'Puan',
                            data: historyData.map(h => h.score),
                            borderColor: '#4f46e5',
                            tension: 0.3,
                            pointBackgroundColor: '#4f46e5'
                        }]
                    },
                    options: { 
                        responsive: true, 
                        plugins: { legend: {display: false} },
                        scales: { y: { beginAtZero: true, max: 100 } }
                    }
                });
            }
        }

        // --- Y√ñNETƒ∞Cƒ∞ PANELƒ∞ ---
        function showTeacherLogin() {
            document.getElementById('mainContentArea').innerHTML = `
                <h3 class="font-bold text-center mb-4">Y√∂netici Giri≈üi</h3>
                <input id="pass" type="password" placeholder="≈ûifre" class="w-full p-3 border rounded mb-4">
                <button id="loginBtn" class="button bg-indigo-600 text-white w-full py-2 rounded font-bold">Giri≈ü</button>
                <button onclick="resetApp()" class="w-full mt-2 text-sm text-gray-500">Geri</button>
            `;
            document.getElementById('loginBtn').onclick = () => {
                if(document.getElementById('pass').value === adminMasterCode && isDbConnected) {
                    isTeacherMode = true;
                    showDashboard();
                } else alert("Hatalƒ± ≈ûifre veya Baƒülantƒ± Yok");
            };
        }

        function showDashboard() {
            document.getElementById('connectionStatus').classList.add('hidden');
            document.getElementById('app').className = 'app-card teacher-mode';
            document.getElementById('loginHeader').innerHTML = '<div class="flex justify-between px-4"><span>Y√∂netim Paneli V14</span><button onclick="location.reload()" class="text-xs bg-red-500 px-2 py-1 rounded">√áƒ±kƒ±≈ü</button></div>';

            document.getElementById('mainContentArea').innerHTML = `
                <div class="flex overflow-x-auto gap-2 mb-4 border-b pb-2">
                    <button onclick="switchTab('results')" class="tab-btn bg-indigo-600 text-white px-4 py-2 rounded text-sm font-bold">üìä Sonu√ßlar</button>
                    <button onclick="switchTab('myexams')" class="tab-btn bg-purple-600 text-white px-4 py-2 rounded text-sm font-bold">üìÇ Sƒ±navlarƒ±m</button>
                    <button onclick="switchTab('create')" class="tab-btn bg-gray-600 text-white px-4 py-2 rounded text-sm font-bold">‚ûï Veri Y√ºkle</button>
                    <button onclick="switchTab('settings')" class="tab-btn bg-orange-600 text-white px-4 py-2 rounded text-sm font-bold">‚öôÔ∏è Ayarlar</button>
                </div>
                <div id="tab-content"></div>
            `;
            
            window.switchTab = (t) => {
                if(t==='results') loadResultsTab();
                if(t==='myexams') loadMyExamsTab();
                if(t==='create') loadCreateTab();
                if(t==='settings') loadSettingsTab();
            };
            loadResultsTab(); // Varsayƒ±lan
        }

        // --- 1. ƒ∞STEK: GELƒ∞≈ûMƒ∞≈û SINAVLARIM SEKMESƒ∞ ---
        async function loadMyExamsTab() {
            const div = document.getElementById('tab-content');
            div.innerHTML = '<div class="loader"></div>';
            
            // T√ºm sƒ±nav ayarlarƒ±nƒ± √ßek
            const snaps = await getDocs(collection(db, "exam_settings"));
            let html = '<div class="grid grid-cols-1 lg:grid-cols-2 gap-4">';

            if(snaps.empty) { div.innerHTML = "Sƒ±nav bulunamadƒ±."; return; }

            // Her sƒ±nav i√ßin detaylarƒ± √ßekmek biraz maliyetli ama "Show" istendiƒüi i√ßin yapƒ±yoruz
            // Performans i√ßin "metadata" koleksiyonu tutulabilir ama ≈üu an brute-force yapƒ±yoruz
            for(const d of snaps.docs) {
                if(d.id === 'admin_config') continue;
                const conf = d.data();
                const code = d.id;

                // Basit saya√ßlar (Firestore okuma maliyetini azaltmak i√ßin sadece count veya metadata kullanƒ±labilir)
                // Burada tam doƒüruluk i√ßin getDoc yapƒ±yoruz.
                let qCount = 0, sCount = 0;
                try {
                   const qS = await getDoc(doc(db, "questions_pool", code));
                   if(qS.exists()) qCount = qS.data().questions_list?.length || 0;
                   
                   const lS = await getDoc(doc(db, "student_lists", code));
                   if(lS.exists()) sCount = lS.data().students?.length || 0;
                } catch(e){}

                html += `
                    <div class="border rounded-lg p-4 shadow-sm bg-white hover:shadow-md transition relative">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <label class="text-xs text-gray-400 font-bold">Sƒ±nav Adƒ± (D√ºzenlenebilir)</label>
                                <div class="flex items-center gap-2">
                                    <input id="name_${code}" value="${conf.customName || code}" class="font-bold text-lg text-indigo-700 border-b border-dashed border-gray-300 bg-transparent focus:outline-none focus:border-indigo-500 w-full">
                                    <button onclick="saveExamName('${code}')" class="text-green-600 text-xs hover:bg-green-50 p-1 rounded">üíæ</button>
                                </div>
                                <div class="text-xs text-gray-500 font-mono mt-1">KOD: ${code}</div>
                            </div>
                            <button onclick="deleteDeep('${code}')" class="bg-red-50 text-red-600 px-2 py-1 rounded text-xs hover:bg-red-600 hover:text-white transition">üóëÔ∏è Sil</button>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2 text-sm mt-3 bg-gray-50 p-2 rounded">
                            <div>
                                <span class="block text-xs text-gray-400">Hazƒ±rlayan</span>
                                <span class="font-semibold text-gray-700">${conf.teacher_name || '-'}</span>
                            </div>
                            <div>
                                <span class="block text-xs text-gray-400">S√ºre</span>
                                <span class="font-semibold text-gray-700">${Math.floor(conf.time_limit/60)} Dk</span>
                            </div>
                            <div onclick="showListDetail('${code}')" class="cursor-pointer hover:text-indigo-600">
                                <span class="block text-xs text-gray-400">√ñƒürenci</span>
                                <span class="font-bold text-lg">${sCount}</span>
                                <span class="text-[10px] underline">Listeyi G√∂r</span>
                            </div>
                            <div onclick="showQuestionDetail('${code}')" class="cursor-pointer hover:text-orange-600">
                                <span class="block text-xs text-gray-400">Soru</span>
                                <span class="font-bold text-lg">${qCount}</span>
                                <span class="text-[10px] underline">Sorularƒ± G√∂r</span>
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-2 truncate">${conf.exam_description || ''}</p>
                    </div>
                `;
            }
            div.innerHTML = html + '</div>';
        }

        window.saveExamName = async (code) => {
            const val = document.getElementById(`name_${code}`).value;
            await updateDoc(doc(db, "exam_settings", code), { customName: val });
            showModal("Ba≈üarƒ±lƒ±", "ƒ∞sim g√ºncellendi.");
        }

        window.deleteDeep = async (code) => {
            if(!confirm(`${code} kodlu sƒ±navƒ± ve T√úM verilerini (sorular, liste, sonu√ßlar) silmek istediƒüine emin misin?`)) return;
            // Batch delete olmadƒ±ƒüƒ± i√ßin tek tek siliyoruz (Basitlik i√ßin)
            try {
                await deleteDoc(doc(db, "exam_settings", code));
                await deleteDoc(doc(db, "questions_pool", code));
                await deleteDoc(doc(db, "student_lists", code));
                // Sonu√ßlarƒ± da sil (Query ile)
                const q = query(collection(db, "quiz_submissions"), where("examCode", "==", code));
                const snap = await getDocs(q);
                snap.forEach(d => deleteDoc(d.ref));
                
                showModal("Silindi", "Sƒ±nav tamamen kaldƒ±rƒ±ldƒ±.");
                loadMyExamsTab();
            } catch(e) { showModal("Hata", e.message); }
        }

        window.showListDetail = async (code) => {
            const snap = await getDoc(doc(db, "student_lists", code));
            if(!snap.exists()) return showModal(code, "Liste yok.");
            const list = snap.data().students || [];
            let h = `<h3 class="font-bold mb-2">${code} - √ñƒürenci Listesi</h3><div class="max-h-96 overflow-auto text-left"><table class="w-full text-sm text-left">`;
            list.sort((a,b)=>a.className.localeCompare(b.className)).forEach(s => {
                h += `<tr class="border-b"><td class="p-1 font-bold">${s.className}</td><td class="p-1">${s.number}</td><td class="p-1">${s.name}</td></tr>`;
            });
            showModal("Liste Detayƒ±", h + "</table></div>", true);
        }

        window.showQuestionDetail = async (code) => {
            const snap = await getDoc(doc(db, "questions_pool", code));
            if(!snap.exists()) return showModal(code, "Soru yok.");
            const list = snap.data().questions_list || [];
            let h = `<h3 class="font-bold mb-2">${code} - Sorular</h3><div class="max-h-96 overflow-auto space-y-2 text-left">`;
            list.forEach((q, i) => {
                h += `<div class="border p-2 rounded bg-gray-50"><p class="font-bold text-xs text-indigo-600">Soru ${i+1} (Cevap: ${q.answer})</p><p class="text-sm">${q.question}</p></div>`;
            });
            showModal("Soru Detayƒ±", h + "</div>", true);
        }


        // --- 3. ƒ∞STEK: DETAYLI SONU√á TABLOSU (V12 √ñZELLƒ∞KLERƒ∞ GERƒ∞ GELDƒ∞) ---
        function loadResultsTab() {
            const div = document.getElementById('tab-content');
            div.innerHTML = `
                <div class="flex gap-2 mb-2">
                    <input id="fCode" placeholder="Kod Ara" class="border p-2 rounded text-sm">
                    <input id="fName" placeholder="ƒ∞sim Ara" class="border p-2 rounded text-sm">
                    <button onclick="downloadExcel()" class="bg-green-600 text-white px-3 rounded text-sm">Excel</button>
                </div>
                <div class="overflow-auto border rounded max-h-[500px]">
                    <table class="min-w-full text-sm divide-y">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="p-2 text-left">√ñƒürenci</th>
                                <th class="p-2 text-left">Kod</th>
                                <th class="p-2 text-left">Puan</th>
                                <th class="p-2 text-left">D/Y/B</th>
                                <th class="p-2 text-left">IP / Tarih</th>
                                <th class="p-2 text-left">Odak</th>
                                <th class="p-2 text-left">ƒ∞≈ülem</th>
                            </tr>
                        </thead>
                        <tbody id="resBody" class="divide-y bg-white"></tbody>
                    </table>
                </div>
            `;
            
            const render = (list) => {
                const body = document.getElementById('resBody');
                body.innerHTML = list.map(s => {
                    const date = s.timestamp ? new Date(s.timestamp.seconds*1000).toLocaleString('tr-TR') : '-';
                    return `
                    <tr class="hover:bg-gray-50">
                        <td class="p-2">
                            <div class="font-bold">${s.name}</div>
                            <div class="text-xs text-gray-500">${s.className} - ${s.number}</div>
                        </td>
                        <td class="p-2 font-mono text-xs">${s.examCode}</td>
                        <td class="p-2 font-bold ${s.score>=50?'text-green-600':'text-red-600'}">${s.score}</td>
                        <td class="p-2 text-xs">${s.correct}/${s.incorrect}/${s.empty}</td>
                        <td class="p-2 text-xs text-gray-500">
                            <div>${s.ipAddress || 'N/A'}</div>
                            <div>${date}</div>
                        </td>
                        <td class="p-2 text-center font-bold ${s.focusLossCount>0?'text-red-600 bg-red-50':''}">${s.focusLossCount||0}</td>
                        <td class="p-2">
                            <button onclick="showAnsDetail('${s.id}')" class="text-blue-600 hover:underline text-xs font-bold mr-2">Cevaplar</button>
                            <button onclick="delSub('${s.id}')" class="text-red-600 hover:underline text-xs">Sil</button>
                        </td>
                    </tr>`;
                }).join('');
            };

            onSnapshot(query(collection(db, "quiz_submissions"), orderBy("timestamp", "desc")), (snap) => {
                allSubmissions = snap.docs.map(d => ({id:d.id, ...d.data()}));
                render(allSubmissions);
            });

            const filter = () => {
                const c = document.getElementById('fCode').value.toLowerCase();
                const n = document.getElementById('fName').value.toLowerCase();
                render(allSubmissions.filter(s => (s.examCode||'').toLowerCase().includes(c) && (s.name||'').toLowerCase().includes(n)));
            };
            document.getElementById('fCode').oninput = filter;
            document.getElementById('fName').oninput = filter;
        }

        window.delSub = async (id) => { if(confirm("Silinsin mi?")) await deleteDoc(doc(db, "quiz_submissions", id)); };
        
        window.showAnsDetail = async (id) => {
            const sub = allSubmissions.find(s => s.id === id);
            if(!sub) return;
            
            // Sorularƒ± √ßek
            let questions = [];
            try {
                const snap = await getDoc(doc(db, "questions_pool", sub.examCode));
                if(snap.exists()) questions = snap.data().questions_list;
            } catch(e) {}

            if(questions.length === 0) return showModal("Hata", "Sorular bulunamadƒ±.");

            let html = `<h3 class="font-bold mb-2">${sub.name} - Cevap Analizi</h3><div class="text-left space-y-2 max-h-96 overflow-auto">`;
            
            // QuestionOrder kullanarak doƒüru sƒ±rayƒ± bul
            const order = sub.questionOrder || Array.from({length:questions.length}, (_,i)=>i);
            
            order.forEach((realIdx, displayIdx) => {
                const q = questions[realIdx];
                const ans = sub.allAnswers[realIdx];
                const isCorrect = (ans === q.answer);
                const bg = !ans ? 'bg-gray-100' : (isCorrect ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200');
                
                html += `
                    <div class="p-2 border rounded ${bg}">
                        <p class="text-xs font-bold text-gray-500">Soru ${displayIdx+1}</p>
                        <p class="text-sm mb-1">${q.question}</p>
                        <div class="text-xs flex gap-4">
                            <span>√ñƒürenci: <b>${ans || 'BO≈û'}</b></span>
                            <span class="text-green-700">Doƒüru: <b>${q.answer}</b></span>
                        </div>
                    </div>
                `;
            });
            showModal("Cevap Detayƒ±", html + "</div>", true);
        }
        
        window.downloadExcel = () => {
            let csv = "\uFEFFAd Soyad,Numara,Sinif,Kod,Puan,Dogru,Yanlis,Bos,IP,Tarih\n";
            allSubmissions.forEach(s => {
                const d = s.timestamp ? new Date(s.timestamp.seconds*1000).toLocaleString() : '';
                csv += `"${s.name}",${s.number},${s.className},${s.examCode},${s.score},${s.correct},${s.incorrect},${s.empty},${s.ipAddress},"${d}"\n`;
            });
            const link = document.createElement("a");
            link.href = "data:text/csv;charset=utf-8," + encodeURIComponent(csv);
            link.download = "Sonuclar.csv";
            link.click();
        }

        // --- 4. ƒ∞STEK: AYARLAR (GLOBAL √ñƒûRETMEN ADI) ---
        function loadSettingsTab() {
            const div = document.getElementById('tab-content');
            div.innerHTML = `
                <div class="max-w-md mx-auto space-y-4">
                    <div class="bg-indigo-50 p-4 rounded border border-indigo-200">
                        <h3 class="font-bold text-indigo-800 mb-2">Genel Ayarlar</h3>
                        <label class="text-xs font-bold">Sistemi Hazƒ±rlayan √ñƒüretmen Adƒ±</label>
                        <input id="sysPrepName" value="${systemPreparerName}" class="w-full p-2 border rounded mb-2" placeholder="√ñrn: Ahmet Hoca">
                        <p class="text-[10px] text-gray-500 mb-2">Bu isim √∂ƒürenci giri≈ü ekranƒ±nda ve sƒ±nav detaylarƒ±nda varsayƒ±lan olarak g√∂r√ºnecektir.</p>
                        <button onclick="saveSystemName()" class="bg-indigo-600 text-white px-4 py-2 rounded font-bold w-full">ƒ∞smi Kaydet</button>
                    </div>
                    
                    <div class="bg-red-50 p-4 rounded border border-red-200">
                        <h3 class="font-bold text-red-800 mb-2">Y√∂netici ≈ûifresi</h3>
                        <input id="newPass" type="password" placeholder="Yeni ≈ûifre" class="w-full p-2 border rounded mb-2">
                        <button onclick="savePass()" class="bg-red-600 text-white px-4 py-2 rounded font-bold w-full">≈ûifreyi Deƒüi≈ütir</button>
                    </div>
                </div>
            `;
        }
        
        window.saveSystemName = async () => {
            const n = document.getElementById('sysPrepName').value;
            await updateDoc(doc(db, "exam_settings", "admin_config"), { preparer_name: n });
            systemPreparerName = n;
            showModal("Ba≈üarƒ±lƒ±", "ƒ∞sim g√ºncellendi.");
        }
        
        window.savePass = async () => {
            const p = document.getElementById('newPass').value;
            if(p.length < 4) return showModal("Hata", "≈ûifre √ßok kƒ±sa");
            if(confirm("Emin misiniz?")) {
                await updateDoc(doc(db, "exam_settings", "admin_config"), { master_code: p });
                adminMasterCode = p;
                showModal("Ba≈üarƒ±lƒ±", "≈ûifre deƒüi≈üti.");
            }
        }

        // --- VERƒ∞ Y√úKLEME (ESKƒ∞Sƒ∞ Gƒ∞Bƒ∞) ---
        function loadCreateTab() {
            document.getElementById('tab-content').innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="border p-4 rounded">
                        <h3 class="font-bold mb-2 text-orange-600">Soru Y√ºkle (JSON)</h3>
                        <input id="qCode" placeholder="Sƒ±nav Kodu" class="w-full mb-2 p-2 border rounded uppercase">
                        <textarea id="qJson" class="w-full h-32 border text-xs font-mono" placeholder='[{"question":"...","options":["A"],"answer":"A"}]'></textarea>
                        <button onclick="uploadQ()" class="bg-orange-600 text-white w-full py-2 rounded font-bold">Sorularƒ± Kaydet</button>
                    </div>
                    <div class="border p-4 rounded">
                        <h3 class="font-bold mb-2 text-teal-600">Liste Y√ºkle (Excel)</h3>
                        <input id="lCode" placeholder="Sƒ±nav Kodu" class="w-full mb-2 p-2 border rounded uppercase">
                        <textarea id="lText" class="w-full h-32 border text-xs" placeholder="No | Sƒ±nƒ±f | Ad Soyad"></textarea>
                        <button onclick="uploadL()" class="bg-teal-600 text-white w-full py-2 rounded font-bold">Listeyi Kaydet</button>
                    </div>
                    <div class="border p-4 rounded col-span-1 md:col-span-2">
                        <h3 class="font-bold mb-2 text-gray-600">Sƒ±nav Ayarƒ± Olu≈ütur</h3>
                        <div class="flex gap-2">
                            <input id="sCode" placeholder="Kod" class="border p-2 uppercase w-1/4">
                            <input id="sName" placeholder="G√∂r√ºnen Ad (√ñrn: Mat-1)" class="border p-2 w-1/4">
                            <input id="sTime" type="number" placeholder="Dakika" class="border p-2 w-1/6">
                            <input id="sTeach" placeholder="√ñzel √ñƒüretmen Adƒ±" class="border p-2 w-1/4">
                            <button onclick="createSettings()" class="bg-gray-700 text-white px-4 rounded">Kaydet</button>
                        </div>
                    </div>
                </div>
            `;
        }

        window.uploadQ = async () => {
            try {
                const c = document.getElementById('qCode').value.toUpperCase();
                const j = JSON.parse(document.getElementById('qJson').value);
                await setDoc(doc(db, "questions_pool", c), { questions_list: j });
                showModal("Ba≈üarƒ±lƒ±", `${j.length} soru y√ºklendi.`);
            } catch(e) { showModal("Hata", e.message); }
        }

        window.uploadL = async () => {
            const c = document.getElementById('lCode').value.toUpperCase();
            const lines = document.getElementById('lText').value.split('\n').filter(x=>x.trim());
            const students = [];
            lines.forEach(l => {
                const p = l.split('\t');
                if(p.length>=3) students.push({number:p[0].trim(), className:p[1].trim(), name:p[2].trim()});
            });
            await setDoc(doc(db, "student_lists", c), { students });
            showModal("Ba≈üarƒ±lƒ±", `${students.length} √∂ƒürenci y√ºklendi.`);
        }

        window.createSettings = async () => {
            const c = document.getElementById('sCode').value.toUpperCase();
            if(!c) return;
            await setDoc(doc(db, "exam_settings", c), {
                customName: document.getElementById('sName').value,
                time_limit: (parseInt(document.getElementById('sTime').value)||10)*60,
                teacher_name: document.getElementById('sTeach').value,
                exam_description: "Y√∂netici tarafƒ±ndan olu≈üturuldu."
            }, {merge:true});
            showModal("Ba≈üarƒ±lƒ±", "Ayarlar kaydedildi.");
        }

        // --- HELPER ---
        function showModal(title, bodyContent, isHtml=false) {
            const m = document.getElementById('customModal');
            document.getElementById('modalBody').innerHTML = isHtml ? bodyContent : `
                <h3 class="text-xl font-bold mb-2">${title}</h3>
                <p class="text-gray-600 mb-4">${bodyContent}</p>
                <button onclick="document.getElementById('customModal').classList.add('hidden')" class="bg-indigo-600 text-white px-4 py-2 rounded">Tamam</button>
            `;
            m.classList.remove('hidden'); m.classList.add('flex');
            document.getElementById('modalCloseX').onclick = () => { m.classList.add('hidden'); m.classList.remove('flex'); };
        }

        initializeFirebase();
    </script>
</body>
</html>
